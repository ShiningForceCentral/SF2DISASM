
; GAME SECTION 02 :
; Character Stats Engine, Battle engine, Enemy AI Engine, Item Effects Engine

; FREE SPACE : 121 bytes.



; =============== S U B R O U T I N E =======================================

j_GetCharName:
										
										jmp     GetCharName(pc) 

	; End of function j_GetCharName


; =============== S U B R O U T I N E =======================================

; get entity's class index ?

j_GetClass:
										
										jmp     GetClass(pc)

	; End of function j_GetClass


; =============== S U B R O U T I N E =======================================

j_GetYPos:
										
										jmp     GetYPos(pc)

	; End of function j_GetYPos


; =============== S U B R O U T I N E =======================================

j_GetMaxMP:
										
										jmp     GetMaxMP(pc)

	; End of function j_GetMaxMP


; =============== S U B R O U T I N E =======================================

j_GetMaxHP:
										
										jmp     GetMaxHP(pc)

	; End of function j_GetMaxHP


; =============== S U B R O U T I N E =======================================

j_GetXPos:
										
										jmp     GetXPos(pc)

	; End of function j_GetXPos


; =============== S U B R O U T I N E =======================================

j_GetUpperMoveType:
										
										jmp     GetUpperMoveType(pc)

	; End of function j_GetUpperMoveType


; =============== S U B R O U T I N E =======================================

j_GetStatus:
										
										jmp     GetStatus(pc)

	; End of function j_GetStatus


; =============== S U B R O U T I N E =======================================

j_GetCurrentSpecialAbility:
										
										jmp     GetCurrentProwess(pc)

	; End of function j_GetCurrentSpecialAbility


; =============== S U B R O U T I N E =======================================

j_GetBaseSpecialAbility:
										
										jmp     GetBaseProwess(pc)

	; End of function j_GetBaseSpecialAbility


; =============== S U B R O U T I N E =======================================

j_GetBaseMOV:
										
										jmp     GetBaseMOV(pc)

	; End of function j_GetBaseMOV


; =============== S U B R O U T I N E =======================================

j_GetBaseDEF:
										
										jmp     GetBaseDEF(pc)

	; End of function j_GetBaseDEF


; =============== S U B R O U T I N E =======================================

j_GetBaseResistance:
										
										jmp     GetBaseResistance(pc)

	; End of function j_GetBaseResistance


; =============== S U B R O U T I N E =======================================

j_GetBaseATK:
										
										jmp     GetBaseATK(pc)

	; End of function j_GetBaseATK


; =============== S U B R O U T I N E =======================================

j_GetBaseAGI:
										
										jmp     GetBaseAGI(pc)

	; End of function j_GetBaseAGI


; =============== S U B R O U T I N E =======================================

j_GetCurrentMOV:
										
										jmp     GetCurrentMOV(pc)

	; End of function j_GetCurrentMOV


; =============== S U B R O U T I N E =======================================

j_GetCurrentMP:
										
										jmp     GetCurrentMP(pc)

	; End of function j_GetCurrentMP


; =============== S U B R O U T I N E =======================================

j_GetCurrentLevel:
										
										jmp     GetCurrentLevel(pc)

	; End of function j_GetCurrentLevel


; =============== S U B R O U T I N E =======================================

j_GetCurrentHP:
										
										jmp     GetCurrentHP(pc)

	; End of function j_GetCurrentHP


; =============== S U B R O U T I N E =======================================

j_GetCurrentEXP:
										
										jmp     GetCurrentEXP(pc)

	; End of function j_GetCurrentEXP


; =============== S U B R O U T I N E =======================================

j_GetCurrentDEF:
										
										jmp     GetCurrentDEF(pc)

	; End of function j_GetCurrentDEF


; =============== S U B R O U T I N E =======================================

j_GetCurrentResistance:
										
										jmp     GetCurrentResistance(pc)

	; End of function j_GetCurrentResistance


; =============== S U B R O U T I N E =======================================

j_GetCurrentATK:
										
										jmp     GetCurrentATK(pc)

	; End of function j_GetCurrentATK


; =============== S U B R O U T I N E =======================================

j_GetEnemyAISetting3233:
										
										jmp     GetEnemyAISetting3233(pc)

	; End of function j_GetEnemyAISetting3233


; =============== S U B R O U T I N E =======================================

j_GetEnemyAISetting36:
										
										jmp     GetEnemyAISetting36(pc)

	; End of function j_GetEnemyAISetting36


; =============== S U B R O U T I N E =======================================

j_GetCharacterWord34:
										
										jmp     GetCharacterWord34(pc)

	; End of function j_GetCharacterWord34


; =============== S U B R O U T I N E =======================================

j_GetCurrentAGI:
										
										jmp     GetCurrentAGI(pc)

	; End of function j_GetCurrentAGI


; =============== S U B R O U T I N E =======================================

j_GetEnemyID:
										
										jmp     GetEnemyID(pc)

	; End of function j_GetEnemyID


; =============== S U B R O U T I N E =======================================

j_GetSomethingClassType:
										
										jmp     GetSomethingClassType(pc)

	; End of function j_GetSomethingClassType


; =============== S U B R O U T I N E =======================================

j_GetKills:
										
										jmp     GetKills(pc)

	; End of function j_GetKills


; =============== S U B R O U T I N E =======================================

j_GetDefeats:
										
										jmp     GetDefeats(pc)

	; End of function j_GetDefeats


; =============== S U B R O U T I N E =======================================

j_CopyCharNameToRAM:
										
										jmp     CopyCharNameToRAM(pc)

	; End of function j_CopyCharNameToRAM


; =============== S U B R O U T I N E =======================================

j_SetYPos:
										
										jmp     SetYPos(pc)

	; End of function j_SetYPos


; =============== S U B R O U T I N E =======================================

j_SetMaxMP:
										
										jmp     SetMaxMP(pc)

	; End of function j_SetMaxMP


; =============== S U B R O U T I N E =======================================

j_SetMaxHP:
										
										jmp     SetMaxHP(pc)

	; End of function j_SetMaxHP


; =============== S U B R O U T I N E =======================================

j_SetXPos:
										
										jmp     SetXPos(pc)

	; End of function j_SetXPos


; =============== S U B R O U T I N E =======================================

j_SetMoveType:
										
										jmp     SetMoveType(pc)

	; End of function j_SetMoveType


; =============== S U B R O U T I N E =======================================

j_SetStatus:
										
										jmp     SetStatus(pc)

	; End of function j_SetStatus


; =============== S U B R O U T I N E =======================================

j_SetCurrentSomething:
										
										jmp     SetCurrentSomething(pc)

	; End of function j_SetCurrentSomething


; =============== S U B R O U T I N E =======================================

j_SetBaseSomething:
										
										jmp     SetBaseSomething(pc)

	; End of function j_SetBaseSomething


; =============== S U B R O U T I N E =======================================

j_SetBaseMOV:
										
										jmp     SetBaseMOV(pc)

	; End of function j_SetBaseMOV


; =============== S U B R O U T I N E =======================================

j_SetBaseDEF:
										
										jmp     SetBaseDEF(pc)

	; End of function j_SetBaseDEF


; =============== S U B R O U T I N E =======================================

j_SetBaseResistance:
										
										jmp     SetBaseResistance(pc)

	; End of function j_SetBaseResistance


; =============== S U B R O U T I N E =======================================

j_SetBaseATK:
										
										jmp     SetBaseATK(pc)

	; End of function j_SetBaseATK


; =============== S U B R O U T I N E =======================================

j_SetBaseAGI:
										
										jmp     SetBaseAGI(pc)

	; End of function j_SetBaseAGI


; =============== S U B R O U T I N E =======================================

j_SetCurrentMOV:
										
										jmp     SetCurrentMOV(pc)

	; End of function j_SetCurrentMOV


; =============== S U B R O U T I N E =======================================

j_SetCurrentMP:
										
										jmp     SetCurrentMP(pc)

	; End of function j_SetCurrentMP


; =============== S U B R O U T I N E =======================================

j_SetLevel:
										
										jmp     SetLevel(pc)

	; End of function j_SetLevel


; =============== S U B R O U T I N E =======================================

j_SetCurrentHP:
										
										jmp     SetCurrentHP(pc)

	; End of function j_SetCurrentHP


; =============== S U B R O U T I N E =======================================

j_SetCurrentEXP:
										
										jmp     SetCurrentEXP(pc)

	; End of function j_SetCurrentEXP


; =============== S U B R O U T I N E =======================================

j_SetCurrentDEF:
										
										jmp     SetCurrentDEF(pc)

	; End of function j_SetCurrentDEF


; =============== S U B R O U T I N E =======================================

j_SetClass:
										
										jmp     SetClass(pc)

	; End of function j_SetClass


; =============== S U B R O U T I N E =======================================

j_SetCurrentResistance:
										
										jmp     SetCurrentResistance(pc)

	; End of function j_SetCurrentResistance


; =============== S U B R O U T I N E =======================================

j_SetCurrentATK:
										
										jmp     SetCurrentATK(pc)

	; End of function j_SetCurrentATK


; =============== S U B R O U T I N E =======================================

j_SetKills:
										
										jmp     SetKills(pc)    

	; End of function j_SetKills


; =============== S U B R O U T I N E =======================================

j_SetDefeats:
										
										jmp     SetDefeats(pc)  

	; End of function j_SetDefeats


; =============== S U B R O U T I N E =======================================

j_SetCharacterWord34:
										
										jmp     SetCharacterWord34(pc)

	; End of function j_SetCharacterWord34


; =============== S U B R O U T I N E =======================================

j_SetCurrentAGI:
										
										jmp     SetCurrentAGI(pc)

	; End of function j_SetCurrentAGI


; =============== S U B R O U T I N E =======================================

j_SetEnemyID:
										
										jmp     SetEnemyID(pc)

	; End of function j_SetEnemyID


; =============== S U B R O U T I N E =======================================

j_IncreaseMP:
										
										jmp     IncreaseMaxMP(pc)

	; End of function j_IncreaseMP


; =============== S U B R O U T I N E =======================================

j_IncreaseMaxHP:
										
										jmp     IncreaseMaxHP(pc)

	; End of function j_IncreaseMaxHP


; =============== S U B R O U T I N E =======================================

j_IncreaseBaseMOV:
										
										jmp     IncreaseBaseMOV(pc)

	; End of function j_IncreaseBaseMOV


; =============== S U B R O U T I N E =======================================

j_IncreaseBaseDEF:
										
										jmp     IncreaseBaseDEF(pc)

	; End of function j_IncreaseBaseDEF


; =============== S U B R O U T I N E =======================================

j_IncreaseBaseATK:
										
										jmp     IncreaseBaseATK(pc)

	; End of function j_IncreaseBaseATK


; =============== S U B R O U T I N E =======================================

j_IncreaseAGI:
										
										jmp     IncreaseBaseAGI(pc)

	; End of function j_IncreaseAGI


; =============== S U B R O U T I N E =======================================

j_IncreaseCurrentMOV:
										
										jmp     IncreaseCurrentMOV(pc)

	; End of function j_IncreaseCurrentMOV


; =============== S U B R O U T I N E =======================================

j_IncreaseCurrentMP:
										
										jmp     IncreaseCurrentMP(pc)

	; End of function j_IncreaseCurrentMP


; =============== S U B R O U T I N E =======================================

j_IncreaseLevel:
										
										jmp     IncreaseLevel(pc)

	; End of function j_IncreaseLevel


; =============== S U B R O U T I N E =======================================

j_IncreaseCurrentHP:
										
										jmp     IncreaseCurrentHP(pc)

	; End of function j_IncreaseCurrentHP


; =============== S U B R O U T I N E =======================================

j_IncreaseEXP:
										
										jmp     IncreaseEXP(pc)

	; End of function j_IncreaseEXP


; =============== S U B R O U T I N E =======================================

j_IncreaseCurrentDEF:
										
										jmp     IncreaseCurrentDEF(pc)

	; End of function j_IncreaseCurrentDEF


; =============== S U B R O U T I N E =======================================

j_IncreaseCurrentATK:
										
										jmp     IncreaseCurrentATK(pc)

	; End of function j_IncreaseCurrentATK


; =============== S U B R O U T I N E =======================================

j_IncreaseCurrentAGI:
										
										jmp     IncreaseCurrentAGI(pc)

	; End of function j_IncreaseCurrentAGI


; =============== S U B R O U T I N E =======================================

j_IncreaseKills:
										
										jmp     IncreaseKills(pc)

	; End of function j_IncreaseKills


; =============== S U B R O U T I N E =======================================

j_IncreaseDefeats:
										
										jmp     IncreaseDefeats(pc)

	; End of function j_IncreaseDefeats


; =============== S U B R O U T I N E =======================================

j_DecreaseBaseMOV:
										
										jmp     DecreaseBaseMOV(pc)

	; End of function j_DecreaseBaseMOV


; =============== S U B R O U T I N E =======================================

j_DecreaseBaseDEF:
										
										jmp     DecreaseBaseDEF(pc)

	; End of function j_DecreaseBaseDEF


; =============== S U B R O U T I N E =======================================

j_DecreaseBaseAGI:
										
										jmp     DecreaseBaseAGI(pc)

	; End of function j_DecreaseBaseAGI


; =============== S U B R O U T I N E =======================================

j_DecreaseCurrentMOV:
										
										jmp     DecreaseCurrentMOV(pc)

	; End of function j_DecreaseCurrentMOV


; =============== S U B R O U T I N E =======================================

j_DecreaseCurrentMP:
										
										jmp     DecreaseCurrentMP(pc)

	; End of function j_DecreaseCurrentMP


; =============== S U B R O U T I N E =======================================

j_DecreaseCurrentHP:
										
										jmp     DecreaseCurrentHP(pc)

	; End of function j_DecreaseCurrentHP


; =============== S U B R O U T I N E =======================================

j_DecreaseCurrentDEF:
										
										jmp     DecreaseCurrentDEF(pc)

	; End of function j_DecreaseCurrentDEF


; =============== S U B R O U T I N E =======================================

j_DecreaseCurrentATK:
										
										jmp     DecreaseCurrentATK(pc)

	; End of function j_DecreaseCurrentATK


; =============== S U B R O U T I N E =======================================

j_DecreaseCurrentAGI:
										
										jmp     DecreaseCurrentAGI(pc)

	; End of function j_DecreaseCurrentAGI


; =============== S U B R O U T I N E =======================================

j_GetClassName:
										
										jmp     GetClassName(pc)

	; End of function j_GetClassName


; =============== S U B R O U T I N E =======================================

j_SetGold:
										
										jmp     SetGold(pc)

	; End of function j_SetGold


; =============== S U B R O U T I N E =======================================

j_GetGold:
										
										jmp     GetGold(pc)

	; End of function j_GetGold


; =============== S U B R O U T I N E =======================================

j_IncreaseGold:
										
										jmp     IncreaseGold(pc)

	; End of function j_IncreaseGold


; =============== S U B R O U T I N E =======================================

j_DecreaseGold:
										
										jmp     DecreaseGold(pc)

	; End of function j_DecreaseGold


; =============== S U B R O U T I N E =======================================

j_ApplyStatusAndItemsOnStats:
										
										jmp     ApplyStatusAndItemsOnStats(pc)

	; End of function j_ApplyStatusAndItemsOnStats


; =============== S U B R O U T I N E =======================================

j_ApplyItemOnStats:
										
										jmp     ApplyItemOnStats(pc)

	; End of function j_ApplyItemOnStats


; =============== S U B R O U T I N E =======================================

j_FindItemName:
										
										jmp     FindItemName(pc)

	; End of function j_FindItemName


; =============== S U B R O U T I N E =======================================

j_GetItemDefAddress:
										
										jmp     GetItemDefAddress(pc)

	; End of function j_GetItemDefAddress


; =============== S U B R O U T I N E =======================================

j_GetItemAndNumberOfItems:
										
										jmp     GetCharItemAtSlotAndNumberOfItems(pc)

	; End of function j_GetItemAndNumberOfItems


; =============== S U B R O U T I N E =======================================

j_GetItemType:
										
										jmp     GetItemType(pc) 

	; End of function j_GetItemType


; =============== S U B R O U T I N E =======================================

j_GetEquippedWeapon:
										
										jmp     GetEquippedWeapon(pc)

	; End of function j_GetEquippedWeapon


; =============== S U B R O U T I N E =======================================

j_GetEquippedRing:
										
										jmp     GetEquippedRing(pc)

	; End of function j_GetEquippedRing


; =============== S U B R O U T I N E =======================================

j_BreakItem:
										
										jmp     BreakItem(pc)   

	; End of function j_BreakItem


; =============== S U B R O U T I N E =======================================

j_RepairItemBySlot:
										
										jmp     RepairItemBySlot(pc)

	; End of function j_RepairItemBySlot


; =============== S U B R O U T I N E =======================================

j_EquipItem:
										
										jmp     EquipItemBySlot(pc)

	; End of function j_EquipItem


; =============== S U B R O U T I N E =======================================

j_UnequipItemIfNotCursed:
										
										jmp     UnequipItemBySlotIfNotCursed(pc)

	; End of function j_UnequipItemIfNotCursed


; =============== S U B R O U T I N E =======================================

j_UnequipItemBySlot:
										
										jmp     UnequipItemBySlot(pc)

	; End of function j_UnequipItemBySlot


; =============== S U B R O U T I N E =======================================

j_AddItem:
										
										jmp     AddItem(pc)     

	; End of function j_AddItem


; =============== S U B R O U T I N E =======================================

j_RemoveItemBySlot:
										
										jmp     RemoveItemBySlot(pc)

	; End of function j_RemoveItemBySlot


; =============== S U B R O U T I N E =======================================

j_DropItemBySlot:
										
										jmp     DropItemBySlot(pc)

	; End of function j_DropItemBySlot


; =============== S U B R O U T I N E =======================================

j_UnequipWeapon:
										
										jmp     UnequipWeapon(pc)

	; End of function j_UnequipWeapon


; =============== S U B R O U T I N E =======================================

j_UnequipRing:
										
										jmp     UnequipRing(pc)

	; End of function j_UnequipRing


; =============== S U B R O U T I N E =======================================

j_GetEquippableWeapons:
										
										jmp     GetEquippableWeapons(pc)

	; End of function j_GetEquippableWeapons


; =============== S U B R O U T I N E =======================================

j_GetEquippableRings:
										
										jmp     GetEquippableRings(pc)

	; End of function j_GetEquippableRings


; =============== S U B R O U T I N E =======================================

j_IsWeaponOrRingEquippable:
										
										jmp     IsWeaponOrRingEquippable(pc)

	; End of function j_IsWeaponOrRingEquippable


; =============== S U B R O U T I N E =======================================

j_GetWeaponNewATKandDEF:
										
										jmp     GetWeaponNewATKandDEF(pc)

	; End of function j_GetWeaponNewATKandDEF


; =============== S U B R O U T I N E =======================================

j_OrderItems:
										
										jmp     OrderItems(pc)

	; End of function j_OrderItems


; =============== S U B R O U T I N E =======================================

j_IsItemCursed:
										
										jmp     IsItemCursed(pc)

	; End of function j_IsItemCursed


; =============== S U B R O U T I N E =======================================

j_IsItemUsableInBattle:
										
										jmp     IsItemUsableInBattle(pc)

	; End of function j_IsItemUsableInBattle


; =============== S U B R O U T I N E =======================================

j_IsItemUsableWeaponInBattle:
										
										jmp     IsItemUsableWeaponInBattle(pc)

	; End of function j_IsItemUsableWeaponInBattle


; =============== S U B R O U T I N E =======================================

j_UnequipAllItemsIfNotCursed:
										
										jmp     UnequipAllItemsIfNotCursed(pc)

	; End of function j_UnequipAllItemsIfNotCursed


; =============== S U B R O U T I N E =======================================

j_sub_9146:
										
										jmp     j_sub_9146_0(pc)

	; End of function j_sub_9146


; =============== S U B R O U T I N E =======================================

j_GetItemSlotContainingIndex:
										
										jmp     GetItemSlotContainingIndex(pc)

	; End of function j_GetItemSlotContainingIndex


; =============== S U B R O U T I N E =======================================

j_FindSpellName:
										
										jmp     FindSpellName(pc)

	; End of function j_FindSpellName


; =============== S U B R O U T I N E =======================================

j_GetSpellDefAddress:
										
										jmp     GetSpellDefAddress(pc)

	; End of function j_GetSpellDefAddress


; =============== S U B R O U T I N E =======================================

j_GetSpellAndNumberOfSpells:
										
										jmp     GetSpellAndNumberOfSpells(pc)

	; End of function j_GetSpellAndNumberOfSpells


; =============== S U B R O U T I N E =======================================

j_GetSpellCost:
										
										jmp     GetSpellCost(pc)

	; End of function j_GetSpellCost


; =============== S U B R O U T I N E =======================================

j_LearnSpell:
										
										jmp     LearnSpell(pc)  

	; End of function j_LearnSpell


; =============== S U B R O U T I N E =======================================

j_GetCharacterRAMAddress_0:
										
										jmp     GetCharEntryAddress(pc)

	; End of function j_GetCharacterRAMAddress_0


; =============== S U B R O U T I N E =======================================

j_GetDistanceBetweenEntities:
										
										jmp     GetDistanceBetweenEntities(pc)

	; End of function j_GetDistanceBetweenEntities


; =============== S U B R O U T I N E =======================================

j_nullsub_6:
										
										jmp     nullsub_6(pc)

	; End of function j_nullsub_6


; =============== S U B R O U T I N E =======================================

j_GetCharEntryAddress:
										
										jmp     GetCharEntryAddress(pc)

	; End of function j_GetCharEntryAddress


; =============== S U B R O U T I N E =======================================

j_NewGame:
										
										jmp     NewGame(pc)

	; End of function j_NewGame


; =============== S U B R O U T I N E =======================================

j_LevelUp:
										
										jmp     LevelUp(pc)

	; End of function j_LevelUp


; =============== S U B R O U T I N E =======================================

j_Promote:
										
										jmp     Promote(pc)

	; End of function j_Promote


; =============== S U B R O U T I N E =======================================

j_DebugModeSelectAction:
										
										jmp     DebugModeSelectAction(pc)

	; End of function j_DebugModeSelectAction


; =============== S U B R O U T I N E =======================================

j_WriteSkirmishScript:
										
										jmp     WriteSkirmishScript(pc)

	; End of function j_WriteSkirmishScript


; =============== S U B R O U T I N E =======================================

j_sub_C404:
										
										jmp     j_sub_C404_0(pc)

	; End of function j_sub_C404


; =============== S U B R O U T I N E =======================================

j_CreateSpellRangeGrid:
										
										jmp     CreateSpellRangeGrid(pc)

	; End of function j_CreateSpellRangeGrid


; =============== S U B R O U T I N E =======================================

j_CreateItemRangeGrid:
										
										jmp     CreateItemRangeGrid(pc)

	; End of function j_CreateItemRangeGrid


; =============== S U B R O U T I N E =======================================

j_sub_C4E8:
										
										jmp     j_sub_C4E8_0(pc)

	; End of function j_sub_C4E8


; =============== S U B R O U T I N E =======================================

j_sub_C5D6:
										
										jmp     j_sub_C5D6_0(pc)

	; End of function j_sub_C5D6


; =============== S U B R O U T I N E =======================================

j_sub_C5FA:
										
										jmp     j_sub_C5FA_0(pc)

	; End of function j_sub_C5FA


; =============== S U B R O U T I N E =======================================

j_CreateTargetGridFromSpell:
										
										jmp     CreateTargetGridFromSpell(pc)

	; End of function j_CreateTargetGridFromSpell


; =============== S U B R O U T I N E =======================================

j_CreateTargetGrid:
										
										jmp     CreateTargetGrid(pc)

	; End of function j_CreateTargetGrid


; =============== S U B R O U T I N E =======================================

j_MakeTargetList:
										
										jmp     MakeTargetList(pc)

	; End of function j_MakeTargetList


; =============== S U B R O U T I N E =======================================

j_MakeTargetListAllies:
										
										jmp     MakeTargetListAllies(pc)

	; End of function j_MakeTargetListAllies


; =============== S U B R O U T I N E =======================================

j_MakeTargetListMonsters:
										
										jmp     MakeTargetListMonsters(pc)

	; End of function j_MakeTargetListMonsters


; =============== S U B R O U T I N E =======================================

j_MakeTargetListEverybody:
										
										jmp     MakeTargetListEverybody(pc)

	; End of function j_MakeTargetListEverybody


; =============== S U B R O U T I N E =======================================

j_UpdateTargetListCharacters:
										
										jmp     UpdateTargetListCharacters(pc)

	; End of function j_UpdateTargetListCharacters


; =============== S U B R O U T I N E =======================================

j_UpdateTargetListMonsters:
										
										jmp     UpdateTargetListMonsters(pc)

	; End of function j_UpdateTargetListMonsters


; =============== S U B R O U T I N E =======================================

j_ConvertCoordToOffset:
										
										jmp     ConvertCoordToOffset(pc)

	; End of function j_ConvertCoordToOffset


; =============== S U B R O U T I N E =======================================

j_ClearMovableGrid:
										
										jmp     ClearMovableGrid(pc)

	; End of function j_ClearMovableGrid


; =============== S U B R O U T I N E =======================================

j_ClearTargetGrid:
										
										jmp     ClearTargetGrid(pc)

	; End of function j_ClearTargetGrid


; =============== S U B R O U T I N E =======================================

j_GetTargetAtCoordOffset:
										
										jmp     GetTargetAtCoordOffset(pc)

	; End of function j_GetTargetAtCoordOffset


; =============== S U B R O U T I N E =======================================

j_GetMoveCost:
										
										jmp     GetMoveCost(pc)

	; End of function j_GetMoveCost


; =============== S U B R O U T I N E =======================================

j_GetCurrentTerrainType:
										
										jmp     GetCurrentTerrainType(pc)

	; End of function j_GetCurrentTerrainType


; =============== S U B R O U T I N E =======================================

j_SetMovableAtCoord:
										
										jmp     SetMovableAtCoord(pc)

	; End of function j_SetMovableAtCoord


; =============== S U B R O U T I N E =======================================

j_CheckFlag:
										
										jmp     CheckFlag(pc)

	; End of function j_CheckFlag


; =============== S U B R O U T I N E =======================================

j_SetFlag:
										
										jmp     SetFlag(pc)

	; End of function j_SetFlag


; =============== S U B R O U T I N E =======================================

j_ClearFlag:
										
										jmp     ClearFlag(pc)

	; End of function j_ClearFlag


; =============== S U B R O U T I N E =======================================

j_UpdateForce:
										
										jmp     UpdateForce(pc) 

	; End of function j_UpdateForce


; =============== S U B R O U T I N E =======================================

j_JoinForce:
										
										jmp     JoinForce(pc)

	; End of function j_JoinForce


; =============== S U B R O U T I N E =======================================

j_LeaveForce:
										
										jmp     LeaveForce(pc)

	; End of function j_LeaveForce


; =============== S U B R O U T I N E =======================================

; In: D0 = character idx

j_IsInBattleParty:
										
										jmp     IsInBattleParty(pc)

	; End of function j_IsInBattleParty


; =============== S U B R O U T I N E =======================================

; In: D0 = character idx

j_JoinBattleParty:
										
										jmp     JoinBattleParty(pc)

	; End of function j_JoinBattleParty


; =============== S U B R O U T I N E =======================================

; In: D0 = character idx

j_LeaveBattleParty:
										
										jmp     LeaveBattleParty(pc)

	; End of function j_LeaveBattleParty


; =============== S U B R O U T I N E =======================================

j_GetDealsItemAmount:
										
										jmp     GetDealsItemAmount(pc)

	; End of function j_GetDealsItemAmount


; =============== S U B R O U T I N E =======================================

j_AddItemToDeals:
										
										jmp     AddItemToDeals(pc)

	; End of function j_AddItemToDeals


; =============== S U B R O U T I N E =======================================

j_RemoveItemFromDeals:
										
										jmp     RemoveItemFromDeals(pc)

	; End of function j_RemoveItemFromDeals


; =============== S U B R O U T I N E =======================================

j_AddItemToCaravan:
										
										jmp     AddItemToCaravan(pc)

	; End of function j_AddItemToCaravan


; =============== S U B R O U T I N E =======================================

j_RemoveItemFromCaravan:
										
										jmp     RemoveItemFromCaravan(pc)

	; End of function j_RemoveItemFromCaravan


; =============== S U B R O U T I N E =======================================

j_AddAllToStack:
										
										jmp     AddAllToStack(pc)

	; End of function j_AddAllToStack


; =============== S U B R O U T I N E =======================================

j_sub_DEFC:
										
										jmp     j_sub_DEFC_0(pc)

	; End of function j_sub_DEFC


; =============== S U B R O U T I N E =======================================

j_MakeRangeLists:
										
										jmp     MakeRangeLists(pc)

	; End of function j_MakeRangeLists


; =============== S U B R O U T I N E =======================================

j_GenerateTargetRangeLists:
										
										jmp     GenerateTargetRangeLists(pc)

	; End of function j_GenerateTargetRangeLists


; =============== S U B R O U T I N E =======================================

MakeBattleEntityCancelMoveString:
										
										jmp     MakeBattleEntityCancelMoveString_0(pc)

	; End of function MakeBattleEntityCancelMoveString


; =============== S U B R O U T I N E =======================================

j_GetTerrain:
										
										jmp     GetTerrain(pc)  

	; End of function j_GetTerrain


; =============== S U B R O U T I N E =======================================

j_SetTerrain:
										
										jmp     SetTerrain(pc)

	; End of function j_SetTerrain


; =============== S U B R O U T I N E =======================================

j_ClearEnemyMoveInfo:
										
										jmp     ClearEnemyMoveInfo(pc)

	; End of function j_ClearEnemyMoveInfo


; =============== S U B R O U T I N E =======================================

; entity D0's current MOV*2, X, Y -> D0, D3, D4

j_GetMoveInfo:
										
										jmp     GetMoveInfo(pc) 

	; End of function j_GetMoveInfo


; =============== S U B R O U T I N E =======================================

j_GetDifficulty:
										
										jmp     GetDifficulty(pc)

	; End of function j_GetDifficulty

p_SpellNames:       dc.l SpellNames
p_AllyNames:        dc.l AllyNames
p_EnemyNames:       dc.l EnemyNames

; =============== S U B R O U T I N E =======================================

; In: D0 = char idx
; Out: A0 = address of name
;      D7 = length of name

GetCharName:
										
										movem.l d0-d1,-(sp)
										btst    #CHAR_BIT_ENEMY,d0
										bne.s   loc_82F0
										bsr.w   GetCharEntryAddress
										moveq   #CHAR_NAME_COUNTER,d0
										clr.w   d7
loc_82E2:
										tst.b   (a0,d7.w)
										beq.s   loc_82EE
										addq.w  #1,d7
										dbf     d0,loc_82E2
loc_82EE:
										bra.s   loc_8300
loc_82F0:
										clr.w   d1
										bsr.w   GetEnemyID
										movea.l (p_EnemyNames).l,a0
										bsr.w   FindName        
loc_8300:
										movem.l (sp)+,d0-d1
										rts

	; End of function GetCharName


; =============== S U B R O U T I N E =======================================

GetClass:
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_CLASS_IDX,d7
										bsr.w   GetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function GetClass


; =============== S U B R O U T I N E =======================================

GetCurrentLevel:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_LEVEL,d7
										bsr.w   GetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function GetCurrentLevel


; =============== S U B R O U T I N E =======================================

GetMaxHP:
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_HP_MAX,d7
										bsr.w   GetCharacterWord
										movem.l (sp)+,d7-a0
										rts

	; End of function GetMaxHP


; =============== S U B R O U T I N E =======================================

GetCurrentHP:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_HP_CURRENT,d7
										bsr.w   GetCharacterWord
										movem.l (sp)+,d7-a0
										rts

	; End of function GetCurrentHP


; =============== S U B R O U T I N E =======================================

GetMaxMP:
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_MP_MAX,d7
										bsr.w   GetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function GetMaxMP


; =============== S U B R O U T I N E =======================================

GetCurrentMP:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_MP_CURRENT,d7
										bsr.w   GetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function GetCurrentMP


; =============== S U B R O U T I N E =======================================

GetBaseATK:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_ATK_MAX,d7
										bsr.w   GetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function GetBaseATK


; =============== S U B R O U T I N E =======================================

GetCurrentATK:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_ATK_CURRENT,d7
										bsr.w   GetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function GetCurrentATK


; =============== S U B R O U T I N E =======================================

GetBaseDEF:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_DEF_MAX,d7
										bsr.w   GetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function GetBaseDEF


; =============== S U B R O U T I N E =======================================

GetCurrentDEF:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_DEF_CURRENT,d7
										bsr.w   GetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function GetCurrentDEF


; =============== S U B R O U T I N E =======================================

GetBaseAGI:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_AGI_MAX,d7
										bsr.w   GetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function GetBaseAGI


; =============== S U B R O U T I N E =======================================

GetCurrentAGI:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_AGI_CURRENT,d7
										bsr.w   GetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function GetCurrentAGI


; =============== S U B R O U T I N E =======================================

GetBaseMOV:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_MOV_MAX,d7
										bsr.w   GetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function GetBaseMOV


; =============== S U B R O U T I N E =======================================

GetCurrentMOV:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_MOV_CURRENT,d7
										bsr.w   GetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function GetCurrentMOV


; =============== S U B R O U T I N E =======================================

GetBaseResistance:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_RESIST_BASE,d7
loc_83EC:
										bsr.w   GetCharacterWord
loc_83F0:
										movem.l (sp)+,d7-a0
										rts

	; End of function GetBaseResistance


; =============== S U B R O U T I N E =======================================

GetCurrentResistance:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_RESIST_CURRENT,d7
										bsr.w   GetCharacterWord
										movem.l (sp)+,d7-a0
										rts

	; End of function GetCurrentResistance


; =============== S U B R O U T I N E =======================================

GetBaseProwess:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_SPECIAL_BASE,d7
										bsr.w   GetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function GetBaseProwess


; =============== S U B R O U T I N E =======================================

GetCurrentProwess:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_PROWESS_CURRENT,d7
										bsr.w   GetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function GetCurrentProwess


; =============== S U B R O U T I N E =======================================

GetStatus:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_STATUS,d7
										bsr.w   GetCharacterWord
										movem.l (sp)+,d7-a0
										rts

	; End of function GetStatus


; =============== S U B R O U T I N E =======================================

GetXPos:
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_X,d7
loc_843C:
										bsr.w   GetCharacterByte
										ext.w   d1
										movem.l (sp)+,d7-a0
										rts

	; End of function GetXPos


; =============== S U B R O U T I N E =======================================

GetYPos:
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_Y,d7
										bsr.w   GetCharacterByte
										ext.w   d1
										movem.l (sp)+,d7-a0
										rts

	; End of function GetYPos


; =============== S U B R O U T I N E =======================================

GetCurrentEXP:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_EXP,d7
										bsr.w   GetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function GetCurrentEXP


; =============== S U B R O U T I N E =======================================

GetUpperMoveType:
										
										movem.l d7-a0,-(sp)
										moveq   #$31,d7 
										bsr.w   GetCharacterByte
										lsr.w   #4,d1
										andi.w  #$F,d1
										movem.l (sp)+,d7-a0
										rts

	; End of function GetUpperMoveType


; =============== S U B R O U T I N E =======================================

GetLowerMoveType:
										
										movem.l d7-a0,-(sp)
										moveq   #$31,d7 
										bsr.w   GetCharacterByte
										andi.w  #$F,d1
										movem.l (sp)+,d7-a0
										rts

	; End of function GetLowerMoveType


; =============== S U B R O U T I N E =======================================

GetEnemyAISetting3233:
										
										movem.l d7-a0,-(sp)
										moveq   #$32,d7 
										bsr.w   GetCharacterWord
										move.w  d1,d2
										lsr.w   #8,d1
										andi.w  #$FF,d1
										andi.w  #$FF,d2
										movem.l (sp)+,d7-a0
										rts

	; End of function GetEnemyAISetting3233


; =============== S U B R O U T I N E =======================================

; In: D0 = char idx
; Out: D1 = high 4 bits
;      D2 = low 4 bits

GetEnemyAISetting36:
										
										movem.l d7-a0,-(sp)
										moveq   #$36,d7 
										bsr.w   GetCharacterByte
										move.w  d1,d2
										lsr.w   #4,d1
										andi.w  #$F,d1
										andi.w  #$F,d2
										movem.l (sp)+,d7-a0
										rts

	; End of function GetEnemyAISetting36


; =============== S U B R O U T I N E =======================================

GetCharacterWord34:
										
										movem.l d7-a0,-(sp)
										moveq   #$34,d7 
										bsr.w   GetCharacterWord
										movem.l (sp)+,d7-a0
										rts

	; End of function GetCharacterWord34


; =============== S U B R O U T I N E =======================================

GetEnemyID:
										
										btst    #CHAR_BIT_ENEMY,d0
										bne.s   loc_84EA
										move.w  #CODE_NOTHING_WORD,d1
										rts
										bra.s   GetKills
loc_84EA:
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_ENEMYIDX,d7
										bsr.w   GetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function GetEnemyID


; =============== S U B R O U T I N E =======================================

GetKills:
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_KILLS,d7
										bsr.w   GetCharacterWord
										movem.l (sp)+,d7-a0
										rts

	; End of function GetKills


; =============== S U B R O U T I N E =======================================

GetDefeats:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_DEFEATS,d7
										bsr.w   GetCharacterWord
										movem.l (sp)+,d7-a0
										rts

	; End of function GetDefeats


; =============== S U B R O U T I N E =======================================

GetSomethingClassType:
										
										btst    #CHAR_BIT_ENEMY,d0
										bne.s   loc_8536
										moveq   #0,d1
										bsr.w   GetClass
										move.b  ClassTypes(pc,d1.w),d1
										mulu.w  #$1E,d1
										add.w   d0,d1
										bset    #$F,d1
										bra.s   return_8538
loc_8536:
										bsr.s   GetEnemyID
return_8538:
										
										rts

	; End of function GetSomethingClassType

ClassTypes:         incbin "data/allies/classes/classtypes.bin"
																						; 0,1,2 = base class, promoted class, special promoted class

; =============== S U B R O U T I N E =======================================

CopyCharNameToRAM:
										
										tst.b   (a0)
										beq.s   return_8574
										movem.l d0/a0-a1,-(sp)
										lea     (a0),a1
										bsr.w   GetCharEntryAddress
										moveq   #CHAR_NAME_COUNTER,d0
loc_856A:
										move.b  (a1)+,(a0)+
										dbf     d0,loc_856A
										movem.l (sp)+,d0/a0-a1
return_8574:
										
										rts

	; End of function CopyCharNameToRAM


; =============== S U B R O U T I N E =======================================

SetClass:
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_CLASS_IDX,d7
										bsr.w   SetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function SetClass


; =============== S U B R O U T I N E =======================================

SetLevel:
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_LEVEL,d7
										bsr.w   SetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function SetLevel


; =============== S U B R O U T I N E =======================================

SetMaxHP:
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_HP_MAX,d7
										bsr.w   SetCharacterWord
										movem.l (sp)+,d7-a0
										rts

	; End of function SetMaxHP


; =============== S U B R O U T I N E =======================================

SetCurrentHP:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_HP_CURRENT,d7
										bsr.w   SetCharacterWord
										movem.l (sp)+,d7-a0
										rts

	; End of function SetCurrentHP


; =============== S U B R O U T I N E =======================================

SetMaxMP:
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_MP_MAX,d7
										bsr.w   SetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function SetMaxMP


; =============== S U B R O U T I N E =======================================

SetCurrentMP:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_MP_CURRENT,d7
										bsr.w   SetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function SetCurrentMP


; =============== S U B R O U T I N E =======================================

SetBaseATK:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_ATK_MAX,d7
loc_85DC:
										bsr.w   SetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function SetBaseATK


; =============== S U B R O U T I N E =======================================

SetCurrentATK:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_ATK_CURRENT,d7
										bsr.w   SetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function SetCurrentATK


; =============== S U B R O U T I N E =======================================

SetBaseDEF:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_DEF_MAX,d7
										bsr.w   SetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function SetBaseDEF


; =============== S U B R O U T I N E =======================================

SetCurrentDEF:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_DEF_CURRENT,d7
										bsr.w   SetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function SetCurrentDEF


; =============== S U B R O U T I N E =======================================

SetBaseAGI:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_AGI_MAX,d7
										bsr.w   SetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function SetBaseAGI


; =============== S U B R O U T I N E =======================================

SetCurrentAGI:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_AGI_CURRENT,d7
										bsr.w   SetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function SetCurrentAGI


; =============== S U B R O U T I N E =======================================

SetBaseMOV:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_MOV_MAX,d7
										bsr.w   SetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function SetBaseMOV


; =============== S U B R O U T I N E =======================================

SetCurrentMOV:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_MOV_CURRENT,d7
										bsr.w   SetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function SetCurrentMOV


; =============== S U B R O U T I N E =======================================

SetBaseResistance:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_RESIST_BASE,d7
										bsr.w   SetCharacterWord
										movem.l (sp)+,d7-a0
										rts

	; End of function SetBaseResistance


; =============== S U B R O U T I N E =======================================

SetCurrentResistance:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_RESIST_CURRENT,d7
										bsr.w   SetCharacterWord
										movem.l (sp)+,d7-a0
										rts

	; End of function SetCurrentResistance


; =============== S U B R O U T I N E =======================================

SetBaseSomething:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_SPECIAL_BASE,d7
										bsr.w   SetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function SetBaseSomething


; =============== S U B R O U T I N E =======================================

SetCurrentSomething:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_PROWESS_CURRENT,d7
										bsr.w   SetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function SetCurrentSomething


; =============== S U B R O U T I N E =======================================

SetStatus:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_STATUS,d7
										bsr.w   SetCharacterWord
										movem.l (sp)+,d7-a0
										rts

	; End of function SetStatus


; =============== S U B R O U T I N E =======================================

SetXPos:
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_X,d7
										bsr.w   SetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function SetXPos


; =============== S U B R O U T I N E =======================================

SetYPos:
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_Y,d7
										bsr.w   SetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function SetYPos


; =============== S U B R O U T I N E =======================================

SetCurrentEXP:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_EXP,d7
										bsr.w   SetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function SetCurrentEXP


; =============== S U B R O U T I N E =======================================

SetMoveType:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_MOVETYPE,d7
										bsr.w   SetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function SetMoveType


; =============== S U B R O U T I N E =======================================

; actually seems to only be used for monster AI, not kills

SetKills:
										movem.l d1-d2/d7-a0,-(sp)
										lsl.w   #8,d1
										andi.w  #$FF,d2
										or.w    d2,d1
										moveq   #CHAR_OFFSET_KILLS,d7
										bsr.w   SetCharacterWord
										movem.l (sp)+,d1-d2/d7-a0
										rts

	; End of function SetKills


; =============== S U B R O U T I N E =======================================

; actually seems to only be used for monster AI, not kills

SetDefeats:
										
										movem.l d1-d2/d7-a0,-(sp)
										lsl.b   #4,d1
										andi.b  #$F,d2
										or.b    d2,d1
										moveq   #$36,d7 
										bsr.w   SetCharacterByte
										movem.l (sp)+,d1-d2/d7-a0
										rts

	; End of function SetDefeats


; =============== S U B R O U T I N E =======================================

SetCharacterWord34:
										
										movem.l d7-a0,-(sp)
										moveq   #$34,d7 
										bsr.w   SetCharacterWord
										movem.l (sp)+,d7-a0
										rts

	; End of function SetCharacterWord34


; =============== S U B R O U T I N E =======================================

SetEnemyID:
										
										movem.l d7-a0,-(sp)
										moveq   #CHAR_OFFSET_ENEMYIDX,d7
										bsr.w   SetCharacterByte
										movem.l (sp)+,d7-a0
										rts

	; End of function SetEnemyID


; =============== S U B R O U T I N E =======================================

IncreaseLevel:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										move.w  #CHAR_STATCAP_LEVEL,d6
										moveq   #CHAR_OFFSET_LEVEL,d7
										bsr.w   IncreaseAndClampByte
										movem.l (sp)+,d5-a0
										rts

	; End of function IncreaseLevel


; =============== S U B R O U T I N E =======================================

IncreaseMaxHP:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										move.w  #CHAR_STATCAP_HP,d6
										moveq   #CHAR_OFFSET_HP_MAX,d7
										bsr.w   ClampWordIncreasing
										movem.l (sp)+,d5-a0
										rts

	; End of function IncreaseMaxHP


; =============== S U B R O U T I N E =======================================

IncreaseCurrentHP:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										bsr.w   GetCharEntryAddress
										move.w  CHAR_OFFSET_HP_MAX(a0),d6
										moveq   #CHAR_OFFSET_HP_CURRENT,d7
										bsr.w   ClampWordIncreasing
										movem.l (sp)+,d5-a0
										rts

	; End of function IncreaseCurrentHP


; =============== S U B R O U T I N E =======================================

IncreaseMaxMP:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										move.w  #CHAR_STATCAP_MP,d6
										moveq   #CHAR_OFFSET_MP_MAX,d7
										bsr.w   IncreaseAndClampByte
										movem.l (sp)+,d5-a0
										rts

	; End of function IncreaseMaxMP


; =============== S U B R O U T I N E =======================================

IncreaseCurrentMP:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										bsr.w   GetCharEntryAddress
										move.b  CHAR_OFFSET_MP_MAX(a0),d6
										moveq   #CHAR_OFFSET_MP_CURRENT,d7
										bsr.w   IncreaseAndClampByte
										movem.l (sp)+,d5-a0
										rts

	; End of function IncreaseCurrentMP


; =============== S U B R O U T I N E =======================================

IncreaseBaseATK:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										move.w  #CHAR_STATCAP_ATK,d6
										moveq   #CHAR_OFFSET_ATK_MAX,d7
										bsr.w   IncreaseAndClampByte
										movem.l (sp)+,d5-a0
										rts

	; End of function IncreaseBaseATK


; =============== S U B R O U T I N E =======================================

IncreaseCurrentATK:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										move.w  #CHAR_STATCAP_ATK,d6
										moveq   #CHAR_OFFSET_ATK_CURRENT,d7
										bsr.w   IncreaseAndClampByte
										movem.l (sp)+,d5-a0
										rts

	; End of function IncreaseCurrentATK


; =============== S U B R O U T I N E =======================================

IncreaseBaseDEF:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										move.w  #CHAR_STATCAP_DEF,d6
										moveq   #CHAR_OFFSET_DEF_MAX,d7
										bsr.w   IncreaseAndClampByte
										movem.l (sp)+,d5-a0
										rts

	; End of function IncreaseBaseDEF


; =============== S U B R O U T I N E =======================================

IncreaseCurrentDEF:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										move.w  #CHAR_STATCAP_DEF,d6
										moveq   #CHAR_OFFSET_DEF_CURRENT,d7
										bsr.w   IncreaseAndClampByte
										movem.l (sp)+,d5-a0
										rts

	; End of function IncreaseCurrentDEF


; =============== S U B R O U T I N E =======================================

IncreaseBaseAGI:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										moveq   #CHAR_STATCAP_AGI_BASE,d6
										moveq   #CHAR_OFFSET_AGI_MAX,d7
										bsr.w   Clamp7BitIncreasing
										movem.l (sp)+,d5-a0
										rts

	; End of function IncreaseBaseAGI


; =============== S U B R O U T I N E =======================================

IncreaseCurrentAGI:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										moveq   #CHAR_STATCAP_AGI_CURRENT,d6
										moveq   #CHAR_OFFSET_AGI_CURRENT,d7
										bsr.w   Clamp7BitIncreasing
										movem.l (sp)+,d5-a0
										rts

	; End of function IncreaseCurrentAGI


; =============== S U B R O U T I N E =======================================

IncreaseBaseMOV:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										move.w  #CHAR_STATCAP_MOV,d6
										moveq   #CHAR_OFFSET_MOV_MAX,d7
										bsr.w   IncreaseAndClampByte
										movem.l (sp)+,d5-a0
										rts

	; End of function IncreaseBaseMOV


; =============== S U B R O U T I N E =======================================

IncreaseCurrentMOV:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										move.w  #CHAR_STATCAP_MOV,d6
										moveq   #CHAR_OFFSET_MOV_CURRENT,d7
										bsr.w   IncreaseAndClampByte
										movem.l (sp)+,d5-a0
										rts

	; End of function IncreaseCurrentMOV


; =============== S U B R O U T I N E =======================================

IncreaseEXP:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										move.w  #CHAR_STATCAP_EXP,d6
										moveq   #CHAR_OFFSET_EXP,d7
										bsr.w   IncreaseAndClampByte
										movem.l (sp)+,d5-a0
										rts

	; End of function IncreaseEXP


; =============== S U B R O U T I N E =======================================

IncreaseKills:
										
										tst.b   d0
										blt.s   return_8886
										movem.l d5-a0,-(sp)
										clr.w   d5
										move.w  #$270F,d6
										moveq   #$32,d7 
										bsr.w   ClampWordIncreasing
										movem.l (sp)+,d5-a0
return_8886:
										
										rts

	; End of function IncreaseKills


; =============== S U B R O U T I N E =======================================

IncreaseDefeats:
										
										tst.b   d0
										blt.s   return_88A0
										movem.l d5-a0,-(sp)
										clr.w   d5
										move.w  #$270F,d6
										moveq   #$36,d7 
										bsr.w   ClampWordIncreasing
										movem.l (sp)+,d5-a0
return_88A0:
										
										rts

	; End of function IncreaseDefeats


; =============== S U B R O U T I N E =======================================

DecreaseCurrentHP:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										bsr.w   GetCharEntryAddress
										move.w  CHAR_OFFSET_HP_MAX(a0),d6
										moveq   #CHAR_OFFSET_HP_CURRENT,d7
										bsr.w   ClampWordDecreasing
										movem.l (sp)+,d5-a0
										rts

	; End of function DecreaseCurrentHP


; =============== S U B R O U T I N E =======================================

DecreaseCurrentMP:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										bsr.w   GetCharEntryAddress
										move.b  CHAR_OFFSET_MP_MAX(a0),d6
										moveq   #CHAR_OFFSET_MP_CURRENT,d7
										bsr.w   DecreaseAndClampByte
										movem.l (sp)+,d5-a0
										rts

	; End of function DecreaseCurrentMP


; =============== S U B R O U T I N E =======================================

DecreaseCurrentATK:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										move.w  #CHAR_STATCAP_ATK,d6
										moveq   #CHAR_OFFSET_ATK_CURRENT,d7
										bsr.w   DecreaseAndClampByte
										movem.l (sp)+,d5-a0
										rts

	; End of function DecreaseCurrentATK


; =============== S U B R O U T I N E =======================================

DecreaseBaseDEF:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										move.w  #CHAR_STATCAP_DEF,d6
										moveq   #CHAR_OFFSET_DEF_MAX,d7
										bsr.w   DecreaseAndClampByte
										movem.l (sp)+,d5-a0
										rts

	; End of function DecreaseBaseDEF


; =============== S U B R O U T I N E =======================================

DecreaseCurrentDEF:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										move.w  #CHAR_STATCAP_DEF,d6
										moveq   #CHAR_OFFSET_DEF_CURRENT,d7
										bsr.w   DecreaseAndClampByte
										movem.l (sp)+,d5-a0
										rts

	; End of function DecreaseCurrentDEF


; =============== S U B R O U T I N E =======================================

DecreaseBaseAGI:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										move.w  #$C8,d6
										moveq   #CHAR_OFFSET_AGI_MAX,d7
										bsr.w   DecreaseAndClampByte
										movem.l (sp)+,d5-a0
										rts

	; End of function DecreaseBaseAGI


; =============== S U B R O U T I N E =======================================

DecreaseCurrentAGI:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										move.w  #$C8,d6
										moveq   #CHAR_OFFSET_AGI_CURRENT,d7
										bsr.w   DecreaseAndClampByte
										movem.l (sp)+,d5-a0
										rts

	; End of function DecreaseCurrentAGI


; =============== S U B R O U T I N E =======================================

DecreaseBaseMOV:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										move.w  #CHAR_STATCAP_MOV,d6
										moveq   #CHAR_OFFSET_MOV_MAX,d7
										bsr.w   DecreaseAndClampByte
										movem.l (sp)+,d5-a0
										rts

	; End of function DecreaseBaseMOV


; =============== S U B R O U T I N E =======================================

DecreaseCurrentMOV:
										
										movem.l d5-a0,-(sp)
										clr.w   d5
										move.w  #CHAR_STATCAP_MOV,d6
										moveq   #CHAR_OFFSET_MOV_CURRENT,d7
										bsr.w   DecreaseAndClampByte
										movem.l (sp)+,d5-a0
										rts

	; End of function DecreaseCurrentMOV


; =============== S U B R O U T I N E =======================================

GetClassName:
										
										movea.l (p_ClassNames).l,a0

	; End of function GetClassName


; =============== S U B R O U T I N E =======================================

; In: A0 = address of names list
;     D1 = name idx
; Out: A0 = address of entry in names list
;      D7 = length of name

FindName:
										move.w  d0,-(sp)
										subq.w  #1,d1
										bmi.s   loc_8986
										clr.w   d0
loc_897E:
										move.b  (a0)+,d0
										adda.w  d0,a0
										dbf     d1,loc_897E
loc_8986:
										clr.w   d7
										move.b  (a0)+,d7
										move.w  (sp)+,d0
										rts

	; End of function FindName


; =============== S U B R O U T I N E =======================================

SetGold:
										move.l  d1,((CURRENT_GOLD-$1000000)).w
																						; puts d1's value at F600 in RAM
										rts

	; End of function SetGold


; =============== S U B R O U T I N E =======================================

GetGold:
										move.l  ((CURRENT_GOLD-$1000000)).w,d1
										rts

	; End of function GetGold


; =============== S U B R O U T I N E =======================================

IncreaseGold:
										
										add.l   ((CURRENT_GOLD-$1000000)).w,d1
										bcs.s   loc_89A8
										cmpi.l  #FORCE_MAX_GOLD,d1
										bls.s   loc_89AE
loc_89A8:
										move.l  #FORCE_MAX_GOLD,d1
loc_89AE:
										move.l  d1,((CURRENT_GOLD-$1000000)).w
										rts

	; End of function IncreaseGold


; =============== S U B R O U T I N E =======================================

DecreaseGold:
										
										movem.l d0,-(sp)
										move.l  ((CURRENT_GOLD-$1000000)).w,d0
										sub.l   d1,d0
										bcc.s   loc_89C2
										moveq   #0,d0
loc_89C2:
										move.l  d0,((CURRENT_GOLD-$1000000)).w
										move.l  d0,d1
										movem.l (sp)+,d0
										rts

	; End of function DecreaseGold


; =============== S U B R O U T I N E =======================================

ApplyStatusAndItemsOnStats:
										
										movem.l d0-d3/a0-a2,-(sp)
										move.w  d0,-(sp)
										bsr.w   GetStatus
										move.w  d1,d3
										andi.w  #$FFFB,d3
										bsr.w   InitCurrentStats
										bsr.w   GetCharEntryAddress
										lea     CHAR_OFFSET_ITEM_0(a0),a1
										lea     CHAR_OFFSET_PROWESS_CURRENT(a0),a2
										bsr.w   ApplyMagicOnStats
										moveq   #CHAR_ITEMSLOTS_COUNTER,d2
loc_89F4:
										move.w  (a1),d1
										andi.w  #ITEM_MASK_IDX,d1
										cmpi.w  #ITEMIDX_NOTHING,d1
										beq.s   loc_8A12
										btst    #ITEM_BIT_EQUIPPED,ITEM_OFFSET_IDXANDEQUIPBYTE(a1)
										beq.s   loc_8A12
										bsr.w   ApplyItemOnStats
										beq.s   loc_8A12
										ori.w   #4,d3
loc_8A12:
										addq.w  #2,a1
										dbf     d2,loc_89F4
										move.w  (sp)+,d0
										move.w  d3,d1
										bsr.w   SetStatus
										movem.l (sp)+,d0-d3/a0-a2
										rts

	; End of function ApplyStatusAndItemsOnStats


; =============== S U B R O U T I N E =======================================

; In: D0 = char index
;     D3 = status bitfield

ApplyMagicOnStats:
										
										clr.l   d1
										move.w  d3,d2
										andi.w  #$C000,d2
										rol.w   #2,d2
										bsr.w   GetBaseATK
										mulu.w  d2,d1
										lsr.l   #3,d1
										bsr.w   IncreaseCurrentATK
										move.w  d3,d2
										andi.w  #$3000,d2
										rol.w   #4,d2
										bsr.w   GetBaseDEF
										mulu.w  d2,d1
										lsr.l   #3,d1
										bsr.w   IncreaseCurrentDEF
										bsr.w   GetBaseAGI
										mulu.w  d2,d1
										lsr.l   #3,d1
										bsr.w   IncreaseCurrentAGI
										move.w  d3,d2
										andi.w  #$C00,d2
										rol.w   #6,d2
										bsr.w   GetBaseDEF
										mulu.w  d2,d1
										lsr.l   #3,d1
										bsr.w   DecreaseCurrentDEF
										bsr.w   GetBaseAGI
										mulu.w  d2,d1
										lsr.l   #3,d1
										bsr.w   DecreaseCurrentAGI
										btst    #0,d3
										beq.s   return_8A8E
										moveq   #1,d1
										bsr.w   DecreaseCurrentMOV
										moveq   #5,d1
										bsr.w   DecreaseCurrentAGI
return_8A8E:
										
										rts

	; End of function ApplyMagicOnStats


; =============== S U B R O U T I N E =======================================

; In: A2 = address in RAM of char's prowess
;     D0 = char idx
;     D1 = item idx

ApplyItemOnStats:
										
										bsr.w   GetItemDefAddress
										btst    #CHAR_BIT_ENEMY,d0
										bne.s   loc_8AA2
										btst    #ITEMTYPE_BIT_CURSED,ITEMDEF_OFFSET_TYPE(a0)
										bra.s   loc_8AA4
loc_8AA2:
										clr.w   d2
loc_8AA4:
										move    sr,-(sp)
										movem.l d1-d2/d7-a1,-(sp)
										lea     ITEMDEF_OFFSET_STATINFO1(a0),a0
										clr.w   d2
										moveq   #1,d7
loc_8AB2:
										move.b  1(a0),d1
										move.b  (a0),d2
										cmpi.b  #$FF,d2
										beq.w   loc_8AD2
										cmpi.b  #$11,d2
										bcs.s   loc_8AC8
loc_8AC6:
										bra.s   loc_8AC6
loc_8AC8:
										lsl.w   #2,d2
										lea     pt_EquipEffectFunctions(pc,d2.w),a1
										movea.l (a1),a1
										jsr     (a1)
loc_8AD2:
										addq.w  #2,a0
										dbf     d7,loc_8AB2
										movem.l (sp)+,d1-d2/d7-a1
										rtr

	; End of function ApplyItemOnStats

pt_EquipEffectFunctions:
										dc.l nullsub_7
										dc.l nullsub_7
										dc.l EquipEffect_IncreaseCriticalProwess
										dc.l EquipEffect_IncreaseDoubleAttackProwess
										dc.l EquipEffect_IncreaseCounterAttackProwess
										dc.l nullsub_7
										dc.l IncreaseCurrentATK
										dc.l IncreaseCurrentDEF
										dc.l IncreaseCurrentAGI
										dc.l IncreaseCurrentMOV
										dc.l DecreaseCurrentATK
										dc.l DecreaseCurrentDEF
										dc.l DecreaseCurrentAGI
										dc.l DecreaseCurrentMOV
										dc.l EquipEffect_SetCriticalProwess
										dc.l EquipEffect_SetDoubleAttackProwess
										dc.l EquipEffect_SetCounterAttackProwess

; =============== S U B R O U T I N E =======================================

nullsub_7:
										
										rts

	; End of function nullsub_7


; =============== S U B R O U T I N E =======================================

EquipEffect_IncreaseCriticalProwess:
										
										move.b  (a2),d2
										andi.b  #CHAR_PROWESS_MASK_CRIT,d2
										cmpi.b  #8,d2
										bcc.s   loc_8B3A
										add.b   d1,d2
										cmpi.b  #8,d2
										bcs.s   loc_8B3A
										moveq   #7,d2
loc_8B3A:
										andi.b  #$F0,(a2)
										or.b    d2,(a2)
										rts

	; End of function EquipEffect_IncreaseCriticalProwess


; =============== S U B R O U T I N E =======================================

EquipEffect_IncreaseDoubleAttackProwess:
										
										move.b  (a2),d2
										lsr.b   #4,d2
										andi.b  #3,d2
										add.b   d1,d2
										cmpi.b  #4,d2
										bcs.s   loc_8B54
										moveq   #3,d2
loc_8B54:
										lsl.b   #4,d2
										andi.b  #$F,(a2)
										or.b    d2,(a2)
										rts

	; End of function EquipEffect_IncreaseDoubleAttackProwess


; =============== S U B R O U T I N E =======================================

EquipEffect_IncreaseCounterAttackProwess:
										
										move.b  (a2),d2
										lsr.b   #6,d2
										andi.b  #3,d2
										add.b   d1,d2
										cmpi.b  #4,d2
										bcs.s   loc_8B70
										moveq   #3,d2
loc_8B70:
										lsl.b   #6,d2
										andi.b  #$3F,(a2) 
										or.b    d2,(a2)
										rts

	; End of function EquipEffect_IncreaseCounterAttackProwess


; =============== S U B R O U T I N E =======================================

EquipEffect_SetCriticalProwess:
										
										andi.b  #$F,d1
										andi.b  #$F0,(a2)
										or.b    d1,(a2)
										rts

	; End of function EquipEffect_SetCriticalProwess


; =============== S U B R O U T I N E =======================================

EquipEffect_SetDoubleAttackProwess:
										
										andi.b  #3,d1
										lsl.b   #4,d1
										andi.b  #$CF,(a2)
										or.b    d1,(a2)
										rts

	; End of function EquipEffect_SetDoubleAttackProwess


; =============== S U B R O U T I N E =======================================

EquipEffect_SetCounterAttackProwess:
										
										andi.b  #3,d1
										lsl.b   #6,d1
										andi.b  #$3F,(a2) 
										or.b    d1,(a2)
										rts

	; End of function EquipEffect_SetCounterAttackProwess


; =============== S U B R O U T I N E =======================================

InitCurrentStats:
										
										move.l  a0,-(sp)
										bsr.w   GetCharEntryAddress
										move.b  CHAR_OFFSET_ATK_MAX(a0),CHAR_OFFSET_ATK_CURRENT(a0)
										move.b  CHAR_OFFSET_DEF_MAX(a0),CHAR_OFFSET_DEF_CURRENT(a0)
										move.b  CHAR_OFFSET_AGI_MAX(a0),CHAR_OFFSET_AGI_CURRENT(a0)
										move.b  CHAR_OFFSET_MOV_MAX(a0),CHAR_OFFSET_MOV_CURRENT(a0)
										move.w  CHAR_OFFSET_RESIST_BASE(a0),CHAR_OFFSET_RESIST_CURRENT(a0)
										move.b  CHAR_OFFSET_SPECIAL_BASE(a0),CHAR_OFFSET_PROWESS_CURRENT(a0)
										movea.l (sp)+,a0
										rts

	; End of function InitCurrentStats


; =============== S U B R O U T I N E =======================================

; In: D1 = item entry
; Out: A0 = address of name
;      D7 = length of name

FindItemName:
										
										move.w  d1,-(sp)
										andi.w  #ITEM_MASK_IDX,d1
										movea.l (p_ItemNames).l,a0
										bsr.w   FindName        
										move.w  (sp)+,d1
										rts

	; End of function FindItemName


; =============== S U B R O U T I N E =======================================

; In: D1 = item idx
; Out: A0 = item definition address in ROM

GetItemDefAddress:
										
										move.l  d1,-(sp)
										andi.w  #ITEM_MASK_IDX,d1
										mulu.w  #SIZE_ITEMDEF,d1
										movea.l (p_ItemDefs).l,a0
										adda.w  d1,a0
										move.l  (sp)+,d1
										rts

	; End of function GetItemDefAddress


; =============== S U B R O U T I N E =======================================

; In: D0 = char entry idx
;     D1 = item slot idx
; Out: D1 = item idx
;      D2 = number of items held

GetCharItemAtSlotAndNumberOfItems:
										
										movem.l d0/d3/a0,-(sp)
										bsr.w   GetCharEntryAddress
										lea     CHAR_OFFSET_ITEM_0(a0),a0
										add.w   d1,d1
										move.w  (a0,d1.w),d1    ; move item d1 word in d1
										moveq   #0,d2
										moveq   #CHAR_ITEMSLOTS_COUNTER,d3
loc_8C10:
										move.w  (a0)+,d0
										andi.w  #ITEM_MASK_IDX,d0
										cmpi.w  #ITEMIDX_NOTHING,d0
										beq.s   loc_8C1E
										addq.w  #1,d2
loc_8C1E:
										dbf     d3,loc_8C10
										movem.l (sp)+,d0/d3/a0
										rts

	; End of function GetCharItemAtSlotAndNumberOfItems


; =============== S U B R O U T I N E =======================================

; In: D1 = item idx
; Out: D2 = item type (0 = item, 1 = weapon, FFFF = ring)

GetItemType:
										
										move.l  a0,-(sp)
										bsr.s   GetItemDefAddress
										addq.w  #ITEMDEF_OFFSET_TYPE,a0
										btst    #ITEMTYPE_BIT_WEAPON,(a0)
										bne.s   loc_8C44        
										btst    #ITEMTYPE_BIT_RING,(a0)
										bne.s   loc_8C3E        
										clr.w   d2              ; other
										bra.s   loc_8C42
loc_8C3E:
										move.w  #$FFFF,d2       ; ring
loc_8C42:
										bra.s   loc_8C48
loc_8C44:
										move.w  #ITEMTYPE_IDX_WEAPON,d2
																						; weapon
loc_8C48:
										movea.l (sp)+,a0
										rts

	; End of function GetItemType


; =============== S U B R O U T I N E =======================================

GetEquippedWeapon:
										
										movem.l d3-d4/a0-a1,-(sp)
										move.w  #ITEMTYPE_MASK_WEAPON,d4
										bra.s   GetEquippedItemByType
GetEquippedRing:
										
										movem.l d3-d4/a0-a1,-(sp)
										move.w  #ITEMTYPE_MASK_RING,d4
GetEquippedItemByType:
										
										bsr.w   GetCharEntryAddress
										lea     CHAR_OFFSET_ITEM_0(a0),a1
										clr.w   d2
										moveq   #CHAR_ITEMSLOTS_COUNTER,d3
loc_8C6A:
										move.w  (a1)+,d1
										btst    #ITEM_BIT_EQUIPPED,d1
										beq.s   loc_8C88        
										andi.w  #ITEM_MASK_IDX,d1
										cmpi.w  #ITEMIDX_NOTHING,d1
										beq.s   loc_8C88        
										bsr.w   GetItemDefAddress
										move.b  ITEMDEF_OFFSET_TYPE(a0),d1
										and.b   d4,d1
										bne.s   loc_8C96
loc_8C88:
										addq.w  #1,d2           ; d2 seems unused here?
										dbf     d3,loc_8C6A
										move.w  #CODE_NOTHING_WORD,d1
										move.w  d1,d2
										bra.s   loc_8C9C
loc_8C96:
										move.w  -(a1),d1
										andi.w  #ITEM_MASK_IDX,d1
loc_8C9C:
										movem.l (sp)+,d3-d4/a0-a1
										rts

	; End of function GetEquippedWeapon


; =============== S U B R O U T I N E =======================================

; In: D0 = char idx
;     D1 = item entry

AddItem:
										movem.l d0/a0,-(sp)
										bsr.w   GetCharEntryAddress
										lea     CHAR_OFFSET_ITEM_0(a0),a0
										moveq   #CHAR_ITEMSLOTS_COUNTER,d0
loc_8CB0:
										move.w  (a0)+,d2
										andi.w  #ITEM_MASK_IDX,d2
										cmpi.w  #ITEMIDX_NOTHING,d2
										beq.s   loc_8CC6
										dbf     d0,loc_8CB0     ; loop over all items to make sure there's a slot open
										move.w  #1,d2           ; no empty slot available
										bra.s   loc_8CCE
loc_8CC6:
										andi.w  #ITEM_MASK_IDXANDBROKEN,d1
										move.w  d1,-(a0)        ; move item in empty slot
										clr.w   d2
loc_8CCE:
										movem.l (sp)+,d0/a0
										rts

	; End of function AddItem


; =============== S U B R O U T I N E =======================================

; In: D0 = char idx
;     D1 = item slot

BreakItem:
										
										movem.l d1/a0,-(sp)
										bsr.w   GetCharEntryAddress
										add.w   d1,d1
										lea     CHAR_OFFSET_ITEM_0(a0,d1.w),a0
										move.w  (a0),d1
										andi.w  #ITEM_MASK_IDX,d1
										cmpi.w  #ITEMIDX_NOTHING,d1
										beq.s   loc_8CF6
										bset    #ITEM_UPPERBIT_BROKEN,(a0)
										clr.w   d2
										bra.s   loc_8CFA
loc_8CF6:
										move.w  #3,d2
loc_8CFA:
										movem.l (sp)+,d1/a0
										rts

	; End of function BreakItem


; =============== S U B R O U T I N E =======================================

RepairItemBySlot:
										
										movem.l d1/a0,-(sp)
										bsr.w   GetCharEntryAddress
										add.w   d1,d1
										lea     CHAR_OFFSET_ITEM_0(a0,d1.w),a0
										move.w  (a0),d1
										andi.w  #ITEM_MASK_IDX,d1
										cmpi.w  #ITEMIDX_NOTHING,d1
										beq.s   loc_8D2A        
										bclr    #7,(a0)
										beq.s   loc_8D24
										clr.w   d2
										bra.s   loc_8D28
loc_8D24:
										move.w  #1,d1
loc_8D28:
										bra.s   loc_8D2E
loc_8D2A:
										move.w  #3,d2           ; code 3: nothing
loc_8D2E:
										movem.l (sp)+,d1/a0
										rts

	; End of function RepairItemBySlot


; =============== S U B R O U T I N E =======================================

; In: D0 = char entry idx
;     D1 = item slot idx
; Out: D2 = 0 if equipped, 1 if not, 2 if equipped and cursed, 3 if item is nothing

EquipItemBySlot:
										
										movem.l d0-d1/a0,-(sp)
										bsr.w   GetCharEntryAddress
										add.w   d1,d1           ; item slot -> additional offset
										lea     CHAR_OFFSET_ITEM_0(a0,d1.w),a0
										move.w  (a0),d1         ; get item entry
										andi.w  #ITEM_MASK_IDX,d1
										cmpi.w  #ITEMIDX_NOTHING,d1
																						; test if item is "nothing"
										beq.s   loc_8D5E        
										bsr.s   IsItemEquippableAndCursed
										cmpi.w  #1,d2
										beq.s   loc_8D5C
loc_8D56:
										bset    #ITEM_BIT_EQUIPPED,ITEM_OFFSET_IDXANDEQUIPBYTE(a0)
loc_8D5C:
										bra.s   loc_8D62
loc_8D5E:
										move.w  #3,d2           ; code 3: item is "nothing"
loc_8D62:
										movem.l (sp)+,d0-d1/a0
										bra.w   ApplyStatusAndItemsOnStats

	; End of function EquipItemBySlot


; =============== S U B R O U T I N E =======================================

; Checks if item is equippable by char D0's class, and whether or not it's a cursed item.
; In: D0 = char idx
; Out: D2 = 0 if equippable, 1 if not, 2 if equippable and cursed

IsItemEquippableAndCursed:
										
										movem.l d0-d1/a0,-(sp)
										bsr.w   GetCharEntryAddress
										move.b  CHAR_OFFSET_CLASS_IDX(a0),d0
										addq.b  #1,d0
										bsr.w   GetItemDefAddress
										move.l  (a0),d1         ; get class-equippable bitfield
										lsr.l   d0,d1           ; push relevant class-equippable bit into carry
										bcc.s   loc_8D94        
										btst    #ITEMTYPE_BIT_CURSED,ITEMDEF_OFFSET_TYPE(a0)
																						; test cursed bit of itemdef's misc byte
										bne.s   loc_8D8E        
										clr.w   d2              ; code 0: equippable
										bra.s   loc_8D92
loc_8D8E:
										move.w  #2,d2           ; code 2: equippable, but cursed
loc_8D92:
										bra.s   loc_8D98
loc_8D94:
										move.w  #1,d2           ; code 1: not equippable
loc_8D98:
										movem.l (sp)+,d0-d1/a0
										rts

	; End of function IsItemEquippableAndCursed


; =============== S U B R O U T I N E =======================================

; In: D0 = char idx
;     D1 = item slot idx

UnequipItemBySlotIfNotCursed:
										
										movem.l d0-d1/a0,-(sp)
										bsr.s   IsItemInSlotEquippedAndCursed
										tst.w   d2
										bne.s   loc_8DAE
										bclr    #ITEM_BIT_EQUIPPED,ITEM_OFFSET_IDXANDEQUIPBYTE(a0)
loc_8DAE:
										movem.l (sp)+,d0-d1/a0
										bra.w   ApplyStatusAndItemsOnStats

	; End of function UnequipItemBySlotIfNotCursed


; =============== S U B R O U T I N E =======================================

; In: D0 = char idx
;     D1 = item slot idx
; Out: A0 = address of char entry item slot idx in RAM
;      D2 = 0 = equipped and cursed, 1 = not equipped, 2 = equipped, 3 = nothing

IsItemInSlotEquippedAndCursed:
										
										bsr.w   GetCharEntryAddress
										add.w   d1,d1
loc_8DBC:
										lea     CHAR_OFFSET_ITEM_0(a0,d1.w),a0
										move.w  (a0),d1
										andi.w  #ITEM_MAX_IDX,d1
										cmpi.w  #ITEMIDX_NOTHING,d1
										beq.s   loc_8DF8        
										btst    #ITEM_BIT_EQUIPPED,ITEM_OFFSET_IDXANDEQUIPBYTE(a0)
										beq.s   loc_8DF2        
										movem.l a0,-(sp)
										bsr.w   GetItemDefAddress
										btst    #ITEMTYPE_BIT_CURSED,ITEMDEF_OFFSET_TYPE(a0)
										movem.l (sp)+,a0
										bne.s   loc_8DEC        
										clr.w   d2              ; cursed
										bra.s   loc_8DF0
loc_8DEC:
										move.w  #2,d2           ; not cursed
loc_8DF0:
										bra.s   loc_8DF6
loc_8DF2:
										move.w  #1,d2           ; not equipped
loc_8DF6:
										bra.s   return_8DFC
loc_8DF8:
										move.w  #3,d2           ; empty slot
return_8DFC:
										
										rts

	; End of function IsItemInSlotEquippedAndCursed


; =============== S U B R O U T I N E =======================================

; In: D0 = char idx
;     D1 = item slot idx

UnequipItemBySlot:
										
										movem.l d0-d1/a0,-(sp)
										bsr.s   IsItemInSlotEquippedAndCursed
										bclr    #ITEM_BIT_EQUIPPED,ITEM_OFFSET_IDXANDEQUIPBYTE(a0)
										movem.l (sp)+,d0-d1/a0
										bra.w   ApplyStatusAndItemsOnStats

	; End of function UnequipItemBySlot


; =============== S U B R O U T I N E =======================================

; In: D0 = char idx
;     D1 = item slot
; Out: D2 = 2 if not dropped, 3 if dropped or nothing

DropItemBySlot:
										
										movem.l d0/a0,-(sp)
										bsr.w   GetCharEntryAddress
										move.w  d1,d0
										add.w   d1,d1
										lea     CHAR_OFFSET_ITEM_0(a0,d1.w),a0
										move.w  (a0),d1
										move.w  #3,d2
										andi.w  #ITEM_MASK_IDX,d1
										cmpi.w  #ITEMIDX_NOTHING,d1
										beq.s   loc_8E54
										movem.l a0,-(sp)
										bsr.w   GetItemDefAddress
										btst    #ITEMTYPE_BIT_CURSED,ITEMDEF_OFFSET_TYPE(a0)
										movem.l (sp)+,a0
										beq.s   loc_8E52
										move.w  #2,d2           ; item cursed
										btst    #ITEM_BIT_EQUIPPED,ITEM_OFFSET_IDXANDEQUIPBYTE(a0)
										bne.s   loc_8E54        ; item equipped and cursed, so can't drop it
loc_8E52:
										bsr.s   RemoveAndArrangeItems
loc_8E54:
										movem.l (sp)+,d0/a0
loc_8E58:
										bra.w   ApplyStatusAndItemsOnStats

	; End of function DropItemBySlot


; =============== S U B R O U T I N E =======================================

; In: A0 = char entry address + offset to items
;     D0 = item slot

RemoveAndArrangeItems:
										
										move.w  #2,d2
										sub.w   d0,d2           ; subtract item slot from 2 to make loop counter
										bmi.s   loc_8E6E        ; no items to rearrange, so skip to removal
loc_8E64:
										move.w  SIZE_ITEM(a0),(a0)
																						; shift item -1 slots
										addq.w  #SIZE_ITEM,a0
										dbf     d2,loc_8E64     
loc_8E6E:
										move.w  #ITEMIDX_NOTHING,(a0)
																						; replace item with nothing
										clr.w   d2
										rts

	; End of function RemoveAndArrangeItems


; =============== S U B R O U T I N E =======================================

; In: D0 = char idx
;     D1 = item slot

RemoveItemBySlot:
										
										movem.l d0/a0,-(sp)
										bsr.w   GetCharEntryAddress
										move.w  d1,d0
										add.w   d1,d1
										lea     CHAR_OFFSET_ITEM_0(a0,d1.w),a0
										move.w  (a0),d1
										move.w  d1,d2
										andi.w  #ITEM_MASK_IDX,d2
										cmpi.w  #ITEMIDX_NOTHING,d2
										beq.s   loc_8E9A
										bsr.s   RemoveAndArrangeItems
										bra.w   loc_8E9E
loc_8E9A:
										move.w  #3,d2
loc_8E9E:
										movem.l (sp)+,d0/a0
										bra.w   ApplyStatusAndItemsOnStats

	; End of function RemoveItemBySlot


; =============== S U B R O U T I N E =======================================

UnequipWeapon:
										
										movem.l d0-d2/a0-a1,-(sp)
										move.w  #ITEMTYPE_MASK_WEAPON,d2
																						; weapon
										bra.s   UnequipItemByType

	; End of function UnequipWeapon


; =============== S U B R O U T I N E =======================================

UnequipRing:
										
										movem.l d0-d2/a0-a1,-(sp)
										move.w  #ITEMTYPE_MASK_RING,d2
																						; ring
UnequipItemByType:
										
										bsr.w   GetCharEntryAddress
										lea     CHAR_OFFSET_ITEM_0(a0),a1
										moveq   #CHAR_ITEMSLOTS_COUNTER,d0
loc_8EC2:
										move.w  (a1),d1
										btst    #ITEM_BIT_EQUIPPED,d1
										beq.s   loc_8EE0
										andi.w  #ITEM_MASK_IDX,d1
										bsr.w   GetItemDefAddress
										move.b  ITEMDEF_OFFSET_TYPE(a0),d1
										and.b   d2,d1
										beq.s   loc_8EE0
loc_8EDA:
										bclr    #ITEM_BIT_EQUIPPED,ITEM_OFFSET_IDXANDEQUIPBYTE(a1)
loc_8EE0:
										addq.w  #SIZE_ITEM,a1
										dbf     d0,loc_8EC2
										movem.l (sp)+,d0-d2/a0-a1
										bra.w   ApplyStatusAndItemsOnStats

	; End of function UnequipRing


; =============== S U B R O U T I N E =======================================

GetEquippableWeapons:
										
										movem.l d0/d2-d6/a1-a2,-(sp)
										move.w  #2,d2
										bra.s   loc_8F00
GetEquippableRings:
										
										movem.l d0/d2-d6/a1-a2,-(sp)
										move.w  #4,d2
loc_8F00:
										bsr.w   GetCharEntryAddress
										move.b  CHAR_OFFSET_CLASS_IDX(a0),d0
										moveq   #1,d3
										lsl.l   d0,d3           ; place class bit in long value
										lea     CHAR_OFFSET_ITEM_0(a0),a1
										lea     ((EQUIPPABLE_ITEMS-$1000000)).w,a2
										move.l  #$7F0004,(a2)
										move.l  #$7F0004,4(a2)
										move.l  #$7F0004,8(a2)
										move.l  #$800004,$C(a2)
										clr.w   d0
										moveq   #0,d4
										moveq   #3,d5
loc_8F38:
										move.w  (a1)+,d1
										andi.w  #ITEM_MASK_IDX,d1
										cmpi.w  #ITEMIDX_NOTHING,d1
																						; skip if empty slot
										beq.s   loc_8F4E
										bsr.s   IsItemEquippable
										bcc.s   loc_8F4E
										move.w  d1,(a2)+
										move.w  d4,(a2)+
										addq.w  #1,d0
loc_8F4E:
										addq.w  #1,d4
										dbf     d5,loc_8F38
										move.w  d0,d1
										movem.l (sp)+,d0/d2-d6/a1-a2
										lea     ((EQUIPPABLE_ITEMS-$1000000)).w,a0
										rts

	; End of function GetEquippableWeapons


; =============== S U B R O U T I N E =======================================

; In: D1 = item idx
;     D2 = item type bitmask (for ANDing the item type bitfield)
;     D3 = class equip bitmask (for ANDing the item equip bitfield)

IsItemEquippable:
										
										movem.l a0,-(sp)
										bsr.w   GetItemDefAddress
										move.b  ITEMDEF_OFFSET_TYPE(a0),d6
										and.b   d2,d6
										beq.s   loc_8F7A        ; skip if not a weapon/ring
										move.l  (a0),d6
										and.l   d3,d6
										beq.s   loc_8F7A
										ori     #1,ccr          ; set carry flag : Item is Equippable !
loc_8F7A:
										movem.l (sp)+,a0
										rts

	; End of function IsItemEquippable


; =============== S U B R O U T I N E =======================================

IsWeaponOrRingEquippable:
										
										movem.l d0/d2-d6/a0,-(sp)
										move.w  #ITEMTYPE_MASK_WEAPONORRING,d2
										bsr.w   GetCharEntryAddress
										move.b  CHAR_OFFSET_CLASS_IDX(a0),d0
										moveq   #1,d3
										lsl.l   d0,d3
										bsr.s   IsItemEquippable
										movem.l (sp)+,d0/d2-d6/a0
										rts

	; End of function IsWeaponOrRingEquippable


; =============== S U B R O U T I N E =======================================

GetWeaponNewATKandDEF:
										
										movem.l d0/d4-d6/a0,-(sp)
loc_8FA0:
										bsr.w   GetCharEntryAddress
										clr.w   d2
										move.b  CHAR_OFFSET_ATK_CURRENT(a0),d2
																						; current ATK
										clr.w   d3
										move.b  CHAR_OFFSET_DEF_CURRENT(a0),d3
																						; current DEF
										movem.w d0/d2-d3,-(sp)
										move.w  #ITEMTYPE_MASK_WEAPONORRING,d2
										clr.w   d0
										move.b  CHAR_OFFSET_CLASS_IDX(a0),d0
										moveq   #1,d3
										lsl.l   d0,d3
										bsr.s   IsItemEquippable
										movem.w (sp)+,d0/d2-d3
										bcc.w   loc_8FE8
										movem.l d1/a0,-(sp)
										andi.w  #ITEM_MASK_IDX,d1
										bsr.w   GetItemDefAddress
										move.b  ITEMDEF_OFFSET_TYPE(a0),d2
										movem.l (sp)+,d1/a0
										andi.w  #ITEMTYPE_MASK_WEAPONORRING,d2
																						; get weapon/ring type
										bsr.w   GetCharATKandDEFWithSpecificWeapon
loc_8FE8:
										movem.l (sp)+,d0/d4-d6/a0
										rts

	; End of function GetWeaponNewATKandDEF


; =============== S U B R O U T I N E =======================================

; In: A0 = char entry address
;     D1 = item idx
; Out: D2 = char ATK with item equipped
;      D3 = char DEF with item equipped

GetCharATKandDEFWithSpecificWeapon:
										
										movem.l d0-d1/d4-a0,-(sp)
										moveq   #CHAR_ITEMSLOTS_COUNTER,d7
										clr.w   d4
loc_8FF6:
										move.w  CHAR_OFFSET_ITEM_0(a0,d4.w),d5
										btst    #ITEM_BIT_EQUIPPED,d5
										beq.s   loc_901C
										movem.l d0-d1/a0,-(sp)  ; it's equipped
										move.w  d5,d1
										andi.w  #ITEM_MASK_IDX,d1
										bsr.w   GetItemDefAddress
										move.b  ITEMDEF_OFFSET_TYPE(a0),d0
										and.b   d2,d0           ; it's a weapon or a ring
										movem.l (sp)+,d0-d1/a0
										bne.w   loc_903A
loc_901C:
										addq.w  #SIZE_ITEM,d4
										dbf     d7,loc_8FF6
										moveq   #CHAR_ITEMSLOTS_COUNTER,d7
										clr.w   d4
loc_9026:
										move.w  CHAR_OFFSET_ITEM_0(a0,d4.w),d5
										btst    #ITEM_BIT_EQUIPPED,d5
										beq.w   loc_903A
										addq.w  #2,d4
										dbf     d7,loc_9026
										clr.w   d4
loc_903A:
										move.w  CHAR_OFFSET_ITEM_0(a0,d4.w),d5
										movem.l d4-d5/a0,-(sp)
										bset    #ITEM_BIT_EQUIPPED,d1
										move.w  d1,CHAR_OFFSET_ITEM_0(a0,d4.w)
																						; equip item
										bsr.w   ApplyStatusAndItemsOnStats
										clr.w   d2
										move.b  CHAR_OFFSET_ATK_CURRENT(a0),d2
										clr.w   d3
										move.b  CHAR_OFFSET_DEF_CURRENT(a0),d3
										movem.l (sp)+,d4-d5/a0
										movem.w d2-d3,-(sp)
										move.w  d5,CHAR_OFFSET_ITEM_0(a0,d4.w)
																						; and unequip
										bsr.w   ApplyStatusAndItemsOnStats
										movem.w (sp)+,d2-d3
										movem.l (sp)+,d0-d1/d4-a0
										rts

	; End of function GetCharATKandDEFWithSpecificWeapon


; =============== S U B R O U T I N E =======================================

OrderItems:
										
										movem.l d0-d3/a0-a1,-(sp)
										bsr.w   GetCharEntryAddress
										lea     CHAR_OFFSET_ITEM_0(a0),a0
										moveq   #2,d1
loc_9082:
										lea     SIZE_ITEM(a0),a1
										move.w  d1,d2
loc_9088:
										move.w  (a0),d0
										andi.w  #ITEM_MASK_IDX,d0
										move.w  (a1),d3
										andi.w  #ITEM_MASK_IDX,d3
										cmp.w   d0,d3
										bcc.s   loc_90A0
										move.w  (a0),d0         ; if d0 > d3 ?
										move.w  (a1),d3
										move.w  d0,(a3)         ; wtf a3 ?! unused bugged subroutine ?
										move.w  d3,(a0)
loc_90A0:
										addq.w  #SIZE_ITEM,a1
loc_90A2:
										dbf     d2,loc_9088
										addq.w  #SIZE_ITEM,a0
										dbf     d1,loc_9082
										movem.l (sp)+,d0-d3/a0-a1
										rts

	; End of function OrderItems


; =============== S U B R O U T I N E =======================================

IsItemCursed:
										
										move.l  a0,-(sp)
										bsr.w   GetItemDefAddress
										btst    #ITEMTYPE_BIT_CURSED,ITEMDEF_OFFSET_TYPE(a0)
										beq.s   loc_90C6        
										ori     #1,ccr          ; item is cursed
										bra.s   loc_90C8
loc_90C6:
										tst.b   d0              ; clear carry flag
loc_90C8:
										movea.l (sp)+,a0
										rts

	; End of function IsItemCursed


; =============== S U B R O U T I N E =======================================

; carry set : YES

IsItemUsableInBattle:
										
										move.l  a0,-(sp)
										bsr.w   GetItemDefAddress
loc_90D2:
										cmpi.b  #$FF,ITEMDEF_OFFSET_SPELL(a0)
										beq.s   loc_90E0
loc_90DA:
										ori     #1,ccr
										bra.s   loc_90E2
loc_90E0:
										tst.b   d0
loc_90E2:
										movea.l (sp)+,a0
										rts

	; End of function IsItemUsableInBattle


; =============== S U B R O U T I N E =======================================

; carry set : NO

IsItemUsableWeaponInBattle:
										
										move.l  a0,-(sp)
										bsr.w   GetItemType     
										tst.w   d2
										beq.s   loc_90FA
										bsr.w   IsWeaponOrRingEquippable
										bcc.s   loc_9100
										bsr.s   IsItemUsableInBattle
										bcc.s   loc_9100
loc_90FA:
										ori     #1,ccr
										bra.s   loc_9102
loc_9100:
										tst.b   d0
loc_9102:
										movea.l (sp)+,a0
										rts

	; End of function IsItemUsableWeaponInBattle


; =============== S U B R O U T I N E =======================================

; In: D0 = char idx

UnequipAllItemsIfNotCursed:
										
										movem.l d0-d1/a0-a1,-(sp)
										bsr.w   GetCharEntryAddress
										lea     CHAR_OFFSET_ITEM_0(a0),a1
										moveq   #CHAR_ITEMSLOTS_COUNTER,d0
loc_9114:
										move.w  (a1),d1
										btst    #ITEM_BIT_EQUIPPED,d1
										beq.s   loc_9138
										andi.w  #ITEM_MASK_IDX,d1
										cmpi.w  #ITEMIDX_NOTHING,d1
										beq.s   loc_9138
										bsr.w   GetItemDefAddress
										btst    #ITEMTYPE_BIT_CURSED,ITEMDEF_OFFSET_TYPE(a0)
										beq.s   loc_9138
										bclr    #ITEM_BIT_EQUIPPED,ITEM_OFFSET_IDXANDEQUIPBYTE(a1)
loc_9138:
										addq.w  #2,a1
										dbf     d0,loc_9114
										movem.l (sp)+,d0-d1/a0-a1
										bra.w   ApplyStatusAndItemsOnStats

	; End of function UnequipAllItemsIfNotCursed


; =============== S U B R O U T I N E =======================================

j_sub_9146_0:
										
										movem.l d2-d3/d6-a0,-(sp)
										move.w  d1,d3
										bsr.w   UpdateForce     
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a0
										move.w  ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,d6
										subq.w  #1,d6           ; one enemy down ?
loc_915A:
										move.b  (a0)+,d0
										clr.w   d1
										bsr.w   GetCharItemAtSlotAndNumberOfItems
										tst.w   d2
										beq.s   loc_9182
										move.w  d2,d7           ; number of items
										subq.w  #1,d7
loc_916A:
										move.w  d7,d1
										bsr.w   GetCharItemAtSlotAndNumberOfItems
										andi.w  #$7F,d1 
										cmp.w   d3,d1
										bne.s   loc_917E
										move.w  d7,d1
										bra.w   loc_918E
loc_917E:
										dbf     d7,loc_916A
loc_9182:
										dbf     d6,loc_915A
										move.w  #$FFFF,d0
										move.w  #$FFFF,d1
loc_918E:
										movem.l (sp)+,d2-d3/d6-a0
										rts

	; End of function j_sub_9146_0


; =============== S U B R O U T I N E =======================================

; In: D0 = entity idx
;     D1 = item idx
; Out: D2 = item slot (FFFF if not held)

GetItemSlotContainingIndex:
										
										movem.l d1/d3/d7,-(sp)
										move.w  d1,d3
										andi.w  #$7F,d3 
										moveq   #0,d2
										moveq   #3,d7
loc_91A2:
										move.w  d2,d1
										move.l  d2,-(sp)
										jsr     GetCharItemAtSlotAndNumberOfItems(pc)
										move.l  (sp)+,d2
										andi.w  #$7F,d1 
										cmp.b   d3,d1
										beq.w   loc_91C0
										addq.w  #1,d2
										dbf     d7,loc_91A2
										move.w  #$FFFF,d2
loc_91C0:
										movem.l (sp)+,d1/d3/d7
										rts

	; End of function GetItemSlotContainingIndex


; =============== S U B R O U T I N E =======================================

; In: D1 = spell entry
; Out: A0 = address of name
;      D7 = length of name

FindSpellName:
										
										move.w  d1,-(sp)
										andi.w  #$3F,d1 
										movea.l (p_SpellNames).l,a0
										bsr.w   FindName        
										move.w  (sp)+,d1
										rts

	; End of function FindSpellName


; =============== S U B R O U T I N E =======================================

;     Get address of entry in spell definition table.
;     In: D1 = spell index
;     Out: A0 = address of spell #D1 definition

GetSpellDefAddress:
										
										move.l  d0,-(sp)
loc_91DC:
										movea.l (p_SpellData).l,a0
										moveq   #$63,d0 
loc_91E4:
										cmp.b   (a0),d1
										beq.s   loc_91F6
										lea     SPELLDEF_SIZE(a0),a0
										dbf     d0,loc_91E4
										movea.l (p_SpellData).l,a0
loc_91F6:
										move.l  (sp)+,d0
										rts

	; End of function GetSpellDefAddress


; =============== S U B R O U T I N E =======================================

; In: D0 = entity #
;     D1 = spell slot
; Out: D1 = spell idx
;      D2 = number of spells

GetSpellAndNumberOfSpells:
										
										movem.l d0/d3/a0,-(sp)
										bsr.w   GetCharEntryAddress
										lea     CHAR_OFFSET_SPELL_0(a0),a0
										move.b  (a0,d1.w),d1
										moveq   #3,d3
										clr.w   d2
loc_920E:
										move.b  (a0)+,d0
										andi.b  #SPELL_MASK_IDX,d0
										cmpi.b  #SPELLIDX_NOTHING,d0
										beq.s   loc_921C
										addq.w  #1,d2
loc_921C:
										dbf     d3,loc_920E
										movem.l (sp)+,d0/d3/a0
										rts

	; End of function GetSpellAndNumberOfSpells


; =============== S U B R O U T I N E =======================================

; In: D0 = char idx
;     D1 = spell idx
; Out: D2 = result (0 = learned new spell, 1 = upgraded spell, 2 = no room)

LearnSpell:
										
										movem.l d0/d3-d5/a0,-(sp)
										bsr.w   GetCharEntryAddress
										lea     CHAR_OFFSET_STATUS(a0),a0
										move.w  d1,d4
										move.w  d1,d5
										move.w  #1,d2
										moveq   #CHAR_SPELLSLOTS_COUNTER,d3
										andi.w  #SPELL_MASK_IDX,d4
																						; get spell index ?
										lsr.w   #SPELL_OFFSET_LV,d5
loc_9242:
										move.b  -(a0),d0        ; loop through spells to see if we already know a lower level
										andi.b  #SPELL_MASK_IDX,d0
										cmp.b   d4,d0
										bne.s   loc_9258
										move.b  (a0),d0
										lsr.b   #SPELL_OFFSET_LV,d0
										cmp.b   d0,d5
										bls.s   loc_9278
										move.b  d1,(a0)         ; replace existing spell with new one (higher level)
										bra.s   loc_9276
loc_9258:
										dbf     d3,loc_9242     
										moveq   #CHAR_SPELLSLOTS_COUNTER,d3
loc_925E:
										move.b  (a0)+,d0        ; loop through spells to find the next empty slot
										andi.b  #SPELL_MASK_IDX,d0
										cmpi.b  #SPELLIDX_NOTHING,d0
										beq.s   loc_9274
										dbf     d3,loc_925E     
										move.w  #2,d2
										bra.s   loc_9278
loc_9274:
										move.b  d1,-(a0)
loc_9276:
										clr.w   d2
loc_9278:
										movem.l (sp)+,d0/d3-d5/a0
										rts

	; End of function LearnSpell


; =============== S U B R O U T I N E =======================================

;     Get MP cost of spell.
;     In: D1 = spell index
;     Out: D1 = spell MP cost

GetSpellCost:
										
										move.l  a0,-(sp)
										bsr.w   GetSpellDefAddress
										clr.w   d1
										move.b  SPELLDEF_OFFSET_MPCOST(a0),d1
										movea.l (sp)+,a0
										rts

	; End of function GetSpellCost


; =============== S U B R O U T I N E =======================================

; In: D0 = char idx
; Out: A0 = char RAM address

GetCharEntryAddress:
										
										movem.w d0-d1,-(sp)
										cmpi.b  #COM_ENEMY_START,d0
										bcc.s   loc_92A0
										cmpi.b  #COM_ALLY_SPACEEND,d0
										bhi.s   loc_92C2
										bra.s   loc_92AA
loc_92A0:
										cmpi.b  #COM_ENEMY_SPACEEND,d0
										bhi.s   loc_92C2
										subi.b  #COM_ALLYENDENEMYSTARTDIFFERENCE,d0
loc_92AA:
										andi.w  #$FF,d0
										lsl.w   #3,d0
										move.w  d0,d1
										lsl.w   #3,d0
										sub.w   d1,d0
										lea     ((CHARACTER_DATA-$1000000)).w,a0
										adda.w  d0,a0
										movem.w (sp)+,d0-d1
										rts
loc_92C2:
										movem.w (sp)+,d0-d1
										move.l  #'CNUM',(ERRCODE_BYTE0).l
										move.l  (sp),(ERRCODE_BYTE4).l
										trap    #VINT_FUNCTIONS
										dc.w VINTS_DEACTIVATE
										dc.l 0
loc_92DE:
										bra.s   loc_92DE

	; End of function GetCharEntryAddress


; =============== S U B R O U T I N E =======================================

SetCharacterByte:
										
										bsr.s   GetCharEntryAddress
										move.b  d1,(a0,d7.w)
										rts

	; End of function SetCharacterByte


; =============== S U B R O U T I N E =======================================

SetCharacterWord:
										
										bsr.s   GetCharEntryAddress
										move.w  d1,(a0,d7.w)
										rts

	; End of function SetCharacterWord


; =============== S U B R O U T I N E =======================================

SetCharacterLong:
										
										bsr.s   GetCharEntryAddress
										move.l  d1,(a0,d7.w)
										rts

	; End of function SetCharacterLong


; =============== S U B R O U T I N E =======================================

; In: D0 = char idx
;     D7 = char byte offset
; Out: D1 = byte

GetCharacterByte:
										
										bsr.s   GetCharEntryAddress
										clr.w   d1
										move.b  (a0,d7.w),d1
										rts

	; End of function GetCharacterByte


; =============== S U B R O U T I N E =======================================

; In: D0 = char idx
;     D7 = char byte offset
; Out: D1 = word

GetCharacterWord:
										
										bsr.s   GetCharEntryAddress
										move.w  (a0,d7.w),d1
										rts

	; End of function GetCharacterWord


; =============== S U B R O U T I N E =======================================

dup_GetCharacterWord:
										
										bsr.s   GetCharEntryAddress
										move.w  (a0,d7.w),d1
										rts

	; End of function dup_GetCharacterWord


; =============== S U B R O U T I N E =======================================

; clamp byte # D7 of entity D0's information + D1 between D5 and D6

IncreaseAndClampByte:
										
										bsr.w   GetCharEntryAddress
										add.b   (a0,d7.w),d1
										bcs.s   loc_9320
										cmp.b   d6,d1
										bcs.s   loc_9324
loc_9320:
										move.b  d6,d1
										bra.s   loc_932A
loc_9324:
										cmp.b   d5,d1
										bcc.s   loc_932A
										move.b  d5,d1
loc_932A:
										move.b  d1,(a0,d7.w)
										andi.w  #$FF,d1
										rts

	; End of function IncreaseAndClampByte


; =============== S U B R O U T I N E =======================================

Clamp7BitIncreasing:
										
										bsr.w   GetCharEntryAddress
										movem.w d2-d3,-(sp)
										move.b  (a0,d7.w),d2
										move.b  d2,d3
										andi.b  #$80,d3
										andi.b  #$7F,d2 
										add.b   d2,d1
										bcs.s   loc_9352
										cmp.b   d6,d1
										bcs.s   loc_9356
loc_9352:
										move.b  d6,d1
										bra.s   loc_935C
loc_9356:
										cmp.b   d5,d1
										bcc.s   loc_935C
										move.b  d5,d1
loc_935C:
										or.b    d3,d1
										move.b  d1,(a0,d7.w)
										andi.w  #$FF,d1
										movem.w (sp)+,d2-d3
										rts

	; End of function Clamp7BitIncreasing


; =============== S U B R O U T I N E =======================================

; clamp byte # D7 of entity D0's information - D1 between D5 and D6

DecreaseAndClampByte:
										
										move.w  d4,-(sp)
										bsr.w   GetCharEntryAddress
										move.b  d1,d4
										move.b  (a0,d7.w),d1
										sub.b   d4,d1
										bcs.s   loc_9380
										cmp.b   d5,d1
										bcc.s   loc_9384
loc_9380:
										move.b  d5,d1
										bra.s   loc_938A
loc_9384:
										cmp.b   d6,d1
										bcs.s   loc_938A
										move.b  d6,d1
loc_938A:
										move.b  d1,(a0,d7.w)
										move.w  (sp)+,d4
										andi.w  #$FF,d1
										rts

	; End of function DecreaseAndClampByte


; =============== S U B R O U T I N E =======================================

ClampWordIncreasing:
										
										bsr.w   GetCharEntryAddress
										add.w   (a0,d7.w),d1
										bmi.s   loc_93A4
										cmp.w   d6,d1
										bcs.s   loc_93A8
loc_93A4:
										move.w  d6,d1
										bra.s   loc_93AE
loc_93A8:
										cmp.w   d5,d1
										bcc.s   loc_93AE
										move.w  d5,d1
loc_93AE:
										move.w  d1,(a0,d7.w)
										rts

	; End of function ClampWordIncreasing


; =============== S U B R O U T I N E =======================================

ClampWordDecreasing:
										
										move.w  d4,-(sp)
										bsr.w   GetCharEntryAddress
										move.w  d1,d4
										move.w  (a0,d7.w),d1
										sub.w   d4,d1
										bmi.s   loc_93C8
										cmp.w   d5,d1
										bhi.s   loc_93CC
loc_93C8:
										move.w  d5,d1
										bra.s   loc_93D2
loc_93CC:
										cmp.w   d6,d1
										bls.s   loc_93D2
										move.w  d6,d1
loc_93D2:
										move.w  d1,(a0,d7.w)
										move.w  (sp)+,d4
										rts

	; End of function ClampWordDecreasing


; =============== S U B R O U T I N E =======================================

sub_93DA:
										bsr.w   GetCharEntryAddress
										add.l   (a0,d7.w),d1
										bmi.s   loc_93E8
										cmp.l   d6,d1
										bcs.s   loc_93EC
loc_93E8:
										move.l  d6,d1
										bra.s   loc_93F2
loc_93EC:
										cmp.l   d5,d1
										bcc.s   loc_93F2
										move.l  d5,d1
loc_93F2:
										move.l  d1,(a0,d7.w)
										rts

	; End of function sub_93DA


; =============== S U B R O U T I N E =======================================

sub_93F8:
										move.l  d4,-(sp)
										bsr.w   GetCharEntryAddress
										move.l  d1,d4
										move.l  (a0,d7.w),d1
										sub.l   d4,d1
										bmi.s   loc_940C
										cmp.l   d5,d1
										bhi.s   loc_9410
loc_940C:
										move.l  d5,d1
										bra.s   loc_9416
loc_9410:
										cmp.l   d6,d1
										bls.s   loc_9416
										move.l  d6,d1
loc_9416:
										move.l  d1,(a0,d7.w)
										move.l  (sp)+,d4
										rts

	; End of function sub_93F8


; =============== S U B R O U T I N E =======================================

; Gets distance between two entities (simple X and Y calculation, no obstructions)
; In: D0 = from entity
;     D1 = to entity
; Out: D2 = distance

GetDistanceBetweenEntities:
										
										movem.l d0-d1/d3-d5,-(sp)
										move.w  d1,d5           ; d0 and d1 are character indexes
										clr.w   d1
										clr.w   d2
										clr.w   d3
										clr.w   d4
										bsr.w   GetXPos
										cmpi.b  #$FF,d1
										beq.w   loc_9478
										move.w  d1,d2           ; keep 1st character XPos
										bsr.w   GetYPos
										cmpi.b  #$FF,d1
										beq.w   loc_9478
										move.w  d1,d3           ; keep 1st character YPos
										move.w  d5,d0
										bsr.w   GetXPos
										cmpi.b  #$FF,d1
										beq.w   loc_9478
										move.w  d1,d4
										bsr.w   GetYPos
										cmpi.b  #$FF,d1
										beq.w   loc_9478
										move.w  d1,d5
										sub.w   d4,d2
										bcc.s   loc_946C
										neg.w   d2
loc_946C:
										sub.w   d5,d3
										bcc.s   loc_9472
										neg.w   d3
loc_9472:
										add.w   d3,d2
										bra.w   loc_947C
loc_9478:
										move.w  #$FFFF,d2
loc_947C:
										movem.l (sp)+,d0-d1/d3-d5
										rts

	; End of function GetDistanceBetweenEntities


; =============== S U B R O U T I N E =======================================

nullsub_6:
										
										rts

	; End of function nullsub_6


; =============== S U B R O U T I N E =======================================

LevelUp:
										movem.l d0-a1,-(sp)
										link    a6,#-$10
										move.w  d0,-2(a6)
										bsr.w   GetClass
										move.w  d1,d3
										bsr.w   GetCurrentLevel
										moveq   #$63,d2 
										cmpi.w  #$C,d3
										bge.s   loc_94A4
										moveq   #$28,d2 
loc_94A4:
										lsl.w   #2,d0
										movea.l (p_pt_CharacterStats).l,a0
										movea.l (a0,d0.w),a0
loc_94B0:
										tst.b   (a0)
										bmi.w   loc_94C6
										cmp.b   (a0)+,d3
										beq.s   loc_94C2
loc_94BA:
										cmpi.b  #$FE,(a0)+
										bcs.s   loc_94BA
										bra.s   loc_94B0
loc_94C2:
										cmp.w   d2,d1
										blt.s   loc_94E2
loc_94C6:
										lea     (byte_FFAF82).l,a1
										move.b  #$FF,(a1)+
										clr.b   (a1)+
										clr.b   (a1)+
										clr.b   (a1)+
										clr.b   (a1)+
										clr.b   (a1)+
										move.b  #$FF,(a1)
										bra.w   loc_95BE
loc_94E2:
										lea     (byte_FFAF82).l,a1
										move.w  -2(a6),d0
										bsr.w   GetCurrentLevel
										move.w  d1,d5
										moveq   #0,d2
										moveq   #0,d3
										moveq   #0,d4
										move.b  (a0)+,d2
										move.b  (a0)+,d3
										move.b  (a0)+,d4
loc_94FE:
										bsr.w   GetMaxHP
										bsr.w   sub_96BA
										move.b  d1,1(a1)
										bsr.w   IncreaseMaxHP
										move.b  (a0)+,d2
										move.b  (a0)+,d3
										move.b  (a0)+,d4
										bsr.w   GetMaxMP
										bsr.w   sub_96BA
										move.b  d1,2(a1)
loc_9520:
										bsr.w   IncreaseMaxMP
										move.b  (a0)+,d2
										move.b  (a0)+,d3
										move.b  (a0)+,d4
										bsr.w   GetBaseATK
										bsr.w   sub_96BA
										move.b  d1,3(a1)
										bsr.w   IncreaseBaseATK
										move.b  (a0)+,d2
										move.b  (a0)+,d3
										move.b  (a0)+,d4
										bsr.w   GetBaseDEF
										bsr.w   sub_96BA
										move.b  d1,4(a1)
										bsr.w   IncreaseBaseDEF
										move.b  (a0)+,d2
										move.b  (a0)+,d3
										move.b  (a0)+,d4
										bsr.w   GetBaseAGI
										bsr.w   sub_96BA
										move.b  d1,5(a1)
										bsr.w   IncreaseBaseAGI
										addq.w  #1,d5
										move.w  d5,d1
										bsr.w   SetLevel
										move.b  d5,(a1)
										bsr.w   GetClass
										cmpi.w  #$B,d1
										blt.s   loc_957E
loc_957A:
										addi.w  #CHAR_CLASS_EXTRALEVEL,d5
loc_957E:
										move.b  #$FF,6(a1)
loc_9584:
										move.b  (a0)+,d2
										move.b  (a0)+,d1
										cmpi.b  #$FE,d2
										bne.s   loc_95A2
										move.w  d0,d2
										lsl.w   #2,d2
										movea.l (p_pt_CharacterStats).l,a0
										movea.l (a0,d2.w),a0
										lea     $10(a0),a0
										bra.s   loc_9584
loc_95A2:
										cmpi.b  #$FF,d2
										beq.w   loc_95BA
										cmp.b   d2,d5
										bne.s   loc_9584
										bsr.w   LearnSpell      
										tst.w   d2
										bne.s   loc_95BA
										move.b  d1,6(a1)
loc_95BA:
										bsr.w   ApplyStatusAndItemsOnStats
loc_95BE:
										unlk    a6
										movem.l (sp)+,d0-a1
										rts

	; End of function LevelUp


; =============== S U B R O U T I N E =======================================

InitCharacterStats:
										
										movem.l d0-d2/a0,-(sp)
										move.w  d1,-(sp)
										move.w  d0,d2
										lsl.w   #2,d2
loc_95D0:
										movea.l (p_pt_CharacterStats).l,a0
										movea.l (a0,d2.w),a0
										clr.w   d1
										addq.l  #2,a0
										move.b  (a0)+,d1
										bsr.w   SetMaxHP
loc_95E4:
										bsr.w   SetCurrentHP
										clr.w   d1
										addq.l  #2,a0
										move.b  (a0)+,d1
										bsr.w   SetMaxMP
										bsr.w   SetCurrentMP
										clr.w   d1
										addq.l  #2,a0
										move.b  (a0)+,d1
										bsr.w   SetBaseATK
										clr.w   d1
										addq.l  #2,a0
										move.b  (a0)+,d1
										bsr.w   SetBaseDEF
										clr.w   d1
										addq.l  #2,a0
										move.b  (a0)+,d1
										bsr.w   SetBaseAGI
										moveq   #1,d1
										bsr.w   SetLevel
										move.w  (sp)+,d4
										move.w  d4,d5
										bsr.w   GetClass
										cmpi.w  #$B,d1
										blt.s   loc_962C
										addi.w  #$14,d5
loc_962C:
										move.w  d0,d2
										lsl.w   #2,d2
										movea.l (p_pt_CharacterStats).l,a0
										movea.l (a0,d2.w),a0
loc_963A:
										tst.b   (a0)
										bmi.w   loc_96B4
										cmp.b   (a0)+,d1
										beq.s   loc_964C
loc_9644:
										cmpi.b  #$FE,(a0)+
										bcs.s   loc_9644
										bra.s   loc_963A
loc_964C:
										lea     $F(a0),a0
loc_9650:
										move.b  (a0)+,d2
										move.b  (a0)+,d1
										cmpi.b  #$FE,d2
										bne.s   loc_966E
										move.w  d0,d2
										lsl.w   #2,d2
										movea.l (p_pt_CharacterStats).l,a0
										movea.l (a0,d2.w),a0
										lea     $10(a0),a0
										bra.s   loc_9650
loc_966E:
										cmpi.b  #$FF,d2
										beq.w   loc_96A6
										cmp.b   d2,d5
										blt.s   loc_9650
										cmpi.b  #$80,d1
										bne.s   loc_96A0
										bsr.w   GetBaseProwess
										move.w  d1,d2
										andi.w  #$F,d1
										lsr.w   #4,d2
										addq.w  #1,d2
										cmpi.w  #8,d2
										bne.s   loc_9696
										moveq   #7,d2
loc_9696:
										lsl.w   #4,d2
										or.w    d2,d1
										bsr.w   SetBaseSomething
										bra.s   loc_96A4
loc_96A0:
										bsr.w   LearnSpell      
loc_96A4:
										bra.s   loc_9650
loc_96A6:
										subq.w  #2,d4
										blt.w   loc_96B4
loc_96AC:
										bsr.w   LevelUp
										dbf     d4,loc_96AC
loc_96B4:
										movem.l (sp)+,d0-d2/a0
										rts

	; End of function InitCharacterStats


; =============== S U B R O U T I N E =======================================

sub_96BA:
										tst.b   d2
										bne.s   loc_96C4
										move.w  #0,d1
										rts
loc_96C4:
										movem.l d0/d2-a0,-(sp)
										movem.w d1-d5,-(sp)
										cmpi.w  #$1E,d5
										blt.s   loc_96DC
										move.w  #$100,d0
										move.w  #$180,d4
										bra.s   loc_96FE
loc_96DC:
										andi.w  #7,d2
										subq.w  #1,d2
										muls.w  #$74,d2 
										movea.l (p_StatGrowthCurves).l,a0
										adda.w  d2,a0
										move.w  d5,d2
										subq.w  #1,d2
										lsl.w   #2,d2
										adda.w  d2,a0
										move.w  (a0)+,d0
										move.w  (a0)+,d7
										sub.w   d3,d4
										mulu.w  d7,d4
loc_96FE:
										move.w  #$80,d6 
										jsr     (UpdateRandomSeed).w
										add.w   d7,d4
										jsr     (UpdateRandomSeed).w
										sub.w   d7,d4
										addi.w  #$80,d4 
										lsr.w   #8,d4
										move.w  d4,d6
										movem.w (sp)+,d1-d5
										sub.w   d3,d4
										mulu.w  d4,d0
										addi.w  #$80,d0 
										lsr.w   #8,d0
										add.w   d3,d0
										add.w   d6,d1
										cmp.w   d0,d1
										bge.s   loc_972E
										addq.w  #1,d6
loc_972E:
										move.w  d6,d1
										movem.l (sp)+,d0/d2-a0
										rts

	; End of function sub_96BA


; =============== S U B R O U T I N E =======================================

NewGame:
										movem.w d0-d1/d7,-(sp)
										bsr.w   InitGameSettings
										moveq   #COM_ALLIES_COUNTER,d7
loc_9740:
										moveq   #COM_ALLIES_COUNTER,d0
										sub.w   d7,d0
										bsr.w   InitCharacterDataInRAM
										dbf     d7,loc_9740
										moveq   #GOLD_STARTING_AMOUNT,d1
																						; starting gold value
										bsr.w   SetGold
										moveq   #CHAR_IDX_BOWIE,d0
																						; starting character
										bsr.w   JoinForce
										movem.w (sp)+,d0-d1/d7
										rts

	; End of function NewGame


; =============== S U B R O U T I N E =======================================

InitCharacterDataInRAM:
										
										movem.l d0-d3/a0-a1,-(sp)
										move.w  d0,d1
										mulu.w  #CHAR_ENTRY_SIZE,d1
										lea     ((CHARACTER_DATA-$1000000)).w,a1
										adda.w  d1,a1
										movea.l (p_AllyNames).l,a0
										move.w  d0,d1
										subq.w  #1,d1
										blt.s   loc_9786
loc_977A:
										clr.w   d2
										move.b  (a0)+,d2
										lea     (a0,d2.w),a0
										dbf     d1,loc_977A
loc_9786:
										move.b  (a0)+,d2
										moveq   #CHAR_NAMELENGTH,d3
										sub.w   d2,d3
										subq.w  #1,d2
										blt.s   loc_9796
loc_9790:
										move.b  (a0)+,(a1)+
										dbf     d2,loc_9790
loc_9796:
										subq.w  #1,d3
										blt.s   loc_97A0
loc_979A:
										clr.b   (a1)+
										dbf     d3,loc_979A
loc_97A0:
										move.w  d0,d1
										mulu.w  #CHARDEF_STARTDATA_ENTRYSIZE,d1
										movea.l (p_CharacterStartData).l,a0
										adda.w  d1,a0
										suba.w  #$A,a1
										move.b  (a0)+,d1
										move.b  d1,$A(a1)
										move.b  (a0)+,d2
										move.b  d2,$B(a1)
										ext.w   d2
										move.w  d2,-(sp)
										clr.w   d3
										move.b  (a0)+,d3
										move.w  d3,CHAR_OFFSET_ITEM_0(a1)
										move.b  (a0)+,d3
										move.w  d3,CHAR_OFFSET_ITEM_1(a1)
										move.b  (a0)+,d3
										move.w  d3,CHAR_OFFSET_ITEM_2(a1)
										move.b  (a0)+,d3
										move.w  d3,CHAR_OFFSET_ITEM_3(a1)
										move.l  #$3F3F3F3F,CHAR_OFFSET_SPELL_0(a1)
										bsr.w   SetCharacterClassData
										move.w  (sp)+,d1
										bsr.w   InitCharacterStats
										bsr.w   ApplyStatusAndItemsOnStats
										movem.l (sp)+,d0-d3/a0-a1
										rts

	; End of function InitCharacterDataInRAM


; =============== S U B R O U T I N E =======================================

SetCharacterClassData:
										
										movem.l d0-d1/a0-a1,-(sp)
										mulu.w  #$38,d0 
										lea     ((CHARACTER_DATA-$1000000)).w,a1
										adda.w  d0,a1
										movea.l (p_ClassData).l,a0
loc_980C:
										andi.w  #$1F,d1
										mulu.w  #5,d1
										adda.w  d1,a0
										move.b  (a0)+,$18(a1)
										move.b  (a0)+,$1A(a1)
										move.b  (a0)+,$1B(a1)
										move.b  (a0)+,$31(a1)
										move.b  (a0)+,$1E(a1)
										movem.l (sp)+,d0-d1/a0-a1
										rts

	; End of function SetCharacterClassData


; =============== S U B R O U T I N E =======================================

Promote:
										movem.w d1,-(sp)
										bsr.w   GetClass
										bsr.s   SetCharacterClassData
										bsr.w   ApplyStatusAndItemsOnStats
										movem.w (sp)+,d1
										rts

	; End of function Promote


; =============== S U B R O U T I N E =======================================

; Clear all flags and important game variables.

InitGameSettings:
										
										movem.l d0/d7-a0,-(sp)
										moveq   #0,d0
										lea     ((GAME_FLAGS-$1000000)).w,a0
										moveq   #$1F,d7
loc_9850:
										move.l  d0,(a0)+
										dbf     d7,loc_9850
										lea     ((DEALS_ITEMS-$1000000)).w,a0
										moveq   #$F,d7
loc_985C:
										move.l  d0,(a0)+
										dbf     d7,loc_985C
										move.l  #$7F7F7F7F,d0
										lea     ((CARAVAN_ITEMS-$1000000)).w,a0
										moveq   #$F,d7
loc_986E:
										move.l  d0,(a0)+
										dbf     d7,loc_986E
										moveq   #0,d0
										move.w  d0,((NUM_ITEMS_IN_CARAVAN-$1000000)).w
										move.w  d0,((CURRENT_GOLD-$1000000)).w
										move.b  d0,((PLAYER_TYPE-$1000000)).w
										move.b  d0,((CURRENT_MAP-$1000000)).w
										move.b  d0,((CURRENT_BATTLE-$1000000)).w
										move.b  d0,((DISPLAY_BATTLE_MESSAGES-$1000000)).w
										move.b  d0,((EGRESS_MAP_INDEX-$1000000)).w
										move.l  #359999,((SPECIAL_BATTLE_RECORD-$1000000)).w
										move.b  #2,((MESSAGE_SPEED-$1000000)).w
										move.l  #$FFFFFFFF,((FOLLOWERS_LIST-$1000000)).w
										move.w  #$FFFF,((byte_FFAF26-$1000000)).w
										movem.l (sp)+,d0/d7-a0
										rts

	; End of function InitGameSettings


; =============== S U B R O U T I N E =======================================

CheckFlag:
										
										movem.l d0-d1/a0,-(sp)
										bsr.w   GetFlag         
										and.b   (a0),d0
										movem.l (sp)+,d0-d1/a0
										rts

	; End of function CheckFlag


; =============== S U B R O U T I N E =======================================

SetFlag:
										movem.l d0-d1/a0,-(sp)
										bsr.w   GetFlag         
										or.b    d0,(a0)
										movem.l (sp)+,d0-d1/a0
										rts

	; End of function SetFlag


; =============== S U B R O U T I N E =======================================

ClearFlag:
										
										movem.l d0-d1/a0,-(sp)
										bsr.w   GetFlag         
										eori.b  #$FF,d0
										and.b   d0,(a0)
										movem.l (sp)+,d0-d1/a0
										rts

	; End of function ClearFlag


; =============== S U B R O U T I N E =======================================

; flag bit check pattern based on bit number D1 -> D0

GetFlag:
										andi.l  #FLAG_MASK,d1
										divu.w  #8,d1           ; get the byte in which the flag is stored
										lea     ((GAME_FLAGS-$1000000)).w,a0
																						; go to the flag location in RAM
										adda.w  d1,a0           ; go to the concerned byte
										swap    d1
										moveq   #$FFFFFF80,d0
										lsr.b   d1,d0
										rts

	; End of function GetFlag


; =============== S U B R O U T I N E =======================================

; determine who is in the force or not based on flags and update RAM lists

UpdateForce:
										
										movem.l d0-d4/d7/a2-a4,-(sp)
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a2
										lea     ((BATTLE_PARTY_MEMBERS-$1000000)).w,a3
										lea     ((RESERVE_MEMBERS-$1000000)).w,a4
										moveq   #0,d2
										moveq   #0,d3
										moveq   #0,d4
										moveq   #0,d0
										moveq   #COM_ALLIES_COUNTER,d7
																						; loop 30 times
loc_991A:
										move.w  d0,d1
										addi.w  #0,d1
										bsr.s   CheckFlag
										beq.w   loc_993E
										move.b  d0,(a2)+
										addq.w  #1,d2
										move.w  d0,d1
										addi.w  #$20,d1 
										bsr.s   CheckFlag
										beq.s   loc_993A
										move.b  d0,(a3)+
										addq.w  #1,d3
										bra.s   loc_993E
loc_993A:
										move.b  d0,(a4)+
										addq.w  #1,d4
loc_993E:
										addq.b  #1,d0
										dbf     d7,loc_991A
										move.w  d2,((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w
										move.w  d3,((NUMBER_OF_BATTLE_PARTY_MEMBERS-$1000000)).w
										move.w  d4,((NUMBER_OF_OTHER_PARTY_MEMBERS-$1000000)).w
										movem.l (sp)+,d0-d4/d7/a2-a4
										rts

	; End of function UpdateForce


; =============== S U B R O U T I N E =======================================

JoinForce:
										
										move.l  d1,-(sp)
										clr.w   d1
										move.b  d0,d1
										addi.w  #0,d1
										bsr.w   SetFlag
										bsr.s   UpdateForce     
										cmpi.w  #FORCE_MAX_SIZE,((NUMBER_OF_BATTLE_PARTY_MEMBERS-$1000000)).w
										bcc.s   loc_9972
										bsr.w   JoinBattleParty
loc_9972:
										move.l  (sp)+,d1
										rts

	; End of function JoinForce


; =============== S U B R O U T I N E =======================================

LeaveForce:
										
										move.l  d1,-(sp)
										move.b  d0,d1
										andi.b  #$FF,d1
										addi.w  #0,d1
										bsr.w   ClearFlag
										move.w  #MAP_NULLPOSITION,d1
										jsr     SetXPos
										move.l  (sp)+,d1
										rts

	; End of function LeaveForce


; =============== S U B R O U T I N E =======================================

IsInBattleParty:
										
										movem.l d1,-(sp)
										move.b  d0,d1
										andi.b  #$FF,d1
										addi.w  #FLAG_COUNT_FORCEMEMBERS_JOINED,d1
										bsr.w   CheckFlag
										movem.l (sp)+,d1
										rts

	; End of function IsInBattleParty


; =============== S U B R O U T I N E =======================================

JoinBattleParty:
										
										move.l  d1,-(sp)
										move.b  d0,d1
										andi.b  #$FF,d1
										addi.w  #FLAG_COUNT_FORCEMEMBERS_JOINED,d1
										bsr.w   SetFlag
										move.l  (sp)+,d1
										rts

	; End of function JoinBattleParty


; =============== S U B R O U T I N E =======================================

LeaveBattleParty:
										
										move.l  d1,-(sp)
										move.b  d0,d1
										andi.b  #$FF,d1
										addi.w  #FLAG_COUNT_FORCEMEMBERS_JOINED,d1
										bsr.w   ClearFlag
										move.w  #$FFFF,d1
										jsr     SetXPos
										move.l  (sp)+,d1
										rts

	; End of function LeaveBattleParty


; =============== S U B R O U T I N E =======================================

; In: D1 = item idx
; Out: D2 = number of item idx in deals

GetDealsItemAmount:
										
										movem.l d0-d1/a0,-(sp)
										bsr.w   GetDealsItemInfo
										movem.l (sp)+,d0-d1/a0
										rts

	; End of function GetDealsItemAmount


; =============== S U B R O U T I N E =======================================

; In: D1 = item idx

AddItemToDeals:
										
										movem.l d0-d2/a0,-(sp)
										bsr.w   GetDealsItemInfo
										cmpi.b  #DEALS_MAX_NUM_PER_ITEM,d2
										beq.s   loc_99FC
										add.b   d0,(a0)
loc_99FC:
										movem.l (sp)+,d0-d2/a0
										rts

	; End of function AddItemToDeals


; =============== S U B R O U T I N E =======================================

; In: D1 = item idx

RemoveItemFromDeals:
										
										movem.l d0-d2/a0,-(sp)
										bsr.w   GetDealsItemInfo
										tst.b   d2
										beq.s   loc_9A10
										sub.b   d0,(a0)
loc_9A10:
										movem.l (sp)+,d0-d2/a0
										rts

	; End of function RemoveItemFromDeals


; =============== S U B R O U T I N E =======================================

; In: D1 = item idx
; Out: A0 = RAM address of deals slot
;      D0 = amt to add to deals slot (0x10 or 0x01)
;      D2 = number of item idx in deals

GetDealsItemInfo:
										
										andi.l  #ITEM_MASK_IDX,d1
										lea     ((DEALS_ITEMS-$1000000)).w,a0
										divu.w  #2,d1
										adda.w  d1,a0
										move.b  (a0),d2
										btst    #DEALS_BIT_REMAINDER,d1
										bne.s   loc_9A34
										lsr.b   #BITS_HALFBYTE,d2
										moveq   #DEALS_ADDAMT_ODD,d0
										bra.s   return_9A3A
loc_9A34:
										andi.b  #DEALS_MAX_NUM_PER_ITEM,d2
										moveq   #DEALS_ADDAMT_EVEN,d0
return_9A3A:
										
										rts

	; End of function GetDealsItemInfo


; =============== S U B R O U T I N E =======================================

; In: D1 = item idx (only the actual item idx is used, the status bits are cut out)

AddItemToCaravan:
										
										movem.l d0-d1/a0,-(sp)
										moveq   #CARAVAN_MAX_ITEMS,d0
										cmp.w   ((NUM_ITEMS_IN_CARAVAN-$1000000)).w,d0
										bcs.s   loc_9A5C
										lea     ((CARAVAN_ITEMS-$1000000)).w,a0
										move.w  ((NUM_ITEMS_IN_CARAVAN-$1000000)).w,d0
										andi.w  #ITEM_MAX_IDX,d1
										move.b  d1,(a0,d0.w)
										addq.w  #1,((NUM_ITEMS_IN_CARAVAN-$1000000)).w
loc_9A5C:
										movem.l (sp)+,d0-d1/a0
										rts

	; End of function AddItemToCaravan


; =============== S U B R O U T I N E =======================================

RemoveItemFromCaravan:
										
										movem.l d0/d7-a1,-(sp)
										moveq   #0,d0
										lea     ((CARAVAN_ITEMS-$1000000)).w,a0
										movea.l a0,a1
										move.w  ((NUM_ITEMS_IN_CARAVAN-$1000000)).w,d7
										subq.w  #1,d7
										bcs.w   loc_9A94
loc_9A78:
										cmp.w   d0,d1
										bne.s   loc_9A84
										addq.l  #1,a1
										subq.w  #1,((NUM_ITEMS_IN_CARAVAN-$1000000)).w
										bra.s   loc_9A86
loc_9A84:
										move.b  (a1)+,(a0)+
loc_9A86:
										addq.w  #1,d0
										dbf     d7,loc_9A78
										cmpa.l  a1,a0
										beq.s   loc_9A94
										move.b  #ITEMIDX_NOTHING,(a0)
loc_9A94:
										movem.l (sp)+,d0/d7-a1
										rts

	; End of function RemoveItemFromCaravan


; =============== S U B R O U T I N E =======================================

DebugModeSelectAction:
										
										movem.l d0-d3/a0,-(sp)
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										moveq   #0,d0
										moveq   #0,d1
										moveq   #6,d2
										jsr     j_NumberPrompt
										cmpi.b  #$FF,d0
										beq.w   loc_9B3E
										move.w  d0,(a0)+
										add.w   d0,d0
										move.w  rjt_DebugModeBattleActions(pc,d0.w),d0
										jmp     rjt_DebugModeBattleActions(pc,d0.w)
rjt_DebugModeBattleActions:
										
										dc.w loc_9AD0-rjt_DebugModeBattleActions
										dc.w loc_9ADA-rjt_DebugModeBattleActions
										dc.w loc_9B06-rjt_DebugModeBattleActions
										dc.w loc_9B2C-rjt_DebugModeBattleActions
										dc.w loc_9B30-rjt_DebugModeBattleActions
										dc.w loc_9B34-rjt_DebugModeBattleActions
										dc.w loc_9B38-rjt_DebugModeBattleActions
loc_9AD0:
										bsr.w   DebugModeSelectTargetEnemy
																						; attack
										move.w  d0,(a0)+
										bra.w   loc_9B3E
loc_9ADA:
										moveq   #1,d0           ; use magic
										moveq   #1,d1
										moveq   #SPELLDEF_LEVELS_NUM,d2
										jsr     j_NumberPrompt
										move.w  d0,d3
										subq.w  #1,d3
										lsl.w   #6,d3
										moveq   #0,d0
										moveq   #0,d1
										moveq   #$2A,d2 
										jsr     j_NumberPrompt
										add.w   d3,d0
										move.w  d0,(a0)+
										bsr.w   DebugModeSelectTargetEnemy
										move.w  d0,(a0)+
										bra.w   loc_9B3E
loc_9B06:
										moveq   #0,d0           ; use item
										moveq   #0,d1
										moveq   #$7F,d2 
										jsr     j_NumberPrompt
										move.w  d0,(a0)+
										bsr.w   DebugModeSelectTargetEnemy
										move.w  d0,(a0)+
										moveq   #0,d0
										moveq   #0,d1
										moveq   #3,d2
										jsr     j_NumberPrompt
										move.w  d0,(a0)+
										bra.w   loc_9B3E
loc_9B2C:
										bra.w   loc_9B3E
loc_9B30:
										bra.w   loc_9B3E
loc_9B34:
										bra.w   loc_9B3E
loc_9B38:
										move.b  #$24,((CURRENT_BATTLE-$1000000)).w 
																						; use prism laser
loc_9B3E:
										movem.l (sp)+,d0-d3/a0
										rts

	; End of function DebugModeSelectAction


; =============== S U B R O U T I N E =======================================

DebugModeSelectTargetEnemy:
										
										move.l  #COM_ENEMY_START,d0
										moveq   #0,d1
										move.w  #COM_ENEMY_END,d2
										jsr     j_NumberPrompt
										rts

	; End of function DebugModeSelectTargetEnemy


; =============== S U B R O U T I N E =======================================

DebugModeSelectHits:
										
										movem.l d0/a0-a6,-(sp)
loc_9B5C:
										jsr     j_YesNoPrompt
										tst.w   d0
										seq     -BCSTACK_OFFSET_DEBUGDODGE(a2)
loc_9B68:
										jsr     j_YesNoPrompt
										tst.w   d0
										seq     -BCSTACK_OFFSET_DEBUGCRIT(a2)
										jsr     j_YesNoPrompt
										tst.w   d0
										seq     -BCSTACK_OFFSET_DEBUGDOUBLE(a2)
loc_9B80:
										jsr     j_YesNoPrompt
										tst.w   d0
										seq     -BCSTACK_OFFSET_DEBUGCOUNTER(a2)
										movem.l (sp)+,d0/a0-a6
										rts

	; End of function DebugModeSelectHits


; =============== S U B R O U T I N E =======================================

; In: D0 = attacker idx

WriteSkirmishScript:
										
										movem.l d0-a6,-(sp)
										link    a2,#BTLSCENE_STACKNEGSIZE
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a3
										lea     ((BATTLESCENE_ATTACKER-$1000000)).w,a4
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a5
										lea     (RAM_START).l,a6; beginning of battle scene command list
										move.b  #0,-BCSTACK_OFFSET_DEBUGDODGE(a2)
										move.b  #0,-BCSTACK_OFFSET_DEBUGCRIT(a2)
loc_9BB8:
										move.b  #0,-BCSTACK_OFFSET_DEBUGDOUBLE(a2)
loc_9BBE:
										move.b  #0,-BCSTACK_OFFSET_DEBUGCOUNTER(a2)
loc_9BC4:
										tst.b   (DEBUG_MODE_ACTIVATED).l
										beq.s   loc_9BE4
										btst    #INPUT_A_START_BIT,((P1_INPUT-$1000000)).w
										beq.s   loc_9BD8
loc_9BD4:
										bsr.w   DebugModeSelectAction
loc_9BD8:
										btst    #INPUT_A_START_BIT,((P2_INPUT-$1000000)).w
										beq.s   loc_9BE4
										bsr.w   DebugModeSelectHits
loc_9BE4:
										move.b  d0,((BATTLESCENE_ATTACKER-$1000000)).w
										move.b  d0,((word_FFB64F-$1000000)).w
										moveq   #0,d1
										move.w  d1,((RAM_BattleScene_EXPGain-$1000000)).w
										move.w  d1,((RAM_BattleScene_GoldGain-$1000000)).w
										move.w  d1,((RAM_BattleScene_AttackNumber-$1000000)).w
										move.b  d1,-BCSTACK_OFFSET_DOUBLE(a2)
										move.b  d1,-BCSTACK_OFFSET_COUNTER(a2)
										move.b  d1,-BCSTACK_OFFSET_SILENCED(a2)
										move.b  d1,-BCSTACK_OFFSET_INACTION_STUN(a2)
										move.b  d1,-BCSTACK_OFFSET_INACTION_CURSE(a2)
										move.b  d1,-BCSTACK_OFFSET_MUDDLED(a2)
										move.b  d1,-BCSTACK_OFFSET_SAMESIDE(a2)
										move.b  d1,-BCSTACK_OFFSET_RANGED(a2)
										move.b  d1,-$F(a2)
										move.b  d1,-BCSTACK_OFFSET_EXPLODE(a2)
loc_9C22:
										move.b  d1,-BCSTACK_OFFSET_INEFFECTIVEATTACK(a2)
										bsr.w   DetermineTargetsByAction
										bsr.w   InitSkirmishProperties
										bsr.w   CheckForTaros
loc_9C32:
										bsr.w   InitSkirmishDisplayedChars
										tst.b   -BCSTACK_OFFSET_INACTION_CURSE(a2)
										beq.s   loc_9C5A
										move.w  #$10,(a6)+
										move.w  #TEXTIDX_BATTLE_CURSEDSTUNNED,(a6)+
										move.b  #0,(a6)+
										move.b  (a4),(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										bra.w   loc_9DC4
loc_9C5A:
										tst.b   -BCSTACK_OFFSET_INACTION_STUN(a2)
										beq.s   loc_9C7E
										move.w  #$10,(a6)+
										move.w  #TEXTIDX_BATTLE_STUNNED,(a6)+
										move.b  #0,(a6)+
										move.b  (a4),(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										bra.w   loc_9DC4
loc_9C7E:
										bsr.w   CreateBattleSceneText
										bsr.w   CreateBattleSceneAnimation
										tst.b   -BCSTACK_OFFSET_SILENCED(a2)
										beq.s   loc_9CAA
										move.w  #$10,(a6)+
										move.w  #TEXTIDX_BATTLE_SILENCED,(a6)+
										move.b  #0,(a6)+
										move.b  (a4),(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										bra.w   loc_9DC4
loc_9CAA:
										moveq   #1,d6
										move.w  ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,d7
										subq.w  #1,d7
										bcs.w   loc_9DC4
loc_9CB6:
										moveq   #0,d1
										move.b  d1,-BCSTACK_OFFSET_DODGE(a2)
										move.b  d1,-BCSTACK_OFFSET_CRIT(a2)
										move.b  d1,-2(a2)
										move.b  d1,-BCSTACK_OFFSET_CUTOFF(a2)
										move.b  d1,-BCSTACK_OFFSET_TARGETDIES(a2)
										bsr.w   WriteSkirmishScript_SwitchTargets
										bsr.w   WriteSkirmishScript_DoAction
										bsr.w   WriteSkirmishScript_EnemyDropItem
										addq.w  #1,a5
										moveq   #2,d6
										dbf     d7,loc_9CB6
loc_9CE0:
										bsr.w   WriteSkirmishScript_IdleSprite
										bsr.w   WriteSkirmishScript_BreakUsedItem
										lea     ((BATTLESCENE_ATTACKER-$1000000)).w,a4
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a5
										bsr.w   FinalDoubleAttackCheck
										tst.b   -BCSTACK_OFFSET_DOUBLE(a2)
										beq.s   loc_9D3E
										move.w  #1,((RAM_BattleScene_AttackNumber-$1000000)).w
										moveq   #0,d1
										move.b  d1,-5(a2)
										move.b  d1,-3(a2)
										move.b  d1,-2(a2)
										move.b  d1,-1(a2)
										move.b  d1,-4(a2)
										move.b  d1,-$F(a2)
										move.w  #$C,(a6)+
										exg     a4,a5
										bsr.w   WriteSkirmishScript_SwitchTargets
										exg     a4,a5
										bsr.w   CreateBattleSceneText
										bsr.w   CreateBattleSceneAnimation
										bsr.w   WriteSkirmishScript_SwitchTargets
										bsr.w   WriteSkirmishScript_DoAction
										bsr.w   WriteSkirmishScript_EnemyDropItem
										bsr.w   WriteSkirmishScript_IdleSprite
loc_9D3E:
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a4
										lea     ((BATTLESCENE_ATTACKER-$1000000)).w,a5
										bsr.w   FinalCounterAttackCheck
										tst.b   -$C(a2)
										beq.s   loc_9D9C
										move.w  #2,((RAM_BattleScene_AttackNumber-$1000000)).w
										moveq   #0,d1
										move.b  d1,-5(a2)
										move.b  d1,-3(a2)
										move.b  d1,-2(a2)
										move.b  d1,-1(a2)
										move.b  d1,-4(a2)
										move.b  d1,-$F(a2)
										move.b  d1,-$E(a2)
										move.w  #$C,(a6)+
										exg     a4,a5
										bsr.w   WriteSkirmishScript_SwitchTargets
										exg     a4,a5
										lea     ((BATTLESCENE_ATTACKER-$1000000)).w,a5
loc_9D84:
										bsr.w   CreateBattleSceneText
										bsr.w   CreateBattleSceneAnimation
										bsr.w   WriteSkirmishScript_SwitchTargets
										bsr.w   WriteSkirmishScript_DoAction
										bsr.w   WriteSkirmishScript_EnemyDropItem
loc_9D98:
										bsr.w   WriteSkirmishScript_IdleSprite
loc_9D9C:
										lea     ((BATTLESCENE_ATTACKER-$1000000)).w,a4
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a5
										tst.b   -BCSTACK_OFFSET_EXPLODE(a2)
										beq.s   loc_9DC4
loc_9DAA:
										move.b  #0,-BCSTACK_OFFSET_EXPLODE(a2)
										move.w  #ACTION_BURSTROCK,(a3)
										move.b  -BCSTACK_OFFSET_EXPLODECHAR(a2),(a4)
										move.w  #$C,(a6)+
loc_9DBC:
										bsr.w   DetermineTargetsByAction
										bra.w   loc_9C7E
loc_9DC4:
										move.b  ((word_FFB64F-$1000000)).w,((BATTLESCENE_ATTACKER-$1000000)).w
										bsr.w   sub_A34E
										unlk    a2
										movem.l (sp)+,d0-a6
										rts

	; End of function WriteSkirmishScript


; =============== S U B R O U T I N E =======================================

; In: A3 = action data

DetermineTargetsByAction:
										
										cmpi.w  #0,(a3)
										bne.s   loc_9DEA
										move.w  #1,((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w
										move.b  3(a3),((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w
										bra.s   loc_9E5A
loc_9DEA:
										cmpi.w  #1,(a3)
										bne.s   loc_9E00
										move.w  2(a3),d1
										move.w  4(a3),d0
										jsr     CreateTargetGridFromSpell
										bra.s   loc_9E5A
loc_9E00:
										cmpi.w  #2,(a3)
										bne.w   loc_9E18
										move.w  2(a3),d1
										move.w  4(a3),d0
										jsr     j_sub_C5D6_0
										bra.s   loc_9E5A
loc_9E18:
										cmpi.w  #4,(a3)
										bne.w   loc_9E2E
										move.b  (a4),d0
										move.w  #$19,d1
										jsr     CreateTargetGridFromSpell
										bra.s   loc_9E5A
loc_9E2E:
										cmpi.w  #5,(a3)
										bne.w   loc_9E3E
										move.w  #0,((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w
										bra.s   loc_9E5A
loc_9E3E:
										cmpi.w  #6,(a3)
										bne.w   loc_9E5A
										jsr     MakeTargetListEverybody
										move.b  #$FF,((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w
										move.b  (a4),d0
										jsr     sub_1AC05C
loc_9E5A:
										bsr.w   SortTargets
										rts

	; End of function DetermineTargetsByAction


; =============== S U B R O U T I N E =======================================

InitSkirmishDisplayedChars:
										
										move.b  #$FF,d3
										move.b  #$FF,d4
										move.b  (a4),d0
										move.b  (a5),d1
										btst    #CHAR_BIT_ENEMY,d0
										bne.s   loc_9E8E
										move.b  d0,d3
										btst    #CHAR_BIT_ENEMY,d1
										beq.s   loc_9E82
										tst.b   -6(a2)
										bne.s   loc_9E82
										move.b  d1,d4
loc_9E82:
										cmpi.w  #ACTION_BURSTROCK,(a3)
										bne.s   loc_9E8C
										move.b  #$FF,d4
loc_9E8C:
										bra.s   loc_9EB2
loc_9E8E:
										move.b  d0,d4
										btst    #CHAR_BIT_ENEMY,d1
										bne.s   loc_9E9E
										tst.b   -BCSTACK_OFFSET_RANGED(a2)
										bne.s   loc_9E9E
										move.b  d1,d3
loc_9E9E:
										cmpi.w  #ACTION_BURSTROCK,(a3)
										bne.s   loc_9EA8
										move.b  #$FF,d3
loc_9EA8:
										cmpi.w  #ACTION_PRISMLASER,(a3)
										bne.s   loc_9EB2
										move.b  #$FF,d3
loc_9EB2:
										move.b  d3,((SKIRMISH_FIRST_ALLY-$1000000)).w
										move.b  d3,((SKIRMISH_LAST_ALLY-$1000000)).w
										move.b  d4,((SKIRMISH_FIRST_ENEMY-$1000000)).w
										move.b  d4,((SKIRMISH_LAST_ENEMY-$1000000)).w
										rts

	; End of function InitSkirmishDisplayedChars


; =============== S U B R O U T I N E =======================================

CheckForTaros:
										
										movem.l d0-d1,-(sp)
										cmpi.b  #BATTLEIDX_TAROS,((CURRENT_BATTLE-$1000000)).w
										bne.w   loc_9F22
										trap    #CLEAR_FLAG
										dc.w $70                ; cleared, set, and checked in ASM x09EC4..x09F27 (CheckForTaros ASM)
										tst.b   (a4)
										bne.w   loc_9F08
										cmpi.w  #ACTION_ATTACK,(a3)
										bne.w   loc_9F08
										move.b  (a5),d0
										jsr     GetEnemyID
										cmpi.w  #$58,d1 
										bne.w   loc_9F08
										move.b  (a4),d0
										jsr     GetEquippedWeapon
										cmpi.w  #ITEMIDX_ACHILLES_SWORD,d1
										bne.w   loc_9F08
										trap    #SET_FLAG
										dc.w $70                ; cleared, set, and checked in ASM x09EC4..x09F27 (CheckForTaros ASM)
loc_9F08:
										move.b  (a5),d0
										jsr     GetEnemyID
										cmpi.w  #$58,d1 
										bne.s   loc_9F22
										trap    #CHECK_FLAG
										dc.w $70                ; cleared, set, and checked in ASM x09EC4..x09F27 (CheckForTaros ASM)
										bne.s   loc_9F22
										move.b  #$FF,-BCSTACK_OFFSET_INEFFECTIVEATTACK(a2)
loc_9F22:
										movem.l (sp)+,d0-d1
										rts

	; End of function CheckForTaros


; =============== S U B R O U T I N E =======================================

; In: A2 = battle scene stack
;     A3 = address in RAM of scene action type
;     A4 = address in RAM of attacker idx
;     A5 = address in RAM of target idx

InitSkirmishProperties:
										
										movem.l d0-d3/a0,-(sp)
										lea     -$18(a2),a0
										move.w  #0,d0
										bra.s   loc_9F38
loc_9F36:
										addq.w  #1,d0
loc_9F38:
										cmpi.w  #COM_ALLY_END,d0
										bgt.s   loc_9F48
										jsr     GetCurrentHP
										move.w  d1,-(a0)
										bra.s   loc_9F36
loc_9F48:
										move.w  #COM_ENEMY_START,d0
										bra.s   loc_9F50
loc_9F4E:
										addq.w  #1,d0
loc_9F50:
										cmpi.w  #COM_ENEMY_END,d0
										bgt.s   loc_9F60
										jsr     GetCurrentHP
										move.w  d1,-(a0)
										bra.s   loc_9F4E
loc_9F60:
										cmpi.w  #ACTION_BURSTROCK,(a3)
										beq.w   loc_9F8E
										cmpi.w  #ACTION_PRISMLASER,(a3)
										beq.w   loc_9F8E
										move.b  (a4),d0
										jsr     GetStatus
										andi.w  #COM_STATUS_MASK_MUDDLE2,d1
										beq.s   loc_9F86
										move.b  #$FF,-BCSTACK_OFFSET_MUDDLED(a2)
										bra.s   loc_9F8E
loc_9F86:
										move.b  (a5),d1
										eor.b   d1,d0
										spl     -BCSTACK_OFFSET_SAMESIDE(a2)
loc_9F8E:
										cmpi.w  #ACTION_ATTACK,(a3)
										bne.s   loc_9FE6
										move.b  (a4),d0
										move.b  (a5),d1
loc_9F98:
										jsr     GetDistanceBetweenEntities
										cmpi.w  #2,d2           ; check if block distance between attacker and target is >= 2
										bcs.s   loc_9FB0
										tst.b   -BCSTACK_OFFSET_MUDDLED(a2)
										bne.s   loc_9FB0
										move.b  #$FF,-BCSTACK_OFFSET_RANGED(a2)
loc_9FB0:
										move.b  (a4),d0
loc_9FB2:
										jsr     GetStatus
										andi.w  #CHAR_STATUS_MASK_CURSE,d1
										beq.s   loc_9FCA
										moveq   #BATTLE_INACTIONCHANCEDIVISOR_CURSE,d0
										jsr     (GetRandomOrDebugValue).w
										tst.w   d0
										seq     -BCSTACK_OFFSET_INACTION_CURSE(a2)
loc_9FCA:
										move.b  (a4),d0
										jsr     GetStatus
										andi.w  #CHAR_STATUS_MASK_STUN,d1
										beq.s   loc_9FE4
										moveq   #BATTLE_INACTIONCHANCEDIVISOR_STUN,d0
										jsr     (GetRandomOrDebugValue).w
										tst.w   d0
										seq     -BCSTACK_OFFSET_INACTION_STUN(a2)
loc_9FE4:
										bra.s   loc_A056
loc_9FE6:
										cmpi.w  #ACTION_SPELL,(a3)
										bne.s   loc_A02A
										move.w  BTLSCENE_ACTION_OFFSET_ITEMORSPELL(a3),d0
										andi.w  #SPELL_MASK_IDX,d0
										move.w  d0,((CURRENT_BATTLE_SPELL_INDEX-$1000000)).w
										move.w  BTLSCENE_ACTION_OFFSET_ITEMORSPELL(a3),d0
										lsr.b   #SPELL_OFFSET_LV,d0
										andi.w  #SPELL_UPPERMASK_LV,d0
										move.w  d0,((CURRENT_BATTLE_SPELL_LEVEL-$1000000)).w
										move.w  ((CURRENT_BATTLE_SPELL_INDEX-$1000000)).w,d1
										jsr     j_GetSpellDefAddress
										btst    #SPELLDEF_PROPS_BIT_AFFECTEDBYSILENCE,SPELLDEF_OFFSET_PROPS(a0)
										beq.s   loc_A028
										move.b  (a4),d0
										jsr     GetStatus
										andi.w  #CHAR_STATUS_MASK_SILENCE,d1
										sne     -BCSTACK_OFFSET_SILENCED(a2)
loc_A028:
										bra.s   loc_A056
loc_A02A:
										cmpi.w  #ACTION_ITEM,(a3)
										bne.s   loc_A03A
										move.w  BTLSCENE_ACTION_OFFSET_ITEMORSPELL(a3),((CURRENT_BATTLE_ITEM-$1000000)).w
										bra.w   loc_A056
loc_A03A:
										cmpi.w  #ACTION_BURSTROCK,(a3)
										bne.s   loc_A044
										bra.w   loc_A056
loc_A044:
										cmpi.w  #ACTION_NOTHING,(a3)
										bne.s   loc_A04E
										bra.w   loc_A056
loc_A04E:
										cmpi.w  #ACTION_PRISMLASER,(a3)
										bne.w   *+4
loc_A056:
										movem.l (sp)+,d0-d3/a0
										rts

	; End of function InitSkirmishProperties


; =============== S U B R O U T I N E =======================================

; Loads proper battle scene text script depending on attack action.
; In: A3 = RAM index containing action type
;     A4 = RAM index containing attacker index
; HARDCODED enemy and text indexes

CreateBattleSceneText:
										
										movem.l d0-d3/a0,-(sp)
										move.b  (a4),d0
										cmpi.w  #0,(a3)
										bne.s   loc_A09E        ; HARDCODED attack lines
										move.w  ((RAM_BattleScene_AttackNumber-$1000000)).w,d2
										move.w  #$111,d1        ; {NAME}'s attack!
										tst.w   d2
										beq.w   loc_A086
										move.w  #$125,d1        ; {NAME}'s second{N}attack!
										cmpi.w  #1,d2
										beq.w   loc_A086
										move.w  #$124,d1        ; {NAME}'s counter{N}attack!
loc_A086:
										move.w  #$10,(a6)+
										move.w  d1,(a6)+
										move.w  d0,(a6)+
loc_A08E:
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										bra.w   loc_A1FA
loc_A09E:
										cmpi.w  #1,(a3)
										bne.w   loc_A150        ; HARDCODED spell text indexes !
										move.w  ((CURRENT_BATTLE_SPELL_INDEX-$1000000)).w,d2
										move.w  #$136,d1        ; {NAME} put on{N}a demon's smile.
										cmpi.w  #$F,d2
										beq.w   loc_A132
										move.w  #$116,d1        ; {NAME} belched{N}out flames!
										cmpi.w  #$11,d2
										beq.w   loc_A132
										cmpi.w  #$29,d2 
										beq.w   loc_A132
										move.w  #$117,d1        ; {NAME} blew out{N}a snowstorm!
										cmpi.w  #$12,d2
										beq.w   loc_A132
										move.w  #$114,d1        ; {NAME} cast{N}demon breath!
										cmpi.w  #$13,d2
										beq.w   loc_A132
										move.w  #$140,d1        ; Odd-eye beam!
										cmpi.w  #$2B,d2 
										beq.w   loc_A132
										move.w  #$11B,d1        ; {NAME} summoned{N}{SPELL}!{D1}
										cmpi.w  #$1D,d2
										beq.w   loc_A132
										cmpi.w  #$1E,d2
										beq.w   loc_A132
										cmpi.w  #$1F,d2
										beq.w   loc_A132
										cmpi.w  #$20,d2 
loc_A10E:
										beq.w   loc_A132
										move.w  2(a3),d2
										move.w  #$119,d1        ; {NAME} blew out{N}aqua-breath!
loc_A11A:
										cmpi.w  #$28,d2 
										beq.w   loc_A132
										move.w  #$11A,d1        ; {NAME} blew out{N}bubble-breath!
loc_A126:
										cmpi.w  #$68,d2 
										beq.w   loc_A132
										move.w  #$112,d1        ; {NAME} cast{N}{SPELL} level {#}!
loc_A132:
										move.w  ((CURRENT_BATTLE_SPELL_INDEX-$1000000)).w,d2
loc_A136:
										move.w  ((CURRENT_BATTLE_SPELL_LEVEL-$1000000)).w,d3
										addq.w  #1,d3
										move.w  #$10,(a6)+
										move.w  d1,(a6)+
										move.w  d0,(a6)+
										move.w  d2,(a6)+
										move.w  #0,(a6)+
										move.w  d3,(a6)+
										bra.w   loc_A1FA
loc_A150:
										cmpi.w  #2,(a3)
										bne.w   loc_A174
										move.w  ((CURRENT_BATTLE_ITEM-$1000000)).w,d2
										move.w  #$10,(a6)+
										move.w  #$113,(a6)+
										move.w  d0,(a6)+
										move.w  d2,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
loc_A170:
										bra.w   loc_A1FA
loc_A174:
										cmpi.w  #4,(a3)
										bne.w   loc_A194
										move.w  #$10,(a6)+
										move.w  #$13E,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										bra.s   loc_A1FA
loc_A194:
										cmpi.w  #5,(a3)
										bne.w   loc_A1CA
										move.w  d0,d2           ; random MUDDLE lines
										move.w  #$142,d1        ; {NAME} did nothing.
										moveq   #$10,d0
										jsr     (GetRandomOrDebugValue).w
										cmpi.w  #9,d0
										bls.s   loc_A1B0
										clr.w   d0
loc_A1B0:
										add.w   d0,d1
										move.w  d2,d0
										move.w  #$10,(a6)+
										move.w  d1,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										bra.s   loc_A1FA
loc_A1CA:
										cmpi.w  #6,(a3)
										bne.s   loc_A1FA
										jsr     GetEnemyID
										cmpi.w  #$26,d1 
										bne.s   loc_A1E2
										move.w  #$141,d1        ; Demon laser!
										bra.s   loc_A1E6
loc_A1E2:
										move.w  #$13F,d1
loc_A1E6:
										move.w  #$10,(a6)+
										move.w  d1,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
loc_A1FA:
										movem.l (sp)+,d0-d3/a0
										rts

	; End of function CreateBattleSceneText


; =============== S U B R O U T I N E =======================================

;     Loads proper battle scene sprite/magic animation properties.
;     In: A3 = 

CreateBattleSceneAnimation:
										
										movem.l d0-d3/a0,-(sp)
										move.b  (a4),d0
										cmpi.w  #1,(a3)
										bne.s   loc_A248
										move.w  2(a3),d1
										jsr     GetSpellCost    
										move.w  d1,d2
										neg.w   d2
loc_A21A:
										jsr     GetStatus
loc_A220:
										btst    #7,d0
										bne.s   loc_A238
										move.w  #$B,(a6)+
										move.w  #0,(a6)+
										move.w  d2,(a6)+
										move.w  d1,(a6)+
										move.w  #0,(a6)+
										bra.s   loc_A248
loc_A238:
										move.w  #$A,(a6)+
										move.w  #0,(a6)+
										move.w  d2,(a6)+
										move.w  d1,(a6)+
										move.w  #0,(a6)+
loc_A248:
										cmpi.w  #5,(a3)
										beq.w   loc_A348
										move.w  #$12,(a6)+
										bsr.w   GetEffectGraphicsIdx
										moveq   #0,d5
										tst.w   (a3)
										bne.s   loc_A2B6
										move.b  (a4),d0
										jsr     GetClass
										moveq   #$53,d5 ; hardcoded class-weapon association ?
										cmpi.w  #$14,d1
										beq.w   loc_A29C
										moveq   #$55,d5 
										cmpi.w  #$1D,d1
										beq.w   loc_A29C
										moveq   #$56,d5 
										cmpi.w  #$16,d1
										bne.s   loc_A296
										jsr     GetEquippedWeapon
										cmpi.w  #$FFFF,d1
										bne.s   loc_A296
										moveq   #$56,d5 
										moveq   #0,d4
										beq.w   loc_A304
loc_A296:
										moveq   #0,d5
										bra.w   loc_A304
loc_A29C:
										moveq   #$10,d0
										jsr     (GetRandomOrDebugValue).w
										tst.w   d0
										bne.s   loc_A2B0
										move.b  #$FF,-$F(a2)
										bra.w   loc_A304
loc_A2B0:
										moveq   #0,d5
										bra.w   loc_A304
loc_A2B6:
										cmpi.w  #1,(a3)
										bne.s   loc_A2FC
										move.b  (a4),d0
										jsr     GetClass
										moveq   #$54,d5 
										cmpi.w  #$1C,d1
										beq.w   loc_A304
										jsr     GetEnemyID
										moveq   #$76,d5 
										cmpi.w  #$1D,d1
										beq.w   loc_A304
										cmpi.w  #$18,d1
										beq.w   loc_A304
										moveq   #$77,d5 
										cmpi.w  #$36,d1 
										beq.w   loc_A304
										moveq   #$78,d5 
										cmpi.w  #$60,d1 
										beq.w   loc_A304
										moveq   #0,d5
loc_A2FC:
										cmpi.w  #2,(a3)
										bne.s   loc_A304
										moveq   #2,d5
loc_A304:
										bsr.w   WriteSkirmishScript_AnimateSprite
										cmpi.w  #4,(a3)
										bne.s   loc_A348
										move.w  #$8000,d2
										jsr     GetStatus
										btst    #7,d0
										bne.s   loc_A330
										move.w  #$B,(a6)+
										move.w  d2,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #1,(a6)+
										bra.s   loc_A340
loc_A330:
										move.w  #$A,(a6)+
										move.w  d2,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #1,(a6)+
loc_A340:
										moveq   #0,d1
										jsr     SetCurrentHP
loc_A348:
										movem.l (sp)+,d0-d3/a0
										rts

	; End of function CreateBattleSceneAnimation


; =============== S U B R O U T I N E =======================================

sub_A34E:
										movem.l d0-d3/a0,-(sp)
										move.w  #$D,(a6)+
										lea     ((BATTLESCENE_ATTACKER-$1000000)).w,a5
										moveq   #3,d6
										bsr.w   WriteSkirmishScript_SwitchTargets
										lea     ((BATTLESCENE_ATTACKER-$1000000)).w,a4
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a5
										tst.b   -BCSTACK_OFFSET_INACTION_CURSE(a2)
										bne.w   loc_A3B2
										tst.b   -BCSTACK_OFFSET_SILENCED(a2)
										bne.w   loc_A3B2
										tst.b   -BCSTACK_OFFSET_INACTION_STUN(a2)
										bne.w   loc_A3B2
										move.b  (a4),d0
										btst    #7,d0
										bne.s   loc_A396
										jsr     GetCurrentHP
										tst.w   d1
										beq.w   loc_A3B2
										bra.s   loc_A3AE
loc_A396:
										cmpi.w  #2,((RAM_BattleScene_AttackNumber-$1000000)).w
										bne.w   loc_A3B2
										move.b  (a5),d0
										jsr     GetCurrentHP
										tst.w   d1
										beq.w   loc_A3B2
loc_A3AE:
										bsr.w   WriteSkirmishScript_EXPandGold
loc_A3B2:
										lea     -$18(a2),a0
										move.w  #0,d0
										bra.s   loc_A3BE
loc_A3BC:
										addq.w  #1,d0
loc_A3BE:
										cmpi.w  #$1D,d0
										bgt.s   loc_A3CE
										move.w  -(a0),d1
										jsr     SetCurrentHP
										bra.s   loc_A3BC
loc_A3CE:
										move.w  #$80,d0 
										bra.s   loc_A3D6
loc_A3D4:
										addq.w  #1,d0
loc_A3D6:
										cmpi.w  #$9F,d0 
										bgt.s   loc_A3E6
										move.w  -(a0),d1
										jsr     SetCurrentHP
										bra.s   loc_A3D4
loc_A3E6:
										move.w  #$12,(a6)+
										move.w  #$FFFF,(a6)+
										movem.l (sp)+,d0-d3/a0
										rts

	; End of function sub_A34E


; =============== S U B R O U T I N E =======================================

; In: A2 = battle scene stack
;     A3 = address in RAM of scene action type
;     A4 = address in RAM of attacker idx
;     A5 = address in RAM of target idx

WriteSkirmishScript_DoAction:
										
										movem.l d0-d3/a0,-(sp)
										cmpi.w  #ACTION_ATTACK,(a3)
										bne.s   loc_A404
										bsr.w   WriteSkirmishScript_Attack
										bra.s   loc_A458
loc_A404:
										cmpi.w  #ACTION_SPELL,(a3)
										bne.s   loc_A410
										bsr.w   WriteSkirmishScript_UseSpell
										bra.s   loc_A458
loc_A410:
										cmpi.w  #ACTION_ITEM,(a3)
										bne.s   loc_A41C
										bsr.w   WriteSkirmishScript_UseItem
										bra.s   loc_A458
loc_A41C:
										cmpi.w  #ACTION_BURSTROCK,(a3)
										bne.s   loc_A436
										move.w  #$12,d6
										bsr.w   WriteSkirmishScript_InflictDamage
										tst.b   -BCSTACK_OFFSET_TARGETDIES(a2)
										beq.s   loc_A434
										bsr.w   WriteSkirmishScript_DeathMessage
loc_A434:
										bra.s   loc_A458
loc_A436:
										cmpi.w  #ACTION_NOTHING,(a3)
										bne.w   loc_A440
										bra.s   loc_A458
loc_A440:
										cmpi.w  #ACTION_PRISMLASER,(a3)
										bne.s   loc_A458
										move.w  #$10,d6
										bsr.w   WriteSkirmishScript_InflictDamage
										tst.b   -BCSTACK_OFFSET_TARGETDIES(a2)
										beq.s   loc_A458
										bsr.w   WriteSkirmishScript_DeathMessage
loc_A458:
										movem.l (sp)+,d0-d3/a0
										rts

	; End of function WriteSkirmishScript_DoAction


; =============== S U B R O U T I N E =======================================

FinalDoubleAttackCheck:
										
										movem.l d0-d3/a0,-(sp)
										tst.b   -$D(a2)
										beq.w   loc_A486
										tst.b   -4(a2)
										bne.w   loc_A486
										tst.b   -8(a2)
loc_A476:
										bne.w   loc_A486
										tst.b   -7(a2)
										bne.w   loc_A486
										bra.w   loc_A48A
loc_A486:
										clr.b   -$D(a2)
loc_A48A:
										tst.b   -$15(a2)
										beq.s   loc_A496
										move.b  #$FF,-$D(a2)
loc_A496:
										movem.l (sp)+,d0-d3/a0
										rts

	; End of function FinalDoubleAttackCheck


; =============== S U B R O U T I N E =======================================

FinalCounterAttackCheck:
										
										movem.l d0-d3/a0,-(sp)
										tst.b   -$C(a2)
										beq.w   loc_A538
										tst.b   -4(a2)
										bne.w   loc_A538
										tst.b   -8(a2)
										bne.w   loc_A538
										tst.b   -7(a2)
										bne.w   loc_A538
										move.b  (a4),d0
										jsr     j_GetStatus
										andi.w  #$C0,d1 
										bne.w   loc_A538
										jsr     j_GetStatus
										andi.w  #1,d1
										bne.w   loc_A538
										move.b  (a5),d0
										jsr     GetEnemyID
										cmpi.w  #$58,d1 
										beq.w   loc_A538
										move.b  (a4),d0
										jsr     GetEnemyID
										cmpi.w  #$20,d1 
										beq.w   loc_A538
										cmpi.w  #$57,d1 
										beq.w   loc_A538
										cmpi.w  #$5D,d1 
										beq.w   loc_A538
										cmpi.w  #$26,d1 
										beq.w   loc_A538
										move.b  (a4),d0
										move.b  (a5),d1
										jsr     GetDistanceBetweenEntities
										move.b  (a4),d0
										jsr     GetWeaponRange  
										cmp.b   d3,d2
										bhi.w   loc_A538
										cmp.b   d4,d2
										bcs.w   loc_A538
										bra.w   loc_A53C
loc_A538:
										clr.b   -$C(a2)
loc_A53C:
										tst.b   -$14(a2)
										beq.s   loc_A548
										move.b  #$FF,-$C(a2)
loc_A548:
										movem.l (sp)+,d0-d3/a0
										rts

	; End of function FinalCounterAttackCheck


; =============== S U B R O U T I N E =======================================

; In: A2 = cutscene stack
;     A3 = battle action in RAM
; Out: D4 = effect idx
; HARDCODED class, enemy and weapon indexes

GetEffectGraphicsIdx:
										
										movem.l d0-d3/a0,-(sp)
										moveq   #0,d4
										move.b  (a4),d0
										cmpi.w  #0,(a3)
										bne.w   loc_A662
										tst.b   -6(a2)
										beq.w   loc_A660
										moveq   #$10,d4
										btst    #7,d0
										bne.s   loc_A57E
										jsr     GetClass
										cmpi.b  #$16,d1
										beq.w   loc_A660
										bra.s   loc_A58C
loc_A57E:
										jsr     GetEnemyID
										cmpi.w  #$41,d1 
										beq.w   loc_A660
loc_A58C:
										jsr     GetEquippedWeapon
										moveq   #$D,d4
										cmpi.w  #$2D,d1 
										beq.w   loc_A660
										cmpi.w  #$2E,d1 
										beq.w   loc_A660
										cmpi.w  #$2F,d1 
										beq.w   loc_A660
										moveq   #$2D,d4 
										cmpi.w  #$30,d1 
										beq.w   loc_A660
										cmpi.w  #$31,d1 
										beq.w   loc_A660
										moveq   #$E,d4
										cmpi.w  #$33,d1 
										beq.w   loc_A660
										cmpi.w  #$35,d1 
										beq.w   loc_A660
										cmpi.w  #$36,d1 
										beq.w   loc_A660
										moveq   #$F,d4
										cmpi.w  #$32,d1 
										beq.w   loc_A660
										cmpi.w  #$34,d1 
										beq.w   loc_A660
										cmpi.w  #$37,d1 
										beq.w   loc_A660
										move.w  #$4D,d4 
										cmpi.w  #$48,d1 
										beq.w   loc_A660
										cmpi.w  #$49,d1 
										beq.w   loc_A660
										cmpi.w  #$4A,d1 
										beq.w   loc_A660
										cmpi.w  #$4B,d1 
										beq.w   loc_A660
										cmpi.w  #$4C,d1 
										beq.w   loc_A660
										cmpi.w  #$4D,d1 
										beq.w   loc_A660
										cmpi.w  #$4E,d1 
										beq.w   loc_A660
										cmpi.w  #$4F,d1 
										beq.w   loc_A660
										cmpi.w  #$50,d1 
										beq.w   loc_A660
										cmpi.w  #$51,d1 
										beq.w   loc_A660
										cmpi.w  #$52,d1 
										beq.w   loc_A660
										cmpi.w  #$53,d1 
loc_A652:
										beq.w   loc_A660
										cmpi.w  #$54,d1 
										beq.w   loc_A660
										moveq   #0,d4
loc_A660:
										bra.s   loc_A6D8
loc_A662:
										cmpi.w  #1,(a3)
										bne.s   loc_A680
										tst.b   -$B(a2)
										bne.s   loc_A67E
										move.w  2(a3),d1
										jsr     GetSpellDefAddress
										clr.w   d4
										move.b  2(a0),d4
loc_A67E:
										bra.s   loc_A6D8
loc_A680:
										cmpi.w  #2,(a3)
										bne.w   loc_A6B6
										move.w  2(a3),d1
										jsr     GetItemType     
										tst.b   d2
										beq.w   loc_A6B4
										jsr     GetItemDefAddress
										move.b  9(a0),d1
										cmpi.b  #$FF,d1
										beq.w   loc_A6B4
										jsr     GetSpellDefAddress
										move.b  2(a0),d4
loc_A6B4:
										bra.s   loc_A6D8
loc_A6B6:
										cmpi.w  #4,(a3)
										bne.w   loc_A6C2
										moveq   #$1E,d4
										bra.s   loc_A6D8
loc_A6C2:
										cmpi.w  #5,(a3)
										bne.w   loc_A6CE
										moveq   #0,d4
										bra.s   loc_A6D8
loc_A6CE:
										cmpi.w  #6,(a3)
										bne.w   loc_A6D8
										moveq   #$15,d4
loc_A6D8:
										btst    #7,(a4)
										beq.s   loc_A6E2
										bset    #7,d4
loc_A6E2:
										movem.l (sp)+,d0-d3/a0
										rts

	; End of function GetEffectGraphicsIdx


; =============== S U B R O U T I N E =======================================

;     Loads proper battle scene sprite animation properties.
;     In: D4 = projectile
;         D5 = special script idx

WriteSkirmishScript_AnimateSprite:
										
										btst    #7,(a4)
										bne.s   loc_A6F8
										move.w  #1,(a6)+
										move.w  d5,(a6)+
										move.w  d4,(a6)+
										bra.s   return_A700
loc_A6F8:
										move.w  #0,(a6)+
										move.w  d5,(a6)+
										move.w  d4,(a6)+
return_A700:
										
										rts

	; End of function WriteSkirmishScript_AnimateSprite


; =============== S U B R O U T I N E =======================================

WriteSkirmishScript_SwitchTargets:
										
										movem.l d0-d1,-(sp)
										move.b  (a5),d0
										jsr     GetCurrentHP
										tst.w   d1
										beq.w   loc_A7CA
										move.w  #$12,(a6)+
										move.w  d6,d1
										tst.b   -BCSTACK_OFFSET_SAMESIDE(a2)
										bne.w   loc_A72C
										tst.b   -BCSTACK_OFFSET_MUDDLED(a2)
										bne.w   loc_A72C
										moveq   #0,d1
loc_A72C:
										move.b  (a5),d0
										btst    #7,d0
										bne.s   loc_A780
										cmp.b   ((SKIRMISH_LAST_ALLY-$1000000)).w,d0
										beq.s   loc_A77E
										move.b  d0,((SKIRMISH_LAST_ALLY-$1000000)).w
										tst.b   -BCSTACK_OFFSET_RANGED(a2)
										bne.w   loc_A772
										cmpi.b  #$FF,((SKIRMISH_LAST_ENEMY-$1000000)).w
										beq.s   loc_A75E
										cmpi.w  #ACTION_BURSTROCK,(a3)
										beq.w   loc_A772
										cmpi.w  #ACTION_PRISMLASER,(a3)
										beq.w   loc_A772
loc_A75E:
										move.w  #$E,(a6)+
										move.w  #$1E,(a6)+
										move.w  #7,(a6)+
										move.w  d0,(a6)+
										move.w  d1,(a6)+
										bra.w   loc_A7CA
loc_A772:
										move.w  #9,(a6)+
										move.w  d0,(a6)+
										move.b  #$FF,((SKIRMISH_LAST_ENEMY-$1000000)).w
loc_A77E:
										bra.s   loc_A7CA
loc_A780:
										cmp.b   ((SKIRMISH_LAST_ENEMY-$1000000)).w,d0
										beq.s   loc_A7CA
										move.b  d0,((SKIRMISH_LAST_ENEMY-$1000000)).w
										tst.b   -BCSTACK_OFFSET_RANGED(a2)
										bne.w   loc_A7BE
										cmpi.b  #$FF,((SKIRMISH_LAST_ALLY-$1000000)).w
										beq.s   loc_A7AA
										cmpi.w  #ACTION_BURSTROCK,(a3)
										beq.w   loc_A7BE
										cmpi.w  #ACTION_PRISMLASER,(a3)
										beq.w   loc_A7BE
loc_A7AA:
										move.w  #$E,(a6)+
										move.w  #$1E,(a6)+
										move.w  #6,(a6)+
										move.w  d0,(a6)+
										move.w  d1,(a6)+
										bra.w   loc_A7CA
loc_A7BE:
										move.w  #8,(a6)+
										move.w  d0,(a6)+
										move.b  #$FF,((SKIRMISH_LAST_ALLY-$1000000)).w
loc_A7CA:
										movem.l (sp)+,d0-d1
										rts

	; End of function WriteSkirmishScript_SwitchTargets


; =============== S U B R O U T I N E =======================================

WriteSkirmishScript_IdleSprite:
										
										movem.l d1,-(sp)
										move.b  (a4),d0
										jsr     GetCurrentHP
										tst.w   d1
										beq.w   loc_A7F2
										btst    #CHAR_BIT_ENEMY,(a4)
										bne.s   loc_A7EE
										move.w  #5,(a6)+
										bra.s   loc_A7F2
loc_A7EE:
										move.w  #4,(a6)+
loc_A7F2:
										movem.l (sp)+,d1
										rts

	; End of function WriteSkirmishScript_IdleSprite


; =============== S U B R O U T I N E =======================================

WriteSkirmishScript_EXPandGold:
										
										movem.l d0-d1/a0,-(sp)
										move.w  ((RAM_BattleScene_EXPGain-$1000000)).w,d1
										tst.b   -7(a2)
										bne.w   loc_A81E
										move.b  ((CURRENT_BATTLE-$1000000)).w,d0
										lea     byte_A870(pc), a0
loc_A810:
										cmpi.b  #$FF,(a0)
										beq.w   loc_A81E
										cmp.b   (a0)+,d0
										bne.s   loc_A810
										lsr.w   #1,d1
loc_A81E:
										move.w  #$10,d0
										jsr     (GetRandomOrDebugValue).w
										tst.w   d0
										bne.s   loc_A82C
										addq.w  #1,d1
loc_A82C:
										move.w  #$10,d0
										jsr     (GetRandomOrDebugValue).w
										tst.w   d0
										bne.s   loc_A83A
										subq.w  #1,d1
loc_A83A:
										tst.w   d1
										bgt.s   loc_A840
										moveq   #1,d1
loc_A840:
										move.w  #$F,(a6)+
										move.w  d1,(a6)+
loc_A846:
										move.w  ((RAM_BattleScene_GoldGain-$1000000)).w,d1
										tst.w   d1
										beq.s   loc_A86A
										move.w  #$10,(a6)+
										move.w  #$189,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										jsr     IncreaseGold
loc_A86A:
										movem.l (sp)+,d0-d1/a0
										rts

	; End of function WriteSkirmishScript_EXPandGold

byte_A870:          dc.b 1
										dc.b $FF

; =============== S U B R O U T I N E =======================================

sub_A872:
										movem.l d0-d3/a0,-(sp)
										move.b  (a4),d0
										btst    #CHAR_BIT_ENEMY,d0
										bne.w   loc_A8C4
										jsr     GetClass
										cmpi.b  #4,d1
										beq.w   loc_A8A2
										cmpi.b  #$13,d1
										beq.w   loc_A8A2
										cmpi.b  #$14,d1
										beq.w   loc_A8A2
										bra.w   loc_A8C4
loc_A8A2:
										move.b  (a5),d0
loc_A8A4:
										jsr     GetMaxHP
										tst.w   d1
										beq.w   loc_A8C4
										move.w  #$19,d5
										mulu.w  d6,d5
										divu.w  d1,d5
										cmpi.w  #$A,d5
										bcc.s   loc_A8C0
										moveq   #$A,d5
loc_A8C0:
										bsr.w   GiveEXPandHealingCap
loc_A8C4:
										movem.l (sp)+,d0-d3/a0
										rts

	; End of function sub_A872


; =============== S U B R O U T I N E =======================================

CalculateDamageEXP:
										
										movem.l d0-d3/a0,-(sp)
										btst    #7,(a4)
										bne.w   loc_A8F0
										move.b  (a5),d0
										jsr     GetMaxHP
										tst.w   d1
										beq.w   loc_A8F0
										bsr.w   GetAmountOfEXPForEncounter
										mulu.w  d6,d5
										divu.w  d1,d5
										bsr.w   GiveEXPandCap
loc_A8F0:
										movem.l (sp)+,d0-d3/a0
										rts

	; End of function CalculateDamageEXP


; =============== S U B R O U T I N E =======================================

GiveMagicDrainEXP:
										
										movem.l d0-d3/a0,-(sp)
										btst    #CHAR_BIT_ENEMY,(a4)
										bne.w   loc_A908
										moveq   #5,d5
										bsr.w   GiveEXPandCap
loc_A908:
										movem.l (sp)+,d0-d3/a0
										rts

	; End of function GiveMagicDrainEXP


; =============== S U B R O U T I N E =======================================

GiveEXPandGoldForKill:
										
										movem.l d0-d3/a0,-(sp)
										btst    #CHAR_BIT_ENEMY,(a4)
										bne.w   loc_A93A
										bsr.w   GetAmountOfEXPForEncounter
										bsr.w   GiveEXPandCap
										move.b  (a5),d0
										bpl.s   loc_A93A
loc_A926:
										jsr     GetEnemyID
										add.w   d1,d1
										lea     EnemyGold(pc), a0
										adda.w  d1,a0
										move.w  (a0),d0
										add.w   d0,((RAM_BattleScene_GoldGain-$1000000)).w
loc_A93A:
										movem.l (sp)+,d0-d3/a0
										rts

	; End of function GiveEXPandGoldForKill


; =============== S U B R O U T I N E =======================================

GiveEXPandCap:
										
										add.w   d5,((RAM_BattleScene_EXPGain-$1000000)).w
										cmpi.w  #$31,((RAM_BattleScene_EXPGain-$1000000)).w 
										ble.s   return_A952
										move.w  #$31,((RAM_BattleScene_EXPGain-$1000000)).w 
return_A952:
										
										rts

	; End of function GiveEXPandCap


; =============== S U B R O U T I N E =======================================

GiveEXPandHealingCap:
										
										add.w   d5,((RAM_BattleScene_EXPGain-$1000000)).w
										cmpi.w  #$19,((RAM_BattleScene_EXPGain-$1000000)).w
										ble.s   return_A966
										move.w  #$19,((RAM_BattleScene_EXPGain-$1000000)).w
return_A966:
										
										rts

	; End of function GiveEXPandHealingCap


; =============== S U B R O U T I N E =======================================

; Gets amount of EXP gained from encounter based on attacker level and target level.
; In: A4 = address of attacker byte in RAM
;     A5 = address of target byte in RAM
; Out: D5 = amount of EXP

GetAmountOfEXPForEncounter:
										
										movem.l d0-d3/a0,-(sp)
										move.b  (a5),d0
										jsr     GetCurrentLevel
										move.w  d1,d2
										move.b  (a4),d0
										jsr     GetClass
										move.w  d1,d3
										jsr     GetCurrentLevel
										cmpi.b  #CHAR_CLASS_FIRSTPROMOTED,d3
										bcs.s   loc_A990
										addi.w  #CHAR_CLASS_EXTRALEVEL,d1
loc_A990:
										sub.w   d2,d1
										moveq   #$32,d5 ; HARDCODED EXP amounts
										cmpi.b  #3,d1
										bmi.w   loc_A9C6
										moveq   #$28,d5 
										cmpi.b  #3,d1
										beq.w   loc_A9C6
										moveq   #$1E,d5
										cmpi.b  #4,d1
										beq.w   loc_A9C6
										moveq   #$14,d5
										cmpi.b  #5,d1
										beq.w   loc_A9C6
										moveq   #$A,d5
										cmpi.b  #6,d1
										beq.w   loc_A9C6
										moveq   #0,d5
loc_A9C6:
										movem.l (sp)+,d0-d3/a0
										rts

	; End of function GetAmountOfEXPForEncounter


; =============== S U B R O U T I N E =======================================

SortTargets:
										
										movem.l d0-d2/d6-a0,-(sp)
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a0
										move.w  ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,d7
										subq.w  #1,d7
										bls.w   loc_AA92
loc_A9DE:
										move.b  (a0,d7.w),d0
										bpl.s   loc_A9F8
										jsr     GetEnemyID
										cmpi.w  #ENEMYIDX_BURST_ROCK,d1
										bne.s   loc_A9F8
										ori.b   #$40,d0 
										move.b  d0,(a0,d7.w)
loc_A9F8:
										dbf     d7,loc_A9DE
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a0
										moveq   #0,d0
										move.w  ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,d7
										subq.w  #1,d7
										subq.w  #1,d7
loc_AA0A:
										move.w  d0,d1
										addq.w  #1,d1
loc_AA0E:
										move.b  (a0,d0.w),d2
										cmp.b   (a0,d1.w),d2
										bcs.s   loc_AA22
										move.b  (a0,d1.w),(a0,d0.w)
										move.b  d2,(a0,d1.w)
loc_AA22:
										addq.w  #1,d1
										cmp.w   ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,d1
										bcs.w   loc_AA0E
										addq.w  #1,d0
										dbf     d7,loc_AA0A
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a0
										move.w  ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,d7
										subq.w  #1,d7
										subq.w  #1,d7
										moveq   #0,d6
loc_AA40:
										btst    #COM_BIT_SORT,(a0,d6.w)
										beq.s   loc_AA78
										move.b  (a0,d6.w),d0
										andi.b  #$BF,d0
										jsr     GetCurrentHP
										move.w  d1,d2
										move.b  1(a0,d6.w),d0
										andi.b  #$BF,d0
										jsr     GetCurrentHP
										cmp.w   d1,d2
										bcc.s   loc_AA78
										move.b  (a0,d6.w),d0
										move.b  1(a0,d6.w),(a0,d6.w)
										move.b  d0,1(a0,d6.w)
loc_AA78:
										addq.w  #1,d6
										dbf     d7,loc_AA40
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a0
										move.w  ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,d7
										subq.w  #1,d7
loc_AA88:
										andi.b  #$BF,(a0,d7.w)
loc_AA8E:
										dbf     d7,loc_AA88
loc_AA92:
										movem.l (sp)+,d0-d2/d6-a0
										rts

	; End of function SortTargets


; =============== S U B R O U T I N E =======================================

OneSecondSleep:
										
										move.l  d0,-(sp)
										moveq   #60,d0
										jsr     (Sleep).w       
										move.l  (sp)+,d0
										rts

	; End of function OneSecondSleep


; =============== S U B R O U T I N E =======================================

NopOnce:
										nop
										rts

	; End of function NopOnce


; =============== S U B R O U T I N E =======================================

NopTwice:
										nop
										nop
										rts

	; End of function NopTwice


; =============== S U B R O U T I N E =======================================

NopThrice:
										
										nop
										nop
										nop
										rts

	; End of function NopThrice


; =============== S U B R O U T I N E =======================================

WriteSkirmishScript_Attack:
										
										bsr.w   WriteSkirmishScript_DodgeAttack
										tst.b   -BCSTACK_OFFSET_DODGE(a2)
										bne.w   loc_AAF6
										bsr.w   CalculateDamage 
										bsr.w   CalculateCriticalHit
										bsr.w   WriteSkirmishScript_InflictDamage
										tst.b   -BCSTACK_OFFSET_TARGETDIES(a2)
										beq.s   loc_AADC
										bsr.w   WriteSkirmishScript_DeathMessage
										bra.w   return_AAFA
loc_AADC:
										bsr.w   WriteSkirmishScript_InflictAilment
										bsr.w   WriteSkirmishScript_InflictCurseDamage
										tst.b   -BCSTACK_OFFSET_TARGETDIES(a2)
										beq.s   loc_AAF6
										exg     a4,a5
										bsr.w   WriteSkirmishScript_DeathMessage
										exg     a4,a5
										bra.w   return_AAFA
loc_AAF6:
										bsr.w   DetermineDoubleAndCounter
return_AAFA:
										
										rts

	; End of function WriteSkirmishScript_Attack


; =============== S U B R O U T I N E =======================================

WriteSkirmishScript_DodgeAttack:
										
										move.b  (a5),d0
										jsr     j_GetStatus
										andi.w  #COM_STATUS_MASK_SLEEP,d1
										bne.w   return_ABBC
										jsr     j_GetStatus
										andi.w  #1,d1
										bne.w   return_ABBC
										moveq   #2,d2
										move.b  (a4),d0
										jsr     GetStatus
										andi.w  #COM_STATUS_MASK_MUDDLE,d1
										bne.w   loc_AB74
										moveq   #$20,d2 
										move.b  (a5),d0
										jsr     GetUpperMoveType
										cmpi.w  #5,d1
										beq.w   loc_AB4A
										cmpi.w  #6,d1
										beq.w   loc_AB4A
										bra.w   loc_AB74
loc_AB4A:
										move.b  (a4),d0
										jsr     GetUpperMoveType
										cmpi.w  #4,d1
										beq.w   loc_AB74
										cmpi.w  #8,d1
										beq.w   loc_AB74
										cmpi.w  #9,d1
										beq.w   loc_AB74
										cmpi.w  #$A,d1
										beq.w   loc_AB74
										moveq   #8,d2
loc_AB74:
										tst.b   -$17(a2)
										beq.s   loc_AB7C
										moveq   #0,d2
loc_AB7C:
										move.w  d2,d0
										jsr     (GetRandomOrDebugValue).w
										tst.w   d0
										bne.w   return_ABBC
										move.w  #$FFFF,d4
										move.w  #1,d5
										exg     a4,a5
										bsr.w   WriteSkirmishScript_AnimateSprite
										move.w  #$10,(a6)+
										move.w  #TEXTIDX_BATTLE_DODGE,(a6)+
										move.b  #0,(a6)+
										move.b  (a4),(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										bsr.w   WriteSkirmishScript_IdleSprite
										exg     a4,a5
										move.b  #$FF,-BCSTACK_OFFSET_DODGE(a2)
return_ABBC:
										
										rts

	; End of function WriteSkirmishScript_DodgeAttack


; =============== S U B R O U T I N E =======================================

; In: A4 = attacker index in RAM
;     A5 = defender index in RAM
; Out: D6 = damage

CalculateDamage:
										
										move.b  (a4),d0
										jsr     GetCurrentATK
										move.w  d1,d2
										move.b  (a5),d0
										jsr     GetCurrentDEF
										sub.w   d1,d2
										bhi.s   loc_ABD6
										moveq   #1,d2
loc_ABD6:
										move.w  d2,d6
										move.b  (a5),d0
										jsr     GetMoveCost
										move.w  #$100,d3
										tst.b   d1
										beq.w   loc_ABFA
										move.w  #$E6,d3 
										cmpi.b  #1,d1
loc_ABF2:
										beq.w   loc_ABFA
										move.w  #$CD,d3 
loc_ABFA:
										mulu.w  d3,d6
										lsr.w   #8,d6
										move.b  (a5),d0
loc_AC00:
										jsr     GetUpperMoveType
										cmpi.w  #5,d1
										beq.w   loc_AC1A
										cmpi.w  #6,d1
										beq.w   loc_AC1A
										bra.w   return_AC4C
loc_AC1A:
										move.b  (a4),d0
										jsr     GetUpperMoveType
										cmpi.w  #4,d1
										beq.w   loc_AC46
										cmpi.w  #8,d1
										beq.w   loc_AC46
										cmpi.w  #9,d1
										beq.w   loc_AC46
										cmpi.w  #$A,d1
										beq.w   loc_AC46
										bra.w   return_AC4C
loc_AC46:
										move.w  d6,d0
										lsr.w   #2,d0
										add.w   d0,d6
return_AC4C:
										
										rts

	; End of function CalculateDamage


; =============== S U B R O U T I N E =======================================

CalculateCriticalHit:
										
										move.b  (a4),d0
										jsr     GetCurrentProwess
										andi.w  #CHAR_PROWESS_MASK_CRIT,d1
										move.w  d1,d2
										lsl.w   #1,d2
										lea     CriticalHitSettings(pc,d2.w),a0
										clr.w   d0
										move.b  (a0),d0
										beq.s   return_ACC8     ; skip function if 0 crit chance
										tst.b   -$F(a2)
										beq.s   loc_AC70
										moveq   #1,d0
loc_AC70:
										tst.b   -BCSTACK_OFFSET_DEBUGCRIT(a2)
										beq.s   loc_AC78
										moveq   #0,d0
loc_AC78:
										jsr     (GetRandomOrDebugValue).w
										tst.w   d0
										bne.s   return_ACC8
										move.b  1(a0),d0
										beq.s   loc_AC8C
										move.w  d6,d2
										lsr.w   d0,d2
										add.w   d2,d6
loc_AC8C:
										cmpi.w  #9,d1
										bcc.s   loc_ACC2
										move.b  #$FF,-3(a2)
										move.b  (a4),d0
										jsr     GetEquippedWeapon
										cmpi.w  #ITEMIDX_GISARME,d1
										bne.s   loc_ACC0
										move.b  (a5),d0
										move.w  #SPELLIDX_DESOUL,d1
										bsr.w   GetResistanceToSpell
										cmpi.w  #3,d2
										beq.s   loc_ACC0
										move.b  #$FF,-BCSTACK_OFFSET_CUTOFF(a2)
										clr.b   -BCSTACK_OFFSET_CRIT(a2)
loc_ACC0:
										bra.s   return_ACC8
loc_ACC2:
										move.b  #$FF,-2(a2)
return_ACC8:
										
										rts

	; End of function CalculateCriticalHit

CriticalHitSettings:incbin "data/allies/classes/criticalhitsettings.bin"
																						; values regarding critical hit chance/double attack/etc?

; =============== S U B R O U T I N E =======================================

; In: D6 = damage

WriteSkirmishScript_InflictDamage:
										
										move.b  (a5),d0
										jsr     GetEnemyID
										cmpi.w  #ENEMYIDX_TAROS,d1
										bne.s   loc_AD1C
										tst.b   -BCSTACK_OFFSET_INEFFECTIVEATTACK(a2)
										beq.s   loc_AD1C
										move.w  #$10,(a6)+
										move.w  #TEXTIDX_BATTLE_INEFFECTIVEATTACK,(a6)+
										move.b  #0,(a6)+
										move.b  (a5),(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										bra.w   return_AE30
loc_AD1C:
										cmpi.w  #2,((RAM_BattleScene_AttackNumber-$1000000)).w
										bne.s   loc_AD26
										lsr.w   #1,d6
loc_AD26:
										move.b  (a5),d0
										jsr     GetEnemyID
										cmpi.w  #ENEMYIDX_BURST_ROCK,d1
										bne.s   loc_AD3E
										tst.w   d6
										bne.s   loc_AD3A
										moveq   #1,d6
loc_AD3A:
										bra.w   loc_AD58
loc_AD3E:
										move.w  d6,d1
										lsr.w   #3,d1
										addq.w  #1,d1
										move.w  d1,d0
										jsr     (GetRandomOrDebugValue).w
										sub.w   d0,d6
										move.w  d1,d0
										jsr     (GetRandomOrDebugValue).w
										sub.w   d0,d6
										bgt.s   loc_AD58
										moveq   #1,d6
loc_AD58:
										jsr     CalculateDamageEXP
										tst.b   -BCSTACK_OFFSET_CUTOFF(a2)
										beq.s   loc_AD74
										move.w  #$18,d4
										move.w  #$FFFF,d5
										bsr.w   WriteSkirmishScript_AnimateSprite
										move.w  #$8000,d6
loc_AD74:
										move.b  (a5),d0
										move.w  d6,d1
										jsr     DecreaseCurrentHP
										jsr     GetCurrentHP
										tst.w   d1
										bne.s   loc_AD92
										move.b  #$FF,-BCSTACK_OFFSET_TARGETDIES(a2)
										bsr.w   GiveEXPandGoldForKill
loc_AD92:
										move.b  (a5),d0
										move.w  d6,d2
										neg.w   d2
										tst.b   -BCSTACK_OFFSET_TARGETDIES(a2)
										beq.s   loc_ADBA
										jsr     GetEnemyID
										cmpi.b  #ENEMYIDX_BURST_ROCK,d1
										bne.s   loc_ADBA
										tst.w   d7
										bne.s   loc_ADBA
										move.b  #$FF,-BCSTACK_OFFSET_EXPLODE(a2)
										move.b  d0,-BCSTACK_OFFSET_EXPLODECHAR(a2)
										moveq   #0,d2
loc_ADBA:
										jsr     GetStatus
										btst    #7,d0
										bne.s   loc_ADD8
										move.w  #$B,(a6)+
										move.w  d2,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #1,(a6)+
										bra.s   loc_ADE8
loc_ADD8:
										move.w  #$A,(a6)+
										move.w  d2,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #1,(a6)+
loc_ADE8:
										btst    #CHAR_BIT_ENEMY,(a4)
										bne.s   loc_AE00
										tst.b   -BCSTACK_OFFSET_CRIT(a2)
										beq.s   loc_ADFA
										move.w  #TEXTIDX_BATTLE_CRITDAMAGE,d1
										bra.s   loc_ADFE
loc_ADFA:
										move.w  #TEXTIDX_BATTLE_DAMAGE_ALLY,d1
loc_ADFE:
										bra.s   loc_AE10
loc_AE00:
										tst.b   -BCSTACK_OFFSET_CRIT(a2)
										beq.s   loc_AE0C
										move.w  #TEXTIDX_BATTLE_HEAVYDAMAGE,d1
										bra.s   loc_AE10
loc_AE0C:
										move.w  #TEXTIDX_BATTLE_DAMAGE_ENEMY,d1
loc_AE10:
										tst.b   -BCSTACK_OFFSET_CUTOFF(a2)
										beq.s   loc_AE1A
										move.w  #TEXTIDX_BATTLE_CUTOFF,d1
loc_AE1A:
										move.w  #$10,(a6)+
										move.w  d1,(a6)+
										move.b  #0,(a6)+
										move.b  (a5),(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d6,(a6)+
return_AE30:
										
										rts

	; End of function WriteSkirmishScript_InflictDamage


; =============== S U B R O U T I N E =======================================

WriteSkirmishScript_InflictAilment:
										
										tst.b   -2(a2)
										beq.w   return_AE88
										move.b  (a4),d0
										jsr     GetCurrentProwess
										andi.w  #$F,d1
										move.w  d1,d2
										subi.w  #9,d2
										move.b  (a5),d0
										jsr     GetStatus
										lsl.w   #2,d2
										movea.l SkirmishAilmentFuncTable(pc,d2.w),a1
										jsr     (a1)
										btst    #7,d0
										bne.s   loc_AE76
										move.w  #$B,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
loc_AE70:
										move.w  #0,(a6)+
										bra.s   return_AE88
loc_AE76:
										move.w  #$A,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #0,(a6)+
return_AE88:
										
										rts

	; End of function WriteSkirmishScript_InflictAilment

SkirmishAilmentFuncTable:
										dc.l WriteSkirmishScript_InflictPoison
										dc.l WriteSkirmishScript_InflictSleep
										dc.l WriteSkirmishScript_InflictStun
										dc.l WriteSkirmishScript_InflictMuddle
										dc.l WriteSkirmishScript_InflictSlow
										dc.l WriteSkirmishScript_DrainMP
										dc.l WriteSkirmishScript_InflictSilence

; =============== S U B R O U T I N E =======================================

WriteSkirmishScript_InflictPoison:
										
										move.w  #$11,(a6)+
										move.w  #$153,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										ori.w   #2,d1
										rts

	; End of function WriteSkirmishScript_InflictPoison


; =============== S U B R O U T I N E =======================================

WriteSkirmishScript_InflictSleep:
										
										move.w  #$11,(a6)+
										move.w  #$152,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										ori.w   #$C0,d1 
										rts

	; End of function WriteSkirmishScript_InflictSleep


; =============== S U B R O U T I N E =======================================

WriteSkirmishScript_InflictStun:
										
										move.w  #$11,(a6)+
										move.w  #$15B,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										ori.w   #1,d1
										rts

	; End of function WriteSkirmishScript_InflictStun


; =============== S U B R O U T I N E =======================================

WriteSkirmishScript_InflictMuddle:
										
										move.w  #$11,(a6)+
										move.w  #$15A,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
loc_AF08:
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										ori.w   #8,d1
										ori.w   #$30,d1 
										rts

	; End of function WriteSkirmishScript_InflictMuddle


; =============== S U B R O U T I N E =======================================

WriteSkirmishScript_InflictSlow:
										
										movem.l d0-d1,-(sp)
										bsr.w   WriteSkirmishScript_SlowMessage
										movem.l (sp)+,d0-d1
										ori.w   #$C00,d1
										rts

	; End of function WriteSkirmishScript_InflictSlow


; =============== S U B R O U T I N E =======================================

WriteSkirmishScript_DrainMP:
										
										movem.l d0-d1,-(sp)
										jsr     GetCurrentMP
										tst.w   d1
										beq.s   loc_AF3E
										bsr.w   sub_B5D6
loc_AF3E:
										movem.l (sp)+,d0-d1
										rts

	; End of function WriteSkirmishScript_DrainMP


; =============== S U B R O U T I N E =======================================

WriteSkirmishScript_InflictSilence:
										
										move.w  d1,d3
										moveq   #0,d1
										jsr     GetSpellAndNumberOfSpells
										tst.w   d2
										beq.s   loc_AF6C
										move.w  #$11,(a6)+
										move.w  #$14F,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										ori.w   #$300,d3
loc_AF6C:
										move.w  d3,d1
										rts

	; End of function WriteSkirmishScript_InflictSilence


; =============== S U B R O U T I N E =======================================

WriteSkirmishScript_InflictCurseDamage:
										
										move.b  (a4),d0
										btst    #7,d0
										bne.w   return_B00C
										jsr     GetStatus
										btst    #2,d1
										beq.w   return_B00C
										moveq   #2,d0
loc_AF8A:
										jsr     (GetRandomOrDebugValue).w
										tst.w   d0
										beq.w   return_B00C
										exg     a4,a5
										bsr.w   WriteSkirmishScript_SwitchTargets
										exg     a4,a5
										bsr.w   WriteSkirmishScript_IdleSprite
										move.b  (a4),d0
										move.w  d6,d3
										lsr.w   #3,d3
										addq.w  #1,d3
										move.w  d3,d1
										jsr     DecreaseCurrentHP
										jsr     GetCurrentHP
										tst.w   d1
										bne.s   loc_AFC0
loc_AFBA:
										move.b  #$FF,-4(a2)
loc_AFC0:
										move.w  d3,d2
										neg.w   d2
										move.b  (a4),d0
										jsr     GetStatus
										btst    #7,d0
										bne.s   loc_AFE4
										move.w  #$B,(a6)+
										move.w  d2,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #1,(a6)+
										bra.s   loc_AFF4
loc_AFE4:
										move.w  #$A,(a6)+
										move.w  d2,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #1,(a6)+
loc_AFF4:
										move.w  #$12,(a6)+
										move.w  #$10,(a6)+
										move.w  #$168,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d3,(a6)+
return_B00C:
										
										rts

	; End of function WriteSkirmishScript_InflictCurseDamage


; =============== S U B R O U T I N E =======================================

DetermineDoubleAndCounter:
										
										move.b  (a4),d0
loc_B010:
										jsr     GetCurrentProwess
										lsr.b   #4,d1
										moveq   #$20,d0 
										andi.w  #3,d1
										beq.w   loc_B038
										moveq   #$10,d0
										cmpi.b  #1,d1
										beq.w   loc_B038
										moveq   #8,d0
										cmpi.b  #2,d1
										beq.w   loc_B038
										moveq   #4,d0
loc_B038:
										jsr     (GetRandomOrDebugValue).w
										tst.w   d0
										bne.s   loc_B046
										move.b  #$FF,-BCSTACK_OFFSET_DOUBLE(a2)
loc_B046:
										move.b  (a5),d0
										jsr     GetCurrentProwess
										lsr.b   #6,d1
										moveq   #$20,d0 
										andi.w  #3,d1
										beq.w   loc_B070
										moveq   #$10,d0
										cmpi.b  #1,d1
										beq.w   loc_B070
										moveq   #8,d0
										cmpi.b  #2,d1
										beq.w   loc_B070
										moveq   #4,d0
loc_B070:
										jsr     (GetRandomOrDebugValue).w
										tst.w   d0
										bne.s   return_B07E
										move.b  #$FF,-BCSTACK_OFFSET_COUNTER(a2)
return_B07E:
										
										rts

	; End of function DetermineDoubleAndCounter


; =============== S U B R O U T I N E =======================================

WriteSkirmishScript_DeathMessage:
										
										move.b  (a5),d0
										btst    #7,d0
										bne.s   loc_B08E
										move.w  #$123,d1
										bra.s   loc_B092
loc_B08E:
										move.w  #$122,d1
loc_B092:
										move.w  #$10,(a6)+
										move.w  d1,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										rts

	; End of function WriteSkirmishScript_DeathMessage


; =============== S U B R O U T I N E =======================================

; In: A2 = battle scene stack
;     A3 = address in RAM of scene action type
;     A4 = address in RAM of attacker idx
;     A5 = address in RAM of target idx

WriteSkirmishScript_UseSpell:
										
										move.b  (a5),d0
										move.w  ((CURRENT_BATTLE_SPELL_INDEX-$1000000)).w,d1
										bsr.w   GetResistanceToSpell
										add.w   d1,d1
										move.w  rjt_ItemUsedEffects(pc,d1.w),d1
										jmp     rjt_ItemUsedEffects(pc,d1.w)

	; End of function WriteSkirmishScript_UseSpell

rjt_ItemUsedEffects:dc.w sub_B114-rjt_ItemUsedEffects
										dc.w sub_B114-rjt_ItemUsedEffects
										dc.w sub_B194-rjt_ItemUsedEffects
										dc.w sub_B27C-rjt_ItemUsedEffects
										dc.w sub_B30E-rjt_ItemUsedEffects
										dc.w sub_B3A8-rjt_ItemUsedEffects
										dc.w sub_B41A-rjt_ItemUsedEffects
										dc.w sub_B488-rjt_ItemUsedEffects
										dc.w sub_B516-rjt_ItemUsedEffects
										dc.w sub_B57E-rjt_ItemUsedEffects
										dc.w nullsub_8-rjt_ItemUsedEffects
										dc.w sub_BADC-rjt_ItemUsedEffects
										dc.w sub_BAE2-rjt_ItemUsedEffects
										dc.w sub_BAF4-rjt_ItemUsedEffects
										dc.w sub_BAFA-rjt_ItemUsedEffects
										dc.w sub_B5D6-rjt_ItemUsedEffects
										dc.w sub_B114-rjt_ItemUsedEffects
										dc.w sub_BAD6-rjt_ItemUsedEffects
										dc.w sub_BAE2-rjt_ItemUsedEffects
										dc.w sub_BB00-rjt_ItemUsedEffects
										dc.w sub_B680-rjt_ItemUsedEffects
										dc.w sub_B6E6-rjt_ItemUsedEffects
										dc.w sub_B74C-rjt_ItemUsedEffects
										dc.w sub_B7B2-rjt_ItemUsedEffects
										dc.w sub_B826-rjt_ItemUsedEffects
										dc.w nullsub_8-rjt_ItemUsedEffects
										dc.w nullsub_8-rjt_ItemUsedEffects
										dc.w sub_BADC-rjt_ItemUsedEffects
										dc.w sub_BAF4-rjt_ItemUsedEffects
										dc.w sub_BAFA-rjt_ItemUsedEffects
										dc.w sub_BADC-rjt_ItemUsedEffects
										dc.w sub_BAE8-rjt_ItemUsedEffects
										dc.w sub_BAF4-rjt_ItemUsedEffects
										dc.w sub_B194-rjt_ItemUsedEffects
										dc.w sub_BA1C-rjt_ItemUsedEffects
										dc.w sub_B886-rjt_ItemUsedEffects
										dc.w sub_B8F8-rjt_ItemUsedEffects
										dc.w sub_BADC-rjt_ItemUsedEffects
										dc.w sub_BAE2-rjt_ItemUsedEffects
										dc.w sub_BAF4-rjt_ItemUsedEffects
										dc.w sub_BAEE-rjt_ItemUsedEffects
										dc.w sub_BAD6-rjt_ItemUsedEffects
										dc.w sub_BA1C-rjt_ItemUsedEffects
										dc.w sub_BAF4-rjt_ItemUsedEffects

; =============== S U B R O U T I N E =======================================

sub_B114:
										move.b  (a5),d0
										jsr     GetMaxHP
										move.w  d1,d2
										jsr     GetCurrentHP
										sub.w   d1,d2
										move.w  2(a3),d1
										jsr     GetSpellDefAddress
										clr.w   d6
										move.b  SPELLDEF_OFFSET_POWER(a0),d6
										cmpi.b  #$FF,d6
										bne.s   loc_B140
										move.w  d2,d6
										bra.s   loc_B144
loc_B140:
										bsr.w   GetSpellPowerAdjustedForClass
loc_B144:
										cmp.w   d6,d2
										bcc.s   loc_B14A
										move.w  d2,d6
loc_B14A:
										move.b  (a5),d0
										jsr     GetStatus
										btst    #7,d0
										bne.s   loc_B16A
										move.w  #$B,(a6)+
										move.w  d6,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
										bra.s   loc_B17A
loc_B16A:
										move.w  #$A,(a6)+
										move.w  d6,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
loc_B17A:
										move.w  #$10,(a6)+
										move.w  #$12A,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d6,(a6)+
										bsr.w   sub_A872
										rts

	; End of function sub_B114


; =============== S U B R O U T I N E =======================================

sub_B194:
										move.b  (a5),d0
										jsr     GetStatus
										clr.b   d2
										tst.w   ((CURRENT_BATTLE_SPELL_LEVEL-$1000000)).w
										cmpi.w  #0,((CURRENT_BATTLE_SPELL_LEVEL-$1000000)).w
										beq.w   loc_B1CA
										cmpi.w  #1,((CURRENT_BATTLE_SPELL_LEVEL-$1000000)).w
										beq.w   loc_B1C0
										bclr    #2,d1
										beq.s   loc_B1C0
										ori.b   #4,d2
loc_B1C0:
										bclr    #0,d1
										beq.s   loc_B1CA
										ori.b   #2,d2
loc_B1CA:
										bclr    #1,d1
										beq.s   loc_B1D4
										ori.b   #1,d2
loc_B1D4:
										tst.b   d2
loc_B1D6:
										beq.w   loc_B266
										btst    #7,d0
										bne.s   loc_B1F4
										move.w  #$B,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
										bra.s   loc_B206
loc_B1F4:
										move.w  #$A,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
loc_B206:
										bsr.w   GiveMagicDrainEXP
										btst    #0,d2
										beq.s   loc_B226
										move.w  #$10,(a6)+
										move.w  #$12D,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
loc_B226:
										btst    #1,d2
										beq.s   loc_B242
										move.w  #$10,(a6)+
										move.w  #$12E,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
loc_B242:
										btst    #2,d2
										beq.s   loc_B264
										move.w  #$10,(a6)+
										move.w  #$12F,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										jsr     UnequipAllItemsIfNotCursed
loc_B264:
										bra.s   loc_B26C
loc_B266:
										moveq   #8,d2
										bsr.w   sub_BA98
loc_B26C:
										move.b  (a5),d0
										jsr     SetStatus
										jsr     ApplyStatusAndItemsOnStats
										rts

	; End of function sub_B194


; =============== S U B R O U T I N E =======================================

sub_B27C:
										move.b  (a5),d0
										jsr     GetStatus
										move.w  d1,d3
										ori.w   #$3000,d1
										jsr     SetStatus
										andi.w  #$3000,d3
										beq.s   loc_B29C
										moveq   #8,d2
										bsr.w   sub_BA98
loc_B29C:
										btst    #7,d0
										bne.s   loc_B2B6
										move.w  #$B,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
										bra.s   loc_B2C8
loc_B2B6:
										move.w  #$A,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
loc_B2C8:
										bsr.w   GiveMagicDrainEXP
										jsr     GetBaseAGI
										mulu.w  #3,d1
										lsr.l   #3,d1
										move.w  #$10,(a6)+
										move.w  #$14C,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										jsr     GetBaseDEF
										mulu.w  #3,d1
										lsr.l   #3,d1
										move.w  #$10,(a6)+
										move.w  #$155,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										rts

	; End of function sub_B27C


; =============== S U B R O U T I N E =======================================

sub_B30E:
										tst.w   d2
										beq.s   loc_B314
										addq.w  #5,d2
loc_B314:
										bsr.w   sub_BA98
										jsr     GetStatus
										move.w  d1,d3
										ori.w   #$C00,d1
										jsr     SetStatus
										andi.w  #$C00,d3
										beq.s   loc_B336
										moveq   #8,d2
										bsr.w   sub_BA98
loc_B336:
										btst    #7,d0
										bne.s   loc_B350
										move.w  #$B,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #1,(a6)+
										bra.s   loc_B362
loc_B350:
										move.w  #$A,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #1,(a6)+
loc_B362:
										bsr.w   GiveMagicDrainEXP

	; End of function sub_B30E


; =============== S U B R O U T I N E =======================================

WriteSkirmishScript_SlowMessage:
										
										jsr     GetBaseAGI
										mulu.w  #3,d1
										lsr.l   #3,d1
										move.w  #$10,(a6)+
										move.w  #$14D,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										jsr     GetBaseDEF
										mulu.w  #3,d1
										lsr.l   #3,d1
										move.w  #$10,(a6)+
										move.w  #$156,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										rts

	; End of function WriteSkirmishScript_SlowMessage


; =============== S U B R O U T I N E =======================================

sub_B3A8:
										move.b  (a5),d0
										jsr     GetStatus
										move.w  d1,d3
										ori.w   #$C000,d1
										jsr     SetStatus
										andi.w  #$C000,d3
										beq.s   loc_B3C8
										moveq   #8,d2
										bsr.w   sub_BA98
loc_B3C8:
										btst    #7,d0
										bne.s   loc_B3E2
										move.w  #$B,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
										bra.s   loc_B3F4
loc_B3E2:
										move.w  #$A,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
loc_B3F4:
										bsr.w   GiveMagicDrainEXP
										jsr     GetBaseATK
										mulu.w  #3,d1
										lsr.l   #3,d1
loc_B404:
										move.w  #$10,(a6)+
										move.w  #$14E,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										rts

	; End of function sub_B3A8


; =============== S U B R O U T I N E =======================================

sub_B41A:
										move.w  d2,d3
										move.b  (a5),d0
										moveq   #0,d1
										jsr     GetSpellAndNumberOfSpells
										tst.w   d2
										bne.s   loc_B42E
										moveq   #8,d3
										bra.s   loc_B430
loc_B42E:
										addq.w  #5,d3
loc_B430:
										move.w  d3,d2
										bsr.w   sub_BA98
										jsr     GetStatus
										ori.w   #$300,d1
										btst    #7,d0
										bne.s   loc_B45A
										move.w  #$B,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #1,(a6)+
										bra.s   loc_B46C
loc_B45A:
										move.w  #$A,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #1,(a6)+
loc_B46C:
										bsr.w   GiveMagicDrainEXP
										move.w  #$10,(a6)+
										move.w  #$14F,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										rts

	; End of function sub_B41A


; =============== S U B R O U T I N E =======================================

sub_B488:
										move.b  (a5),d0
										tst.w   ((CURRENT_BATTLE_SPELL_LEVEL-$1000000)).w
										beq.w   loc_B4AE
										addq.w  #5,d2
										bsr.w   sub_BA98
										jsr     GetStatus
										ori.w   #8,d1
										ori.w   #$30,d1 
										move.w  #$151,d2
										bra.w   loc_B4D0
loc_B4AE:
										moveq   #8,d2
										jsr     GetStatus
										andi.w  #8,d1
										bne.s   loc_B4BE
										moveq   #5,d2
loc_B4BE:
										bsr.w   sub_BA98
										jsr     GetStatus
										ori.w   #$30,d1 
										move.w  #$151,d2
loc_B4D0:
										btst    #7,d0
										bne.s   loc_B4EA
										move.w  #$B,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #1,(a6)+
										bra.s   loc_B4FC
loc_B4EA:
										move.w  #$A,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #1,(a6)+
loc_B4FC:
										bsr.w   GiveMagicDrainEXP
										move.w  #$10,(a6)+
										move.w  d2,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										rts

	; End of function sub_B488


; =============== S U B R O U T I N E =======================================

sub_B516:
										addq.w  #5,d2
										bsr.w   sub_BA98
										jsr     GetStatus
										btst    #7,d0
										bne.s   loc_B53C
										move.w  #$B,(a6)+
										move.w  #$8000,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #1,(a6)+
										bra.s   loc_B54E
loc_B53C:
										move.w  #$A,(a6)+
										move.w  #$8000,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #1,(a6)+
loc_B54E:
										bsr.w   GiveEXPandGoldForKill
										btst    #7,d0
										bne.s   loc_B55E
										move.w  #$130,d2
										bra.s   loc_B562
loc_B55E:
										move.w  #$131,d2
loc_B562:
										move.w  #$10,(a6)+
										move.w  d2,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.b  #$FF,-4(a2)
										rts

	; End of function sub_B516


; =============== S U B R O U T I N E =======================================

sub_B57E:
										addq.w  #5,d2
										bsr.w   sub_BA98
										jsr     GetStatus
										ori.w   #$C0,d1 
										btst    #7,d0
										bne.s   loc_B5A8
										move.w  #$B,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #1,(a6)+
										bra.s   loc_B5BA
loc_B5A8:
										move.w  #$A,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #1,(a6)+
loc_B5BA:
										bsr.w   GiveMagicDrainEXP
										move.w  #$10,(a6)+
										move.w  #$152,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										rts

	; End of function sub_B57E


; =============== S U B R O U T I N E =======================================

sub_B5D6:
										move.b  (a5),d0
										jsr     GetCurrentMP
										moveq   #3,d0
										jsr     (GetRandomOrDebugValue).w
										addq.w  #3,d0
										cmp.b   d0,d1
										bcc.s   loc_B5EC
										move.w  d1,d0
loc_B5EC:
										move.w  d0,d2
										move.w  d0,d3
										neg.w   d3
										move.b  (a5),d0
										jsr     GetStatus
										btst    #7,d0
										bne.s   loc_B612
loc_B600:
										move.w  #$B,(a6)+
										move.w  #0,(a6)+
										move.w  d3,(a6)+
										move.w  d1,(a6)+
										move.w  #1,(a6)+
										bra.s   loc_B622
loc_B612:
										move.w  #$A,(a6)+
loc_B616:
										move.w  #0,(a6)+
										move.w  d3,(a6)+
										move.w  d1,(a6)+
										move.w  #1,(a6)+
loc_B622:
										move.b  (a4),d0
										jsr     GetStatus
										btst    #7,d0
										bne.s   loc_B642
										move.w  #$B,(a6)+
										move.w  #0,(a6)+
										move.w  d2,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
										bra.s   loc_B652
loc_B642:
										move.w  #$A,(a6)+
										move.w  #0,(a6)+
										move.w  d2,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
loc_B652:
										bsr.w   GiveMagicDrainEXP
										move.w  #$12,(a6)+
										btst    #7,d0
										bne.s   loc_B666
										move.w  #$13D,d1
										bra.s   loc_B66C
loc_B666:
										move.b  (a5),d0
										move.w  #$13A,d1
loc_B66C:
										move.w  #$10,(a6)+
										move.w  d1,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d2,(a6)+
										rts

	; End of function sub_B5D6


; =============== S U B R O U T I N E =======================================

sub_B680:
										move.b  (a5),d0
										jsr     GetStatus
										btst    #7,d0
										bne.s   loc_B6A2
										move.w  #$B,(a6)+
loc_B692:
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
loc_B69C:
										move.w  #2,(a6)+
										bra.s   loc_B6B4
loc_B6A2:
										move.w  #$A,(a6)+
loc_B6A6:
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
loc_B6B0:
										move.w  #2,(a6)+
loc_B6B4:
										moveq   #3,d0
										jsr     (GetRandomOrDebugValue).w
										addq.w  #2,d0
										move.w  #$10,(a6)+
										move.w  #$96,(a6)+ 
										move.b  #0,(a6)+
										move.b  (a5),(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d0,(a6)+
										move.w  d0,d1
										move.b  (a5),d0
										jsr     IncreaseBaseATK
										jsr     ApplyStatusAndItemsOnStats
										rts

	; End of function sub_B680


; =============== S U B R O U T I N E =======================================

sub_B6E6:
										move.b  (a5),d0
loc_B6E8:
										jsr     GetStatus
										btst    #7,d0
										bne.s   loc_B708
										move.w  #$B,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
										bra.s   loc_B71A
loc_B708:
										move.w  #$A,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
loc_B71A:
										moveq   #3,d0
										jsr     (GetRandomOrDebugValue).w
										addq.w  #2,d0
										move.w  #$10,(a6)+
										move.w  #$97,(a6)+ 
										move.b  #0,(a6)+
										move.b  (a5),(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d0,(a6)+
										move.w  d0,d1
										move.b  (a5),d0
										jsr     IncreaseBaseDEF
										jsr     ApplyStatusAndItemsOnStats
										rts

	; End of function sub_B6E6


; =============== S U B R O U T I N E =======================================

sub_B74C:
										move.b  (a5),d0
										jsr     GetStatus
										btst    #7,d0
										bne.s   loc_B76E
										move.w  #$B,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
										bra.s   loc_B780
loc_B76E:
										move.w  #$A,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
loc_B780:
										moveq   #3,d0
										jsr     (GetRandomOrDebugValue).w
										addq.w  #2,d0
										move.w  #$10,(a6)+
										move.w  #$98,(a6)+ 
										move.b  #0,(a6)+
										move.b  (a5),(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d0,(a6)+
										move.w  d0,d1
										move.b  (a5),d0
										jsr     IncreaseBaseAGI
										jsr     ApplyStatusAndItemsOnStats
										rts

	; End of function sub_B74C


; =============== S U B R O U T I N E =======================================

sub_B7B2:
										move.b  (a5),d0
										jsr     GetStatus
										btst    #7,d0
										bne.s   loc_B7D4
										move.w  #$B,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
										bra.s   loc_B7E6
loc_B7D4:
										move.w  #$A,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
loc_B7E6:
										jsr     GetBaseMOV
										clr.w   d2
										cmpi.b  #9,d1
										beq.w   loc_B802
										moveq   #1,d2
										cmpi.b  #8,d1
										beq.w   loc_B802
										moveq   #2,d2
loc_B802:
										move.w  #$10,(a6)+
										move.w  #$99,(a6)+ 
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d2,(a6)+
										move.w  d2,d1
										jsr     IncreaseBaseMOV
										jsr     ApplyStatusAndItemsOnStats
										rts

	; End of function sub_B7B2


; =============== S U B R O U T I N E =======================================

sub_B826:
										move.b  (a5),d0
										jsr     GetStatus
										btst    #7,d0
										bne.s   loc_B848
										move.w  #$B,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
										bra.s   loc_B85A
loc_B848:
										move.w  #$A,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
loc_B85A:
										moveq   #3,d0
										jsr     (GetRandomOrDebugValue).w
										addq.w  #2,d0
										move.w  #$10,(a6)+
										move.w  #$9A,(a6)+ 
										move.b  #0,(a6)+
										move.b  (a5),(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d0,(a6)+
										move.w  d0,d1
										move.b  (a5),d0
										jsr     IncreaseMaxHP
										rts

	; End of function sub_B826


; =============== S U B R O U T I N E =======================================

sub_B886:
										move.b  (a5),d0
loc_B888:
										jsr     GetMaxMP
										tst.w   d1
										bne.s   loc_B898
										moveq   #8,d2
										bsr.w   sub_BA98
loc_B898:
										move.b  (a5),d0
										jsr     GetStatus
										btst    #7,d0
										bne.s   loc_B8BA
										move.w  #$B,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
										bra.s   loc_B8CC
loc_B8BA:
										move.w  #$A,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
loc_B8CC:
										moveq   #3,d0
										jsr     (GetRandomOrDebugValue).w
										addq.w  #2,d0
										move.w  #$10,(a6)+
										move.w  #$9B,(a6)+ 
										move.b  #0,(a6)+
										move.b  (a5),(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d0,(a6)+
										move.w  d0,d1
										move.b  (a5),d0
										jsr     IncreaseMaxMP
										rts

	; End of function sub_B886


; =============== S U B R O U T I N E =======================================

sub_B8F8:
										move.b  (a5),d0
										moveq   #0,d1
										jsr     SetCurrentEXP
										jsr     LevelUp
										lea     ((byte_FFAF82-$1000000)).w,a1
										cmpi.b  #$FF,(a1)
										bne.s   loc_B918
										moveq   #8,d2
										bsr.w   sub_BA98
loc_B918:
										move.b  (a5),d0
										jsr     GetStatus
										btst    #7,d0
										bne.s   loc_B93A
										move.w  #$B,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
										bra.s   loc_B94C
loc_B93A:
										move.w  #$A,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
loc_B94C:
										clr.l   d1
										move.b  (a1)+,d1
										move.w  #$10,(a6)+
										move.w  #$F4,(a6)+ 
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
										move.b  (a1)+,d1
										beq.s   loc_B97C
										move.w  #$10,(a6)+
										move.w  #$10A,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
loc_B97C:
										move.b  (a1)+,d1
										beq.s   loc_B994
										move.w  #$10,(a6)+
										move.w  #$10B,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
loc_B994:
										move.b  (a1)+,d1
										beq.s   loc_B9AC
										move.w  #$10,(a6)+
										move.w  #$10C,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
loc_B9AC:
										move.b  (a1)+,d1
										beq.s   loc_B9C4
										move.w  #$10,(a6)+
										move.w  #$10D,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
loc_B9C4:
										move.b  (a1)+,d1
										beq.s   loc_B9DC
										move.w  #$10,(a6)+
										move.w  #$10E,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
loc_B9DC:
										move.b  (a1)+,d1
										cmpi.b  #$FF,d1
										beq.s   return_BA1A
										move.w  d1,d2
										andi.w  #$3F,d2 
										lsr.w   #6,d1
										bne.s   loc_BA04
										move.w  #$10,(a6)+
										move.w  #$10F,(a6)+
										move.w  d0,(a6)+
										move.w  d2,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										bra.s   return_BA1A
loc_BA04:
										addq.w  #1,d1
										move.w  #$10,(a6)+
										move.w  #$110,(a6)+
										move.w  d2,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d1,(a6)+
return_BA1A:
										
										rts

	; End of function sub_B8F8


; =============== S U B R O U T I N E =======================================

sub_BA1C:
										move.b  (a5),d0
										jsr     GetMaxMP
										move.w  d1,d2
										jsr     GetCurrentMP
										sub.w   d1,d2
										move.w  2(a3),d1
										jsr     GetSpellDefAddress
										clr.w   d6
										move.b  7(a0),d6
										cmpi.b  #$FF,d6
										bne.s   loc_BA46
										move.w  d2,d6
loc_BA46:
										cmp.w   d6,d2
										bcc.s   loc_BA4C
										move.w  d2,d6
loc_BA4C:
										move.b  (a5),d0
										jsr     GetStatus
										btst    #7,d0
										bne.s   loc_BA6C
										move.w  #$B,(a6)+
										move.w  #0,(a6)+
										move.w  d6,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
										bra.s   loc_BA7C
loc_BA6C:
										move.w  #$A,(a6)+
										move.w  #0,(a6)+
										move.w  d6,(a6)+
										move.w  d1,(a6)+
										move.w  #2,(a6)+
loc_BA7C:
										move.w  #$10,(a6)+
										move.w  #$12C,(a6)+
										move.w  d0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  d6,(a6)+
										bsr.w   sub_A872
										rts

	; End of function sub_BA1C


; =============== S U B R O U T I N E =======================================

nullsub_8:
										
										rts

	; End of function nullsub_8


; =============== S U B R O U T I N E =======================================

sub_BA98:
										move.l  d0,-(sp)
										tst.b   -$17(a2)
										beq.s   loc_BAA2
										moveq   #8,d2
loc_BAA2:
										moveq   #8,d0
										jsr     (GetRandomOrDebugValue).w
										cmp.w   d2,d0
										bcc.s   loc_BAD2
										move.w  #$10,(a6)+
										move.w  #$127,(a6)+
										move.b  #0,(a6)+
										move.b  (a5),(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.b  #$FF,-5(a2)
										move.l  (sp)+,d0
										move.l  (sp)+,d0
										rts
loc_BAD2:
										move.l  (sp)+,d0
										rts

	; End of function sub_BA98


; =============== S U B R O U T I N E =======================================

sub_BAD6:
										moveq   #$10,d3
										bra.w   loc_BB02

	; End of function sub_BAD6


; =============== S U B R O U T I N E =======================================

sub_BADC:
										moveq   #$20,d3 
										bra.w   loc_BB02

	; End of function sub_BADC


; =============== S U B R O U T I N E =======================================

sub_BAE2:
										moveq   #$20,d3 
										bra.w   loc_BB02

	; End of function sub_BAE2


; =============== S U B R O U T I N E =======================================

sub_BAE8:
										moveq   #$10,d3
										bra.w   loc_BB02

	; End of function sub_BAE8


; =============== S U B R O U T I N E =======================================

sub_BAEE:
										moveq   #8,d3
										bra.w   loc_BB02

	; End of function sub_BAEE


; =============== S U B R O U T I N E =======================================

sub_BAF4:
										moveq   #8,d3
										bra.w   loc_BB02

	; End of function sub_BAF4


; =============== S U B R O U T I N E =======================================

sub_BAFA:
										moveq   #$20,d3 
										bra.w   loc_BB02

	; End of function sub_BAFA


; =============== S U B R O U T I N E =======================================

sub_BB00:
										moveq   #0,d3

	; End of function sub_BB00


; START OF FUNCTION CHUNK FOR sub_BAD6

loc_BB02:
										move.w  2(a3),d1
										jsr     GetSpellDefAddress
										clr.w   d6
										move.b  7(a0),d6
										bsr.w   GetSpellPowerAdjustedForClass
										move.w  d6,d1
										lsr.w   #2,d1
										cmpi.b  #1,d2
										bne.s   loc_BB22
										sub.w   d1,d6
loc_BB22:
										cmpi.b  #2,d2
										bne.s   loc_BB2A
										lsr.w   #1,d6
loc_BB2A:
										cmpi.b  #3,d2
										bne.s   loc_BB32
										add.w   d1,d6
loc_BB32:
										move.w  d3,d0
										beq.s   loc_BB46
										jsr     (GetRandomOrDebugValue).w
										tst.w   d0
										bne.s   loc_BB46
										add.w   d1,d6
										move.b  #$FF,-3(a2)
loc_BB46:
										bsr.w   WriteSkirmishScript_InflictDamage
										tst.b   -4(a2)
										beq.s   return_BB54
										bsr.w   WriteSkirmishScript_DeathMessage
return_BB54:
										
										rts

; END OF FUNCTION CHUNK FOR sub_BAD6


; =============== S U B R O U T I N E =======================================

;     Miscellaneous hacks to alter spell damage. (125% if promoted, damage divided if SORC spells)
;     In: D6 = original damage
;     Out: D6 = altered damage

GetSpellPowerAdjustedForClass:
										
										movem.l d0-d1/a0,-(sp)
										cmpi.w  #1,(a3)
										bne.w   loc_BB78
										move.b  (a4),d0
										jsr     GetClass
										cmpi.b  #CHAR_CLASS_FIRSTPROMOTED,d1
										bcs.w   loc_BB78
										mulu.w  #5,d6
										lsr.w   #2,d6
loc_BB78:
										move.w  ((CURRENT_BATTLE_SPELL_INDEX-$1000000)).w,d1
										cmpi.w  #SPELLIDX_DAO,d1; HARDCODED spell indexes
										beq.w   loc_BBA0
										cmpi.w  #SPELLIDX_APOLLO,d1
										beq.w   loc_BBA0
										cmpi.w  #SPELLIDX_NEPTUN,d1
										beq.w   loc_BBA0
										cmpi.w  #SPELLIDX_ATLAS,d1
										beq.w   loc_BBA0
										bra.w   loc_BBB2
loc_BBA0:
										move.w  ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,d0
										beq.w   loc_BBB2
										andi.w  #$FFFF,d6
										divu.w  d0,d6
										andi.w  #$FFFF,d6
loc_BBB2:
										movem.l (sp)+,d0-d1/a0
										rts

	; End of function GetSpellPowerAdjustedForClass


; =============== S U B R O U T I N E =======================================

WriteSkirmishScript_UseItem:
										
										move.w  ((CURRENT_BATTLE_ITEM-$1000000)).w,d1
										jsr     GetItemDefAddress
										move.b  9(a0),d0
										move.w  d0,2(a3)
										andi.w  #$3F,d0 
										move.w  d0,((CURRENT_BATTLE_SPELL_INDEX-$1000000)).w
										move.b  9(a0),d0
										lsr.b   #6,d0
										andi.w  #3,d0
										move.w  d0,((CURRENT_BATTLE_SPELL_LEVEL-$1000000)).w
										bra.w   WriteSkirmishScript_UseSpell

	; End of function WriteSkirmishScript_UseItem


; =============== S U B R O U T I N E =======================================

nullsub_9:
										
										rts

	; End of function nullsub_9


; =============== S U B R O U T I N E =======================================

WriteSkirmishScript_BreakUsedItem:
										
										movem.l d0-d3/a0,-(sp)
										cmpi.w  #ACTION_ITEM,(a3)
										bne.w   loc_BC94
										move.w  ((CURRENT_BATTLE_ITEM-$1000000)).w,d1
										jsr     GetItemType     
										tst.w   d2
										beq.w   loc_BC88
										jsr     GetItemDefAddress
										btst    #7,ITEMDEF_OFFSET_TYPE(a0)
										beq.w   loc_BC94
										btst    #CHAR_BIT_ENEMY,(a4)
										bne.w   loc_BC94
										move.w  ((CURRENT_BATTLE_ITEM-$1000000)).w,d0
										btst    #ITEM_BIT_BROKEN,d0
										bne.w   loc_BC5C
										moveq   #4,d0
										jsr     (GetRandomOrDebugValue).w
										tst.b   d0
										bne.s   loc_BC58
										moveq   #0,d0
										jsr     GetItemBreakMessage(pc)
										nop
										move.w  #$10,(a6)+
										move.w  d3,(a6)+
										move.w  d1,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.b  (a4),d0
										move.w  6(a3),d1
										jsr     BreakItem       
loc_BC58:
										bra.w   loc_BC94
loc_BC5C:
										moveq   #1,d0
										jsr     GetItemBreakMessage(pc)
										nop
										move.w  #$10,(a6)+
										move.w  d3,(a6)+
										move.w  d1,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.b  (a4),d0
										move.w  6(a3),d1
										jsr     RemoveItemBySlot
										bra.w   loc_BC94
loc_BC88:
										move.b  (a4),d0
										move.w  6(a3),d1
										jsr     RemoveItemBySlot
loc_BC94:
										movem.l (sp)+,d0-d3/a0
										rts

	; End of function WriteSkirmishScript_BreakUsedItem


; =============== S U B R O U T I N E =======================================

; In: A2 = skirmish properties stack
;     D0 = whether item is already damaged (0=no, 1=yes)
; Out: D3 = message idx

GetItemBreakMessage:
										
										movem.l d0/a0,-(sp)
										tst.b   d0
										bne.s   loc_BCB4
										tst.b   -5(a2)
										bne.s   loc_BCAE        
loc_BCA8:
										move.w  #$174,d3        ; But smoke rose from{N}the {ITEM}.{D1}
										bra.s   loc_BCB2
loc_BCAE:
										move.w  #$17E,d3        ; And smoke emerged from{N}the {ITEM}.{D1}
loc_BCB2:
										bra.s   loc_BCC4
loc_BCB4:
										tst.b   -5(a2)
										bne.s   loc_BCC0        
										move.w  #$179,d3        ; But, the {ITEM}{N}burst into flames.
										bra.s   loc_BCC4
loc_BCC0:
										move.w  #$183,d3        ; And the {ITEM}{N}burst into flames.
loc_BCC4:
										move.w  ((CURRENT_BATTLE_ITEM-$1000000)).w,d0
										andi.w  #$7F,d0 
										lea     ItemBreakMessages(pc), a0
loc_BCD0:
										cmpi.w  #$FFFF,(a0)
										beq.w   loc_BCEA
										cmp.b   (a0),d0
										beq.w   loc_BCE2
										addq.l  #2,a0
										bra.s   loc_BCD0
loc_BCE2:
										moveq   #0,d0
										move.b  1(a0),d0
										add.w   d0,d3
loc_BCEA:
										movem.l (sp)+,d0/a0
										rts

	; End of function GetItemBreakMessage

ItemBreakMessages:  incbin "data/items/itembreakmessages.bin"

; =============== S U B R O U T I N E =======================================

; In: A2 = battle scene stack
;     A3 = address in RAM of scene action type
;     A4 = address in RAM of attacker idx
;     A5 = address in RAM of target idx

WriteSkirmishScript_EnemyDropItem:
										
										movem.l d0-d3/a0,-(sp)
										btst    #CHAR_BIT_ENEMY,(a4)
										bne.w   loc_BE4C
										btst    #CHAR_BIT_ENEMY,(a5)
										beq.w   loc_BE4C
										tst.b   -BCSTACK_OFFSET_TARGETDIES(a2)
										beq.w   loc_BE4C
										move.b  ((CURRENT_BATTLE-$1000000)).w,d3
										lea     EnemyItemDrops(pc), a0
loc_BD48:
										cmp.b   (a0),d3
										bne.w   loc_BD6A
										move.b  (a5),d0
										cmp.b   1(a0),d0
										bne.w   loc_BD6A
										clr.w   d1
										move.b  2(a0),d1
										bsr.w   GetItemSlotContainingIndex
										cmpi.w  #CODE_NOTHING_WORD,d2
										bne.w   loc_BD78
loc_BD6A:
										adda.w  #4,a0
										cmpi.w  #CODE_TERMINATOR_WORD,(a0)
										bne.s   loc_BD48
										bra.w   loc_BE4C
loc_BD78:
										move.w  d1,d3
										andi.w  #ITEM_MASK_IDX,d3
										move.w  d2,d4
										cmpi.w  #ITEMIDX_TAROS_SWORD,d3
										beq.w   loc_BD9C
										cmpi.w  #ITEMIDX_IRON_BALL,d3
										beq.w   loc_BD9C
										cmpi.w  #ITEMIDX_COUNTER_SWORD,d3
										beq.w   loc_BD9C
										bra.w   loc_BDC4
loc_BD9C:
										moveq   #$20,d0 
										jsr     (GetRandomOrDebugValue).w
										tst.w   d0
										bne.w   loc_BE4C
										bra.w   loc_BDC4
										jsr     j_IsSpecialBattle
										tst.w   d1
										beq.w   loc_BDC4        ; if battle index not in list
										moveq   #3,d0           ; else
										jsr     (GetRandomOrDebugValue).w
										tst.w   d0
										beq.w   loc_BE4C
loc_BDC4:
										clr.w   d0
										move.b  3(a0),d0
										lea     ((ENEMY_ITEM_DROPS-$1000000)).w,a0
										divu.w  #8,d0
										adda.w  d0,a0
										swap    d0
										bset    d0,(a0)
										bne.w   loc_BE4C
										move.b  (a5),d0
										move.w  d4,d1
										jsr     RemoveItemBySlot
										move.b  (a4),d0
										jsr     GetCurrentHP
										tst.w   d1
										beq.w   loc_BE36
										move.w  d3,d1
										jsr     AddItem         
										tst.b   d2
										bne.w   loc_BE36
										move.w  #$10,(a6)+
										move.w  #TEXTIDX_BATTLE_DROPPEDITEM,(a6)+
																						; {NAME} dropped{N}a {ITEM}.{D1}
										move.b  #0,(a6)+
										move.b  (a5),(a6)+
										move.w  d1,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										move.w  #$10,(a6)+
										move.w  #TEXTIDX_BATTLE_PICKEDUPITEM,(a6)+
																						; {NAME} received{N}the {ITEM}.
										move.b  #0,(a6)+
										move.b  (a4),(a6)+
										move.w  d1,(a6)+
										move.w  #0,(a6)+
										move.w  #0,(a6)+
										bra.w   loc_BE4C
loc_BE36:
										move.w  d3,d1
										jsr     j_GetItemDefAddress
										btst    #ITEMTYPE_BIT_RARE,ITEMDEF_OFFSET_TYPE(a0)
										beq.s   loc_BE4C
										jsr     AddItemToDeals  
loc_BE4C:
										movem.l (sp)+,d0-d3/a0
										rts

	; End of function WriteSkirmishScript_EnemyDropItem

EnemyItemDrops:     incbin "battles/global/enemyitemdrops.bin"
EnemyGold:          incbin "battles/global/enemygold.bin"

; =============== S U B R O U T I N E =======================================

GetEnemyDestination:
										
										movem.l d0/a0,-(sp)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										jsr     GetYPos
										move.w  d1,d2
										jsr     GetXPos
loc_C03A:
										move.b  (a0)+,d0
										cmpi.b  #$FF,d0
										beq.w   loc_C06A
										tst.b   d0
										bne.s   loc_C04C
										addq.w  #1,d1
										bra.s   loc_C068
loc_C04C:
										subq.b  #1,d0
										bne.s   loc_C054
										subq.w  #1,d2
										bra.s   loc_C068
loc_C054:
										subq.b  #1,d0
										bne.s   loc_C05C
										subq.w  #1,d1
										bra.s   loc_C068
loc_C05C:
										subq.b  #1,d0
										bne.s   loc_C064
										addq.w  #1,d2
										bra.s   loc_C068
loc_C064:
										bra.w   loc_C06A
loc_C068:
										bra.s   loc_C03A
loc_C06A:
										movem.l (sp)+,d0/a0
										rts

	; End of function GetEnemyDestination


; =============== S U B R O U T I N E =======================================

ClearEnemyMoveInfo:
										
										movem.l d0-a6,-(sp)
										lea     ((ENEMY_TARGETTING_COMMAND_LIST-$1000000)).w,a0
										lea     ((byte_FFB1DC-$1000000)).w,a1
										clr.w   d0
										move.w  #$30,d1 
loc_C082:
										move.b  #$FF,(a0,d0.w)
										move.b  #0,(a1,d0.w)
										addq.w  #1,d0
										subq.w  #1,d1
										bne.s   loc_C082
										movem.l (sp)+,d0-a6
										rts

	; End of function ClearEnemyMoveInfo


; =============== S U B R O U T I N E =======================================

;     Convert coordinate to offset and add to address argument.
;     In: A0 = start of grid
;         D1 = X coord
;         D2 = Y coord
;     Out: A0 = start of grid + offset

ConvertCoordToOffset:
										
										move.l  d2,-(sp)
										mulu.w  #$30,d2 
										add.w   d1,d2
										adda.l  d2,a0
										move.l  (sp)+,d2
										rts

	; End of function ConvertCoordToOffset


; =============== S U B R O U T I N E =======================================

;     Clear valid target index grid at RAM:5600.

ClearTargetGrid:
										
										movem.l d0-d1/a0,-(sp)
										lea     (byte_FF5600).l,a0
										move.w  #$240,d0
										moveq   #$FFFFFFFF,d1
loc_C0B8:
										move.l  d1,(a0)+
										subq.w  #1,d0
										bne.s   loc_C0B8
										movem.l (sp)+,d0-d1/a0
										rts

	; End of function ClearTargetGrid


; =============== S U B R O U T I N E =======================================

;     Clear moveable tile data at RAM:4400 and RAM:4d00.

ClearMovableGrid:
										
										movem.l d0-a6,-(sp)
										lea     ((byte_FF4000+$400)).l,a0
										lea     ((byte_FF4A00+$300)).l,a1
										move.w  #$240,d0
										moveq   #$FFFFFFFF,d1
loc_C0DA:
										move.l  d1,(a0)+
										move.l  d1,(a1)+
										subq.w  #1,d0
										bne.s   loc_C0DA
										movem.l (sp)+,d0-a6
										rts

	; End of function ClearMovableGrid


; =============== S U B R O U T I N E =======================================

;     Get value at converted coordinate offset.
;     In: D1 = X coord
;         D2 = Y coord
;     Out: D0 = terrain at offset

GetTargetAtCoordOffset:
										
										movem.l d1-a6,-(sp)
										lea     (byte_FF5600).l,a0
										bsr.s   ConvertCoordToOffset
										move.b  (a0),d0
										movem.l (sp)+,d1-a6
										rts

	; End of function GetTargetAtCoordOffset


; =============== S U B R O U T I N E =======================================

; get distance from current unit to entity D0 -> D0

GetMoveCostToEntity:
										
										movem.l d1-a6,-(sp)
										jsr     GetYPos
										move.b  d1,d2
										jsr     GetXPos
										bsr.w   GetDestinationMoveCost
										movem.l (sp)+,d1-a6
										rts

	; End of function GetMoveCostToEntity


; =============== S U B R O U T I N E =======================================

; get movecost to get to tile D1,D2 -> D0

GetDestinationMoveCost:
										
										movem.l d1-a6,-(sp)
										lea     ((byte_FF4000+$400)).l,a0
										lea     ((byte_FF4A00+$300)).l,a1
										clr.w   d0
										mulu.w  #$30,d2 
										andi.w  #$FF,d1
										add.w   d1,d2
										move.b  (a1,d2.w),d0
										lsl.w   #8,d0
										move.b  (a0,d2.w),d0
										movem.l (sp)+,d1-a6
										rts

	; End of function GetDestinationMoveCost


; =============== S U B R O U T I N E =======================================

; get terrain type of tile under entity D0 -> D0

GetCurrentTerrainType:
										
										movem.l d1-a6,-(sp)
										jsr     GetYPos
										move.w  d1,d2
										jsr     GetXPos
										bsr.w   GetTerrain      
										movem.l (sp)+,d1-a6
										rts

	; End of function GetCurrentTerrainType


; =============== S U B R O U T I N E =======================================

;     Get obstruction at converted coordinate offset.
;     In: D1 = X coord
;         D2 = Y coord
;     Out: D0 = target at offset

GetTerrain:
										
										movem.l d1-a6,-(sp)
										lea     (TERRAIN_DATA).l,a0
										bsr.w   ConvertCoordToOffset
										move.b  (a0),d0
										movem.l (sp)+,d1-a6
										rts

	; End of function GetTerrain


; =============== S U B R O U T I N E =======================================

SetTerrain:
										
										movem.l d1-a6,-(sp)
loc_C17A:
										lea     (TERRAIN_DATA).l,a0
										bsr.w   ConvertCoordToOffset
										move.b  d0,(a0)
										movem.l (sp)+,d1-a6
										rts

	; End of function SetTerrain


; =============== S U B R O U T I N E =======================================

MemorizePath:
										
										movem.l d0-a6,-(sp)     ; copy current moving unit's terrain list to memory
loc_C190:
										jsr     GetUpperMoveType
										lsl.w   #4,d1
										lea     MoveTypeTerrainCosts(pc), a0
										adda.w  d1,a0
										lea     ((MOVE_COST_LIST-$1000000)).w,a1
										moveq   #$F,d7
loc_C1A4:
										move.b  (a0)+,d1
										andi.b  #$F,d1
loc_C1AA:
										cmpi.b  #$F,d1
										bne.s   loc_C1B2
										moveq   #$FFFFFFFF,d1
loc_C1B2:
										move.b  d1,(a1)+
										dbf     d7,loc_C1A4
										movem.l (sp)+,d0-a6
										rts

	; End of function MemorizePath


; =============== S U B R O U T I N E =======================================

sub_C1BE:
										movem.l d0/d2-a6,-(sp)
										bsr.s   MemorizePath
										lea     ((MOVE_COST_LIST-$1000000)).w,a0
										bsr.w   GetCurrentTerrainType
										andi.w  #$F,d0
										adda.w  d0,a0
										move.b  (a0),d1
										movem.l (sp)+,d0/d2-a6
										rts

	; End of function sub_C1BE


; =============== S U B R O U T I N E =======================================

GetMoveCost:
										
										movem.l d0/d2-a6,-(sp)
										jsr     GetUpperMoveType
										lsl.w   #4,d1
										lea     MoveTypeTerrainCosts(pc), a0
										adda.w  d1,a0
										bsr.w   GetCurrentTerrainType
										andi.w  #$F,d0
										adda.w  d0,a0
										move.b  (a0),d1
										lsr.b   #4,d1
loc_C1FA:
										andi.b  #$F,d1
										movem.l (sp)+,d0/d2-a6
										rts

	; End of function GetMoveCost


; =============== S U B R O U T I N E =======================================

;     Set coord to movable in movable grid.
;     In: D1 = X coord
;         D2 = Y coord

SetMovableAtCoord:
										
										movem.l d0-a6,-(sp)
loc_C208:
										lea     ((byte_FF4000+$400)).l,a0
										bsr.w   ConvertCoordToOffset
loc_C212:
										move.b  #0,(a0)
										lea     ((byte_FF4A00+$300)).l,a0
										bsr.w   ConvertCoordToOffset
										move.b  #0,(a0)
										movem.l (sp)+,d0-a6
										rts

	; End of function SetMovableAtCoord


; =============== S U B R O U T I N E =======================================

;     Get resistance to spell of combatant.
;     In: D0 = combatant idx
;         D1 = spell idx
;     Out: D2 = resistance bitmask

GetResistanceToSpell:
										
										movem.l d0-d1/d3-a6,-(sp)
										andi.b  #SPELL_MASK_IDX,d1
loc_C232:
										move.b  SpellElements(pc,d1.w),d2
										jsr     GetCurrentResistance
										andi.w  #SPELL_MASK_ALLRESIST,d1
										ror.w   d2,d1
										move.w  d1,d2
										andi.w  #SPELL_MASK_RESIST,d2
										movem.l (sp)+,d0-d1/d3-a6
										rts

	; End of function GetResistanceToSpell

SpellElements:      incbin "data/spells/spellelements.bin"

; =============== S U B R O U T I N E =======================================

sub_C27A:
										movem.l d0-d2/d4-a6,-(sp)
										btst    #7,d0
										bne.s   loc_C2A4
										moveq   #1,d3
										cmpi.b  #0,d1
										beq.w   loc_C2C2
										moveq   #0,d3
										cmp.b   d0,d1
										bne.w   loc_C2C2
										moveq   #2,d0
										jsr     (GetRandomOrDebugValue).w
										beq.w   loc_C2C2
										moveq   #1,d3
										bra.s   loc_C2C2
loc_C2A4:
										moveq   #1,d3
										cmpi.b  #$80,d1
										beq.w   loc_C2C2
										moveq   #0,d3
										cmp.b   d0,d1
										bne.w   loc_C2C2
										moveq   #2,d0
										jsr     (GetRandomOrDebugValue).w
										beq.w   loc_C2C2
										moveq   #1,d3
loc_C2C2:
										movem.l (sp)+,d0-d2/d4-a6
										rts

	; End of function sub_C27A


; =============== S U B R O U T I N E =======================================

; entity D0's current MOV*2, X, Y -> D0, D3, D4

GetMoveInfo:
										
										movem.l d1-d2/d5-a1,-(sp)
										bsr.w   MemorizePath
loc_C2D0:
										lea     ((byte_FF4000+$400)).l,a2
										lea     ((byte_FF4A00+$300)).l,a3
										lea     (TERRAIN_DATA).l,a4
										lea     ((MOVE_COST_LIST-$1000000)).w,a5
										jsr     GetXPos
										move.w  d1,d3
loc_C2EE:
										jsr     GetYPos
										move.w  d1,d4
										jsr     GetCurrentMOV
										move.w  d1,d0
										add.w   d0,d0
										movem.l (sp)+,d1-d2/d5-a1
										rts

	; End of function GetMoveInfo


; =============== S U B R O U T I N E =======================================

; get index and max/min range of current character's current weapon (D1,D3,D4)

GetWeaponRange:
										
										movem.l d0-d2/d5-a6,-(sp)
										jsr     GetEquippedWeapon
										cmpi.w  #$FFFF,d1
										bne.s   loc_C368
										clr.l   d3
										clr.l   d4
										btst    #7,d0
										bne.s   loc_C338
										jsr     GetClass
										cmpi.w  #$16,d1
										bne.s   loc_C338
										move.w  #2,d3
										move.w  #1,d4
										bra.w   loc_C37A
loc_C338:
										jsr     GetEnemyID
										cmpi.b  #$3B,d1 
										bne.s   loc_C350
										move.w  #2,d3
										move.w  #1,d4
										bra.w   loc_C37A
loc_C350:
										cmpi.b  #$57,d1 
										bne.s   loc_C362
										move.w  #3,d3
										move.w  #1,d4
										bra.w   loc_C37A
loc_C362:
										moveq   #1,d3
										moveq   #1,d4
										bra.s   loc_C37A
loc_C368:
										jsr     GetItemDefAddress
										clr.w   d3
										clr.w   d4
										move.b  4(a0),d3
										move.b  5(a0),d4
loc_C37A:
										movem.l (sp)+,d0-d2/d5-a6
										rts

	; End of function GetWeaponRange


; =============== S U B R O U T I N E =======================================

GetSpellRange:
										
										movem.l d0-d2/d5-a6,-(sp)
										jsr     GetSpellDefAddress
										move.b  4(a0),d3
										move.b  5(a0),d4
										movem.l (sp)+,d0-d2/d5-a6
										rts

	; End of function GetSpellRange


; =============== S U B R O U T I N E =======================================

GetItemRange:
										
										movem.l d0-d2/d5-a6,-(sp)
										jsr     GetItemDefAddress
										move.b  4(a0),d3
										move.b  5(a0),d4
										movem.l (sp)+,d0-d2/d5-a6
										rts

	; End of function GetItemRange


; =============== S U B R O U T I N E =======================================

; In: D0 = combatant entry
; Out: D1 = whether combatant is inflicted with MUDDLE 2

CheckMuddled2:
										
										movem.l d0/d2-a6,-(sp)
										bsr.w   GetStatus
										move.w  d1,d2
										andi.w  #$30,d1 
										tst.w   d1
										beq.s   loc_C3D6
										move.w  d2,d1
										andi.w  #8,d1
										tst.w   d1
										beq.s   loc_C3D2
										move.w  #1,d1
										bra.s   loc_C3D4
loc_C3D2:
										clr.w   d1
loc_C3D4:
										bra.s   loc_C3D8
loc_C3D6:
										clr.w   d1
loc_C3D8:
										movem.l (sp)+,d0/d2-a6
										rts

	; End of function CheckMuddled2


; =============== S U B R O U T I N E =======================================

GenerateTargetRangeLists:
										
										movem.l d0-a6,-(sp)
										move.w  #$FFFF,d3
										bsr.w   UpdateTargetList
										move.l  d0,-(sp)
										bsr.w   GetMoveInfo     
										bsr.w   MakeRangeLists
										move.l  (sp)+,d0
										move.w  #0,d3
										bsr.w   UpdateTargetList
										movem.l (sp)+,d0-a6
										rts

	; End of function GenerateTargetRangeLists


; =============== S U B R O U T I N E =======================================

j_sub_C404_0:
										
										movem.l d0-a6,-(sp)
										bsr.w   ClearTargetGrid 
										bsr.w   ClearMovableGrid
										move.w  #0,((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w
										eori.w  #$FFFF,d0
										bsr.w   MakeTargetList
										eori.w  #$FFFF,d0
										bsr.w   GetWeaponRange  
										move.w  d3,d2
										move.w  d4,d3
										moveq   #$FFFFFFFF,d5
										addq.b  #1,d2
										lea     pt_SpellRanges(pc), a1
										nop
										move.w  d2,d4
										lsl.w   #2,d4
										adda.w  d4,a1
										sub.b   d3,d2
loc_C43C:
										movea.l -(a1),a0
										bsr.w   ApplyRelativeCoordListToGrids
										subq.w  #1,d2
										bne.s   loc_C43C
										movem.l (sp)+,d0-a6
										rts

	; End of function j_sub_C404_0


; =============== S U B R O U T I N E =======================================

; In: D0 = item user
;     D1 = item idx

CreateItemRangeGrid:
										
										movem.l d0-a6,-(sp)
										bsr.w   ClearTargetGrid 
										bsr.w   ClearMovableGrid
										move.w  #0,((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w
										jsr     GetItemDefAddress
										move.b  9(a0),d1
										cmpi.b  #$3F,d1 
										beq.s   loc_C472
										bsr.w   CreateSpellRangeGrid
loc_C472:
										movem.l (sp)+,d0-a6
										rts

	; End of function CreateItemRangeGrid


; =============== S U B R O U T I N E =======================================

;     Clear and update target/movable grids based on spell properties.
;     In: D0 = spell user
;         D1 = spell idx

CreateSpellRangeGrid:
										
										movem.l d0-a6,-(sp)
										bsr.w   ClearTargetGrid 
										bsr.w   ClearMovableGrid
										move.w  #0,((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w
										jsr     GetSpellDefAddress
										btst    #7,d0
										bne.s   loc_C4AA
										btst    #6,3(a0)
										beq.s   loc_C4A4
										bsr.w   MakeTargetListAllies
										bra.s   loc_C4A8
loc_C4A4:
										bsr.w   MakeTargetListMonsters
loc_C4A8:
										bra.s   loc_C4BC
loc_C4AA:
										btst    #6,3(a0)
										beq.s   loc_C4B8
										bsr.w   MakeTargetListMonsters
										bra.s   loc_C4BC
loc_C4B8:
										bsr.w   MakeTargetListAllies
loc_C4BC:
										moveq   #$FFFFFFFF,d5
										moveq   #0,d2
										move.b  4(a0),d2
										move.b  5(a0),d3
										addq.b  #1,d2
										lea     pt_SpellRanges(pc), a1
										nop
										move.w  d2,d4
										lsl.w   #2,d4
										adda.w  d4,a1
										sub.b   d3,d2
loc_C4D8:
										movea.l -(a1),a0
										bsr.w   ApplyRelativeCoordListToGrids
										subq.w  #1,d2
										bne.s   loc_C4D8
										movem.l (sp)+,d0-a6
										rts

	; End of function CreateSpellRangeGrid


; =============== S U B R O U T I N E =======================================

j_sub_C4E8_0:
										
										movem.l d0-a6,-(sp)
										bsr.w   ClearTargetGrid 
										bsr.w   ClearMovableGrid
										move.w  #0,((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w
										bsr.w   MakeTargetList
										moveq   #$FFFFFFFF,d5
										lea     SpellRange1(pc), a0
										nop
										bsr.w   ApplyRelativeCoordListToGrids
										movem.l (sp)+,d0-a6
										rts

	; End of function j_sub_C4E8_0


; =============== S U B R O U T I N E =======================================

;     Apply coord list at A0 and add any targets to target list.
;     In: A0 = address of relative coord list
;         D0 = current entity idx
;         D1 = starting X coord
;         D2 = starting Y coord

ApplyRelativeCoordListToGrids:
										
										movem.l d0-a6,-(sp)
										jsr     GetXPos
										cmpi.w  #$FFFF,d1
										beq.w   loc_C58A
										move.w  d1,d3
										jsr     GetYPos
										move.w  d1,d4
										clr.w   d7
										move.b  (a0)+,d7
										subq.w  #1,d7
loc_C532:
										move.w  d4,d2
										add.b   1(a0),d2
										cmpi.w  #$30,d2 
loc_C53C:
										bcc.w   loc_C584
										move.w  d3,d1
										add.b   (a0),d1
										cmpi.w  #$30,d1 
										bcc.w   loc_C584
										tst.b   d5
										beq.s   loc_C55E
										bsr.w   GetTerrain      
										cmpi.b  #$FF,d0
										beq.s   loc_C55E
										bsr.w   SetMovableAtCoord
loc_C55E:
										bsr.w   GetTargetAtCoordOffset
										cmpi.b  #$FF,d0
										beq.w   loc_C584
										jsr     GetCurrentHP
										tst.w   d1
										beq.w   loc_C584
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a1
										adda.w  ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,a1
										move.b  d0,(a1)
										addq.w  #1,((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w
loc_C584:
										addq.l  #2,a0
										dbf     d7,loc_C532
loc_C58A:
										movem.l (sp)+,d0-a6
										rts

	; End of function ApplyRelativeCoordListToGrids

pt_SpellRanges:     dc.l SpellRange0
										dc.l SpellRange1
										dc.l SpellRange2
										dc.l SpellRange3
SpellRange0:        dc.b 1
										dc.b 0
										dc.b 0
SpellRange1:        dc.b 4
										dc.b 0
										dc.b 1
										dc.b 1
										dc.b 0
										dc.b 0
										dc.b $FF
										dc.b $FF
										dc.b 0
SpellRange2:        dc.b 8
										dc.b 0
										dc.b $FE
										dc.b $FF
										dc.b $FF
										dc.b $FE
										dc.b 0
										dc.b $FF
										dc.b 1
										dc.b 0
										dc.b 2
										dc.b 1
										dc.b 1
										dc.b 2
										dc.b 0
										dc.b 1
										dc.b $FF
SpellRange3:        dc.b $C
										dc.b 0
										dc.b 3
										dc.b 1
										dc.b 2
										dc.b 2
										dc.b 1
										dc.b 3
										dc.b 0
										dc.b 2
										dc.b $FF
										dc.b 1
										dc.b $FE
										dc.b 0
										dc.b $FD
										dc.b $FF
										dc.b $FE
										dc.b $FE
										dc.b $FF
										dc.b $FD
										dc.b 0
										dc.b $FE
										dc.b 1
										dc.b $FF
										dc.b 2

; =============== S U B R O U T I N E =======================================

j_sub_C5D6_0:
										
										movem.l d0-a6,-(sp)
										move.w  #0,((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w
										jsr     GetItemDefAddress
										move.b  9(a0),d1
										cmpi.b  #$FF,d1
										beq.s   loc_C5F4
										bsr.w   CreateTargetGridFromSpell
loc_C5F4:
										movem.l (sp)+,d0-a6
										rts

	; End of function j_sub_C5D6_0


; =============== S U B R O U T I N E =======================================

j_sub_C5FA_0:
										
										movem.l d0-a6,-(sp)
										move.w  #0,((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w
										jsr     GetItemDefAddress
										move.b  9(a0),d1
										cmpi.b  #$FF,d1
										beq.s   loc_C618
										bsr.w   CreateTargetGrid
loc_C618:
										movem.l (sp)+,d0-a6
										rts

	; End of function j_sub_C5FA_0


; =============== S U B R O U T I N E =======================================

CreateTargetGridFromSpell:
										
										cmpi.b  #$19,d1
										bne.s   loc_C62A
										bsr.w   MakeTargetListEverybody
										bra.s   CreateTargetGrid
loc_C62A:
										bsr.w   MakeTargetList

	; End of function CreateTargetGridFromSpell


; =============== S U B R O U T I N E =======================================

CreateTargetGrid:
										
										movem.l d0-a6,-(sp)
										move.w  #0,((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w
										jsr     GetSpellDefAddress
										cmpi.b  #$C1,d1
										beq.w   loc_C678
										cmpi.b  #$2A,d1 
										beq.w   loc_C678
										moveq   #0,d2
										move.b  6(a0),d2
										addq.b  #1,d2
										lea     pt_SpellRanges(pc), a1
										move.w  d2,d4
										lsl.w   #2,d4
										adda.w  d4,a1
										cmpi.b  #$19,d1
										bne.s   loc_C668
										subq.b  #1,d2
loc_C668:
										moveq   #0,d5
loc_C66A:
										movea.l -(a1),a0
										bsr.w   ApplyRelativeCoordListToGrids
										subq.w  #1,d2
										bne.s   loc_C66A
										bra.w   loc_C688
loc_C678:
										btst    #7,d0
										bne.s   loc_C684
										bsr.w   sub_C68E
										bra.s   loc_C688
loc_C684:
										bsr.w   sub_C6D4
loc_C688:
										movem.l (sp)+,d0-a6
										rts

	; End of function CreateTargetGrid


; =============== S U B R O U T I N E =======================================

sub_C68E:
										movem.l d0-a6,-(sp)
loc_C692:
										move.w  #0,((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a0
										move.w  #0,d0
										bra.s   loc_C6A4
loc_C6A2:
										addq.w  #1,d0
loc_C6A4:
										cmpi.w  #$1D,d0
										bgt.s   loc_C6CE
										jsr     GetXPos
										cmpi.b  #$FF,d1
										beq.w   loc_C6CC
loc_C6B8:
										jsr     GetCurrentHP
										tst.w   d1
										beq.w   loc_C6CC
										move.b  d0,(a0)
										addq.l  #1,a0
										addq.w  #1,((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w
loc_C6CC:
										bra.s   loc_C6A2
loc_C6CE:
										movem.l (sp)+,d0-a6
										rts

	; End of function sub_C68E


; =============== S U B R O U T I N E =======================================

sub_C6D4:
										movem.l d0-a6,-(sp)
										move.w  #0,((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a0
										move.w  #$80,d0 
										bra.s   loc_C6EA
loc_C6E8:
										addq.w  #1,d0
loc_C6EA:
										cmpi.w  #$9F,d0 
										bgt.s   loc_C714
										jsr     GetXPos
										cmpi.b  #$FF,d1
										beq.w   loc_C712
										jsr     GetCurrentHP
										tst.w   d1
										beq.w   loc_C712
										move.b  d0,(a0)
										addq.l  #1,a0
										addq.w  #1,((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w
loc_C712:
										bra.s   loc_C6E8
loc_C714:
										movem.l (sp)+,d0-a6
										rts

	; End of function sub_C6D4


; =============== S U B R O U T I N E =======================================

; something with terrain lists and checking, look into it ???
; In: D1 = x pos
;     D2 = y pos
;     D3 = max range
;     D4 = min range
; Out: D1 = chosen x pos
;      D2 = chosen y pos

GetClosestAttackPosition:
										
										movem.l d0/d3-a6,-(sp)
										link    a6,#-6
										move.b  d1,-1(a6)
										move.b  d2,-2(a6)
										move.b  #$FF,-3(a6)
										move.b  #$FF,-4(a6)
										move.b  #$FF,-5(a6)
										cmpi.b  #$30,d1 
										bcc.w   loc_C7E2
										cmpi.b  #$30,d2 
										bcc.w   loc_C7E2
										move.b  d3,d6
										neg.b   d6              ; D6 is now -max range
loc_C750:
										move.b  d3,d5
										move.b  d6,d0
										or.b    d0,d0
										bge.s   loc_C75A
										neg.b   d0
loc_C75A:
										sub.b   d0,d5
										neg.b   d5              ; D5 is now (max range - max range) ???
										move.b  d3,d0
loc_C760:
										cmp.b   d4,d0
										bcs.w   loc_C7BE
										move.b  -1(a6),d1
										add.b   d5,d1
										cmpi.b  #$30,d1 
										bcc.w   loc_C7BE
										move.b  -2(a6),d2
										add.b   d6,d2
										cmpi.b  #$30,d2 
										bcc.w   loc_C7BE
										bsr.w   GetDestinationMoveCost
										tst.w   d0              ; already in range, so end because it can't get cheaper
										beq.w   loc_C7EA
										btst    #$F,d0
										bne.w   loc_C7BE
										cmp.b   -5(a6),d0
										bcc.w   loc_C7BE
										move.b  d0,d7
										andi.w  #$FF,d1
										andi.w  #$FF,d2
										bsr.w   GetTargetAtCoordOffset
										cmpi.b  #$FF,d0
										bne.w   loc_C7BE        ; already someone there, so it can't be chosen
										move.b  d7,-5(a6)
										move.b  d1,-3(a6)
										move.b  d2,-4(a6)
loc_C7BE:
										addq.b  #1,d5
										move.b  d5,d1
										or.b    d1,d1
										bge.s   loc_C7C8
										neg.b   d1
loc_C7C8:
										move.b  d6,d0
										or.b    d0,d0
										bge.s   loc_C7D0
										neg.b   d0
loc_C7D0:
										add.b   d1,d0
										cmp.b   d3,d0
										bls.s   loc_C760
										cmp.b   d3,d6
										beq.w   loc_C7E2
										addq.b  #1,d6
										bra.w   loc_C750
loc_C7E2:
										move.b  -3(a6),d1
										move.b  -4(a6),d2
loc_C7EA:
										unlk    a6
										movem.l (sp)+,d0/d3-a6
										rts

	; End of function GetClosestAttackPosition


; =============== S U B R O U T I N E =======================================

MakeTargetList:
										
										btst    #7,d0
										bne.w   MakeTargetListMonsters
																						; generate list of targets: opposite alignment of D0

	; End of function MakeTargetList


; =============== S U B R O U T I N E =======================================

;     Clear target grid, then add allies.

MakeTargetListAllies:
										
										movem.l d0-a0,-(sp)
										bsr.w   ClearTargetGrid 
										moveq   #0,d0
										moveq   #$1D,d7
										bra.w   loc_C828

	; End of function MakeTargetListAllies


; =============== S U B R O U T I N E =======================================

MakeTargetListMonsters:
										
										movem.l d0-a0,-(sp)
										bsr.w   ClearTargetGrid 
										move.w  #$80,d0 
										moveq   #$1F,d7
										bra.w   loc_C828

	; End of function MakeTargetListMonsters


; =============== S U B R O U T I N E =======================================

MakeTargetListEverybody:
										
										movem.l d0-a0,-(sp)
										bsr.s   MakeTargetListAllies
										move.w  #COM_ENEMY_START,d0
										moveq   #COM_ENEMIES_COUNTER,d7
loc_C828:
										jsr     GetCurrentHP
										tst.w   d1
										beq.w   loc_C86E
										jsr     GetCharacterWord34
										btst    #3,d1
										beq.s   loc_C844
										bra.w   loc_C86E
loc_C844:
										jsr     GetYPos
loc_C84A:
										cmpi.w  #MAP_SIZE_MAXHEIGHT,d1
										bcc.w   loc_C86E
										move.w  d1,d2
										jsr     GetXPos
										cmpi.w  #MAP_SIZE_MAXWIDTH,d1
										bcc.w   loc_C86E
										lea     (byte_FF5600).l,a0
										bsr.w   ConvertCoordToOffset
										move.b  d0,(a0)
loc_C86E:
										addq.b  #1,d0
loc_C870:
										dbf     d7,loc_C828
										movem.l (sp)+,d0-a0
										rts

	; End of function MakeTargetListEverybody


; =============== S U B R O U T I N E =======================================

UpdateTargetList:
										
										btst    #7,d0
										beq.w   UpdateTargetListMonsters

	; End of function UpdateTargetList


; =============== S U B R O U T I N E =======================================

UpdateTargetListCharacters:
										
										movem.l d0-a0,-(sp)
										moveq   #COM_ALLY_START,d0
										moveq   #COM_ALLIES_COUNTER,d7
										bra.w   loc_C898

	; End of function UpdateTargetListCharacters


; =============== S U B R O U T I N E =======================================

UpdateTargetListMonsters:
										
										movem.l d0-a0,-(sp)
										move.w  #COM_ENEMY_START,d0
										moveq   #COM_ENEMIES_COUNTER,d7
loc_C898:
										jsr     GetCurrentHP
										tst.w   d1
										beq.w   loc_C8F4
										jsr     GetYPos
										move.w  d1,d2
										cmpi.w  #MAP_SIZE_MAXHEIGHT,d2
										bcc.w   loc_C8F4
										jsr     GetXPos
										cmpi.w  #MAP_SIZE_MAXWIDTH,d1
										bcc.w   loc_C8F4
										lea     (TERRAIN_DATA).l,a0
										bsr.w   ConvertCoordToOffset
										move.b  (a0),d4
										cmpi.b  #$FF,d4
										bne.s   loc_C8D8
										bra.w   loc_C8F4
loc_C8D8:
										btst    #6,d4
										beq.s   loc_C8E6
										tst.w   d3
										bne.s   loc_C8E6
										bra.w   loc_C8F4
loc_C8E6:
										tst.w   d3
										bne.s   loc_C8F0
										bclr    #7,(a0)
										bra.s   loc_C8F4
loc_C8F0:
										bset    #7,(a0)
loc_C8F4:
										addq.b  #1,d0
										dbf     d7,loc_C898
										movem.l (sp)+,d0-a0
										rts

	; End of function UpdateTargetListMonsters


; =============== S U B R O U T I N E =======================================

sub_C900:
										movem.l d0-a0,-(sp)
										move.w  #0,d0
										moveq   #$1D,d7
loc_C90A:
										jsr     GetCurrentHP
										tst.w   d1
										beq.w   loc_C94C
										jsr     GetYPos
										move.w  d1,d2
										cmpi.w  #$30,d2 
										bcc.w   loc_C94C
										jsr     GetXPos
										cmpi.w  #$30,d1 
										bcc.w   loc_C94C
										lea     ((byte_FF4A00+$300)).l,a0
										bsr.w   ConvertCoordToOffset
										tst.w   d3
										bne.s   loc_C948
										bclr    #7,(a0)
										bra.s   loc_C94C
loc_C948:
										bset    #7,(a0)
loc_C94C:
										addq.b  #1,d0
										dbf     d7,loc_C90A
										movem.l (sp)+,d0-a0
										rts

	; End of function sub_C900


; =============== S U B R O U T I N E =======================================

sub_C958:
										movem.l d1-a2,-(sp)
										move.l  d0,-(sp)
										moveq   #$FFFFFFFF,d3
										bsr.w   UpdateTargetList
										bsr.w   GetMoveInfo     
										bsr.w   MakeRangeLists
										moveq   #0,d3
										bsr.w   UpdateTargetList
										clr.w   ((byte_FF8808-$1000000)).w
										clr.w   ((word_FF8806-$1000000)).w
										clr.w   ((DMA_SPACE_FF8804-$1000000)).w
										move.l  (sp)+,d0
										moveq   #0,d3
										bsr.w   GetNextUsableAttackItem
										cmpi.w  #$7F,d1 
										beq.w   loc_CA02
										bsr.w   MakeTargetListEverybody
										bsr.w   GetTargetsReachableByItem
										move.w  ((byte_FF8808-$1000000)).w,d7
										subq.w  #1,d7
										bcs.w   loc_CA02
										move.l  d1,-(sp)
										btst    #7,d0
										bne.s   loc_C9BC
										bsr.w   CheckMuddled2   
										tst.b   d1
										bne.s   loc_C9B6
										bsr.w   MakeTargetListMonsters
										bra.s   loc_C9BA
loc_C9B6:
										bsr.w   MakeTargetListAllies
loc_C9BA:
										bra.s   loc_C9CE
loc_C9BC:
										bsr.w   CheckMuddled2   
										tst.b   d1
										bne.s   loc_C9CA
										bsr.w   MakeTargetListAllies
										bra.s   loc_C9CE
loc_C9CA:
										bsr.w   MakeTargetListMonsters
loc_C9CE:
										move.l  (sp)+,d1
										lea     (word_FF880A).l,a0
										move.w  d2,(a0)
										jsr     GetItemDefAddress
loc_C9DE:
										move.b  9(a0),d1
										lea     ((byte_FF886E-$1000000)).w,a0
										lea     ((byte_FF88FE-$1000000)).w,a1
										lea     ((byte_FF898E-$1000000)).w,a2
loc_C9EE:
										move.b  (a0,d7.w),d2
										move.b  (a1,d7.w),d5
										bsr.w   sub_CAEA
										move.b  d6,(a2,d7.w)
										dbf     d7,loc_C9EE
loc_CA02:
										moveq   #0,d3
										bsr.w   GetNextUsableAttackSpell
										cmpi.w  #$3F,d1 
										beq.w   loc_CA7A
										bsr.w   MakeTargetListEverybody
										bsr.w   GetTargetsReachableBySpell
										move.w  ((word_FF8806-$1000000)).w,d7
										subq.w  #1,d7
										bcs.w   loc_CA7A
										move.l  d1,-(sp)
										btst    #7,d0
										bne.s   loc_CA3E
										bsr.w   CheckMuddled2   
										tst.b   d1
										bne.s   loc_CA38
										bsr.w   MakeTargetListMonsters
										bra.s   loc_CA3C
loc_CA38:
										bsr.w   MakeTargetListAllies
loc_CA3C:
										bra.s   loc_CA50
loc_CA3E:
										bsr.w   CheckMuddled2   
										tst.b   d1
										bne.s   loc_CA4C
										bsr.w   MakeTargetListAllies
										bra.s   loc_CA50
loc_CA4C:
										bsr.w   MakeTargetListMonsters
loc_CA50:
										move.l  (sp)+,d1
										lea     (word_FF880C).l,a0
										move.w  d1,(a0)
										lea     ((byte_FF883E-$1000000)).w,a0
										lea     ((byte_FF88CE-$1000000)).w,a1
										lea     ((byte_FF895E-$1000000)).w,a2
loc_CA66:
										move.b  (a0,d7.w),d2
										move.b  (a1,d7.w),d5
										bsr.w   sub_CAEA
										move.b  d6,(a2,d7.w)
										dbf     d7,loc_CA66
loc_CA7A:
										bsr.w   MakeTargetListEverybody
										bsr.w   GetTargetsReachableByAttack
										move.w  ((DMA_SPACE_FF8804-$1000000)).w,d7
										subq.w  #1,d7
										bcs.w   loc_CAE4
										move.l  d1,-(sp)
										btst    #7,d0
										bne.s   loc_CAA8
										bsr.w   CheckMuddled2   
										tst.b   d1
										bne.s   loc_CAA2
										bsr.w   MakeTargetListMonsters
										bra.s   loc_CAA6
loc_CAA2:
										bsr.w   MakeTargetListAllies
loc_CAA6:
										bra.s   loc_CABA
loc_CAA8:
										bsr.w   CheckMuddled2   
										tst.b   d1
										bne.s   loc_CAB6
										bsr.w   MakeTargetListAllies
										bra.s   loc_CABA
loc_CAB6:
										bsr.w   MakeTargetListMonsters
loc_CABA:
										move.l  (sp)+,d1
										lea     ((byte_FF880E-$1000000)).w,a0
										lea     ((byte_FF889E-$1000000)).w,a1
										lea     ((byte_FF892E-$1000000)).w,a2
loc_CAC8:
										move.b  (a0,d7.w),d2
										move.b  (a1,d7.w),d5
										move.b  #$3F,d1 
										bsr.w   sub_CAEA
										move.b  d6,(a2,d7.w)
										dbf     d7,loc_CAC8
										bsr.w   MakeTargetListEverybody
loc_CAE4:
										movem.l (sp)+,d1-a2
										rts

	; End of function sub_C958


; =============== S U B R O U T I N E =======================================

sub_CAEA:
										movem.l d0-d5/d7-a6,-(sp)
										moveq   #0,d6
										cmpi.b  #$3F,d1 
										bne.s   loc_CAFE
										move.b  d2,d1
										bsr.w   sub_CB18
										bra.s   loc_CB12
loc_CAFE:
										move.b  d0,d3
										move.b  d2,d0
										bsr.w   CreateTargetGrid
										tst.w   ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w
										beq.s   loc_CB12
										move.b  d3,d0
										bsr.w   sub_CBA2
loc_CB12:
										movem.l (sp)+,d0-d5/d7-a6
										rts

	; End of function sub_CAEA


; =============== S U B R O U T I N E =======================================

sub_CB18:
										movem.l d0-d5/d7-a6,-(sp)
										move.b  d1,d3
										move.b  d0,d4
										bsr.w   sub_CC0C
										btst    #7,d0
										beq.s   loc_CB3A
										jsr     GetCharacterWord34
										move.w  d1,d2
										rol.w   #4,d2
										andi.w  #$F,d2
										bra.s   loc_CB3E
loc_CB3A:
										move.w  #2,d2
loc_CB3E:
										move.l  d1,-(sp)
										bsr.w   GetDifficulty
										mulu.w  #4,d1
										add.w   d1,d2
										move.l  (sp)+,d1
										lsl.w   #2,d2
										movea.l off_CB62(pc,d2.w),a0
										move.b  d3,d0
										bsr.w   sub_CC8A
										clr.w   d7
										jsr     (a0)
										movem.l (sp)+,d0-d5/d7-a6
										rts

	; End of function sub_CB18

off_CB62:           dc.l sub_CCA0
										dc.l sub_CCD4
										dc.l sub_CD18
										dc.l sub_CD4C
										dc.l sub_CCA0
										dc.l sub_CCD4
										dc.l sub_CCA0
										dc.l sub_CD4C
										dc.l sub_CCD4
										dc.l sub_CCD4
										dc.l sub_CCD4
										dc.l sub_CCD4
										dc.l sub_CCD4
										dc.l sub_CCD4
										dc.l sub_CCD4
										dc.l sub_CCD4

; =============== S U B R O U T I N E =======================================

sub_CBA2:
										movem.l d0-d5/d7-a6,-(sp)
										move.w  d0,d4
										move.b  d1,d3
										btst    #7,d0
										beq.s   loc_CBC0
										jsr     GetCharacterWord34
										move.w  d1,d2
										rol.w   #4,d2
										andi.w  #3,d2
										bra.s   loc_CBC4
loc_CBC0:
										move.w  #2,d2
loc_CBC4:
										move.l  d1,-(sp)
										bsr.w   GetDifficulty
										mulu.w  #4,d1
										add.w   d1,d2
										move.l  (sp)+,d1
										lsl.w   #2,d2
										movea.l off_CB62(pc,d2.w),a0
										move.b  d3,d1
										moveq   #0,d3
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a1
loc_CBE0:
										move.w  ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,d7
										subq.w  #1,d7
										bcs.w   loc_CC04
loc_CBEA:
										move.b  (a1)+,d0
										bsr.w   GetSpellPowerAdjustedForResistance
										bsr.w   sub_CC8A
										move.l  d7,-(sp)
										move.w  #1,d7
										jsr     (a0)
										move.l  (sp)+,d7
										add.w   d6,d3
										dbf     d7,loc_CBEA
loc_CC04:
										move.w  d3,d6
										movem.l (sp)+,d0-d5/d7-a6
										rts

	; End of function sub_CBA2


; =============== S U B R O U T I N E =======================================

sub_CC0C:
										movem.l d0-d5/d7-a6,-(sp)
										move.b  d1,d2
										jsr     GetCurrentATK
										move.b  d2,d0
										move.w  d1,d2
										jsr     GetCurrentDEF
										sub.w   d1,d2
										bhi.s   loc_CC28
										moveq   #1,d2
loc_CC28:
										move.w  d2,d6
										jsr     GetMoveCost
										move.w  #$100,d2
										tst.b   d1
										beq.w   loc_CC4A
										move.w  #$E6,d2 
										cmpi.b  #1,d1
										beq.w   loc_CC4A
										move.w  #$CD,d2 
loc_CC4A:
										mulu.w  d2,d6
										lsr.w   #8,d6
										movem.l (sp)+,d0-d5/d7-a6
										rts

	; End of function sub_CC0C


; =============== S U B R O U T I N E =======================================

; In: D0 = target combatant idx
;     D1 = spell idx
; Out: D6 = adjusted power

GetSpellPowerAdjustedForResistance:
										
										movem.l d0-d5/d7-a0,-(sp)
										bsr.w   GetResistanceToSpell
										jsr     GetSpellDefAddress
										moveq   #0,d6
										move.b  SPELLDEF_OFFSET_POWER(a0),d6
										move.w  d6,d3
										lsr.w   #2,d3
										cmpi.b  #SPELLDEF_RESIST_MINOR,d2
										bne.s   loc_CC74
										sub.w   d3,d6
loc_CC74:
										cmpi.b  #SPELLDEF_RESIST_MAJOR,d2
										bne.s   loc_CC7C
										lsr.w   #1,d6
loc_CC7C:
										cmpi.b  #SPELLDEF_RESIST_WEAKNESS,d2
										bne.s   loc_CC84
										add.w   d3,d6
loc_CC84:
										movem.l (sp)+,d0-d5/d7-a0
										rts

	; End of function GetSpellPowerAdjustedForResistance


; =============== S U B R O U T I N E =======================================

sub_CC8A:
										movem.l d0/d2-a6,-(sp)
										jsr     GetCurrentHP
										sub.w   d6,d1
										bcc.s   loc_CC9A
										moveq   #0,d1
loc_CC9A:
										movem.l (sp)+,d0/d2-a6
										rts

	; End of function sub_CC8A


; =============== S U B R O U T I N E =======================================

sub_CCA0:
										movem.l d0-d5/d7-a6,-(sp)
										moveq   #1,d6
										tst.w   d1
										bne.s   loc_CCAE
										addi.w  #$F,d6
loc_CCAE:
										lea     (ENEMY_TARGETTING_COMMAND_LIST).l,a1
										clr.w   d5
										move.b  d4,d5
										andi.b  #$7F,d5 
										clr.w   d7
										move.b  (a1,d5.w),d7
										cmp.b   d0,d7
										bne.s   loc_CCCA
										addi.w  #2,d6
loc_CCCA:
										bsr.w   sub_CE36
										movem.l (sp)+,d0-d5/d7-a6
										rts

	; End of function sub_CCA0


; =============== S U B R O U T I N E =======================================

sub_CCD4:
										movem.l d0-d5/d7-a6,-(sp)
										moveq   #1,d6
										tst.w   d1
										bne.s   loc_CCE2
										addi.w  #$F,d6
loc_CCE2:
										bsr.w   sub_D2F8
										bcs.s   loc_CCEA
										addq.w  #1,d6
loc_CCEA:
										bsr.w   sub_D362
										bcs.s   loc_CCF2
										addq.w  #1,d6
loc_CCF2:
										lea     (ENEMY_TARGETTING_COMMAND_LIST).l,a1
										clr.w   d5
										move.b  d4,d5
										andi.b  #$7F,d5 
										clr.w   d7
										move.b  (a1,d5.w),d7
										cmp.b   d0,d7
										bne.s   loc_CD0E
										addi.w  #2,d6
loc_CD0E:
										bsr.w   sub_CE36
										movem.l (sp)+,d0-d5/d7-a6
										rts

	; End of function sub_CCD4


; =============== S U B R O U T I N E =======================================

sub_CD18:
										movem.l d0-d5/d7-a6,-(sp)
										moveq   #3,d6
										jsr     j_randomLessThanD6
										tst.b   d7
										beq.w   loc_CD3C
										move.b  d5,d0
										add.b   d0,d0
										moveq   #$12,d6
										sub.b   d0,d6
										bcc.s   loc_CD36
										moveq   #0,d6
loc_CD36:
										addq.w  #1,d6
										bra.w   loc_CD46
loc_CD3C:
										moveq   #1,d6
										tst.w   d1
										bne.s   loc_CD46
										addi.w  #$F,d6
loc_CD46:
										movem.l (sp)+,d0-d5/d7-a6
										rts

	; End of function sub_CD18


; =============== S U B R O U T I N E =======================================

sub_CD4C:
										movem.l d0-d5/d7-a6,-(sp)
										moveq   #1,d6
										tst.w   d1
										bne.s   loc_CD5A
										addi.w  #$F,d6
loc_CD5A:
										bsr.w   sub_D362
										bcs.s   loc_CD62
										addq.w  #1,d6
loc_CD62:
										movem.l (sp)+,d0-d5/d7-a6
										rts

	; End of function sub_CD4C


; =============== S U B R O U T I N E =======================================

; In: D0 = heal target char idx
;     D4 = heal spell idx

sub_CD68:
										movem.l d0-d1/d3-a6,-(sp)
										clr.w   d5
										move.b  d4,d5
										lsr.w   #6,d5
										andi.w  #3,d5
										move.w  d1,d3
										jsr     GetCurrentHP
										move.w  d1,d2
										jsr     GetMaxHP
										sub.w   d2,d1           ; d1 = max HP - current HP
										moveq   #$FFFFFFFF,d2
										cmpi.w  #ENEMYAI_THRESHOLD_HEAL1,d1
										bls.w   loc_CDDC
										moveq   #0,d2
										cmpi.w  #ENEMYAI_THRESHOLD_HEAL2,d1
										bls.w   loc_CDB8
										cmpi.w  #2,d5
										bcs.w   loc_CDB8
										moveq   #2,d2
										cmpi.w  #ENEMYAI_THRESHOLD_HEAL3,d1
										bls.w   loc_CDB8
										cmpi.w  #3,d5
loc_CDB2:
										bcs.w   loc_CDB8
										moveq   #3,d2
loc_CDB8:
										move.w  d3,d0
										jsr     GetCurrentMP
										move.w  d1,d3
loc_CDC2:
										moveq   #0,d1
										add.w   d2,d1
										lsl.w   #5,d1
										add.w   d4,d1
										jsr     GetSpellDefAddress
										cmp.b   SPELLDEF_OFFSET_MPCOST(a0),d3
																						; check if spell cost is more than current MP
										bcc.w   loc_CDDC
										dbf     d2,loc_CDC2
loc_CDDC:
										cmpi.b  #1,d2
										bne.s   loc_CDE4
										moveq   #0,d2
loc_CDE4:
										movem.l (sp)+,d0-d1/d3-a6
										rts

	; End of function sub_CD68


; =============== S U B R O U T I N E =======================================

sub_CDEA:
										movem.l d0-d5/d7-a6,-(sp)
										bsr.w   GetLowerMoveType
										cmpi.w  #$D,d1
										bne.s   loc_CE00
										move.w  #$D,d6
										bra.w   loc_CE30
loc_CE00:
										cmpi.w  #$E,d1
										bne.s   loc_CE0E
										move.w  #$D,d6
										bra.w   loc_CE30
loc_CE0E:
										bsr.w   GetUpperMoveType
										lea     (byte_D8F4).l,a0
										move.w  #$D,d6
										clr.w   d0
loc_CE1E:
										cmp.b   (a0,d0.w),d1
										bne.s   loc_CE28
										bra.w   loc_CE30
loc_CE28:
										addi.w  #1,d0
										subq.w  #1,d6
										bne.s   loc_CE1E
loc_CE30:
										movem.l (sp)+,d0-d5/d7-a6
										rts

	; End of function sub_CDEA


; =============== S U B R O U T I N E =======================================

sub_CE36:
										movem.l d0-d5/d7-a6,-(sp)
										clr.w   d5
										move.b  d0,d5
										move.w  d4,d0
										btst    #7,d0
										beq.s   loc_CE4A
										bra.w   loc_CE90
loc_CE4A:
										bsr.w   CheckMuddled2   
										tst.b   d1
										beq.s   loc_CE56
										bra.w   loc_CE90
loc_CE56:
										cmpi.b  #1,d7
										bne.s   loc_CE66
										lea     (byte_DA22).l,a4
										bra.w   loc_CE80
loc_CE66:
										clr.l   d0
										move.b  d4,d0
										jsr     GetUpperMoveType
										clr.l   d3
										move.b  d1,d3
										lea     (off_D9C2).l,a4 
										lsl.l   #2,d3
										movea.l (a4,d3.l),a4
loc_CE80:
										clr.w   d0
										move.b  d5,d0
										bsr.w   GetClass
										clr.w   d2
										move.b  (a4,d1.w),d2
										add.w   d2,d6
loc_CE90:
										movem.l (sp)+,d0-d5/d7-a6
										rts

	; End of function sub_CE36


; =============== S U B R O U T I N E =======================================

sub_CE96:
										movem.l d0/d3-a6,-(sp)
										jsr     GetYPos
										move.w  d1,d2
										jsr     GetXPos
										bsr.w   MakeTargetListEverybody
										moveq   #0,d3
										moveq   #0,d4
										move.w  d1,d5
										move.w  d2,d6
										bsr.w   GetClosestAttackPosition
										cmpi.w  #$FFFF,d1
										bne.w   loc_CECC
										moveq   #1,d3
										moveq   #1,d4
										move.w  d5,d1
										move.w  d6,d2
										bsr.w   GetClosestAttackPosition
loc_CECC:
										movem.l (sp)+,d0/d3-a6
										rts

	; End of function sub_CE96


; =============== S U B R O U T I N E =======================================

; Get highest usable level of spell D1, considering current MP and highest known level.
; In: D0 = combatant idx
;     D1 = spell idx
; Out: D1 = spell idx

GetHighestUsableSpellLevel:
										
										movem.l d0/d2-a6,-(sp)
										move.w  d1,d2
										jsr     GetCurrentMP
										move.w  d1,d3
										move.w  d2,d1
										andi.w  #$3F,d1 
										lsr.w   #6,d2
										andi.w  #3,d2
loc_CEEC:
										moveq   #0,d1
										add.w   d2,d1
										lsl.w   #6,d1
										add.w   d4,d1
										jsr     GetSpellDefAddress
										cmp.b   1(a0),d3
										bcc.w   loc_CF08
										dbf     d2,loc_CEEC
										moveq   #$3F,d1 
loc_CF08:
										movem.l (sp)+,d0/d2-a6
										rts

	; End of function GetHighestUsableSpellLevel


; =============== S U B R O U T I N E =======================================

; In: D0 = combatant idx
;     D1 = spell idx
; Out: D1 = spell idx
;      D2 = slot

GetSlotContainingSpell:
										
										movem.l d0/d3-a6,-(sp)
										andi.b  #$3F,d1 
										move.b  d1,d4
										moveq   #0,d3
loc_CF1A:
										move.w  d3,d1
loc_CF1C:
										jsr     GetSpellAndNumberOfSpells
										move.w  d1,d2
										andi.b  #$3F,d2 
										cmp.b   d4,d2
										beq.w   loc_CF38
										addq.w  #1,d3
loc_CF30:
										cmpi.w  #4,d3
										bcs.s   loc_CF1A
										moveq   #$3F,d1 
loc_CF38:
										move.w  d3,d2
loc_CF3A:
										movem.l (sp)+,d0/d3-a6
										rts

	; End of function GetSlotContainingSpell


; =============== S U B R O U T I N E =======================================

; In: D0 = combatant idx
;     D1 = item idx
; Out: D1 = item idx
;      D2 = slot

GetSlotContainingItem:
										
										movem.l d0/d3-a6,-(sp)
loc_CF44:
										andi.w  #$7F,d1 
										move.w  d1,d4
										moveq   #0,d3
loc_CF4C:
										move.w  d3,d1
loc_CF4E:
										jsr     GetCharItemAtSlotAndNumberOfItems
										move.w  d1,d2
										andi.w  #$7F,d2 
										cmp.w   d4,d2
										beq.w   loc_CF6C
										addq.w  #1,d3
loc_CF62:
										cmpi.w  #4,d3
										bcs.s   loc_CF4C
										move.w  #$7F,d1 
loc_CF6C:
										move.w  d3,d2
										movem.l (sp)+,d0/d3-a6
										rts

	; End of function GetSlotContainingItem


; =============== S U B R O U T I N E =======================================

GetNextUsableAttackSpell:
										
										movem.l d0/d3-a6,-(sp)
										bsr.w   CheckMuddled2   
										move.w  d1,d7
										btst    #CHAR_BIT_ENEMY,d0
										bne.s   loc_CF88
loc_CF84:
										move.w  #1,d7
loc_CF88:
										move.w  d3,d1
loc_CF8A:
										jsr     GetSpellAndNumberOfSpells
										move.w  d1,d4
										andi.w  #SPELL_MASK_IDX,d4
										cmpi.w  #SPELLIDX_NOTHING,d4
										bne.s   loc_CFA0
										bra.w   loc_CFFC
loc_CFA0:
										tst.b   d7
										beq.s   loc_CFEA
										move.w  d1,d5
										andi.b  #SPELL_MASK_IDX,d5
										cmpi.b  #SPELLIDX_BLAZE,d5
										bne.s   loc_CFB4
										bra.w   loc_CFEA
loc_CFB4:
										cmpi.b  #SPELLIDX_FREEZE,d5
										bne.s   loc_CFBE
										bra.w   loc_CFEA
loc_CFBE:
										cmpi.b  #SPELLIDX_BOLT,d5
										bne.s   loc_CFC8
										bra.w   loc_CFEA
loc_CFC8:
										cmpi.b  #SPELLIDX_BLAST,d5
										bne.s   loc_CFD2
										bra.w   loc_CFEA
loc_CFD2:
										cmpi.b  #SPELLIDX_KATON,d5
										bne.s   loc_CFDC
										bra.w   loc_CFEA
loc_CFDC:
										cmpi.b  #SPELLIDX_RAIJIN,d5
										bne.s   loc_CFE6
										bra.w   loc_CFEA
loc_CFE6:
										bra.w   loc_CFFC
loc_CFEA:
										jsr     GetSpellDefAddress
										move.b  SPELLDEF_OFFSET_PROPS(a0),d2
										andi.b  #SPELLDEF_PROPS_TYPE_MASK,d2
										beq.w   loc_D00C
loc_CFFC:
										addq.w  #1,d3
										cmpi.w  #CHAR_SPELLSLOTS,d3
										bcs.s   loc_CF88
loc_D004:
										move.w  #SPELLIDX_NOTHING,d1
										bra.w   loc_D012
loc_D00C:
										bsr.w   GetHighestUsableSpellLevel
										move.w  d3,d2
loc_D012:
										movem.l (sp)+,d0/d3-a6
										rts

	; End of function GetNextUsableAttackSpell


; =============== S U B R O U T I N E =======================================

; Get next healing spell known by combatant.
; In: D0 = entity #
;     D3 = starting spell slot
; Out: D1 = spell idx
;      D2 = spell slot

GetNextHealingSpell:
										
										movem.l d0/d3-a6,-(sp)
loc_D01C:
										move.w  d3,d1
										jsr     GetSpellAndNumberOfSpells
										move.w  d1,d4
										andi.w  #$3F,d4 
										cmpi.w  #$3F,d4 
										bne.s   loc_D034
										bra.w   loc_D04A
loc_D034:
										jsr     GetSpellDefAddress
										move.b  3(a0),d2
										andi.b  #3,d2
										cmpi.b  #1,d2
										beq.w   loc_D05A
loc_D04A:
										addq.w  #1,d3
										cmpi.w  #4,d3
										bcs.s   loc_D01C
										move.w  #$3F,d1 
										bra.w   loc_D05C
loc_D05A:
										move.w  d3,d2
loc_D05C:
										movem.l (sp)+,d0/d3-a6
										rts

	; End of function GetNextHealingSpell


; =============== S U B R O U T I N E =======================================

GetNextStatusSpell:
										
										movem.l d0/d3-a6,-(sp)
loc_D066:
										move.w  d3,d1
										jsr     GetSpellAndNumberOfSpells
										move.w  d1,d4
										andi.w  #SPELL_MASK_IDX,d4
										cmpi.w  #SPELLIDX_NOTHING,d4
										bne.s   loc_D07E
										bra.w   loc_D094
loc_D07E:
										jsr     GetSpellDefAddress
										move.b  SPELLDEF_OFFSET_PROPS(a0),d2
										andi.b  #SPELLDEF_PROPS_TYPE_MASK,d2
										cmpi.b  #SPELLDEF_TYPE_STATUS,d2
										beq.w   loc_D0A4
loc_D094:
										addq.w  #1,d3
										cmpi.w  #CHAR_SPELLSLOTS,d3
										bcs.s   loc_D066
										move.w  #SPELLIDX_NOTHING,d1
										bra.w   loc_D0A6
loc_D0A4:
										move.w  d3,d2
loc_D0A6:
										movem.l (sp)+,d0/d3-a6
										rts

	; End of function GetNextStatusSpell


; =============== S U B R O U T I N E =======================================

; Get the next item in combatant's inventory that can be used to cast BLAZE/FREEZE/BOLT/BLAST.
; <HARDCODED>
; In: D0 = combatant idx
;     D3 = starting item slot
; Out: D1 = item idx
;      D2 = item slot

GetNextUsableAttackItem:
										
										movem.l d0/d3-a6,-(sp)
										bsr.w   CheckMuddled2   
										move.w  d1,d6
										btst    #CHAR_BIT_ENEMY,d0
										bne.s   loc_D0C0
										move.w  #1,d6
loc_D0C0:
										move.w  d3,d1
										jsr     GetCharItemAtSlotAndNumberOfItems
										cmpi.w  #ITEMIDX_NOTHING,d1
										bne.s   loc_D0D2
										bra.w   loc_D0DC
loc_D0D2:
										jsr     IsItemUsableInBattle
										bcs.w   loc_D0E8
loc_D0DC:
										addq.w  #1,d3
										cmpi.w  #CHAR_ITEMSLOTS,d3
										bcs.s   loc_D0C0
										bra.w   loc_D156
loc_D0E8:
										btst    #ITEM_BIT_EQUIPPED,d1
										bne.w   loc_D0F8
										btst    #ITEM_BIT_ENEMYUSE,d1
										beq.w   loc_D156
loc_D0F8:
										jsr     GetItemDefAddress
										move.w  d1,d7
										clr.w   d1
										move.b  ITEMDEF_OFFSET_SPELL(a0),d1
										tst.b   d6
										beq.s   loc_D13C
										move.w  d1,d5
										andi.b  #SPELL_MASK_IDX,d5
										cmpi.b  #SPELLIDX_BLAZE,d5
										bne.s   loc_D11A
										bra.w   loc_D13C
loc_D11A:
										cmpi.b  #SPELLIDX_FREEZE,d5
										bne.s   loc_D124
										bra.w   loc_D13C
loc_D124:
										cmpi.b  #SPELLIDX_BOLT,d5
										bne.s   loc_D12E
										bra.w   loc_D13C
loc_D12E:
										cmpi.b  #SPELLIDX_BLAST,d5
										bne.s   loc_D138
										bra.w   loc_D13C
loc_D138:
										bra.w   loc_D156
loc_D13C:
										jsr     GetSpellDefAddress
										move.b  SPELLDEF_OFFSET_PROPS(a0),d2
										andi.b  #SPELLDEF_PROPS_TYPE_MASK,d2
										bne.w   loc_D156
										move.w  d3,d2
										move.w  d7,d1
										bra.w   loc_D15A
loc_D156:
										move.w  #ITEMIDX_NOTHING,d1
loc_D15A:
										movem.l (sp)+,d0/d3-a6
										rts

	; End of function GetNextUsableAttackItem


; =============== S U B R O U T I N E =======================================

; Get the next item in combatant's inventory that can be used to cast a healing spell.
; <HARDCODED>
; In: D0 = combatant idx
;     D3 = starting item slot
; Out: D1 = item idx
;      D2 = item slot

GetNextUsableHealingItem:
										
										movem.l d0/d3-a6,-(sp)
loc_D164:
										move.w  d3,d1
										jsr     GetCharItemAtSlotAndNumberOfItems
										cmpi.w  #ITEMIDX_NOTHING,d1
										bne.s   loc_D176
										bra.w   loc_D1BA
loc_D176:
										move.w  d1,d7
										jsr     IsItemUsableInBattle
										bcc.s   loc_D1BA
										cmpi.b  #8,d7
										beq.s   loc_D18E
										btst    #ITEM_BIT_ENEMYUSE,d1
										beq.w   loc_D1BA
loc_D18E:
										jsr     GetItemDefAddress
										move.w  d1,d7
										clr.w   d1
										move.b  9(a0),d1
										jsr     GetSpellDefAddress
										move.b  3(a0),d2
										andi.b  #3,d2
										cmpi.b  #1,d2
										bne.w   loc_D1BA
										move.w  d3,d2
										move.w  d7,d1
										bra.w   loc_D1C6
loc_D1BA:
										addq.w  #1,d3
										cmpi.w  #4,d3
										bcs.s   loc_D164
										move.w  #$7F,d1 
loc_D1C6:
										movem.l (sp)+,d0/d3-a6
										rts

	; End of function GetNextUsableHealingItem


; =============== S U B R O U T I N E =======================================

GetTargetsReachableByAttack:
										
										movem.l d0-d5/d7-a3,-(sp)
										lea     ((DMA_SPACE_FF8804-$1000000)).w,a1
										lea     ((byte_FF880E-$1000000)).w,a2
										lea     ((byte_FF889E-$1000000)).w,a3
										bsr.w   GetWeaponRange  
										bra.w   loc_D22E

	; End of function GetTargetsReachableByAttack


; =============== S U B R O U T I N E =======================================

GetTargetsReachableByItem:
										
										movem.l d0-d5/d7-a3,-(sp)
										lea     ((byte_FF8808-$1000000)).w,a1
										lea     ((byte_FF886E-$1000000)).w,a2
										lea     ((byte_FF88FE-$1000000)).w,a3
										jsr     GetItemDefAddress
										move.b  9(a0),d1
										jsr     GetSpellDefAddress
										move.b  4(a0),d3
										move.b  5(a0),d4
										bra.w   loc_D22E

	; End of function GetTargetsReachableByItem


; =============== S U B R O U T I N E =======================================

GetTargetsReachableBySpell:
										
										movem.l d0-d5/d7-a3,-(sp)
										lea     ((word_FF8806-$1000000)).w,a1
										lea     ((byte_FF883E-$1000000)).w,a2
										lea     ((byte_FF88CE-$1000000)).w,a3
										jsr     GetSpellDefAddress
										move.b  4(a0),d3
										move.b  5(a0),d4
loc_D22E:
										bsr.w   CheckMuddled2   
										tst.b   d1
										beq.s   loc_D23A
										eori.b  #$80,d0         ; flip enemy bit, to get the opposite type when muddled
loc_D23A:
										btst    #7,d0
										beq.s   loc_D248
										moveq   #0,d0
										move.w  #$1D,d7
										bra.s   loc_D250
loc_D248:
										move.b  #$80,d0
loc_D24C:
										move.w  #$1F,d7
loc_D250:
										move.w  #0,(a1)
loc_D254:
										jsr     GetCurrentHP
										tst.w   d1
										bne.s   loc_D262
										bra.w   loc_D28A        ; combatant is dead, so skip
loc_D262:
										jsr     GetYPos
										move.b  d1,d2
										jsr     GetXPos
										bsr.w   GetClosestAttackPosition
										cmpi.b  #$FF,d1
loc_D278:
										beq.w   loc_D28A
										addq.w  #1,(a1)
										move.b  d0,(a2)+
										move.b  d0,d5
										bsr.w   GetDestinationMoveCost
										move.b  d0,(a3)+
										move.b  d5,d0
loc_D28A:
										addq.b  #1,d0
										dbf     d7,loc_D254
										movem.l (sp)+,d0-d5/d7-a3
										rts

	; End of function GetTargetsReachableBySpell


; =============== S U B R O U T I N E =======================================

IsCharacterLessThanHalfHP:
										
										movem.l d1-d2,-(sp)
										jsr     GetCurrentHP
										move.w  d1,d2
										jsr     GetMaxHP
										bra.w   loc_D2C8
										movem.l d1-d2,-(sp)
										move.w  d1,d2
										jsr     GetMaxHP
										bra.w   loc_D2C8
										movem.l d1-d2,-(sp)
										move.w  d1,d2
										jsr     GetCurrentHP
loc_D2C8:
										add.w   d2,d2
										cmp.w   d2,d1
										movem.l (sp)+,d1-d2
										rts

	; End of function IsCharacterLessThanHalfHP


; =============== S U B R O U T I N E =======================================

sub_D2D2:
										movem.l d1-d2,-(sp)
										jsr     GetCurrentHP
										move.w  d1,d2
										jsr     GetMaxHP
loc_D2E4:
										bra.w   loc_D304
loc_D2E8:
										movem.l d1-d2,-(sp)
										move.w  d1,d2
										jsr     GetMaxHP
										bra.w   loc_D304

	; End of function sub_D2D2


; =============== S U B R O U T I N E =======================================

sub_D2F8:
										movem.l d1-d2,-(sp)
										move.w  d1,d2
										jsr     GetCurrentHP
loc_D304:
										mulu.w  #3,d2
										cmp.w   d2,d1
										movem.l (sp)+,d1-d2
										rts

	; End of function sub_D2F8


; =============== S U B R O U T I N E =======================================

sub_D310:
										movem.l d1-d2,-(sp)
										jsr     GetCurrentHP
										move.w  d1,d2
										jsr     GetMaxHP
										bra.w   loc_D342

	; End of function sub_D310


; =============== S U B R O U T I N E =======================================

sub_D326:
										movem.l d1-d2,-(sp)
										move.w  d1,d2
										jsr     GetMaxHP
										bra.w   loc_D342

	; End of function sub_D326


; =============== S U B R O U T I N E =======================================

sub_D336:
										movem.l d1-d2,-(sp)
										move.w  d1,d2
loc_D33C:
										jsr     GetCurrentHP

	; End of function sub_D336


; START OF FUNCTION CHUNK FOR sub_D310

loc_D342:
										lsl.w   #2,d2
										cmp.w   d2,d1
										movem.l (sp)+,d1-d2
										rts

; END OF FUNCTION CHUNK FOR sub_D310


; =============== S U B R O U T I N E =======================================

sub_D34C:
										movem.l d1-d2,-(sp)
										jsr     GetCurrentHP
										move.w  d1,d2
										jsr     GetMaxHP
										bra.w   loc_D37E

	; End of function sub_D34C


; =============== S U B R O U T I N E =======================================

sub_D362:
										movem.l d1-d2,-(sp)
										move.w  d1,d2
										jsr     GetMaxHP
										bra.w   loc_D37E
										movem.l d1-d2,-(sp)
										move.w  d1,d2
										jsr     GetCurrentHP
loc_D37E:
										mulu.w  #5,d2
										cmp.w   d2,d1
										movem.l (sp)+,d1-d2
										rts

	; End of function sub_D362


; =============== S U B R O U T I N E =======================================

sub_D38A:
										movem.l d1-d2,-(sp)
										jsr     GetCurrentHP
										move.w  d1,d2
loc_D396:
										jsr     GetMaxHP
										bra.w   loc_D3BC
										movem.l d1-d2,-(sp)
										move.w  d1,d2
										jsr     GetMaxHP
										bra.w   loc_D3BC
										movem.l d1-d2,-(sp)
										move.w  d1,d2
										jsr     GetCurrentHP
loc_D3BC:
										mulu.w  #3,d2
										add.w   d1,d1
										cmp.w   d2,d1
										movem.l (sp)+,d1-d2
										rts

	; End of function sub_D38A


; =============== S U B R O U T I N E =======================================

sub_D3CA:
										movem.l d1-d2,-(sp)
										jsr     GetCurrentMP
										move.w  d1,d2
										jsr     GetMaxMP
										bra.w   loc_D3FC

	; End of function sub_D3CA


; =============== S U B R O U T I N E =======================================

sub_D3E0:
										movem.l d1-d2,-(sp)
										move.w  d1,d2
										jsr     GetMaxMP
										bra.w   loc_D3FC

	; End of function sub_D3E0


; =============== S U B R O U T I N E =======================================

sub_D3F0:
										movem.l d1-d2,-(sp)
										move.w  d1,d2
										jsr     GetCurrentMP

	; End of function sub_D3F0


; START OF FUNCTION CHUNK FOR sub_D3CA

loc_D3FC:
										mulu.w  #3,d2
										cmp.w   d2,d1
										movem.l (sp)+,d1-d2
										rts

; END OF FUNCTION CHUNK FOR sub_D3CA


; =============== S U B R O U T I N E =======================================

GetDifficulty:
										
										movem.l d0/d2-a6,-(sp)
										clr.w   d2
										move.w  #$4E,d1 
										bsr.w   CheckFlag
										beq.s   loc_D41C
										move.w  #1,d2
loc_D41C:
										move.w  #$4F,d1 
										bsr.w   CheckFlag
										beq.s   loc_D428
										addq.w  #2,d2
loc_D428:
										move.w  d2,d1
										movem.l (sp)+,d0/d2-a6
										rts

	; End of function GetDifficulty


; =============== S U B R O U T I N E =======================================

sub_D430:
										movem.l d0/d2-a6,-(sp)
										link    a6,#-2
										move.b  d0,-1(a6)
										move.b  d1,-2(a6)
										clr.w   d0
										move.b  -1(a6),d0
										bsr.w   GetCurrentTerrainType
										btst    #7,d0
										bne.s   loc_D454
										clr.w   d1
										bra.s   loc_D458
loc_D454:
										move.b  #$FF,d1
loc_D458:
										unlk    a6
										movem.l (sp)+,d0/d2-a6
										rts

	; End of function sub_D430


; =============== S U B R O U T I N E =======================================

sub_D460:
										movem.l d0-a6,-(sp)
										move.w  d0,d7
										move.w  #5,d1
										bsr.w   GetTargetsReachableBySpell
										lea     ((word_FF8806-$1000000)).w,a0
										move.w  (a0),d0
										tst.w   d0
										bne.s   loc_D47C
										bra.w   loc_D4DA
loc_D47C:
										lea     ((word_FF8806-$1000000)).w,a0
										move.w  (a0),d5
										subi.w  #1,d5
										lea     ((byte_FF883E-$1000000)).w,a0
										lea     ((byte_FF880E-$1000000)).w,a1
loc_D48E:
										move.b  (a0)+,(a1)+
										dbf     d5,loc_D48E
										lea     ((byte_FF895E-$1000000)).w,a0
										lea     ((byte_FF880E-$1000000)).w,a1
										lea     ((byte_FF883E-$1000000)).w,a4
										clr.w   d4
										clr.w   d5
										lea     ((word_FF8806-$1000000)).w,a3
										move.w  (a3),d6
										subi.w  #1,d6
loc_D4AE:
										clr.w   d0
										move.b  (a1,d4.w),d0
loc_D4B4:
										move.w  #$46,d1 
										bsr.w   CreateTargetGrid
										bsr.w   sub_D7AA
										tst.w   d1
										beq.s   loc_D4D0
										move.b  d1,(a0,d5.w)
loc_D4C8:
										move.b  d0,(a4,d5.w)
										addi.w  #1,d5
loc_D4D0:
										addi.w  #1,d4
										dbf     d6,loc_D4AE
										move.w  d5,(a3)
loc_D4DA:
										movem.l (sp)+,d0-a6
										rts

	; End of function sub_D460


; =============== S U B R O U T I N E =======================================

sub_D4E0:
										movem.l d0-a6,-(sp)
										move.w  d0,d7
										move.w  #$46,d1 
										bsr.w   GetTargetsReachableBySpell
										lea     ((word_FF8806-$1000000)).w,a0
										move.w  (a0),d0
										tst.w   d0
										bne.s   loc_D4FC
										bra.w   loc_D55A
loc_D4FC:
										lea     ((word_FF8806-$1000000)).w,a0
										move.w  (a0),d5
										subi.w  #1,d5
										lea     ((byte_FF883E-$1000000)).w,a0
										lea     ((byte_FF880E-$1000000)).w,a1
loc_D50E:
										move.b  (a0)+,(a1)+
										dbf     d5,loc_D50E
										lea     ((byte_FF895E-$1000000)).w,a0
										lea     ((byte_FF880E-$1000000)).w,a1
loc_D51C:
										lea     ((byte_FF883E-$1000000)).w,a4
										clr.w   d4
										clr.w   d5
loc_D524:
										lea     ((word_FF8806-$1000000)).w,a3
										move.w  (a3),d6
										subi.w  #1,d6
loc_D52E:
										clr.w   d0
										move.b  (a1,d4.w),d0
										move.w  #$46,d1 
										bsr.w   CreateTargetGrid
										bsr.w   sub_D742
										tst.w   d1
										beq.s   loc_D550
										move.b  d1,(a0,d5.w)
										move.b  d0,(a4,d5.w)
										addi.w  #1,d5
loc_D550:
										addi.w  #1,d4
										dbf     d6,loc_D52E
										move.w  d5,(a3)
loc_D55A:
										movem.l (sp)+,d0-a6
										rts

	; End of function sub_D4E0


; =============== S U B R O U T I N E =======================================

sub_D560:
										movem.l d0-a6,-(sp)
										move.w  d0,d7
										move.w  #6,d1
										bsr.w   GetTargetsReachableBySpell
										lea     ((word_FF8806-$1000000)).w,a0
										move.w  (a0),d0
										tst.w   d0
										bne.s   loc_D57C
										bra.w   loc_D626
loc_D57C:
										move.w  d0,d5
										subi.w  #1,d5
										lea     ((byte_FF883E-$1000000)).w,a1
										lea     ((byte_FF895E-$1000000)).w,a2
										lea     ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,a3
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a4
loc_D592:
										clr.w   d0
										move.b  (a1)+,d0
										move.w  #6,d1
										bsr.w   CreateTargetGrid
										bsr.w   sub_D6F2
										move.b  d1,(a2)+
										dbf     d5,loc_D592
										lea     ((word_FF8806-$1000000)).w,a0
										move.w  (a0),d5
loc_D5AE:
										subi.w  #1,d5
										lea     ((byte_FF883E-$1000000)).w,a0
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a1
loc_D5BA:
										move.b  (a0)+,(a1)+
loc_D5BC:
										dbf     d5,loc_D5BA
										lea     ((word_FF8806-$1000000)).w,a0
										move.w  (a0),d5
										subi.w  #1,d5
										lea     ((byte_FF883E-$1000000)).w,a1
										lea     ((byte_FF895E-$1000000)).w,a2
										lea     ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,a3
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a4
										lea     ((byte_FF892E-$1000000)).w,a5
										clr.w   d4
										clr.w   d3
loc_D5E2:
										clr.w   d0
										move.b  (a2,d3.w),d0
										cmpi.b  #2,d0
										blt.s   loc_D5FE
										move.b  d0,(a5,d4.w)
										move.b  (a4,d3.w),d0
										move.b  d0,(a1,d4.w)
										addi.w  #1,d4
loc_D5FE:
										addi.w  #1,d3
										dbf     d5,loc_D5E2
										lea     ((word_FF8806-$1000000)).w,a0
										move.w  d4,(a0)
										tst.w   d4
										bne.s   loc_D614
										bra.w   loc_D626
loc_D614:
										subi.w  #1,d4
loc_D618:
										lea     ((byte_FF892E-$1000000)).w,a0
										lea     ((byte_FF895E-$1000000)).w,a1
loc_D620:
										move.b  (a0)+,(a1)+
										dbf     d4,loc_D620
loc_D626:
										movem.l (sp)+,d0-a6
										rts

	; End of function sub_D560


; =============== S U B R O U T I N E =======================================

sub_D62C:
										movem.l d0-a6,-(sp)
										move.w  d0,d7
										move.w  #$47,d1 
										bsr.w   GetTargetsReachableBySpell
										lea     ((word_FF8806-$1000000)).w,a0
										move.w  (a0),d0
										tst.w   d0
										bne.s   loc_D648
										bra.w   loc_D6EC
loc_D648:
										move.w  d0,d5
										subi.w  #1,d5
										lea     ((byte_FF883E-$1000000)).w,a1
										lea     ((byte_FF895E-$1000000)).w,a2
										lea     ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,a3
loc_D65A:
										clr.w   d0
										move.b  (a1)+,d0
										move.w  #$47,d1 
										bsr.w   CreateTargetGrid
										move.w  (a3),d2
										move.b  d2,(a2)+
										dbf     d5,loc_D65A
										lea     ((word_FF8806-$1000000)).w,a0
										move.w  (a0),d5
										subi.w  #1,d5
										lea     ((byte_FF883E-$1000000)).w,a0
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a1
loc_D680:
										move.b  (a0)+,(a1)+
										dbf     d5,loc_D680
										lea     ((word_FF8806-$1000000)).w,a0
										move.w  (a0),d5
										subi.w  #1,d5
										lea     ((byte_FF883E-$1000000)).w,a1
										lea     ((byte_FF895E-$1000000)).w,a2
										lea     ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,a3
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a4
										lea     ((byte_FF892E-$1000000)).w,a5
										clr.w   d4
										clr.w   d3
loc_D6A8:
										clr.w   d0
										move.b  (a2,d3.w),d0
										cmpi.b  #3,d0
										blt.s   loc_D6C4
										move.b  d0,(a5,d4.w)
										move.b  (a4,d3.w),d0
										move.b  d0,(a1,d4.w)
										addi.w  #1,d4
loc_D6C4:
										addi.w  #1,d3
										dbf     d5,loc_D6A8
loc_D6CC:
										lea     ((word_FF8806-$1000000)).w,a0
										move.w  d4,(a0)
										tst.w   d4
										bne.s   loc_D6DA
										bra.w   loc_D6EC
loc_D6DA:
										subi.w  #1,d4
										lea     ((byte_FF892E-$1000000)).w,a0
										lea     ((byte_FF895E-$1000000)).w,a1
loc_D6E6:
										move.b  (a0)+,(a1)+
										dbf     d4,loc_D6E6
loc_D6EC:
										movem.l (sp)+,d0-a6
										rts

	; End of function sub_D62C


; =============== S U B R O U T I N E =======================================

sub_D6F2:
										movem.l d0/d2-a6,-(sp)
										lea     ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,a0
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a1
										move.w  (a0),d7
										subi.w  #1,d7
										clr.w   d6
										clr.w   d5
loc_D708:
										clr.w   d0
										move.b  (a1,d5.w),d0
										clr.w   d3
										bsr.w   GetNextUsableAttackSpell
										cmpi.w  #$3F,d1 
										beq.s   loc_D722
										addi.w  #1,d6
										bra.w   loc_D732
loc_D722:
										clr.w   d3
										bsr.w   GetNextHealingSpell
										cmpi.w  #$3F,d1 
										beq.s   loc_D732
										addi.w  #1,d6
loc_D732:
										addi.w  #1,d5
										dbf     d7,loc_D708
										move.w  d6,d1
										movem.l (sp)+,d0/d2-a6
										rts

	; End of function sub_D6F2


; =============== S U B R O U T I N E =======================================

sub_D742:
										movem.l d0/d2-a6,-(sp)
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a0
										lea     ((ENEMY_TARGETTING_COMMAND_LIST-$1000000)).w,a2
										clr.w   d4
										lea     ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,a3
										clr.w   d5
										move.w  (a3),d6
										tst.w   d6
										bne.s   loc_D760
										bra.w   loc_D7A2
loc_D760:
										subi.w  #1,d6
loc_D764:
										clr.w   d0
										move.b  (a0,d4.w),d0
										clr.w   d3
										bsr.w   GetNextUsableAttackSpell
										cmpi.b  #$3F,d1 
										bne.s   loc_D792
										andi.b  #$7F,d0 
										move.b  (a2,d0.w),d2
										cmpi.b  #$FF,d2
										beq.s   loc_D792
										move.w  d2,d0
										bsr.w   GetCurrentHP
										tst.w   d1
										beq.s   loc_D792
										addi.w  #1,d5
loc_D792:
										addi.w  #1,d4
										dbf     d6,loc_D764
										cmpi.w  #2,d5
										bge.s   loc_D7A2
										clr.w   d5
loc_D7A2:
										move.w  d5,d1
										movem.l (sp)+,d0/d2-a6
										rts

	; End of function sub_D742


; =============== S U B R O U T I N E =======================================

sub_D7AA:
										movem.l d0/d2-a6,-(sp)
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a0
										lea     ((ENEMY_TARGETTING_COMMAND_LIST-$1000000)).w,a2
										clr.w   d4
										clr.w   d5
										lea     ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,a3
										move.w  (a3),d6
										tst.w   d6
										bne.s   loc_D7C8
										bra.w   loc_D81C
loc_D7C8:
										subi.w  #1,d6
loc_D7CC:
										clr.w   d0
										move.b  (a0,d4.w),d0
										clr.w   d3
										bsr.w   GetNextUsableAttackSpell
										cmpi.b  #$3F,d1 
										bne.s   loc_D814
										andi.b  #$7F,d0 
										move.b  (a2,d0.w),d2
										cmpi.b  #$FF,d2
										beq.s   loc_D814
										move.w  d2,d0
										bsr.w   GetCurrentHP
										tst.w   d1
										beq.s   loc_D814
										move.b  (a0,d4.w),d0
										bsr.w   GetCurrentATK
										move.w  #$FF,d0
										sub.w   d1,d0
										add.w   d0,d5
										cmpi.w  #$FF,d5
										addi.w  #1,d5
										ble.s   loc_D814
										move.w  #$FF,d5
loc_D814:
										addi.w  #1,d4
										dbf     d6,loc_D7CC
loc_D81C:
										move.w  d5,d1
										movem.l (sp)+,d0/d2-a6
										rts

	; End of function sub_D7AA

MoveTypeTerrainCosts:
										incbin "battles/global/movetypeterraincosts.bin"
byte_D8F4:          dc.b $FF                ; related to move types
										dc.b $C
										dc.b $B
										dc.b $A
										dc.b 9
										dc.b 8
										dc.b 6
										dc.b 5
										dc.b 4
										dc.b 3
										dc.b 2
										dc.b 1
										dc.b 7
byte_D901:          dc.b 0
										dc.b $C
										dc.b 3
										dc.b $12
										dc.b $11
										dc.b 4
										dc.b $13
										dc.b $14
										dc.b 6
										dc.b 9
										dc.b $17
										dc.b $E
										dc.b $1A
										dc.b $A
										dc.b $1B
										dc.b 5
										dc.b 8
										dc.b $15
										dc.b $19
										dc.b $16
										dc.b 7
										dc.b $18
										dc.b 1
										dc.b $D
										dc.b $1D
										dc.b 2
										dc.b $1F
										dc.b $10
										dc.b $F
										dc.b $1E
										dc.b $B
										dc.b $1C
byte_D921:          dc.b 0
										dc.b $C
										dc.b $B
										dc.b $1C
										dc.b $1E
										dc.b 2
										dc.b $F
										dc.b $10
										dc.b $1F
										dc.b $1D
										dc.b 1
										dc.b $D
										dc.b 7
										dc.b $18
										dc.b 8
										dc.b 5
										dc.b $16
										dc.b $19
										dc.b $15
										dc.b $A
										dc.b $1B
										dc.b 3
										dc.b $11
										dc.b $12
										dc.b 4
										dc.b $14
										dc.b $13
										dc.b 9
										dc.b 6
										dc.b $1A
										dc.b $E
										dc.b $17
byte_D941:          dc.b 6
										dc.b 9
										dc.b $17
										dc.b $E
										dc.b $1A
										dc.b 3
										dc.b $12
										dc.b $11
										dc.b 4
										dc.b $13
										dc.b $14
										dc.b 0
										dc.b $C
										dc.b $A
										dc.b $1B
										dc.b 5
										dc.b 8
										dc.b $15
										dc.b $19
										dc.b $16
										dc.b 7
										dc.b $18
										dc.b 1
										dc.b $D
										dc.b $1D
										dc.b 2
										dc.b $1F
										dc.b $10
										dc.b $F
										dc.b $1E
										dc.b $B
										dc.b $1C
byte_D961:          dc.b 0
										dc.b $C
										dc.b 3
										dc.b $12
										dc.b $11
										dc.b 4
										dc.b $13
										dc.b $14
										dc.b 2
										dc.b $1F
										dc.b $10
										dc.b $F
										dc.b $1E
										dc.b 7
										dc.b $18
										dc.b 1
										dc.b $D
										dc.b $1D
										dc.b $B
										dc.b $1C
										dc.b 6
										dc.b 9
										dc.b $17
										dc.b $E
										dc.b $1A
										dc.b $A
										dc.b $1B
										dc.b 5
										dc.b 8
										dc.b $15
										dc.b $19
										dc.b $16
										dc.b $FF
off_D982:           dc.l byte_D901          ; related to move type
										dc.l byte_D901
										dc.l byte_D901
										dc.l byte_D901
										dc.l byte_D901
										dc.l byte_D961
										dc.l byte_D961
										dc.l byte_D901
off_D9A2:           dc.l byte_D941
off_D9A6:           dc.l byte_D941
										dc.l byte_D921
										dc.l byte_D921
										dc.l byte_D901
										dc.l byte_D901
										dc.l byte_D901
										dc.l byte_D901
off_D9C2:           dc.l byte_DA02          ; Gives values from Upper Move Type and Class
										dc.l byte_DA02
										dc.l byte_DA02
										dc.l byte_DA02
										dc.l byte_DA02
										dc.l byte_DA62
										dc.l byte_DA62
										dc.l byte_DA02
										dc.l byte_DA42
										dc.l byte_DA42
										dc.l byte_DA22
										dc.l byte_DA22
										dc.l byte_DA02
										dc.l byte_DA02
off_D9FA:           dc.l byte_DA02
										dc.l byte_DA02
byte_DA02:          dc.b 4
										dc.b 1
										dc.b 0
										dc.b 4
										dc.b 4
										dc.b 2
										dc.b 2
										dc.b 1
										dc.b 2
										dc.b 2
										dc.b 2
										dc.b 0
										dc.b 4
										dc.b 1
										dc.b 2
										dc.b 0
										dc.b 0
										dc.b 4
										dc.b 4
										dc.b 4
										dc.b 4
										dc.b 2
										dc.b 2
										dc.b 2
										dc.b 1
										dc.b 2
										dc.b 2
										dc.b 2
										dc.b 0
										dc.b 1
										dc.b 0
										dc.b 0
byte_DA22:          dc.b 3
										dc.b 1
										dc.b 3
										dc.b 0
										dc.b 0
										dc.b 1
										dc.b 0
										dc.b 1
										dc.b 1
										dc.b 0
										dc.b 1
										dc.b 3
										dc.b 3
										dc.b 2
										dc.b 0
										dc.b 3
										dc.b 3
										dc.b 0
										dc.b 0
										dc.b 0
										dc.b 0
										dc.b 1
										dc.b 1
										dc.b 0
										dc.b 1
										dc.b 1
										dc.b 0
										dc.b 1
										dc.b 3
										dc.b 2
										dc.b 3
										dc.b 3
byte_DA42:          dc.b 3
										dc.b 1
										dc.b 0
										dc.b 3
										dc.b 3
										dc.b 2
										dc.b 4
										dc.b 2
										dc.b 2
										dc.b 4
										dc.b 2
										dc.b 0
										dc.b 3
										dc.b 1
										dc.b 4
										dc.b 0
										dc.b 0
										dc.b 3
										dc.b 3
										dc.b 3
										dc.b 3
										dc.b 2
										dc.b 2
										dc.b 4
										dc.b 2
										dc.b 2
										dc.b 4
										dc.b 2
										dc.b 0
										dc.b 1
										dc.b 0
										dc.b 0
byte_DA62:          dc.b 3
										dc.b 2
										dc.b 2
										dc.b 3
										dc.b 3
										dc.b 0
										dc.b 1
										dc.b 2
										dc.b 0
										dc.b 1
										dc.b 0
										dc.b 1
										dc.b 3
										dc.b 2
										dc.b 1
										dc.b 2
										dc.b 2
										dc.b 3
										dc.b 3
										dc.b 3
										dc.b 3
										dc.b 0
										dc.b 0
										dc.b 1
										dc.b 2
										dc.b 0
										dc.b 1
										dc.b 0
										dc.b 1
										dc.b 2
										dc.b 2
										dc.b 2

; =============== S U B R O U T I N E =======================================

MakeRangeLists:
										
										movem.l d0-a5,-(sp)
										link    a6,#-$40
										lea     (a6),a1
										move.w  #$F,d5
										move.l  #$40004000,d1
loc_DA96:
										move.l  d1,-(a1)
										dbf     d5,loc_DA96
										lea     (a3),a1
										move.w  #$8F,d5 
										moveq   #$FFFFFFFF,d1
loc_DAA4:
										move.l  d1,(a1)+
										move.l  d1,(a1)+
										move.l  d1,(a1)+
										move.l  d1,(a1)+
										dbf     d5,loc_DAA4
										lea     (a2),a1
										move.w  #$8F,d5 
										moveq   #$FFFFFFFF,d1
loc_DAB8:
										move.l  d1,(a1)+
										move.l  d1,(a1)+
										move.l  d1,(a1)+
										move.l  d1,(a1)+
										dbf     d5,loc_DAB8
										clr.w   d6
										moveq   #0,d5
										move.b  d4,d5
										mulu.w  #$30,d5 
										andi.w  #$FF,d3
										add.w   d3,d5
loc_DAD4:
										move.b  d6,(a2,d5.w)
										move.w  d6,d1
										lsr.w   #8,d1
										move.b  d1,(a3,d5.w)
										tst.b   1(a3,d5.w)
										bpl.s   loc_DAEC
										addq.w  #1,d5
										bsr.s   sub_DB48
										subq.w  #1,d5
loc_DAEC:
										tst.b   -1(a3,d5.w)
										bpl.s   loc_DAF8
										subq.w  #1,d5
										bsr.s   sub_DB48
										addq.w  #1,d5
loc_DAF8:
										tst.b   -$30(a3,d5.w)
										bpl.s   loc_DB08
										subi.w  #$30,d5 
										bsr.s   sub_DB48
										addi.w  #$30,d5 
loc_DB08:
										tst.b   $30(a3,d5.w)
										bpl.s   loc_DB18
										addi.w  #$30,d5 
										bsr.s   sub_DB48
										subi.w  #$30,d5 
loc_DB18:
										move.w  d0,d1
										andi.w  #$1F,d1
										add.w   d1,d1
										move.w  -$40(a6,d1.w),d5
										btst    #$E,d5
										bne.s   loc_DB38
										move.b  (a3,d5.w),-$40(a6,d1.w)
										move.b  (a2,d5.w),-$3F(a6,d1.w)
										bra.s   loc_DAD4
loc_DB38:
										addq.w  #1,d6
										subq.w  #1,d0
										bmi.s   loc_DB40
										bne.s   loc_DB18
loc_DB40:
										unlk    a6
										movem.l (sp)+,d0-a5
										rts

	; End of function MakeRangeLists


; =============== S U B R O U T I N E =======================================

sub_DB48:
										cmpi.w  #$900,d5
										bcs.s   loc_DB50
										rts
loc_DB50:
										move.b  (a4,d5.w),d1
										btst    #7,d1
										beq.s   loc_DB5C
										rts
loc_DB5C:
										andi.w  #$1F,d1
										move.b  (a5,d1.w),d2
										ext.w   d2
										cmp.w   d2,d0
										bcc.s   loc_DB6C
										rts
loc_DB6C:
										beq.s   loc_DB8A
										move.w  d0,d1
										sub.w   d2,d1
										andi.w  #$1F,d1
										add.w   d1,d1
										move.b  -$40(a6,d1.w),(a3,d5.w)
										move.b  -$3F(a6,d1.w),(a2,d5.w)
										move.w  d5,-$40(a6,d1.w)
										rts
loc_DB8A:
										add.w   d6,d2
										move.b  d2,(a2,d5.w)
										move.w  d2,d1
										lsr.w   #8,d1
										move.b  d1,(a3,d5.w)
										rts

	; End of function sub_DB48


; =============== S U B R O U T I N E =======================================

MakeBattleEntityCancelMoveString_0:
										
										movem.l d0-d6/a0-a5,-(sp)
										bsr.w   sub_DBA8
										movem.l (sp)+,d0-d6/a0-a5
										rts

	; End of function MakeBattleEntityCancelMoveString_0


; =============== S U B R O U T I N E =======================================

sub_DBA8:
										clr.w   d2
										move.b  d1,d2
										mulu.w  #$30,d2 
										andi.w  #$FF,d0
										add.w   d0,d2
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										clr.b   d3
loc_DBBC:
										move.b  (a3,d2.w),d4
										lsl.w   #8,d4
										move.b  (a2,d2.w),d4
										tst.w   d4
										bne.s   loc_DBCE
loc_DBCA:
										bra.w   loc_DD0A
loc_DBCE:
										subq.w  #1,d4
										clr.b   d5
										clr.b   d0
										addq.w  #1,d2
										move.b  (a3,d2.w),d0
										lsl.w   #8,d0
										move.b  (a2,d2.w),d0
										tst.w   d0
										bpl.s   loc_DBE8
										bra.w   loc_DBFA
loc_DBE8:
										cmp.w   d4,d0
										bmi.s   loc_DBEE
										bne.s   loc_DBFA
loc_DBEE:
										cmpi.w  #$900,d2
										bcc.s   loc_DBFA
										bset    #0,d5
										move.w  d0,d4
loc_DBFA:
										subq.w  #1,d2
										clr.b   d0
										subq.w  #1,d2
loc_DC00:
										move.b  (a3,d2.w),d0
										lsl.w   #8,d0
loc_DC06:
										move.b  (a2,d2.w),d0
										tst.w   d0
										bpl.s   loc_DC12
										bra.w   loc_DC2E
loc_DC12:
										cmp.w   d4,d0
										bmi.s   loc_DC18
										bne.s   loc_DC2E
loc_DC18:
										cmpi.w  #$900,d2
										bcc.s   loc_DC2E
										tst.b   d5
										bne.s   loc_DC28
										moveq   #4,d5
										bra.w   loc_DC2C
loc_DC28:
										bset    #2,d5
loc_DC2C:
										move.w  d0,d4
loc_DC2E:
										addq.w  #1,d2
										clr.b   d0
										subi.w  #$30,d2 
										move.b  (a3,d2.w),d0
										lsl.w   #8,d0
										move.b  (a2,d2.w),d0
										tst.w   d0
										bpl.s   loc_DC48
										bra.w   loc_DC64
loc_DC48:
										cmp.w   d4,d0
										bmi.s   loc_DC4E
										bne.s   loc_DC64
loc_DC4E:
										cmpi.w  #$900,d2
										bcc.s   loc_DC64
										tst.b   d5
										bne.s   loc_DC5E
										moveq   #2,d5
										bra.w   loc_DC62
loc_DC5E:
										bset    #1,d5
loc_DC62:
										move.w  d0,d4
loc_DC64:
										addi.w  #$30,d2 
										clr.b   d0
										addi.w  #$30,d2 
										move.b  (a3,d2.w),d0
										lsl.w   #8,d0
										move.b  (a2,d2.w),d0
										tst.w   d0
										bpl.s   loc_DC80
										bra.w   loc_DC9C
loc_DC80:
										cmp.w   d4,d0
										bmi.s   loc_DC86
										bne.s   loc_DC9C
loc_DC86:
										cmpi.w  #$900,d2
										bcc.s   loc_DC9C
										tst.b   d5
										bne.s   loc_DC96
										moveq   #8,d5
										bra.w   loc_DC9A
loc_DC96:
										bset    #3,d5
loc_DC9A:
										move.w  d0,d4
loc_DC9C:
										subi.w  #$30,d2 
										move.b  d3,d1
										and.b   d5,d1
										bne.s   loc_DCAA
										bra.w   loc_DCB4
loc_DCAA:
										move.b  d5,d1
										eor.b   d3,d1
										beq.s   loc_DCB4
										bra.w   loc_DCB6
loc_DCB4:
										move.b  d5,d1
loc_DCB6:
										ror.b   #1,d1
										bcc.s   loc_DCBE
										bra.w   loc_DCDA
loc_DCBE:
										ror.b   #1,d1
										bcc.s   loc_DCC6
										bra.w   loc_DCE6
loc_DCC6:
										ror.b   #1,d1
										bcc.s   loc_DCCE
										bra.w   loc_DCF2
loc_DCCE:
										ror.b   #1,d1
										bcc.s   loc_DCD6
										bra.w   loc_DCFC
loc_DCD6:
										bra.w   loc_DD0A
loc_DCDA:
										moveq   #0,d5
										moveq   #1,d3
										addi.w  #1,d2
										bra.w   loc_DD04
loc_DCE6:
										moveq   #1,d5
										moveq   #2,d3
										subi.w  #$30,d2 
loc_DCEE:
										bra.w   loc_DD04
loc_DCF2:
										moveq   #2,d5
										moveq   #4,d3
										subq.w  #1,d2
										bra.w   loc_DD04
loc_DCFC:
										moveq   #3,d5
										moveq   #8,d3
										addi.w  #$30,d2 
loc_DD04:
										move.b  d5,(a0)+
										bra.w   loc_DBBC
loc_DD0A:
										move.b  #$FF,(a0)
										rts

	; End of function sub_DBA8


; =============== S U B R O U T I N E =======================================

sub_DD10:
										movem.l d0-d6/a0-a5,-(sp)
										bsr.w   sub_DBA8
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a1
										move.w  a0,d0
										move.w  a1,d1
										sub.w   d1,d0
										bne.s   loc_DD28
										bra.w   loc_DD5A
loc_DD28:
										move.w  d0,d2
										lsr.w   #1,d2
										bcc.s   loc_DD30
										addq.w  #1,d2
loc_DD30:
										subq.w  #1,d2
										suba.w  #1,a0
loc_DD36:
										move.b  (a0),d0
										move.b  (a1),d1
										eori.b  #2,d1
										move.b  d1,(a0)
										cmpa.w  a0,a1
										bne.s   loc_DD48
										bra.w   loc_DD5A
loc_DD48:
										eori.b  #2,d0
										move.b  d0,(a1)
										suba.w  #1,a0
										adda.w  #1,a1
										dbf     d2,loc_DD36
loc_DD5A:
										movem.l (sp)+,d0-d6/a0-a5
										rts

	; End of function sub_DD10


; =============== S U B R O U T I N E =======================================

; unused, pointless

AddAllToStack:
										
										movem.l d0-a5,-(sp)
										movem.l (sp)+,d0-a5
										rts

	; End of function AddAllToStack


; =============== S U B R O U T I N E =======================================

j_makeEnemyMoveOrder:
										
										movem.l d0-d6/a0-a5,-(sp)
										bsr.w   MakeEnemyMoveOrder
										movem.l (sp)+,d0-d6/a0-a5
										rts

	; End of function j_makeEnemyMoveOrder


; =============== S U B R O U T I N E =======================================

; create enemy move order from movecost lists

MakeEnemyMoveOrder:
										
										clr.w   d2
										move.b  d1,d2
										mulu.w  #$30,d2 
										andi.w  #$FF,d0
										add.w   d0,d2
										move.b  (a3,d2.w),d6
										lsl.w   #8,d6
										move.b  (a2,d2.w),d6
										ext.w   d3
										sub.w   d3,d6
										tst.w   d6
										bpl.s   loc_DD9A
										clr.w   d6
loc_DD9A:
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										clr.b   d3
loc_DDA0:
										move.b  (a3,d2.w),d4
										lsl.w   #8,d4
										move.b  (a2,d2.w),d4
										cmp.w   d4,d6
										bcs.s   loc_DDB2
										bra.w   loc_DEF6
loc_DDB2:
										tst.w   d4
										bne.s   loc_DDBA
										bra.w   loc_DEF6
loc_DDBA:
										subq.w  #1,d4
										clr.b   d5
										clr.b   d0
										addq.w  #1,d2
										move.b  (a3,d2.w),d0
										lsl.w   #8,d0
										move.b  (a2,d2.w),d0
										tst.w   d0
										bpl.s   loc_DDD4
										bra.w   loc_DDE6
loc_DDD4:
										cmp.w   d4,d0
										bmi.s   loc_DDDA
										bne.s   loc_DDE6
loc_DDDA:
										cmpi.w  #$900,d2
										bcc.s   loc_DDE6
										bset    #0,d5
										move.w  d0,d4
loc_DDE6:
										subq.w  #1,d2
										clr.b   d0
										subq.w  #1,d2
										move.b  (a3,d2.w),d0
										lsl.w   #8,d0
										move.b  (a2,d2.w),d0
										tst.w   d0
										bpl.s   loc_DDFE
										bra.w   loc_DE1A
loc_DDFE:
										cmp.w   d4,d0
										bmi.s   loc_DE04
										bne.s   loc_DE1A
loc_DE04:
										cmpi.w  #$900,d2
										bcc.s   loc_DE1A
										tst.b   d5
										bne.s   loc_DE14
										moveq   #4,d5
										bra.w   loc_DE18
loc_DE14:
										bset    #2,d5
loc_DE18:
										move.w  d0,d4
loc_DE1A:
										addq.w  #1,d2
										clr.b   d0
										subi.w  #$30,d2 
loc_DE22:
										move.b  (a3,d2.w),d0
										lsl.w   #8,d0
										move.b  (a2,d2.w),d0
										tst.w   d0
										bpl.s   loc_DE34
										bra.w   loc_DE50
loc_DE34:
										cmp.w   d4,d0
										bmi.s   loc_DE3A
										bne.s   loc_DE50
loc_DE3A:
										cmpi.w  #$900,d2
										bcc.s   loc_DE50
										tst.b   d5
										bne.s   loc_DE4A
										moveq   #2,d5
										bra.w   loc_DE4E
loc_DE4A:
										bset    #1,d5
loc_DE4E:
										move.w  d0,d4
loc_DE50:
										addi.w  #$30,d2 
										clr.b   d0
										addi.w  #$30,d2 
										move.b  (a3,d2.w),d0
										lsl.w   #8,d0
										move.b  (a2,d2.w),d0
										tst.w   d0
										bpl.s   loc_DE6C
										bra.w   loc_DE88
loc_DE6C:
										cmp.w   d4,d0
										bmi.s   loc_DE72
										bne.s   loc_DE88
loc_DE72:
										cmpi.w  #$900,d2
										bcc.s   loc_DE88
										tst.b   d5
										bne.s   loc_DE82
										moveq   #8,d5
										bra.w   loc_DE86
loc_DE82:
										bset    #3,d5
loc_DE86:
										move.w  d0,d4
loc_DE88:
										subi.w  #$30,d2 
										move.b  d3,d1
										and.b   d5,d1
										bne.s   loc_DE96
										bra.w   loc_DEA0
loc_DE96:
										move.b  d5,d1
										eor.b   d3,d1
										beq.s   loc_DEA0
										bra.w   loc_DEA2
loc_DEA0:
										move.b  d5,d1
loc_DEA2:
										ror.b   #1,d1
										bcc.s   loc_DEAA
										bra.w   loc_DEC6
loc_DEAA:
										ror.b   #1,d1
										bcc.s   loc_DEB2
										bra.w   loc_DED2
loc_DEB2:
										ror.b   #1,d1
										bcc.s   loc_DEBA
										bra.w   loc_DEDE
loc_DEBA:
										ror.b   #1,d1
										bcc.s   loc_DEC2
										bra.w   loc_DEE8
loc_DEC2:
										bra.w   loc_DEF6
loc_DEC6:
										moveq   #0,d5
										moveq   #1,d3
										addi.w  #1,d2
										bra.w   loc_DEF0
loc_DED2:
										moveq   #1,d5
										moveq   #2,d3
										subi.w  #$30,d2 
										bra.w   loc_DEF0
loc_DEDE:
										moveq   #2,d5
										moveq   #4,d3
										subq.w  #1,d2
										bra.w   loc_DEF0
loc_DEE8:
										moveq   #3,d5
										moveq   #8,d3
										addi.w  #$30,d2 
loc_DEF0:
										move.b  d5,(a0)+
										bra.w   loc_DDA0
loc_DEF6:
										move.b  #$FF,(a0)
										rts

	; End of function MakeEnemyMoveOrder


; =============== S U B R O U T I N E =======================================

; In: D0 = char idx

j_sub_DEFC_0:
										
										movem.l d0-a5,-(sp)
										move.w  d0,d7
										btst    #CHAR_BIT_ENEMY,d0
										bne.s   loc_DF10
										move.w  #6,d5
										bra.w   loc_E076
loc_DF10:
										bsr.w   GetLowerMoveType
										cmpi.b  #$F,d1
										beq.s   loc_DF1E
										bra.w   loc_DFA2
loc_DF1E:
										bsr.w   GetMaxHP
										move.w  d1,d2
										bsr.w   GetCurrentHP
										cmp.w   d2,d1
										beq.s   loc_DF30
										bra.w   loc_DFA2
loc_DF30:
										lea     ((CURRENT_BATTLE-$1000000)).w,a0
										clr.w   d6
										move.b  (a0),d6
										lea     byte_E25B(pc), a0
										nop
										clr.w   d2
										move.b  (a0),d2
										subi.w  #1,d2
										clr.w   d0
										adda.w  #1,a0
loc_DF4C:
										move.b  (a0,d0.w),d1
										cmp.b   d1,d6
										bne.s   loc_DF58
										bra.w   loc_DF64
loc_DF58:
										addi.w  #1,d0
										dbf     d2,loc_DF4C
										bra.w   loc_DFA2
loc_DF64:
										lea     off_E260(pc), a0
										nop
										lsl.w   #2,d0
										movea.l (a0,d0.w),a0
										clr.w   d5
										move.b  d7,d5
										andi.b  #$7F,d5 
										move.b  (a0,d5.w),d0
										tst.b   d0
										bne.s   loc_DF84
										bra.w   loc_DFA2
loc_DF84:
										bsr.w   sub_E0B6
										cmp.b   d1,d0
										ble.s   loc_DFA2
										lea     (BATTLESCENE_ACTION_TYPE).l,a0
										move.w  #3,(a0)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										bra.w   loc_E0AA
loc_DFA2:
										lea     (byte_FFB20C).l,a0
										move.w  #0,(a0)
										move.w  d7,d0
										bsr.w   GetEnemyAISetting36
										cmpi.w  #$F,d1
										bne.s   loc_DFC2
										cmpi.w  #$F,d2
										bne.s   loc_DFC2
										bra.w   loc_DFE6
loc_DFC2:
										move.w  d7,d0
										bsr.w   GetCharacterWord34
										move.w  d1,d4
										andi.w  #3,d1
										btst    #0,d1
										bne.s   loc_DFE6
										bsr.w   sub_F522
										lea     (BATTLESCENE_ACTION_TYPE).l,a0
										move.w  #3,(a0)
										bra.w   loc_E0AA
loc_DFE6:
										move.w  d7,d0
										btst    #7,d0
										beq.s   loc_E01C
										bsr.w   GetEnemyID
										cmpi.w  #$5D,d1 ; check if Prism Flower
										bne.s   loc_E000        
										bsr.w   HandleLineAttackerAI
										bra.w   loc_E0AA
loc_E000:
										cmpi.w  #$26,d1 ; check if Zeon Guard
										bne.s   loc_E00E        
										bsr.w   HandleLineAttackerAI
										bra.w   loc_E0AA
loc_E00E:
										cmpi.w  #$20,d1 ; check if Burst Rock
										bne.s   loc_E01C
										bsr.w   HandleExploderAI
										bra.w   loc_E0AA
loc_E01C:
										move.w  d7,d0
										bsr.w   GetEnemyAISetting3233
										cmpi.w  #$FF,d1
										beq.s   loc_E048
										btst    #6,d1
										bne.s   loc_E048
										move.w  d1,d0
										bsr.w   GetCurrentHP
										tst.w   d1
										bne.s   loc_E048
										move.w  d7,d0
										bsr.w   GetEnemyAISetting3233
										move.w  d2,d1
										move.w  #$FF,d2
										bsr.w   SetKills        
loc_E048:
										move.w  d7,d0
										bsr.w   GetLowerMoveType
										move.w  d1,d5
										lea     word_E249(pc), a0
										nop
										move.b  (a0,d1.w),d6
										tst.b   d6
										beq.s   loc_E076
										cmpi.b  #1,d6
										bne.s   loc_E06A
										jsr     j_getMoveListForEnemyTarget
loc_E06A:
										cmpi.b  #2,d6
										bne.s   loc_E076
loc_E070:
										jsr     sub_1AC030
loc_E076:
										move.w  d5,d1
										lea     off_E1AC(pc), a0
										nop
										lsl.l   #2,d1
										movea.l (a0,d1.w),a1
										clr.w   d2
										move.b  (a1),d2
										adda.w  #1,a1
loc_E08C:
										subi.b  #1,d2
loc_E090:
										clr.w   d1
										move.b  (a1),d1
										move.b  d7,d0
										bsr.w   HandleEnemyAICommand
										tst.b   d1
										bne.s   loc_E0A2
										bra.w   loc_E0AA
loc_E0A2:
										adda.w  #1,a1
										dbf     d2,loc_E090
loc_E0AA:
										jsr     j_clearTerrainListObstructions
										movem.l (sp)+,d0-a5
										rts

	; End of function j_sub_DEFC_0


; =============== S U B R O U T I N E =======================================

sub_E0B6:
										movem.l d0/d2-a6,-(sp)
										move.w  #1,d1
										jsr     j_getAddrOfBattleCombatants
										move.w  d1,d2
										subi.w  #2,d2
										clr.w   d0
										move.w  #$80,d0 
										clr.w   d3
loc_E0D2:
										bsr.w   GetCurrentHP
										tst.w   d1
										bne.s   loc_E0DE
loc_E0DA:
										addi.w  #1,d3
loc_E0DE:
										addi.w  #1,d0
										dbf     d2,loc_E0D2
										move.w  d3,d1
										movem.l (sp)+,d0/d2-a6
										rts

	; End of function sub_E0B6


; =============== S U B R O U T I N E =======================================

HandleLineAttackerAI:
										
										movem.l d0-a6,-(sp)
										move.w  d0,d7
										bsr.w   MakeTargetListAllies
										move.w  d7,d0
										jsr     sub_1AC05C
										lea     ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,a0
										move.w  (a0),d0
										tst.w   d0
										beq.s   loc_E12C
										lea     (BATTLESCENE_ACTION_TYPE).l,a0
										move.w  #6,(a0)
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a1
										clr.w   d1
										move.b  ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,d1
										move.w  d1,2(a0)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										bra.s   loc_E13E
loc_E12C:
										lea     (BATTLESCENE_ACTION_TYPE).l,a0
loc_E132:
										move.w  #3,(a0)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
loc_E13E:
										movem.l (sp)+,d0-a6
										rts

	; End of function HandleLineAttackerAI


; =============== S U B R O U T I N E =======================================

HandleExploderAI:
										
										movem.l d0-a6,-(sp)
										move.w  d0,d5
										bsr.w   MakeTargetListAllies
										move.w  #$19,d1         ; Burst Rock spell
										bsr.w   CreateTargetGridFromSpell
										lea     ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,a0
										move.w  (a0),d0
										tst.w   d0
										beq.s   loc_E190
										move.w  #6,d6
										jsr     j_randomLessThanD6
										cmpi.b  #4,d7
										bne.s   loc_E190
										lea     (BATTLESCENE_ACTION_TYPE).l,a0
										move.w  #4,(a0)
										move.w  #$19,2(a0)
										move.w  d5,4(a0)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										bra.w   loc_E1A6
loc_E190:
										move.w  d5,d0
										move.w  #$B,d1
										clr.w   d7
										bsr.w   HandleEnemyAICommand
										lea     (BATTLESCENE_ACTION_TYPE).l,a0
										move.w  #3,(a0)
loc_E1A6:
										movem.l (sp)+,d0-a6
										rts

	; End of function HandleExploderAI

off_E1AC:           dc.l byte_E1EC
										dc.l byte_E1F2
										dc.l byte_E1F9
										dc.l byte_E200
										dc.l byte_E207
										dc.l byte_E20E
										dc.l byte_E215
										dc.l byte_E21B
										dc.l byte_E222
										dc.l byte_E229
										dc.l byte_E227
										dc.l byte_E227
										dc.l byte_E231
										dc.l byte_E239
										dc.l byte_E239
										dc.l byte_E241
byte_E1EC:          dc.b 5
										dc.b 0
										dc.b 7
										dc.b 3
										dc.b $B
										dc.b $E
byte_E1F2:          dc.b 6
										dc.b $A
										dc.b 0
										dc.b 7
										dc.b 3
										dc.b $C
										dc.b $E
byte_E1F9:          dc.b 6
										dc.b 1
										dc.b $12
										dc.b 7
										dc.b 5
										dc.b $C
										dc.b $E
byte_E200:          dc.b 6
										dc.b 1
										dc.b $12
										dc.b 7
										dc.b 5
										dc.b $B
										dc.b $E
byte_E207:          dc.b 6
										dc.b 2
										dc.b $13
										dc.b 7
										dc.b 4
										dc.b $D
										dc.b $E
byte_E20E:          dc.b 6
										dc.b 2
										dc.b $13
										dc.b 7
										dc.b 4
										dc.b $D
										dc.b $E
byte_E215:          dc.b 5
										dc.b 3
										dc.b 0
										dc.b 7
										dc.b $B
										dc.b $E
byte_E21B:          dc.b 6
										dc.b $A
										dc.b 3
										dc.b 0
										dc.b 7
										dc.b $B
										dc.b $E
byte_E222:          dc.b 4
										dc.b 3
										dc.b 0
										dc.b 7
										dc.b $E
byte_E227:          dc.b 1
										dc.b $E
byte_E229:          dc.b 7
										dc.b $11
										dc.b 5
										dc.b 1
										dc.b 7
										dc.b $12
										dc.b $C
										dc.b $E
byte_E231:          dc.b 7
										dc.b $12
										dc.b 7
										dc.b 5
										dc.b 1
										dc.b $B
										dc.b $C
										dc.b $E
byte_E239:          dc.b 7
										dc.b $13
										dc.b 4
										dc.b 2
										dc.b 7
										dc.b $10
										dc.b $D
										dc.b $E
byte_E241:          dc.b 7
										dc.b $A
										dc.b 5
										dc.b 1
										dc.b 7
										dc.b $10
										dc.b $C
										dc.b $E
word_E249:          dc.w 0
										dc.b 1
										dc.b 1
										dc.b 2
										dc.b 2
										dc.b 0
										dc.b 0
										dc.b 0
										dc.b 1
										dc.b 0
										dc.b 0
										dc.b 1
										dc.b 2
										dc.b 2
										dc.b 0
										dc.b 0
										dc.b 0
byte_E25B:          dc.b 3
										dc.b $10
										dc.b $14
										dc.b $16
										dc.b $FF
off_E260:           dc.l byte_E26C
off_E264:           dc.l byte_E277
										dc.l byte_E283
byte_E26C:          dc.b 5
										dc.b 4
										dc.b 2
										dc.b 2
										dc.b 3
										dc.b 0
										dc.b 0
										dc.b 4
										dc.b 1
										dc.b 3
										dc.b 0
byte_E277:          dc.b 3
										dc.b 0
										dc.b 0
										dc.b 0
										dc.b 0
										dc.b 0
										dc.b 2
										dc.b 0
										dc.b 0
										dc.b 0
										dc.b 0
										dc.b 1
byte_E283:          dc.b 0
										dc.b 0
										dc.b 0
										dc.b 6
										dc.b 1
										dc.b 3
										dc.b 0
										dc.b 1
										dc.b 3
										dc.b 6
										dc.b 6
										dc.b 1
										dc.b 0
										dc.b 3
										dc.b 3
										dc.b 0
										dc.b $FF

; =============== S U B R O U T I N E =======================================

HandleEnemyAICommand:
										
										movem.l d0/d2-a5,-(sp)
										cmpi.b  #0,d1
										bne.s   loc_E2AA
										move.w  #0,d1
										bsr.w   sub_E3EE
										bra.w   loc_E3E8
loc_E2AA:
										cmpi.b  #1,d1
										bne.s   loc_E2BC
										move.w  #1,d1
										bsr.w   sub_E3EE
										bra.w   loc_E3E8
loc_E2BC:
										cmpi.b  #2,d1
										bne.s   loc_E2CE
										move.w  #2,d1
										bsr.w   sub_E3EE
										bra.w   loc_E3E8
loc_E2CE:
										cmpi.b  #3,d1
										bne.s   loc_E2E0
										move.w  #0,d1
										bsr.w   sub_E78C
										bra.w   loc_E3E8
loc_E2E0:
										cmpi.b  #4,d1
										bne.s   loc_E2F2
										move.w  #2,d1
										bsr.w   sub_E78C
										bra.w   loc_E3E8
loc_E2F2:
										cmpi.b  #5,d1
										bne.s   loc_E304
										move.w  #1,d1
										bsr.w   sub_E78C
										bra.w   loc_E3E8
loc_E304:
										cmpi.b  #6,d1
										bne.s   loc_E316
										move.w  #3,d1
										bsr.w   sub_E78C
										bra.w   loc_E3E8
loc_E316:
										cmpi.b  #7,d1
										bne.s   loc_E32C
										move.w  #1,d1
										move.w  #0,d2
										bsr.w   sub_EBA4        
										bra.w   loc_E3E8
loc_E32C:
										cmpi.b  #$A,d1
										bne.s   loc_E342
										move.w  #0,d1
										move.w  #0,d2
										bsr.w   sub_E98C
										bra.w   loc_E3E8
loc_E342:
										cmpi.b  #$B,d1
										bne.s   loc_E354
										move.w  #0,d1
										bsr.w   sub_F1D4
										bra.w   loc_E3E8
loc_E354:
										cmpi.b  #$C,d1
										bne.s   loc_E366
										move.w  #1,d1
										bsr.w   sub_F1D4
										bra.w   loc_E3E8
loc_E366:
										cmpi.b  #$D,d1
										bne.s   loc_E378
										move.w  #2,d1
										bsr.w   sub_F1D4
										bra.w   loc_E3E8
loc_E378:
										cmpi.b  #$E,d1
										bne.s   loc_E394
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #3,(a0)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										clr.w   d0
										bra.w   loc_E3E8
loc_E394:
										cmpi.b  #$10,d1
										bne.s   loc_E3AA
										move.w  #2,d1
										move.w  #2,d2
										bsr.w   sub_E98C
										bra.w   loc_E3E8
loc_E3AA:
										cmpi.b  #$11,d1
										bne.s   loc_E3C0
										move.w  #1,d1
										move.w  #1,d2
										bsr.w   sub_E98C
										bra.w   loc_E3E8
loc_E3C0:
										cmpi.b  #$12,d1
										bne.s   loc_E3D4
										clr.w   d1
										move.w  #1,d2
										bsr.w   sub_E98C
loc_E3D0:
										bra.w   loc_E3E8
loc_E3D4:
										cmpi.b  #$13,d1
										bne.s   loc_E3E8
										clr.w   d1
										move.w  #2,d2
										bsr.w   sub_E98C
										bra.w   *+4
loc_E3E8:
										movem.l (sp)+,d0/d2-a5
										rts

	; End of function HandleEnemyAICommand


; =============== S U B R O U T I N E =======================================

sub_E3EE:
										movem.l d0/d2-a6,-(sp)
										link    a6,#-6
										move.b  d0,-4(a6)
										move.b  d1,-5(a6)
										bsr.w   CheckMuddled2   
										tst.b   d1
										beq.s   loc_E40A
										bra.w   loc_E776
loc_E40A:
										clr.w   d1
										move.b  -5(a6),d1
										move.b  #$7F,-2(a6) 
										move.b  #$3F,-1(a6) 
										move.b  -4(a6),d0
										clr.w   d3
										bsr.w   GetNextUsableHealingItem
										cmpi.w  #$7F,d1 
										beq.s   loc_E490
										cmpi.b  #8,d1
										bne.s   loc_E490
										move.b  d1,-2(a6)       ; item is Healing Rain
										move.b  d2,-3(a6)
										bsr.w   GetItemDefAddress
										move.b  ITEMDEF_OFFSET_SPELL(a0),-1(a6)
										move.w  #$80,d0 
										bsr.w   IsCharacterLessThanHalfHP
										bcc.s   loc_E45E        
										move.b  #$7F,-2(a6) 
										move.b  #$3F,-1(a6) 
										bra.w   loc_E490
loc_E45E:
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a1
																						; enemy 0 has less than half HP, and we have a healing rain, so use it
										move.w  #2,(a1)
										clr.w   d0
										move.b  -3(a6),d0
										move.w  d0,6(a1)
										clr.w   d0
										move.b  -4(a6),d0
										move.w  d0,4(a1)
										clr.w   d1
										move.b  -2(a6),d1
										move.w  d1,2(a1)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a1
										move.w  #$FF,(a1)
										bra.w   loc_E782
loc_E490:
										move.b  -4(a6),d0
										clr.w   d3
										bsr.w   GetNextHealingSpell
										cmpi.w  #$3F,d1 
										beq.s   loc_E4DA
										move.b  d1,-1(a6)
										move.w  d1,d2
										andi.w  #$3F,d2 
										bsr.w   GetCurrentMP
										cmpi.w  #0,d2
										bne.s   loc_E4C4
										cmpi.w  #3,d1
										bge.s   loc_E4C0
										bra.w   loc_E4DA
										bra.s   loc_E4C4
loc_E4C0:
										bra.w   loc_E500
loc_E4C4:
										cmpi.w  #1,d2
										bne.s   loc_E4DA
										cmpi.w  #7,d1
										bge.s   loc_E4D6
										bra.w   loc_E4DA
										bra.s   loc_E4DA
loc_E4D6:
										bra.w   loc_E500
loc_E4DA:
										move.b  -4(a6),d0
										clr.w   d3
										bsr.w   GetNextUsableHealingItem
										cmpi.w  #$7F,d1 
										bne.s   loc_E4EE
										bra.w   loc_E776
loc_E4EE:
										move.b  d1,-2(a6)
										move.b  d2,-3(a6)
										bsr.w   GetItemDefAddress
										move.b  ITEMDEF_OFFSET_SPELL(a0),-1(a6)
loc_E500:
										move.b  -4(a6),d0
										btst    #7,d0
										beq.s   loc_E510
										bsr.w   MakeTargetListMonsters
										bra.s   loc_E514
loc_E510:
										bsr.w   MakeTargetListAllies
loc_E514:
										move.w  #$FFFF,d3
										bsr.w   UpdateTargetListCharacters
										move.b  -4(a6),d0
										bsr.w   GetMoveInfo     
										bsr.w   MakeRangeLists
										clr.w   d3
										bsr.w   UpdateTargetListCharacters
										lea     ((byte_FF883E-$1000000)).w,a0
										clr.w   d3
										move.b  -4(a6),d0
										btst    #7,d0
										bne.s   loc_E546
										clr.w   d0
										move.w  #$1D,d4
										bra.s   loc_E54E
loc_E546:
										move.w  #$80,d0 
										move.w  #$1F,d4
loc_E54E:
										bsr.w   GetCurrentHP
										tst.w   d1
										bne.s   loc_E55A
										bra.w   loc_E56C
loc_E55A:
										bsr.w   sub_D38A
										bcc.s   loc_E564
										bra.w   loc_E56C
loc_E564:
										move.b  d0,(a0,d3.w)
										addi.w  #1,d3
loc_E56C:
										addi.w  #1,d0
										dbf     d4,loc_E54E
										lea     ((word_FF8806-$1000000)).w,a1
										move.w  d3,(a1)
										tst.b   d3
										bne.s   loc_E582
										bra.w   loc_E776
loc_E582:
										lea     ((byte_FF880E-$1000000)).w,a1
										lea     ((byte_FF895E-$1000000)).w,a2
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a3
										clr.w   d4
										lea     ((DMA_SPACE_FF8804-$1000000)).w,a4
										move.w  #0,(a4)
loc_E598:
										clr.w   d0
										move.b  (a0,d4.w),d0
										clr.w   d1
										move.b  -1(a6),d1
										bsr.w   CreateTargetGrid
										move.w  ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,d5
										tst.w   d5
										bne.s   loc_E5B4
										bra.w   loc_E5E2
loc_E5B4:
										clr.w   d7
										clr.w   d2
										move.b  #0,(a1,d4.w)
loc_E5BE:
										move.b  (a3,d7.w),d0
										bsr.w   sub_CDEA
										cmpi.w  #$D,d6
										bne.s   loc_E5D4
loc_E5CC:
										move.b  #1,(a1,d4.w)
										addq.w  #1,(a4)
loc_E5D4:
										add.w   d6,d2
										addi.w  #4,d2
										addi.w  #1,d7
										subq.w  #1,d5
										bne.s   loc_E5BE
loc_E5E2:
										move.b  d2,(a2,d4.w)
										addi.w  #1,d4
										subq.w  #1,d3
										bne.s   loc_E598
										bra.w   *+4
										move.w  ((word_FF8806-$1000000)).w,d1
										cmpi.w  #1,d1
										bgt.s   loc_E600
										bra.w   loc_E654
loc_E600:
										subq.w  #2,d1
										clr.w   d2
										move.b  #0,d2
										lea     ((byte_FF883E-$1000000)).w,a0
										lea     ((byte_FF895E-$1000000)).w,a1
loc_E610:
										tst.b   d2
										bpl.s   loc_E618
										bra.w   loc_E654
loc_E618:
										move.b  #$FF,d2
										clr.w   d3
loc_E61E:
										move.b  1(a1,d3.w),d4
										cmp.b   (a1,d3.w),d4
										ble.s   loc_E646
										move.b  1(a1,d3.w),d4
										move.b  (a1,d3.w),1(a1,d3.w)
										move.b  d4,(a1,d3.w)
										move.b  1(a0,d3.w),d4
										move.b  (a0,d3.w),1(a0,d3.w)
										move.b  d4,(a0,d3.w)
										move.w  d3,d2
loc_E646:
										tst.w   d1
										beq.s   loc_E650
										addq.w  #1,d3
										subq.w  #1,d1
										bra.s   loc_E61E
loc_E650:
										move.w  d2,d1
										bra.s   loc_E610
loc_E654:
										lea     ((word_FF8806-$1000000)).w,a0
										move.w  (a0),d5
										clr.w   d6
										lea     ((byte_FF883E-$1000000)).w,a0
loc_E660:
										cmpi.b  #$7F,-2(a6) 
										beq.s   loc_E66C
										bra.w   loc_E6C0
loc_E66C:
										move.b  (a0,d6.w),d0
										move.b  -4(a6),d1
										move.b  -1(a6),d4
										bsr.w   sub_CD68        
										cmpi.b  #$FF,d2
										bne.s   loc_E686
										bra.w   loc_E6FC
loc_E686:
										tst.b   d2
										bne.s   loc_E6B0
										cmp.b   d0,d1
										beq.s   loc_E6B0
										move.b  -4(a6),d0
										bsr.w   GetCurrentMP
										cmpi.b  #$B,d1
										blt.s   loc_E6B0
										move.b  -1(a6),d0
										lsr.b   #6,d0
										andi.b  #3,d0
										cmpi.b  #2,d0
										blt.s   loc_E6B0
										move.b  #1,d2
loc_E6B0:
										move.b  -1(a6),d0
										lsl.b   #6,d2
										andi.b  #$3F,d0 
										or.b    d2,d0
										move.b  d0,-1(a6)
loc_E6C0:
										clr.w   d0
										move.b  (a0,d6.w),d0
loc_E6C6:
										cmpi.b  #$7F,-2(a6) 
										beq.s   loc_E6DA
										clr.w   d1
loc_E6D0:
										move.b  -2(a6),d1
										bsr.w   GetItemRange
										bra.s   loc_E6E4
loc_E6DA:
										clr.w   d1
										move.b  -1(a6),d1
										bsr.w   GetSpellRange
loc_E6E4:
										bsr.w   GetYPos
										move.w  d1,d2
										bsr.w   GetXPos
loc_E6EE:
										bsr.w   GetClosestAttackPosition
										cmpi.b  #$FF,d1
										beq.s   loc_E6FC
loc_E6F8:
										bra.w   loc_E70A
loc_E6FC:
										addi.w  #1,d6
										subq.w  #1,d5
loc_E702:
										bne.w   loc_E660
										bra.w   loc_E776
loc_E70A:
										move.b  d1,d0
										move.b  d2,d1
										lea     ((byte_FF4000+$400)).l,a2
										lea     ((byte_FF4000+$400)).l,a3
										bsr.w   sub_DD10
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a1
loc_E722:
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a1
										cmpi.b  #$7F,-2(a6) 
										bne.s   loc_E748
										move.w  #1,(a1)
										clr.w   d0
										move.b  -1(a6),d0
										move.w  d0,2(a1)
										clr.w   d0
										move.b  (a0,d6.w),d0
										move.w  d0,4(a1)
										bra.s   loc_E772
loc_E748:
										move.w  #2,(a1)
										clr.w   d0
										move.b  -3(a6),d0
										move.w  d0,6(a1)
										clr.w   d0
										move.b  (a0,d6.w),d0
loc_E75C:
										move.w  d0,4(a1)
										clr.w   d0
										move.b  -4(a6),d0
										move.b  -3(a6),d1
										bsr.w   GetCharItemAtSlotAndNumberOfItems
										move.w  d1,2(a1)
loc_E772:
										bra.w   loc_E782
loc_E776:
										move.w  #$FFFF,d1
										unlk    a6
										movem.l (sp)+,d0/d2-a6
										rts
loc_E782:
										clr.w   d1
										unlk    a6
										movem.l (sp)+,d0/d2-a6
										rts

	; End of function sub_E3EE


; =============== S U B R O U T I N E =======================================

sub_E78C:
										movem.l d0/d2-a6,-(sp)
										move.w  d0,d7
										move.w  d1,d6
										bsr.w   sub_C958
										bsr.w   sub_EDD6
										cmpi.b  #3,d2
										bne.s   loc_E7B6
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #3,(a0)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										bra.w   loc_E97C
loc_E7B6:
										movem.l d0-d3,-(sp)
										move.w  d0,d1
										move.w  d7,d0
										bsr.w   sub_C27A
										tst.w   d3
										beq.s   loc_E7DE
										movem.l (sp)+,d0-d3
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #5,(a0)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										bra.w   loc_E984
loc_E7DE:
										movem.l (sp)+,d0-d3
										cmpi.b  #2,d2
										bne.w   loc_E86C
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #2,(a0)
										lea     ((word_FF880A-$1000000)).w,a1
										move.w  (a1),6(a0)
										move.w  d0,4(a0)
										move.w  d7,d0
										move.w  (a1),d1
										bsr.w   GetCharItemAtSlotAndNumberOfItems
										move.w  d1,2(a0)
										lea     ((ENEMY_TARGETTING_COMMAND_LIST-$1000000)).w,a2
										move.w  d7,d1
										btst    #7,d1
										beq.s   loc_E81E
										andi.b  #$7F,d1 
										move.b  d0,(a2,d1.w)
loc_E81E:
										lea     ((word_FF880A-$1000000)).w,a1
										move.w  (a1),d1
										move.w  d7,d0
										bsr.w   GetCharItemAtSlotAndNumberOfItems
										bsr.w   GetItemDefAddress
										move.b  9(a0),d1
										bsr.w   GetSpellRange
										bsr.w   MakeTargetListEverybody
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  4(a0),d0
										jsr     GetYPos
										move.w  d1,d2
										jsr     GetXPos
										bsr.w   GetClosestAttackPosition
										move.w  d1,d0
										move.w  d2,d1
										lea     ((byte_FF4000+$400)).l,a2
										lea     ((byte_FF4A00+$300)).l,a3
										bsr.w   sub_DD10
										bra.w   loc_E984
loc_E86C:
										cmpi.b  #1,d2
										bne.s   loc_E8D0
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #1,(a0)
										lea     ((word_FF880C-$1000000)).w,a1
										move.w  (a1),2(a0)
										move.w  d0,4(a0)
										lea     ((ENEMY_TARGETTING_COMMAND_LIST-$1000000)).w,a2
										move.w  d7,d1
										btst    #7,d1
										beq.s   loc_E89A
										andi.b  #$7F,d1 
										move.b  d0,(a2,d1.w)
loc_E89A:
										move.w  2(a0),d1
										bsr.w   GetSpellRange
										bsr.w   MakeTargetListEverybody
										jsr     GetYPos
										move.w  d1,d2
										jsr     GetXPos
										bsr.w   GetClosestAttackPosition
										move.w  d1,d0
										move.w  d2,d1
										lea     ((byte_FF4000+$400)).l,a2
										lea     ((byte_FF4A00+$300)).l,a3
										bsr.w   sub_DD10
										bra.w   loc_E984
loc_E8D0:
										tst.b   d2
										bne.w   loc_E97C
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #0,(a0)
										move.w  d0,2(a0)
										lea     ((ENEMY_TARGETTING_COMMAND_LIST-$1000000)).w,a2
										move.w  d7,d1
										btst    #7,d1
										beq.s   loc_E8F6
										andi.b  #$7F,d1 
										move.b  d0,(a2,d1.w)
loc_E8F6:
										move.l  d0,-(sp)
										move.w  d7,d0
										jsr     GetEquippedWeapon
										cmpi.w  #$FFFF,d1
										bne.s   loc_E93C
										clr.l   d3
										clr.l   d4
										jsr     GetSomethingClassType
										cmpi.b  #$3B,d1 
										bne.s   loc_E922
										move.w  #2,d3
										move.w  #1,d4
										bra.w   loc_E938
loc_E922:
										cmpi.b  #$57,d1 
										bne.s   loc_E934
										move.w  #3,d3
										move.w  #1,d4
										bra.w   loc_E938
loc_E934:
										moveq   #1,d3
										moveq   #0,d4
loc_E938:
										bra.w   loc_E94C
loc_E93C:
										jsr     GetItemDefAddress
										moveq   #0,d3
										move.b  4(a0),d3
										move.b  5(a0),d4
loc_E94C:
										move.l  (sp)+,d0
										bsr.w   MakeTargetListEverybody
										jsr     GetYPos
										move.w  d1,d2
										jsr     GetXPos
										bsr.w   GetClosestAttackPosition
										move.w  d1,d0
										move.w  d2,d1
										lea     ((byte_FF4000+$400)).l,a2
loc_E96E:
										lea     ((byte_FF4A00+$300)).l,a3
loc_E974:
										bsr.w   sub_DD10
										bra.w   loc_E984
loc_E97C:
										moveq   #$FFFFFFFF,d1
										movem.l (sp)+,d0/d2-a6
										rts
loc_E984:
										moveq   #0,d1
										movem.l (sp)+,d0/d2-a6
										rts

	; End of function sub_E78C


; =============== S U B R O U T I N E =======================================

sub_E98C:
										movem.l d0/d2-a6,-(sp)
										link    a6,#-6
										btst    #7,d0
										bne.s   loc_E9B2
										move.b  #$FF,d1
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
loc_E9A2:
										move.w  #3,(a0)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										bra.w   loc_EB7A
loc_E9B2:
										move.b  d0,-1(a6)
										move.b  d1,-2(a6)
										move.b  d2,-4(a6)
loc_E9BE:
										bsr.w   GetCurrentMOV
										tst.b   d1
										bne.s   loc_E9DE
										move.b  #$FF,d1
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #3,(a0)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										bra.w   loc_EB7A
loc_E9DE:
										bsr.w   GetEnemyAISetting3233
										cmpi.b  #$FF,d1
										bne.s   loc_EA00
										move.b  #$FF,d1
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #3,(a0)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
loc_E9F8:
										move.b  #$FF,(a0)
										bra.w   loc_EB7A
loc_EA00:
										move.b  d1,-3(a6)
loc_EA04:
										btst    #6,d1
										bne.s   loc_EA2E
										clr.w   d0
										move.b  d1,d0
loc_EA0E:
										bsr.w   GetCurrentHP
										tst.w   d1
										bne.s   loc_EA2E
										move.b  #$FF,d1
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #3,(a0)
loc_EA22:
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										bra.w   loc_EB7A
loc_EA2E:
										move.b  -2(a6),d0
										tst.b   d0
										bne.w   loc_EAE6
										move.b  -1(a6),d0
										move.w  #$FFFF,d3
										bsr.w   UpdateTargetListCharacters
										bsr.w   GetMoveInfo     
										bsr.w   MakeRangeLists
										clr.w   d3
										bsr.w   UpdateTargetListCharacters
										clr.w   d0
										move.b  -1(a6),d0
										bsr.w   sub_CE96
										tst.b   d1
										bne.s   loc_EA78
										move.w  #$FFFF,d1
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #3,(a0)
										bra.w   loc_EB7A
loc_EA78:
										jsr     j_clearTerrainListObstructions
										move.b  -1(a6),d0
										jsr     sub_1AC028
										move.b  -1(a6),d0
										clr.w   d1
										bsr.w   sub_E78C
										tst.b   d1
										bne.s   loc_EA9C
										clr.w   d1
										bra.w   loc_EB7A
loc_EA9C:
										jsr     j_clearTerrainListObstructions
loc_EAA2:
										move.b  -1(a6),d0
										move.b  -3(a6),d1
										bsr.w   sub_F7A0
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  (a0),d1
										cmpi.b  #$FF,d1
										bne.s   loc_EAD4
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #3,(a0)
loc_EACA:
										bra.w   loc_EB7A
										move.w  #$FFFF,d1
										bra.s   loc_EAE2
loc_EAD4:
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #3,(a0)
										clr.w   d1
										bra.w   loc_EB7A
loc_EAE2:
										bra.w   loc_EB7A
loc_EAE6:
										clr.w   d0
										move.b  -1(a6),d0
										move.b  -2(a6),d1
										bsr.w   sub_D430
										tst.b   d1
										bne.s   loc_EB10
										move.w  #$FFFF,d1
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #3,(a0)
										bra.w   loc_EB7A
loc_EB10:
										jsr     j_clearTerrainListObstructions
										move.b  -1(a6),d0
										jsr     sub_1AC028
										move.b  -1(a6),d0
										clr.w   d1
										bsr.w   sub_E78C
										tst.b   d1
										bne.s   loc_EB34
										clr.w   d1
										bra.w   loc_EB7A
loc_EB34:
										jsr     j_clearTerrainListObstructions
										move.b  -1(a6),d0
										move.b  -3(a6),d1
										bsr.w   sub_F7A0
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  (a0),d1
										cmpi.b  #$FF,d1
										bne.s   loc_EB6C
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #3,(a0)
										bra.w   loc_EB7A
										move.w  #$FFFF,d1
										bra.s   loc_EB7A
loc_EB6C:
										clr.w   d1
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #3,(a0)
										bra.w   *+4
loc_EB7A:
										clr.w   d2
										move.b  -4(a6),d2
										tst.w   d2
										beq.s   loc_EB9C
										cmpi.w  #1,d2
										bne.s   loc_EB90
										jsr     j_getMoveListForEnemyTarget
loc_EB90:
										cmpi.w  #2,d2
										bne.s   loc_EB9C
										jsr     sub_1AC030
loc_EB9C:
										unlk    a6
										movem.l (sp)+,d0/d2-a6
										rts

	; End of function sub_E98C


; =============== S U B R O U T I N E =======================================

; In: D0 = char idx

sub_EBA4:
										movem.l d0/d2-a6,-(sp)
										move.w  d0,d7
										btst    #CHAR_BIT_ENEMY,d0
										bne.s   loc_EBC8
										move.w  #$FFFF,d1
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
loc_EBB8:
										move.w  #3,(a0)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										bra.w   loc_EDD0
loc_EBC8:
										bsr.w   CheckMuddled2   
										tst.b   d1
										beq.s   loc_EBE8
										move.w  #$FFFF,d1
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #3,(a0)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										bra.w   loc_EDD0
loc_EBE8:
										move.w  d7,d0
										clr.w   d3
										bsr.w   GetNextStatusSpell
										cmpi.w  #$3F,d1 
										bne.s   loc_EC0E
										move.w  #$FFFF,d1
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #3,(a0)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										bra.w   loc_EDD0
loc_EC0E:
										cmpi.w  #$47,d1 
										bne.s   loc_EC18
										bra.w   loc_EC3A
loc_EC18:
										cmpi.w  #6,d1
										bne.s   loc_EC22
										bra.w   loc_EC3A
loc_EC22:
										move.w  #$FFFF,d1
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #3,(a0)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										bra.w   loc_EDD0
loc_EC3A:
										move.w  d1,d6
										bsr.w   GetSpellDefAddress
										clr.w   d2
										move.b  SPELLDEF_OFFSET_MPCOST(a0),d2
										move.b  SPELLDEF_OFFSET_PROPS(a0),d5
										clr.w   d0
										move.b  d7,d0
										bsr.w   GetCurrentMP
										cmp.b   d2,d1
										bge.s   loc_EC6E
										move.w  #$FFFF,d1
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #3,(a0)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										bra.w   loc_EDD0
loc_EC6E:
										clr.w   d0
										btst    #6,d5
										move.w  #$FFFF,d3
										bne.s   loc_EC80
										bsr.w   UpdateTargetListMonsters
										bra.s   loc_EC84
loc_EC80:
										bsr.w   UpdateTargetListCharacters
loc_EC84:
										move.b  d7,d0
										bsr.w   GetMoveInfo     
										bsr.w   MakeRangeLists
										btst    #6,d5
										clr.w   d3
										bne.s   loc_ECA0
										bsr.w   UpdateTargetListMonsters
										bsr.w   MakeTargetListAllies
										bra.s   loc_ECA8
loc_ECA0:
										bsr.w   UpdateTargetListCharacters
										bsr.w   MakeTargetListMonsters
loc_ECA8:
										clr.w   d1
										move.b  d6,d1
										clr.w   d0
										move.b  d7,d0
										cmpi.w  #5,d1
										bne.s   loc_ECBE
										bsr.w   sub_D460
										bra.w   loc_ED00
loc_ECBE:
										cmpi.w  #$43,d1 
										bne.s   loc_ECCC
										bsr.w   sub_D4E0
										bra.w   loc_ED00
loc_ECCC:
										cmpi.w  #$47,d1 
										bne.s   loc_ECDA
										bsr.w   sub_D62C
										bra.w   loc_ED00
loc_ECDA:
										cmpi.w  #6,d1
										bne.s   loc_ECE8
										bsr.w   sub_D560
										bra.w   loc_ED00
loc_ECE8:
										move.w  #$FFFF,d1
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #3,(a0)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										bra.w   loc_EDD0
loc_ED00:
										lea     ((word_FF8806-$1000000)).w,a0
										move.w  (a0),d5
										tst.w   d5
										bne.s   loc_ED22
										move.w  #$FFFF,d1
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #3,(a0)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										bra.w   loc_EDD0
loc_ED22:
										subi.w  #1,d5
										lea     ((byte_FF883E-$1000000)).w,a0
										lea     ((byte_FF895E-$1000000)).w,a1
										move.b  #$FF,d0
										clr.w   d1
										clr.w   d2
loc_ED36:
										clr.w   d3
										move.b  (a1,d2.w),d3
										cmp.b   d1,d3
										blt.s   loc_ED46
										move.b  (a0,d2.w),d0
										move.b  d3,d1
loc_ED46:
										addi.w  #1,d2
										dbf     d5,loc_ED36
										cmpi.b  #$FF,d0
										bne.s   loc_ED6C
										move.w  #$FFFF,d1
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #3,(a0)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										bra.w   loc_EDD0
loc_ED6C:
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #1,(a0)
										move.w  d6,2(a0)
										move.w  d0,4(a0)
										move.w  d6,d1
										bsr.w   GetSpellRange
										move.w  4(a0),d0
										bsr.w   MakeTargetListEverybody
loc_ED8A:
										jsr     GetYPos
										move.w  d1,d2
										jsr     GetXPos
										bsr.w   GetClosestAttackPosition
										cmpi.w  #$FF,d1
										bne.s   loc_EDBA
										move.w  #$FFFF,d1
										lea     ((BATTLESCENE_ACTION_TYPE-$1000000)).w,a0
										move.w  #3,(a0)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										bra.w   loc_EDD0
loc_EDBA:
										move.w  d1,d0
										move.w  d2,d1
										lea     ((byte_FF4000+$400)).l,a2
										lea     ((byte_FF4A00+$300)).l,a3
										bsr.w   sub_DD10
										clr.w   d1
loc_EDD0:
										movem.l (sp)+,d0/d2-a6
										rts

	; End of function sub_EBA4


; =============== S U B R O U T I N E =======================================

sub_EDD6:
										movem.l d3-a5,-(sp)
										link    a6,#-$C6
										move.b  d0,-$C1(a6)
										move.b  #0,-$C2(a6)
										move.b  #0,-$C3(a6)
										clr.w   d3
										lea     ((DMA_SPACE_FF8804-$1000000)).w,a0
										tst.w   (a0)
										beq.s   loc_EDFC
										bset    #0,d3
loc_EDFC:
										lea     ((word_FF8806-$1000000)).w,a0
										tst.w   (a0)
										beq.s   loc_EE08
										bset    #1,d3
loc_EE08:
										lea     ((byte_FF8808-$1000000)).w,a0
										tst.w   (a0)
										beq.s   loc_EE14
										bset    #2,d3
loc_EE14:
										tst.b   d3
										bne.s   loc_EE24
										moveq   #3,d2
										move.w  #$FFFF,d0
										moveq   #0,d1
										bra.w   loc_F1CC
loc_EE24:
										move.b  d3,d4
										andi.b  #6,d4
										tst.b   d4
										bne.s   loc_EE48
										lea     ((DMA_SPACE_FF8804-$1000000)).w,a0
										lea     ((byte_FF880E-$1000000)).w,a1
										lea     ((byte_FF889E-$1000000)).w,a2
										lea     ((byte_FF892E-$1000000)).w,a3
										move.b  #0,-$C3(a6)
										bra.w   loc_EF2E
loc_EE48:
										move.w  d4,d1
										andi.b  #6,d1
										cmpi.b  #6,d1
										beq.w   loc_EEC6
										btst    #1,d4
										beq.s   loc_EE9A
										lea     ((word_FF880C-$1000000)).w,a1
										move.w  (a1),d1
										cmpi.w  #$28,d1 
										bne.s   loc_EE6C
										bra.w   loc_EEFA
loc_EE6C:
										move.b  #6,d6
										jsr     (UpdateRandomSeed).w
										cmpi.b  #2,d7
										bne.s   loc_EE7E
										bra.w   loc_EEFA
loc_EE7E:
										cmpi.b  #4,d7
										bne.s   loc_EE88
										bra.w   loc_EEFA
loc_EE88:
										btst    #0,d3
										bne.s   loc_EE94
										bra.w   loc_EEFA
										bra.s   loc_EE98
loc_EE94:
										bra.w   loc_EEE0
loc_EE98:
										bra.s   loc_EEC6
loc_EE9A:
										move.b  #6,d6
										jsr     (UpdateRandomSeed).w
										cmpi.b  #3,d7
										bne.s   loc_EEAC
										bra.w   loc_EF14
loc_EEAC:
										cmpi.b  #5,d7
										bne.s   loc_EEB6
										bra.w   loc_EF14
loc_EEB6:
										btst    #0,d3
										bne.s   loc_EEC2
										bra.w   loc_EF14
										bra.s   loc_EEC6
loc_EEC2:
										bra.w   loc_EEE0
loc_EEC6:
										move.b  #2,d6
										jsr     j_randomLessThanD6
										cmpi.b  #1,d7
										bne.s   loc_EEDC
										bra.w   loc_EF14
										bra.s   loc_EEE0
loc_EEDC:
										bra.w   loc_EEFA
loc_EEE0:
										lea     ((DMA_SPACE_FF8804-$1000000)).w,a0
										lea     ((byte_FF880E-$1000000)).w,a1
										lea     ((byte_FF889E-$1000000)).w,a2
										lea     ((byte_FF892E-$1000000)).w,a3
										move.b  #0,-$C3(a6)
										bra.w   loc_EF2E
loc_EEFA:
										lea     ((word_FF8806-$1000000)).w,a0
										lea     ((byte_FF883E-$1000000)).w,a1
loc_EF02:
										lea     ((byte_FF88CE-$1000000)).w,a2
										lea     ((byte_FF895E-$1000000)).w,a3
										move.b  #1,-$C3(a6)
										bra.w   loc_EF2E
loc_EF14:
										lea     ((byte_FF8808-$1000000)).w,a0
										lea     ((byte_FF886E-$1000000)).w,a1
										lea     ((byte_FF88FE-$1000000)).w,a2
										lea     ((byte_FF898E-$1000000)).w,a3
										move.b  #2,-$C3(a6)
										bra.w   *+4
loc_EF2E:
										move.w  (a0),d3
										subi.w  #1,d3
										clr.b   d4
loc_EF36:
										cmp.b   (a3,d3.w),d4
										bgt.s   loc_EF40
										move.b  (a3,d3.w),d4
loc_EF40:
										dbf     d3,loc_EF36
										move.b  d4,-$C2(a6)
										cmpi.b  #$F,d4
										bge.s   loc_EF52
										bra.w   loc_EF8E
loc_EF52:
										move.b  #$F,-$C2(a6)
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a4
										move.w  (a0),d3
										subi.w  #1,d3
										clr.w   d5
loc_EF64:
										cmp.b   (a3,d3.w),d4
										bgt.s   loc_EF80
										move.b  (a1,d3.w),(a4,d5.w)
										move.l  a6,-(sp)
										adda.w  d5,a6
										move.b  (a2,d3.w),-$90(a6)
										movea.l (sp)+,a6
										addi.w  #1,d5
loc_EF80:
										dbf     d3,loc_EF64
										lea     ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,a4
										move.w  d5,(a4)
										bra.w   loc_EFC0
loc_EF8E:
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a4
										move.w  (a0),d3
										subi.w  #1,d3
										clr.w   d5
loc_EF9A:
										cmp.b   (a3,d3.w),d4
										bne.s   loc_EFB6
										move.b  (a1,d3.w),(a4,d5.w)
										move.l  a6,-(sp)
										adda.w  d5,a6
										move.b  (a2,d3.w),-$90(a6)
										movea.l (sp)+,a6
										addi.w  #1,d5
loc_EFB6:
										dbf     d3,loc_EF9A
										lea     ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,a4
										move.w  d5,(a4)
loc_EFC0:
										cmpi.b  #1,d5
										bne.s   loc_EFD8
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a4
										move.b  (a4),d0
										move.b  -$C2(a6),d1
										move.b  -$C3(a6),d2
										bra.w   loc_F1CC
loc_EFD8:
										clr.l   d0
										move.b  -$C1(a6),d0
										btst    #7,d0
										bne.w   loc_F008
										clr.l   d4
										lea     ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,a5
										move.w  (a5),d4
										move.b  d4,-$C4(a6)
										move.w  d4,d6
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a5
										clr.l   d5
loc_EFFA:
										move.b  (a5)+,-$30(a6,d5.w)
										addq.l  #1,d5
										subq.w  #1,d4
										bne.s   loc_EFFA
										bra.w   loc_F172
loc_F008:
										move.b  -$C2(a6),d0
										cmpi.b  #$F,d0
										bge.s   loc_F034
										clr.l   d4
										lea     ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,a5
										move.w  (a5),d4
										move.b  d4,-$C4(a6)
										move.w  d4,d6
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a5
										clr.l   d5
loc_F026:
										move.b  (a5)+,-$30(a6,d5.w)
										addq.l  #1,d5
										subq.w  #1,d4
										bne.s   loc_F026
										bra.w   loc_F172
loc_F034:
										clr.l   d0
										move.b  -$C1(a6),d0
										jsr     GetUpperMoveType
										clr.l   d3
										move.b  d1,d3
										lea     (off_D982).l,a4 
										lsl.l   #2,d3
										movea.l (a4,d3.l),a4
										cmpi.b  #1,-$C3(a6)
										bne.s   loc_F05E
										lea     (byte_D921).l,a4
loc_F05E:
										clr.l   d4
										lea     ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,a5
										move.w  (a5),d4
										move.w  d4,d6
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a5
										clr.l   d5
loc_F06E:
										move.b  (a5)+,-$30(a6,d5.w)
										addq.l  #1,d5
										subq.w  #1,d4
										bne.s   loc_F06E
										lea     ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,a5
										move.w  #0,(a5)
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a5
										clr.l   d5
loc_F086:
										clr.l   d4
loc_F088:
										clr.l   d0
										move.b  -$30(a6,d4.w),d0
										btst    #7,d0
										beq.s   loc_F098
										bra.w   loc_F0D8
loc_F098:
										jsr     GetClass
										cmp.b   (a4,d5.w),d1
										beq.s   loc_F0A8
										bra.w   loc_F0D8
loc_F0A8:
										lea     ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,a5
										move.w  (a5),d2
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a5
										move.b  d0,(a5,d2.w)
										move.b  d1,-$60(a6,d2.w)
										move.l  a6,-(sp)
										adda.w  d4,a6
										move.b  -$90(a6),d0
										movea.l (sp)+,a6
										move.l  a6,-(sp)
										adda.w  d2,a6
										move.b  d0,-$C0(a6)
										movea.l (sp)+,a6
										lea     ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,a5
										move.w  (a5),d2
										addq.w  #1,d2
										move.w  d2,(a5)
loc_F0D8:
										addq.b  #1,d4
										cmpi.b  #$30,d4 
										blt.s   loc_F0EE
										move.b  #$FF,d0
										clr.w   d1
										move.b  #3,d2
										bra.w   loc_F1CC
loc_F0EE:
										cmp.b   d4,d6
										beq.s   loc_F0F4
										bra.s   loc_F088
loc_F0F4:
										addq.b  #1,d5
										cmpi.b  #$20,d5 
										bge.s   loc_F0FE
										bra.s   loc_F086
loc_F0FE:
										move.b  #0,-$C4(a6)
										clr.l   d6
										clr.l   d2
										move.b  -$60(a6,d2.w),d2
										lea     ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,a5
										move.w  (a5),d7
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a5
										clr.l   d4
loc_F118:
										move.b  -$60(a6,d4.w),d5
										cmp.b   d5,d2
										bne.s   loc_F13C
										move.b  (a5,d4.w),-$30(a6,d6.w)
										move.l  a6,-(sp)
										adda.w  d4,a6
										move.b  -$C0(a6),d0
										movea.l (sp)+,a6
										move.l  a6,-(sp)
										adda.w  d6,a6
										move.b  d0,-$90(a6)
										movea.l (sp)+,a6
										addq.w  #1,d6
loc_F13C:
										addi.w  #1,d4
										cmpi.w  #$30,d4 
										blt.s   loc_F154
										move.b  #$FF,d0
										clr.w   d1
										move.b  #3,d2
										bra.w   loc_F1CC
loc_F154:
										subq.w  #1,d7
										bne.s   loc_F118
										move.b  d6,-$C4(a6)
										cmpi.b  #1,d6
										bne.s   loc_F172
										move.b  -$30(a6),d0
										move.b  -$C2(a6),d1
										move.b  -$C3(a6),d2
										bra.w   loc_F1CC
loc_F172:
										clr.l   d2
										move.b  #$FF,d2
										clr.w   d3
										move.b  -$C4(a6),d3
										cmpi.w  #$30,d3 
										ble.s   loc_F192
										move.b  #$FF,d0
										clr.w   d1
										move.b  #3,d2
										bra.w   loc_F1CC
loc_F192:
										clr.l   d4
										clr.l   d6
loc_F196:
										movea.l a6,a5
										adda.w  d4,a5
										move.b  -$90(a5),d5
										cmp.b   d5,d2
										bgt.s   loc_F1A8
										move.b  d5,d2
										move.b  -$30(a6,d4.w),d6
loc_F1A8:
										addi.w  #1,d4
										subq.w  #1,d3
										bne.s   loc_F196
										cmpi.b  #$FF,d2
										bne.s   loc_F1C2
										move.b  #$FF,d0
										clr.w   d1
										move.b  #3,d2
										bra.s   loc_F1CC
loc_F1C2:
										move.b  d6,d0
										move.b  -$C2(a6),d1
										move.b  -$C3(a6),d2
loc_F1CC:
										unlk    a6
										movem.l (sp)+,d3-a5
										rts

	; End of function sub_EDD6


; =============== S U B R O U T I N E =======================================

sub_F1D4:
										movem.l d0/d3-a6,-(sp)
										link    a6,#-$64
										move.w  d0,d7
										move.b  d1,-$62(a6)
										tst.b   d1
										beq.s   loc_F1FE
										cmpi.b  #1,d1
										bne.s   loc_F1F2
										jsr     j_getMoveListForEnemyTarget
loc_F1F2:
										cmpi.b  #2,d1
										bne.s   loc_F1FE
										jsr     sub_1AC030
loc_F1FE:
										bsr.w   GetMoveInfo     
										move.w  #$80,d0 
										bsr.w   MakeRangeLists
										bsr.w   MakeTargetListEverybody
										move.w  d7,d0
										bsr.w   CheckMuddled2   
										tst.b   d1
										beq.s   loc_F22C
										btst    #7,d0
										bne.s   loc_F222
										clr.w   d6
										bra.s   loc_F228
loc_F222:
										clr.w   d6
										move.w  #$80,d6 
loc_F228:
										bra.w   loc_F39E
loc_F22C:
										move.w  d7,d0
										btst    #7,d0
										bne.s   loc_F23E
										move.w  #$80,d0 
										move.w  #$1F,d6
										bra.s   loc_F244
loc_F23E:
										clr.w   d0
										move.w  #$1D,d6
loc_F244:
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a0
										clr.w   d2
loc_F24A:
										bsr.w   GetCurrentHP    ; iterate through force or monsters
										tst.w   d1
										bne.s   loc_F256
										bra.w   loc_F276
loc_F256:
										bsr.w   GetXPos
										tst.b   d1
										bpl.s   loc_F262
										bra.w   loc_F276
loc_F262:
										bsr.w   GetYPos
										tst.b   d1
										bpl.s   loc_F26E
										bra.w   loc_F276
loc_F26E:
										move.b  d0,(a0,d2.w)    ; add to targets if alive and on map
										addi.w  #1,d2
loc_F276:
										addq.w  #1,d0
										dbf     d6,loc_F24A
										move.w  d2,((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w
										move.w  d2,d6
										clr.w   d2
loc_F284:
										clr.w   d0
										move.b  (a0,d2.w),d0
										bsr.w   GetMoveCostToEntity
										move.b  d0,-$60(a6,d2.w)
										addi.w  #1,d2
										subq.w  #1,d6
										bne.s   loc_F284
										move.w  ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,d1
										cmpi.w  #1,d1
										bgt.s   loc_F2A8
										bra.w   loc_F39A
loc_F2A8:
										subq.w  #2,d1
										move.b  #0,d2
										lea     ((TARGET_CHARACTERS_INDEX_LIST-$1000000)).w,a0
loc_F2B2:
										tst.b   d2
										bpl.s   loc_F2BA
										bra.w   loc_F2F6
loc_F2BA:
										move.b  #$FF,d2
										clr.w   d3
loc_F2C0:
										move.b  -$5F(a6,d3.w),d4
										cmp.b   -$60(a6,d3.w),d4
										bcc.s   loc_F2E8
										move.b  -$5F(a6,d3.w),d4
										move.b  -$60(a6,d3.w),-$5F(a6,d3.w)
										move.b  d4,-$60(a6,d3.w)
										move.b  1(a0,d3.w),d4
										move.b  (a0,d3.w),1(a0,d3.w)
										move.b  d4,(a0,d3.w)
										move.w  d3,d2
loc_F2E8:
										tst.w   d1
										beq.s   loc_F2F2
										addq.w  #1,d3
										subq.w  #1,d1
										bra.s   loc_F2C0
loc_F2F2:
										move.w  d2,d1
										bra.s   loc_F2B2
loc_F2F6:
										btst    #7,d0
										bne.s   loc_F300
										bra.w   loc_F39A
loc_F300:
										clr.w   d0
										move.b  d7,d0
										bsr.w   GetUpperMoveType
										lea     (off_D982).l,a1 
										lsl.l   #2,d1
										movea.l (a1,d1.l),a1
										move.w  ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,d6
										clr.w   d5
loc_F31A:
										clr.w   d0
										move.b  (a0,d5.w),d0
										bsr.w   GetClass
										move.b  d1,d4
										clr.w   d3
										move.w  #$20,d2 
loc_F32C:
										cmp.b   (a1,d3.w),d4
										bne.s   loc_F33A
										move.b  d3,-$30(a6,d5.w)
										bra.w   loc_F340
loc_F33A:
										addq.b  #1,d3
										subq.w  #1,d2
										bne.s   loc_F32C
loc_F340:
										addq.b  #1,d5
										subq.w  #1,d6
										bne.s   loc_F31A
										move.w  ((TARGET_CHARACTERS_INDEX_LIST_SIZE-$1000000)).w,d6
										subi.w  #2,d6
										clr.w   d5
loc_F350:
										move.b  -$30(a6,d5.w),d0
										move.b  -$2F(a6,d5.w),d1
										sub.b   d1,d0
										bpl.s   loc_F35E
										neg.b   d0
loc_F35E:
										cmpi.b  #1,d0
										bgt.s   loc_F392
										move.b  (a0,d5.w),d0
loc_F368:
										sub.b   1(a0,d5.w),d0
										bpl.s   loc_F370
										neg.b   d0
loc_F370:
										cmpi.b  #3,d0
										bgt.s   loc_F392
										move.b  -$30(a6,d5.w),d0
										move.b  d0,-$2F(a6,d5.w)
										move.b  d1,-$30(a6,d5.w)
										move.b  (a0,d5.w),d0
										move.b  1(a0,d5.w),d1
										move.b  d0,1(a0,d5.w)
										move.b  d1,(a0,d5.w)
loc_F392:
										addi.w  #1,d5
										dbf     d6,loc_F350
loc_F39A:
										clr.w   d6
										move.b  (a0),d6
loc_F39E:
										clr.w   d0
										move.b  d7,d0
										btst    #7,d0
										beq.w   loc_F404
										bsr.w   GetEnemyID
										cmpi.b  #$A,d1          ; HARDCODED enemy indexes
										bne.s   loc_F3B8
										bra.w   loc_F3D0
loc_F3B8:
										cmpi.b  #$3B,d1 
										bne.s   loc_F3C2
										bra.w   loc_F3D0
loc_F3C2:
										cmpi.b  #$57,d1 
										bne.s   loc_F3CC
										bra.w   loc_F3D0
loc_F3CC:
										bra.w   loc_F404
loc_F3D0:
										jsr     j_clearTerrainListObstructions
										move.b  d6,d0
										bsr.w   GetYPos
										move.w  d1,d4
										bsr.w   GetXPos
										move.w  d1,d3
										move.w  #$80,d0 
										lea     ((byte_FF4000+$400)).l,a2
										lea     ((byte_FF4A00+$300)).l,a3
										lea     (TERRAIN_DATA).l,a4
										lea     KrakenMoveCosts(pc), a5
										nop
										bra.w   loc_F43A
loc_F404:
										jsr     j_clearTerrainListObstructions
										clr.w   d0
										move.b  d7,d0
										bsr.w   MemorizePath
										move.b  d6,d0
										bsr.w   GetYPos
										move.w  d1,d4
										bsr.w   GetXPos
										move.w  d1,d3
										move.w  #$80,d0 
										lea     ((byte_FF4000+$400)).l,a2
loc_F42A:
										lea     ((byte_FF4A00+$300)).l,a3
										lea     (TERRAIN_DATA).l,a4
										lea     ((MOVE_COST_LIST-$1000000)).w,a5
loc_F43A:
										bsr.w   MakeRangeLists
										move.b  d7,d0
										bsr.w   GetXPos
										move.w  d1,d2
										move.w  #4,d3
										bsr.w   GetYPos
										move.w  d2,d0
										bsr.w   j_makeEnemyMoveOrder
loc_F454:
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  (a0),d0
										cmpi.b  #$FF,d0
										bne.s   loc_F476
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										lea     (BATTLESCENE_ACTION_TYPE).l,a0
										move.w  #3,(a0)
										bra.w   loc_F512
loc_F476:
										move.b  -$62(a6),d1
										tst.b   d1
										beq.s   loc_F49A
										cmpi.b  #1,d1
										bne.s   loc_F48C
										move.b  d7,d0
										jsr     j_getMoveListForEnemyTarget
loc_F48C:
										cmpi.b  #2,d1
										bne.s   loc_F49A
										move.b  d7,d0
										jsr     sub_1AC030
loc_F49A:
										move.w  d7,d0
										move.w  #$FFFF,d3
										bsr.w   UpdateTargetList
										bsr.w   GetMoveInfo     
										bsr.w   MakeRangeLists
										bsr.w   MakeTargetListEverybody
										move.w  #0,d3
										move.w  d7,d0
										bsr.w   UpdateTargetList
										clr.w   d0
										move.b  d7,d0
										bsr.w   GetEnemyDestination
										clr.w   d3
										clr.w   d4
										bsr.w   GetClosestAttackPosition
										cmpi.b  #$FF,d1
										bne.s   loc_F4FE
										move.b  d7,d0
										bsr.w   GetEnemyDestination
										move.w  #1,d3
										move.w  #1,d4
										bsr.w   GetClosestAttackPosition
										cmpi.b  #$FF,d1
										bne.s   loc_F4FE
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										lea     (BATTLESCENE_ACTION_TYPE).l,a0
										move.w  #3,(a0)
										bra.w   loc_F512
loc_F4FE:
										move.w  d1,d0
										move.w  d2,d1
										lea     ((byte_FF4000+$400)).l,a2
										lea     ((byte_FF4A00+$300)).l,a3
										bsr.w   sub_DD10
loc_F512:
										jsr     j_clearTerrainListObstructions
										clr.w   d1
										unlk    a6
										movem.l (sp)+,d0/d3-a6
										rts

	; End of function sub_F1D4


; =============== S U B R O U T I N E =======================================

sub_F522:
										movem.l d0-a6,-(sp)
										link    a6,#-4
										move.b  d0,-3(a6)
										move.w  #8,d6
										jsr     j_randomLessThanD6
										cmpi.b  #2,d7
										bne.s   loc_F554
										lea     (BATTLESCENE_ACTION_TYPE).l,a2
										move.w  #3,(a2)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a2
										move.b  #$FF,(a2)
										bra.w   loc_F782
loc_F554:
										cmpi.b  #4,d7
										bne.s   loc_F570
										lea     (BATTLESCENE_ACTION_TYPE).l,a2
										move.w  #3,(a2)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a2
										move.b  #$FF,(a2)
										bra.w   loc_F782
loc_F570:
										cmpi.b  #6,d7
										bne.s   loc_F58C
										lea     (BATTLESCENE_ACTION_TYPE).l,a2
										move.w  #3,(a2)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a2
										move.b  #$FF,(a2)
										bra.w   loc_F782
loc_F58C:
										bsr.w   sub_F8EA
										tst.b   d1
										beq.s   loc_F5AA
										lea     (BATTLESCENE_ACTION_TYPE).l,a2
										move.w  #3,(a2)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a2
										move.b  #$FF,(a2)
										bra.w   loc_F782
loc_F5AA:
										tst.b   d2
										bne.s   loc_F5C4
										clr.w   d0
										move.b  -3(a6),d0
										jsr     j_GetMonsterStartPos
										move.b  d1,-1(a6)
										move.b  d2,-2(a6)
										bra.s   loc_F5DE
loc_F5C4:
										clr.w   d0
										move.b  -3(a6),d0
										bsr.w   GetEnemyAISetting3233
										move.w  d1,d0
										jsr     j_getEnemyAITargetPos
										move.b  d1,-1(a6)
										move.b  d1,-2(a6)
loc_F5DE:
										move.b  -3(a6),d0
										bsr.w   GetMoveInfo     
										bsr.w   MakeRangeLists
										bsr.w   MakeTargetListEverybody
										lea     (byte_FFB1DC).l,a0
										clr.w   d0
										move.b  -3(a6),d0
										andi.b  #$7F,d0 
										adda.w  d0,a0
										clr.w   d1
										move.b  (a0),d1
										andi.b  #$F,d1
										tst.b   d1
										bne.s   loc_F62A
										clr.w   d6
										move.w  #2,d6
										jsr     j_randomLessThanD6
										tst.b   d7
										bne.s   loc_F624
										move.b  #4,d1
										move.b  d1,(a0)
										bra.s   loc_F62A
loc_F624:
										move.b  #3,d1
										move.b  d1,(a0)
loc_F62A:
										move.b  d1,-4(a6)
										clr.l   d5
										move.b  d1,d5
										subi.l  #1,d5
										clr.w   d1
										move.b  (a0),d1
										lsr.w   #4,d1
										move.w  d1,d6
										clr.w   d7
										lea     off_F78A(pc), a1
										nop
										move.b  -4(a6),d7
										subi.b  #3,d7
										lsl.l   #2,d7
										movea.l (a1,d7.w),a1
										clr.w   d7
										clr.w   d0
										clr.w   d3
loc_F65C:
										clr.w   d1
										clr.w   d2
										move.b  (a1,d0.w),d1
										move.b  1(a1,d0.w),d2
										add.b   -1(a6),d1
										add.b   -2(a6),d2
										tst.b   d1
										bpl.s   loc_F678
										bra.w   loc_F6AC
loc_F678:
										cmpi.b  #$30,d1 
										ble.s   loc_F682
										bra.w   loc_F6AC
loc_F682:
										tst.b   d2
										bpl.s   loc_F68A
										bra.w   loc_F6AC
loc_F68A:
										cmpi.b  #$30,d2 
										ble.s   loc_F694
										bra.w   loc_F6AC
loc_F694:
										move.l  d3,-(sp)
										clr.w   d3
										clr.w   d4
										bsr.w   GetClosestAttackPosition
										move.l  (sp)+,d3
										cmpi.b  #$FF,d1
										bne.s   loc_F6AA
										bra.w   loc_F6AC
loc_F6AA:
										bset    d3,d7
loc_F6AC:
										addi.w  #2,d0
										addi.w  #1,d3
										dbf     d5,loc_F65C
										bclr    d6,d7
										tst.b   d7
										bne.s   loc_F6EA
										lea     (byte_FFB1DC).l,a0
										clr.w   d0
										move.b  -3(a6),d0
										andi.b  #$7F,d0 
										adda.w  d0,a0
										move.b  #0,(a0)
										lea     (BATTLESCENE_ACTION_TYPE).l,a2
										move.w  #3,(a2)
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a2
										move.b  #$FF,(a2)
										bra.w   loc_F782
loc_F6EA:
										move.w  d7,d5
										move.w  #3,d4
										clr.w   d0
loc_F6F2:
										lsr.w   #1,d5
										bcc.s   loc_F6FA
										addi.b  #1,d0
loc_F6FA:
										dbf     d4,loc_F6F2
										move.w  d7,d5
										move.w  d0,d6
										jsr     j_randomLessThanD6
										clr.l   d4
										move.b  -4(a6),d4
										subi.w  #1,d4
										clr.w   d0
										clr.w   d1
loc_F716:
										lsr.w   #1,d5
										bcc.s   loc_F726
										cmp.b   d7,d0
										bne.s   loc_F722
										bra.w   loc_F72E
loc_F722:
										addi.b  #1,d0
loc_F726:
										addi.b  #1,d1
										dbf     d4,loc_F716
loc_F72E:
										lea     (byte_FFB1DC).l,a0
										clr.w   d0
										move.b  -3(a6),d0
										andi.b  #$7F,d0 
										adda.w  d0,a0
										move.b  (a0),d0
										move.b  d1,d2
										lsl.w   #4,d2
										andi.b  #$F0,d2
										andi.b  #$F,d0
										or.b    d2,d0
										move.b  d0,(a0)
										clr.l   d7
										move.b  d1,d7
										lsl.w   #1,d7
										move.b  (a1,d7.w),d0
										move.b  1(a1,d7.w),d1
										add.b   -1(a6),d0
										add.b   -2(a6),d1
										lea     ((byte_FF4000+$400)).l,a2
										lea     ((byte_FF4A00+$300)).l,a3
										bsr.w   sub_DD10
										lea     (BATTLESCENE_ACTION_TYPE).l,a2
										move.w  #3,(a2)
loc_F782:
										unlk    a6
										movem.l (sp)+,d0-a6
										rts

	; End of function sub_F522

off_F78A:           dc.l byte_F792
										dc.l byte_F798
byte_F792:          dc.b 0
										dc.b $FF
										dc.b $FF
										dc.b 1
										dc.b 1
										dc.b 1
byte_F798:          dc.b 0
										dc.b $FF
										dc.b $FF
										dc.b 0
										dc.b 0
										dc.b 1
										dc.b 1
										dc.b 0

; =============== S U B R O U T I N E =======================================

sub_F7A0:
										movem.l d0-a6,-(sp)
										link    a6,#-4
										move.b  d0,-1(a6)
										move.b  d1,-2(a6)
										clr.w   d0
										move.b  -1(a6),d0
										bsr.w   MemorizePath
										move.b  -2(a6),d0
										jsr     j_getEnemyAITargetPos
										move.w  d1,d3
										move.w  d2,d4
										move.w  #$80,d0 
										lea     ((byte_FF4000+$400)).l,a2
										lea     ((byte_FF4A00+$300)).l,a3
										lea     (TERRAIN_DATA).l,a4
										lea     ((MOVE_COST_LIST-$1000000)).w,a5
										bsr.w   MakeRangeLists
										move.w  #$FFFF,d3
										bsr.w   sub_C900
										bsr.w   MakeTargetListEverybody
										clr.w   d0
										move.b  -1(a6),d0
										bsr.w   GetXPos
										move.w  d1,d2
										bsr.w   GetCurrentMOV
										move.w  d1,d3
										add.w   d3,d3
										bsr.w   GetYPos
										move.w  d2,d0
										bsr.w   j_makeEnemyMoveOrder
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  (a0),d0
										cmpi.b  #$FF,d0
										bne.s   loc_F820
										bra.w   loc_F8E2
loc_F820:
										clr.w   d0
										move.b  -1(a6),d0
										bsr.w   GetEnemyDestination
										move.b  d1,-4(a6)
										move.b  d2,-3(a6)
										move.w  #$FFFF,d3
										bsr.w   UpdateTargetListCharacters
										move.b  -1(a6),d0
										bsr.w   GetMoveInfo     
										bsr.w   MakeRangeLists
										move.w  #0,d3
										bsr.w   UpdateTargetListCharacters
										move.b  -4(a6),d1
										move.b  -3(a6),d2
										clr.w   d3
										clr.w   d4
										bsr.w   GetClosestAttackPosition
										cmpi.b  #$FF,d1
										beq.s   loc_F868
										bra.w   loc_F8CE
loc_F868:
										move.b  -4(a6),d1
										move.b  -3(a6),d2
										move.w  #1,d3
										move.w  #1,d4
										bsr.w   GetClosestAttackPosition
										cmpi.b  #$FF,d1
										beq.s   loc_F886
										bra.w   loc_F8CE
loc_F886:
										move.b  -4(a6),d1
										move.b  -3(a6),d2
										move.w  #2,d3
										move.w  #2,d4
										bsr.w   GetClosestAttackPosition
										cmpi.b  #$FF,d1
										beq.s   loc_F8A4
										bra.w   loc_F8CE
loc_F8A4:
										move.b  -4(a6),d1
										move.b  -3(a6),d2
										move.w  #3,d3
										move.w  #3,d4
										bsr.w   GetClosestAttackPosition
										cmpi.b  #$FF,d1
										beq.s   loc_F8C2
										bra.w   loc_F8CE
loc_F8C2:
										lea     ((BATTLE_ENTITY_MOVE_STRING-$1000000)).w,a0
										move.b  #$FF,(a0)
										bra.w   loc_F8E2
loc_F8CE:
										move.w  d1,d0
										move.w  d2,d1
										lea     ((byte_FF4000+$400)).l,a2
										lea     ((byte_FF4A00+$300)).l,a3
loc_F8DE:
										bsr.w   sub_DD10
loc_F8E2:
										unlk    a6
										movem.l (sp)+,d0-a6
										rts

	; End of function sub_F7A0


; =============== S U B R O U T I N E =======================================

sub_F8EA:
										movem.l d0/d3-a6,-(sp)
loc_F8EE:
										link    a6,#-4
										move.w  d0,d7
										bsr.w   GetEnemyAISetting3233
										move.b  d1,-3(a6)
										move.b  d2,-4(a6)
										bsr.w   GetEnemyAISetting36
										move.b  d1,-1(a6)
										move.b  d2,-2(a6)
										move.b  -3(a6),d0
										cmpi.b  #$FF,d0
										beq.s   loc_F924
loc_F916:
										cmpi.b  #$F,d1
										beq.s   loc_F924
										move.b  #1,d1
										bra.w   loc_F9AC
loc_F924:
										move.b  -4(a6),d0
										cmpi.b  #$FF,d0
										beq.s   loc_F93C
loc_F92E:
										cmpi.b  #$F,d2
										beq.s   loc_F93C
										move.b  #1,d1
										bra.w   loc_F9AC
loc_F93C:
										move.b  -3(a6),d0
										cmpi.b  #$FF,d0
										beq.s   loc_F96E
loc_F946:
										move.b  -1(a6),d0
										cmpi.b  #$F,d0
										bne.s   loc_F96E
										move.b  -4(a6),d0
										cmpi.b  #$FF,d0
										bne.s   loc_F96E
										move.b  -2(a6),d0
loc_F95E:
										cmpi.b  #$F,d0
										beq.s   loc_F96E
										clr.w   d1
loc_F966:
										move.b  #1,d2
										bra.w   loc_F9AC
loc_F96E:
										move.b  -3(a6),d0
										cmpi.b  #$FF,d0
										bne.s   loc_F98A
										move.b  -1(a6),d0
										cmpi.b  #$F,d0
										beq.s   loc_F98A
										clr.w   d1
										clr.w   d2
loc_F986:
										bra.w   loc_F9AC
loc_F98A:
										move.b  -4(a6),d0
loc_F98E:
										cmpi.b  #$FF,d0
										bne.s   loc_F9A6
										move.b  -2(a6),d0
										cmpi.b  #$F,d0
										beq.s   loc_F9A6
										clr.w   d1
										clr.w   d2
										bra.w   loc_F9AC
loc_F9A6:
										move.w  #1,d1
										clr.w   d2
loc_F9AC:
										unlk    a6
										movem.l (sp)+,d0/d3-a6
										rts

	; End of function sub_F8EA

KrakenMoveCosts:    dc.b $F                 ; special move cost list for Kraken Arm, Kraken Leg, Kraken Head
										dc.b 2
										dc.b 2
										dc.b 3
										dc.b 4
										dc.b 3
										dc.b 3
										dc.b $FF
										dc.b 2
										dc.b $FF
										dc.b $FF
										dc.b $FF
										dc.b $FF
										dc.b $FF
										dc.b $FF
										dc.b $FF
SpellNames:         incbin "data/spells/spellnames.bin"
AllyNames:          incbin "data/allies/allynames.bin"
EnemyNames:         incbin "data/enemies/enemynames.bin"
algn_FF87:          align $8000
